{% extends 'base.html' %}
{% load static %}

{% block title %}
<title>Main</title>
<link rel="icon" href="{% static 'icons/Bin.jpg' %}" type="image/png">
<!-- <link rel="stylesheet" href="{% static 'css/home.css' %}"> -->
<!-- <link rel="stylesheet" href="{% static 'js/home1.js' %}"> -->

<style>
.setting-form,
.form1,
.form2 {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 400px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
    transition: background 0.3s, color 0.3s;
}

.profile-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 400px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
    transition: background 0.3s, color 0.3s;
}

#profile-toggle:checked ~ .profile-form {
    display: flex;
}

.theme-light {
  background-color: #ffffff;
  color: #000000;
}

.theme-light .side-menu,
.theme-light .profile-form,
.theme-light .profile-preview-card,
.theme-light .setting-form,
.theme-light .form1,
.theme-light .form2,
.theme-light .add_card,
.theme-light .color_theme,
.theme-light .wallet-form,
.theme-light .deposit-form,
.theme-light .subscribe-form-month,
.theme-light .subscribe-form-year,
.theme-light .bin_mouth-form,
.theme-light .bin_premium_mouth-form,
.theme-light .bin_years-form,
.theme-light .bin_premium_years-form,
.theme-light .check-subscription-form {
    background: linear-gradient(to right, #ffffff, #e0e0e0);
    color: #000000;
}

.theme-light .status-value.online { color: #00be00; }
.theme-light .status-value.offline { color: #ff4444; }

.theme-light .profile-form label,
.theme-light .setting-form label,
.theme-light .form1 label,
.theme-light .form2 label {
    color: #000000;
}

.theme-light .profile-form input,
.theme-light .setting-form input,
.theme-light .form1 input,
.theme-light .form2 input,
.theme-light .profile-form textarea,
.theme-light .setting-form textarea,
.theme-light .form1 textarea,
.theme-light .form2 textarea,
.theme-light .profile-form select,
.theme-light .setting-form select,
.theme-light .form1 select,
.theme-light .form2 select {
    background: rgba(255, 255, 255, 0.8);
    color: #000000;
    border: 1px solid #999999;
    border-radius: 5px;
    padding: 8px;
    outline: none;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
}

.theme-light .profile-form input:focus,
.theme-light .setting-form input:focus,
.theme-light .form1 input:focus,
.theme-light .form2 input:focus,
.theme-light .profile-form textarea:focus,
.theme-light .setting-form textarea:focus,
.theme-light .form1 textarea:focus,
.theme-light .form2 textarea:focus,
.theme-light .profile-form select:focus,
.theme-light .setting-form select:focus,
.theme-light .form1 select:focus,
.theme-light .form2 select:focus {
    background: rgba(255, 255, 255, 0.9);
    border-color: #666666;
}

.theme-light .profile-form select option,
.theme-light .setting-form select option,
.theme-light .form1 select option,
.theme-light .form2 select option {
    background: #ffffff;
    color: #000000;
}

.theme-light .side-menu .profile-btn,
.theme-light .setting-form .profile-btn {
    background: rgba(255, 255, 255, 0.8);
    color: #000000;
    padding: 10px 15px;
    border: 1px solid #999999;
    border-radius: 8px;
    cursor: pointer;
    display: block;
    margin: 5px 0;
    text-align: center;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
    text-decoration: none;
}

.theme-light .side-menu .profile-btn:hover,
.theme-light .setting-form .profile-btn:hover {
    background: rgba(255, 255, 255, 0.95);
    border-color: #666666;
    color: #000000;
}

.theme-dark {
  background-color: #747474;
  color: #ffffff;
}

.theme-dark .username-text,
.theme-dark .edit-icon,
.theme-dark .profile-preview-label,
.theme-dark .profile-preview-value,
.theme-dark .birthday-value {
    color: #ffffff;
}

.theme-dark .profile-preview-section .profile-preview-label,
.theme-dark .profile-preview-section .profile-preview-birthday,
.theme-dark .profile-preview-birthday span,
.theme-dark .profile-preview-birthday svg {
    color: #ffffff;  
    stroke: #ffffff; 
}

.theme-dark #preview-username,
.theme-dark .profile-preview-label,
.theme-dark #preview-description,
.theme-dark #preview-birthday,
.theme-dark .profile-preview-birthday svg {
    color: #ffffff;
    stroke: #ffffff;
}

.theme-dark .status-value.online { color: #00ff00; }
.theme-dark .status-value.offline { color: #ff4444; }

.theme-dark .side-menu,
.theme-dark .profile-form,
.theme-dark .profile-preview-card,
.theme-dark .setting-form,
.theme-dark .form1,
.theme-dark .form2,
.theme-dark .add_card,
.theme-dark .color_theme,
.theme-dark .wallet-form,
.theme-dark .deposit-form,
.theme-dark .subscribe-form-month,
.theme-dark .subscribe-form-year,
.theme-dark .bin_mouth-form,
.theme-dark .bin_premium_mouth-form,
.theme-dark .bin_years-form,
.theme-dark .bin_premium_years-form,
.theme-dark .check-subscription-form {
    background: linear-gradient(to right, #2c2c2c, #1a1a1a);
    color: #ffffff;
}

.theme-dark .profile-form label,
.theme-dark .setting-form label,
.theme-dark .form1 label,
.theme-dark .form2 label {
    color: #ffffff;
}

.theme-dark .profile-form input,
.theme-dark .setting-form input,
.theme-dark .form1 input,
.theme-dark .form2 input,
.theme-dark .profile-form textarea,
.theme-dark .setting-form textarea,
.theme-dark .form1 textarea,
.theme-dark .form2 textarea,
.theme-dark .profile-form select,
.theme-dark .setting-form select,
.theme-dark .form1 select,
.theme-dark .form2 select {
    background: rgba(0, 0, 0, 0.5);
    color: #ffffff;
    border: 1px solid #555555;
    border-radius: 5px;
    padding: 8px;
    outline: none;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
}

.theme-dark .profile-form input:focus,
.theme-dark .setting-form input:focus,
.theme-dark .form1 input:focus,
.theme-dark .form2 input:focus,
.theme-dark .profile-form textarea:focus,
.theme-dark .setting-form textarea:focus,
.theme-dark .form1 textarea:focus,
.theme-dark .form2 textarea:focus,
.theme-dark .profile-form select:focus,
.theme-dark .setting-form select:focus,
.theme-dark .form1 select:focus,
.theme-dark .form2 select:focus {
    background: rgba(50, 50, 50, 0.7);
    border-color: #b30086;
}

.theme-dark .profile-form select option,
.theme-dark .setting-form select option,
.theme-dark .form1 select option,
.theme-dark .form2 select option {
    background: #2c2c2c;
    color: #ffffff;
}

.theme-dark .side-menu .profile-btn,
.theme-dark .setting-form .profile-btn {
    background: rgba(50, 50, 50, 0.7);
    color: #ffffff;
    padding: 10px 15px;
    border: 1px solid #555555;
    border-radius: 8px;
    cursor: pointer;
    display: block;
    margin: 5px 0;
    text-align: center;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
    text-decoration: none;
}

.theme-dark .side-menu .profile-btn:hover,
.theme-dark .setting-form .profile-btn:hover {
    background: rgba(70, 70, 70, 0.9);
    border-color: #b30086;
    color: #ffffff;
}

.theme-pink {
  background: linear-gradient(to right, #ffb6c1, #b30086);
  color: #000000;
}

.theme-pink .status-value.online { color: #00ffd5; }
.theme-pink .status-value.offline { color: #ff4444; }

.theme-pink .side-menu,
.theme-pink .profile-form,
.theme-pink .profile-preview-card,
.theme-pink .setting-form,
.theme-pink .form1,
.theme-pink .form2,
.theme-pink .add_card,
.theme-pink .color_theme,
.theme-pink .wallet-form,
.theme-pink .deposit-form,
.theme-pink .subscribe-form-month,
.theme-pink .subscribe-form-year,
.theme-pink .bin_mouth-form,
.theme-pink .bin_premium_mouth-form,
.theme-pink .bin_years-form,
.theme-pink .bin_premium_years-form,
.theme-pink .check-subscription-form {
    background: linear-gradient(to right, #ffb6c1, #b30086);
    color: #000000;
}

.theme-pink .profile-form label,
.theme-pink .setting-form label,
.theme-pink .form1 label,
.theme-pink .form2 label {
    color: #000000;
}

.theme-pink .profile-form input,
.theme-pink .setting-form input,
.theme-pink .form1 input,
.theme-pink .form2 input {
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    border: 1px solid #000000;
    padding: 8px;
    border-radius: 5px;
    outline: none;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
}

.theme-pink .profile-form input:focus,
.theme-pink .setting-form input:focus,
.theme-pink .form1 input:focus,
.theme-pink .form2 input:focus {
    background: rgba(255, 255, 255, 0.3);
    border-color: #b30086;
}
.theme-pink .profile-form textarea,
.theme-pink .setting-form textarea,
.theme-pink .form1 textarea,
.theme-pink .form2 textarea {
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    border: 1px solid #000000;
    padding: 8px;
    border-radius: 5px;
    outline: none;
    width: 100%;
    resize: vertical;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
}

.theme-pink .profile-form textarea:focus,
.theme-pink .setting-form textarea:focus,
.theme-pink .form1 textarea:focus,
.theme-pink .form2 textarea:focus {
    background: rgba(255, 255, 255, 0.3);
    border-color: #b30086;
}

.theme-pink .profile-form select,
.theme-pink .setting-form select,
.theme-pink .form1 select,
.theme-pink .form2 select {
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    border: 1px solid #000000;
    padding: 6px 10px;
    border-radius: 5px;
    outline: none;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
}

.theme-pink .profile-form select:focus,
.theme-pink .setting-form select:focus,
.theme-pink .form1 select:focus,
.theme-pink .form2 select:focus {
    background: rgba(255, 255, 255, 0.3);
    border-color: #b30086;
}

.theme-pink .profile-form select option,
.theme-pink .setting-form select option,
.theme-pink .form1 select option,
.theme-pink .form2 select option {
    background: white;
    color: #000000;
}

.theme-pink .side-menu .profile-btn {
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    padding: 10px 15px;
    border: 1px solid #000000;
    border-radius: 8px;
    cursor: pointer;
    display: block;
    margin: 5px 0;
    text-align: center;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
}

.theme-pink .side-menu .profile-btn:hover {
    background: rgba(255, 255, 255, 0.4);
    border-color: #b30086;
    color: #000000;
}

.theme-pink .setting-form .profile-btn {
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    padding: 10px 15px;
    border: 1px solid #000000;
    border-radius: 8px;
    cursor: pointer;
    display: block;
    margin: 5px 0;
    text-align: center;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
    text-decoration: none;
}

.theme-pink .setting-form .profile-btn:hover {
    background: rgba(255, 255, 255, 0.4);
    border-color: #b30086;
    color: #000000;
}

.theme-green {
  background: linear-gradient(to right, #a8ffbf, #008c3a);
  color: #777777;
}

.theme-green .status-value.online { color: #00ff00; }
.theme-green .status-value.offline { color: #ff4444; }

.theme-green .side-menu,
.theme-green .profile-form,
.theme-green .profile-preview-card,
.theme-green .setting-form,
.theme-green .form1,
.theme-green .form2,
.theme-green .add_card,
.theme-green .color_theme,
.theme-green .wallet-form,
.theme-green .deposit-form,
.theme-green .subscribe-form-month,
.theme-green .subscribe-form-year,
.theme-green .bin_mouth-form,
.theme-green .bin_premium_mouth-form,
.theme-green .bin_years-form,
.theme-green .bin_premium_years-form,
.theme-green .check-subscription-form {
    background: linear-gradient(to right, #a8e6a2, #2e7d32);
    color: #ffffff;
}

.theme-green .profile-form label,
.theme-green .setting-form label,
.theme-green .form1 label,
.theme-green .form2 label {
    color: #ffffff;
}

.theme-green .profile-form input,
.theme-green .setting-form input,
.theme-green .form1 input,
.theme-green .form2 input,
.theme-green .profile-form textarea,
.theme-green .setting-form textarea,
.theme-green .form1 textarea,
.theme-green .form2 textarea,
.theme-green .profile-form select,
.theme-green .setting-form select,
.theme-green .form1 select,
.theme-green .form2 select {
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    border: 1px solid #2e7d32;
    border-radius: 5px;
    padding: 8px;
    outline: none;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
}

.theme-green .profile-form input:focus,
.theme-green .setting-form input:focus,
.theme-green .form1 input:focus,
.theme-green .form2 input:focus,
.theme-green .profile-form textarea:focus,
.theme-green .setting-form textarea:focus,
.theme-green .form1 textarea:focus,
.theme-green .form2 textarea:focus,
.theme-green .profile-form select:focus,
.theme-green .setting-form select:focus,
.theme-green .form1 select:focus,
.theme-green .form2 select:focus {
    background: rgba(255, 255, 255, 0.3);
    border-color: #145214;
}

.theme-green .profile-form select option,
.theme-green .setting-form select option,
.theme-green .form1 select option,
.theme-green .form2 select option {
    background: #a8e6a2;
    color: #000000;
}

.theme-green .side-menu .profile-btn,
.theme-green .setting-form .profile-btn {
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    padding: 10px 15px;
    border: 1px solid #2e7d32;
    border-radius: 8px;
    cursor: pointer;
    display: block;
    margin: 5px 0;
    text-align: center;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
    text-decoration: none;
}

.theme-green .side-menu .profile-btn:hover,
.theme-green .setting-form .profile-btn:hover {
    background: rgba(255, 255, 255, 0.35);
    border-color: #145214;
    color: #000000;
}

body {
  transition: background-color 0.3s, color 0.3s;
}

.username {
    text-align: left;
    margin: 5px 0;
    font-weight: bold;
}

.username-line {
    align-self: flex-start;
    text-align: left;
    margin: 5px 0;
    font-weight: bold;
}

body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #f0f0f0;
}

#menu-toggle,
#profile-toggle,
#setting-toggle,
#form1-toggle,
#form2-toggle,
#wallet-toggle,
#check-subscription-toggle,
#subscribe-month-toggle,
#subscribe-year-toggle,
#bin_mouth-toggle,
#bin_premium_mouth-toggle,
#bin_years-toggle,
#bin_premium_years-toggle,
#deposit-toggle,
#add_card-toggle,
#color_theme-toggle,
#chat-toggle {
    display: none;
}

.hamburger {
    position: fixed;
    top: 20px;
    left: 20px;
    width: 30px;
    height: 25px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    cursor: pointer;
    z-index: 1001;
}

.hamburger span {
    display: block;
    height: 4px;
    background: #333;
    border-radius: 2px;
    transition: 0.3s;
}

#menu-toggle:checked + .hamburger span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
}

#menu-toggle:checked + .hamburger span:nth-child(2) {
    opacity: 0;
}

#menu-toggle:checked + .hamburger span:nth-child(3) {
    transform: rotate(-45deg) translate(5px, -5px);
}

.side-menu {
    position: fixed;
    top: 0;
    left: -300px;
    width: 300px;
    height: 100%;
    background: #fff;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
    padding: 20px;
    box-sizing: border-box;
    transition: 0.3s;
    z-index: 1002;
}

#menu-toggle:checked ~ .side-menu {
    left: 0;
}

.overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    z-index: 1000;
}

#menu-toggle:checked ~ .overlay {
    display: block;
}

.content {
    padding: 50px;
}

.side-menu .avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 15px;
}

.side-menu .username-line {
    border-bottom: 1px solid #ccc;
    padding-bottom: 5px;
    margin-bottom: 10px;
}

.side-menu .profile-btn,
.side-menu .setting-btn {
    display: block;
    background: white;
    color: #333;
    text-align: center;
    padding: 10px;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    margin-top: 5px;
    border: 1px solid #ccc;
    transition: 0.2s;
}

.side-menu .profile-btn:hover,
.side-menu .setting-btn:hover {
    background: #e0e0e0;
}

.profile-form .info {
    display: flex;
    flex-direction: column;
    min-width: 0;
    max-width: 100%;
}

.profile-form .info h2 {
    font-size: 1.4rem;
    margin: 0;
    word-wrap: break-word;
    overflow-wrap: anywhere; 
    white-space: normal;
    text-align: left;
}

.form1 img.avatar,
.form2 img.avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 10px;
}

#profile-toggle:checked ~ .profile-form {
    display: flex;
}

#setting-toggle:checked ~ .setting-form {
    display: flex;
}

#form1-toggle:checked ~ .form1 {
    display: flex;
}

#form2-toggle:checked ~ .form2 {
    display: flex;
}

.profile-overlay,
.setting-overlay,
.form1-overlay,
.form2-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    z-index: 1500;
}

#profile-toggle:checked ~ .profile-overlay {
    display: block;
}

#setting-toggle:checked ~ .setting-overlay {
    display: block;
}

#form1-toggle:checked ~ .form1-overlay {
    display: block;
}

#form2-toggle:checked ~ .form2-overlay {
    display: block;
}

.profile-form button,
.setting-form button,
.form1 button,
.form2 button,
.setting-form .profile-btn {
    background: white;
    border: 1px solid #ccc;
    color: #333;
    padding: 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.2s;
}

.profile-form button:hover,
.setting-form button:hover,
.form1 button:hover,
.form2 button:hover,
.setting-form .profile-btn:hover {
    background: #e0e0e0;
}

.profile-header {
    display: flex;
    align-items: center;
    gap: 25px;
}

.profile-header img.avatar {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    object-fit: cover;
}

.profile-header .info {
    display: flex;
    flex-direction: column;
}

.profile-header .info h2 {
    margin: 0;
    font-size: 26px;
    color: #333;
}

.profile-header .info p {
    margin: 5px 0 0 0;
    color: #777;
    font-size: 15px;
}

.profile-divider {
    border: none;
    border-top: 1px solid #ddd;
    margin: 25px 0 15px 0;
}

.profile-body p {
    margin: 10px 0;
    color: #444;
    font-size: 15px;
}

.tag-copy {
    font-weight: bold;
    color: #007bff;
    cursor: pointer;
    margin-left: 5px;
}

.profile-body textarea {
    resize: none;
    font-family: Arial, sans-serif;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    width: 100%;
}

.btn-delete-avatar {
    background-color: #ff4d4d;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
    display: inline-block;
    width: fit-content;
    line-height: 1;
    transition: background-color 0.2s ease, transform 0.1s ease;
}

.btn-delete-avatar:hover {
    background-color: #e04343;
}

.btn-delete-avatar:active {
    transform: scale(0.96);
}

.other-profile-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 30px;
    border-radius: 10px;
    display: none;
    z-index: 2000;
    width: 400px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.other-profile-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    z-index: 1500;
    cursor: pointer;
}

#other-profile-toggle:checked ~ .other-profile-form {
    display: flex;
}

#other-profile-toggle:checked ~ .other-profile-overlay {
    display: block;
}

.other-profile-overlay {
    cursor: pointer;
}

#other-profile-toggle {
    display: none;
}

.language-form {
  margin: 10px 0 20px 0;
}

.language-form select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.color_theme button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.color_theme button:hover {
  background: #008080cc;
}

.color_theme {
  margin: 10px 0 20px 0;
}

.color_theme select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.color_theme button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.color_theme button:hover {
  background: #008080cc;
}

.color_theme {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.color_theme-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
}

.color_theme-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    width: 520px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.color_theme.active {
    display: flex;
}
.color_theme-overlay.active {
    display: block;
}

#color_theme-toggle:checked ~ .color_theme-form,
#color_theme-toggle:checked ~ .color_theme {
    display: flex;
}
#color_theme-toggle:checked ~ .color_theme-overlay {
    display: block;
}

.wallet button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.wallet button:hover {
  background: #008080cc;
}

.wallet {
  margin: 10px 0 20px 0;
}

.wallet select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.wallet button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.wallet button:hover {
  background: #008080cc;
}

.wallet {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.wallet-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1500;
}

.wallet-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 300px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.wallet.active {
    display: flex;
}
.wallet-overlay.active {
    display: block;
}

#wallet-toggle:checked ~ .wallet-form,
#wallet-toggle:checked ~ .wallet {
    display: flex;
}
#wallet-toggle:checked ~ .wallet-overlay {
    display: block;
}

.add_card button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.add_card button:hover {
  background: #008080cc;
}

.add_card {
  margin: 10px 0 20px 0;
}

.add_card select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.add_card button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.add_card button:hover {
  background: #008080cc;
}

.add_card {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.add_card-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1500;
}

.add_card-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 300px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.add_card.active {
    display: flex;
}
.add_card-overlay.active {
    display: block;
}

#add_card-toggle:checked ~ .add_card-form,
#add_card-toggle:checked ~ .add_card {
    display: flex;
}
#add_card-toggle:checked ~ .add_card-overlay {
    display: block;
}

.deposit button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.deposit button:hover {
  background: #008080cc;
}

.deposit {
  margin: 10px 0 20px 0;
}

.deposit select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.deposit button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.deposit button:hover {
  background: #008080cc;
}

.deposit {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.deposit-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1500;
}

.deposit-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 300px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.deposit-btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid #007bff;
    background-color: #007bff;
    color: white;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: 0.2s;
}

.deposit-btn:hover {
    background-color: #0056b3;
    border-color: #0056b3;
}

.deposit.active {
    display: flex;
}
.deposit-overlay.active {
    display: block;
}

#deposit-toggle:checked ~ .deposit-form,
#deposit-toggle:checked ~ .deposit {
    display: flex;
}
#deposit-toggle:checked ~ .deposit-overlay {
    display: block;
}

.check-subscription button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.check-subscription button:hover {
  background: #008080cc;
}

.check-subscription {
  margin: 10px 0 20px 0;
}

.check-subscription select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.check-subscription button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.check-subscription button:hover {
  background: #008080cc;
}

.check-subscription {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.check-subscription-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1500;
}

.check-subscription-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 300px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.check-subscription-btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid #007bff;
    background-color: #007bff;
    color: white;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: 0.2s;
}

.check-subscription-btn:hover {
    background-color: #0056b3;
    border-color: #0056b3;
}

.check-subscription.active {
    display: flex;
}
.check-subscription-overlay.active {
    display: block;
}

#check-subscription-toggle:checked ~ .check-subscription-form,
#check-subscription-toggle:checked ~ .check-subscription {
    display: flex;
}
#check-subscription-toggle:checked ~ .check-subscription-overlay {
    display: block;
}

.subscribe-btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid #007bff;
    background-color: #007bff;
    color: white;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: 0.2s;
}

.subscribe-btn:hover {
    background-color: #0056b3;
    border-color: #0056b3;
}

.subscribe-form-month button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.subscribe-form-month button:hover {
  background: #008080cc;
}

.subscribe-form-month {
  margin: 10px 0 20px 0;
}

.subscribe-form-month select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.subscribe-form-month button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.subscribe-form-month button:hover {
  background: #008080cc;
}

.subscribe-form-month {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.subscribe-month-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1500;
}

.subscribe-form-month.active {
    display: flex;
}
.subscribe-month-overlay.active {
    display: block;
}

#subscribe-month-toggle:checked ~ .subscribe-form-month {
    display: flex;
}

#subscribe-month-toggle:checked ~ .subscribe-month-overlay {
    display: block;
}

.subscribe-form-year button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.subscribe-form-year button:hover {
  background: #008080cc;
}

.subscribe-form-year {
  margin: 10px 0 20px 0;
}

.subscribe-form-year select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.subscribe-form-year button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.subscribe-form-year button:hover {
  background: #008080cc;
}

.subscribe-form-year {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.subscribe-year-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1500;
}

.subscribe-form-year.active {
    display: flex;
}
.subscribe-year-overlay.active {
    display: block;
}

#subscribe-year-toggle:checked ~ .subscribe-form-year {
    display: flex;
}

#subscribe-year-toggle:checked ~ .subscribe-year-overlay {
    display: block;
}

.subscribe-btn {
    position: relative;
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid #007bff;
    background-color: #007bff;
    color: white;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: 0.2s;
}

.subscribe-btn:hover {
    background-color: #0056b3;
    border-color: #0056b3;
}

.year-btn .discount {
    position: absolute;
    top: -11px;  
    right: -10px;
    background-color: red;
    color: white;
    font-size: 12px;
    font-weight: 600;
    padding: 2px 5px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.bin_mouth button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.bin_mouth button:hover {
  background: #008080cc;
}

.bin_mouth {
  margin: 10px 0 20px 0;
}

.bin_mouth select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.bin_mouth button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.bin_mouth button:hover {
  background: #008080cc;
}

.bin_mouth {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.bin_mouth-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1500;
}

.bin_mouth-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 350px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.bin_mouth.active {
    display: flex;
}
.bin_mouth-overlay.active {
    display: block;
}

#bin_mouth-toggle:checked ~ .bin_mouth-form,
#bin_mouth-toggle:checked ~ .bin_mouth {
    display: flex;
}
#bin_mouth-toggle:checked ~ .bin_mouth-overlay {
    display: block;
}

.bin_premium_mouth button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.bin_premium_mouth button:hover {
  background: #008080cc;
}

.bin_premium_mouth {
  margin: 10px 0 20px 0;
}

.bin_premium_mouth select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.bin_premium_mouth button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.bin_premium_mouth button:hover {
  background: #008080cc;
}

.bin_premium_mouth {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.bin_premium_mouth-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1500;
}

.bin_premium_mouth-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 450px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.bin_premium_mouth.active {
    display: flex;
}
.bin_premium_mouth-overlay.active {
    display: block;
}

#bin_premium_mouth-toggle:checked ~ .bin_premium_mouth-form,
#bin_premium_mouth-toggle:checked ~ .bin_premium_mouth {
    display: flex;
}
#bin_premium_mouth-toggle:checked ~ .bin_premium_mouth-overlay {
    display: block;
}

.bin_years button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.bin_years button:hover {
  background: #008080cc;
}

.bin_years {
  margin: 10px 0 20px 0;
}

.bin_years select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.bin_years button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.bin_years button:hover {
  background: #008080cc;
}

.bin_years {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.bin_years-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1500;
}

.bin_years-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 430px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.bin_years.active {
    display: flex;
}
.bin_years-overlay.active {
    display: block;
}

#bin_years-toggle:checked ~ .bin_years-form,
#bin_years-toggle:checked ~ .bin_years {
    display: flex;
}
#bin_years-toggle:checked ~ .bin_years-overlay {
    display: block;
}

.bin_premium_years button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.bin_premium_years button:hover {
  background: #008080cc;
}

.bin_premium_years {
  margin: 10px 0 20px 0;
}

.bin_premium_years select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #aaa;
  cursor: pointer;
}

.bin_premium_years button {
  padding: 8px 12px;
  margin-left: 8px;
  border-radius: 8px;
  border: 1px solid #aaa;
  background: teal;
  color: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.bin_premium_years button:hover {
  background: #008080cc;
}

.bin_premium_years {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 700px;
    max-width: 90%;
    min-height: 400px;
    flex-direction: column;
    gap: 20px;
}

.bin_premium_years-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1500;
}

.bin_premium_years-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 520px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.bin_premium_years.active {
    display: flex;
}
.bin_premium_years-overlay.active {
    display: block;
}

#bin_premium_years-toggle:checked ~ .bin_premium_years-form,
#bin_premium_years-toggle:checked ~ .bin_premium_years {
    display: flex;
}
#bin_premium_years-toggle:checked ~ .bin_premium_years-overlay {
    display: block;
}

.Subscribe-switching-button {
    margin-top: 15px;
    padding: 10px 25px;
    font-size: 16px;
    font-weight: bold;
    color: white;
    background-color: #007bff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
    position: relative;
}

.Subscribe-switching-button:hover:enabled {
    background-color: #0056b3;
    transform: scale(1.05);
}

.Subscribe-switching-button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

.Subscribe-switching-button .discount {
    position: absolute;
    top: -9px;
    right: -18px;
    background-color: red;
    color: white;
    font-size: 12px;
    padding: 2px 5px;
    border-radius: 4px;
}

.subscribe-btn {
    margin-top: 15px;
    padding: 10px 25px;
    font-size: 16px;
    font-weight: bold;
    color: white;
    background-color: #007bff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
    
    width: 100%;
    box-sizing: border-box;
}

.subscribe-btn:hover:enabled {
    background-color: #0056b3;
    transform: scale(1.05);
}

.subscribe-btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

.pricing {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 1.2rem;
}

.old-price {
    color: #999;
    text-decoration: line-through;
    font-size: 1rem;
}

.new-price {
    color: #ff0000;
    font-weight: bold;
    font-size: 1.3rem;
}

.check-subscription-btn {
    padding: 12px 25px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    background-color: #1900ff;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
}

.check-subscription-btn:hover {
    background-color: #1200b1;
    transform: scale(1.05);
}

.btn-refund {
    background-color: #ff0000;
    color: white;             
    border: none;
    padding: 10px 25px;        
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;      
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
}

.btn-refund:hover {
    background-color: #cc0000;  
    transform: scale(1.05);      
}

.plan {
  border-radius: 16px;
  box-shadow: 0 30px 30px -25px rgba(0, 38, 255, 0.205);
  padding: 10px;
  background-color: #fff;
  color: #697e91;
  max-width: 300px;
}

.plan strong {
  font-weight: 600;
  color: #425275;
}

.plan .inner {
  align-items: center;
  padding: 20px;
  padding-top: 40px;
  background-color: #ecf0ff;
  border-radius: 12px;
  position: relative;
}

.plan .pricing {
  position: absolute;
  top: 0;
  right: 0;
  background-color: #bed6fb;
  border-radius: 99em 0 0 99em;
  display: flex;
  align-items: center;
  padding: 0.625em 0.75em;
  font-size: 1.25rem;
  font-weight: 600;
  color: #425475;
}

.plan .pricing small {
  color: #707a91;
  font-size: 0.75em;
  margin-left: 0.25em;
}

.plan .title {
  font-weight: 600;
  font-size: 1.25rem;
  color: #425675;
}

.plan .title + * {
  margin-top: 0.75rem;
}

.plan .info + * {
  margin-top: 1rem;
}

.plan .features {
  display: flex;
  flex-direction: column;
}

.plan .features li {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.plan .features li + * {
  margin-top: 0.75rem;
}

.plan .features .icon {
  background-color: #1FCAC5;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  border-radius: 50%;
  width: 20px;
  height: 20px;
}

.plan .features .icon svg {
  width: 14px;
  height: 14px;
}

.plan .features + * {
  margin-top: 1.25rem;
}

.plan .action {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: end;
}

.plan .button {
  background-color: #6558d3;
  border-radius: 6px;
  color: #fff;
  font-weight: 500;
  font-size: 1.125rem;
  text-align: center;
  border: 0;
  outline: 0;
  width: 100%;
  padding: 0.625em 0.75em;
  text-decoration: none;
}

.plan .button:hover, .plan .button:focus {
  background-color: #4133B7;
}

.edit-profile-container {
    display: flex;
    gap: 30px;
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.form1 {
    flex: 1;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 900px;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-sizing: border-box;
}

#form1-toggle:checked ~ .form1 {
    display: block;
}

.form1-inner {
    display: flex;
    gap: 30px;
}

.form1-fields {
    flex: 1;
    min-width: 350px;
}

.form1-preview {
    flex: 0 0 350px;
    position: sticky;
    top: 20px;
    height: fit-content;
}

.profile-preview-card {
    position: relative;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    background-color: transparent;
    overflow: hidden;
}

.profile-preview-background {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: -1;
    opacity: 1; 
    transition: background-image 0.3s ease;
}

.profile-preview-card * {
    position: relative;
    z-index: 1;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.btn-delete-background {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
    margin-top: 10px;
}

.btn-delete-background:hover {
    background: #c82333;
}

.btn-delete-background:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

#backgroundInput:disabled + label {
    background: #6c757d !important;
    cursor: not-allowed;
    opacity: 0.6;
}

.profile-preview-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.profile-preview-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #007bff;
}

.profile-preview-info h3 {
    margin: 0 0 5px 0;
    font-size: 22px;
    color: #333;
    word-wrap: break-word;
}

.profile-preview-status {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
}

.profile-preview-tag {
    font-size: 13px;
    color: #007bff;
    font-weight: 600;
    background: #e3f2fd;
    padding: 4px 10px;
    border-radius: 12px;
    display: inline-block;
}

.profile-preview-divider {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 20px 0;
}

.profile-preview-section {
    margin-bottom: 15px;
}

.profile-preview-label {
    font-weight: 600;
    color: #555;
    font-size: 13px;
    text-transform: uppercase;
    margin-bottom: 5px;
}

.profile-preview-value {
    color: #333;
    font-size: 15px;
    line-height: 1.5;
    word-wrap: break-word;
}

.profile-preview-birthday {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #333;
    font-size: 15px;
}

.preview-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #007bff;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

@media (max-width: 900px) {
    .form1 {
        width: 95%;
    }
    
    .form1-inner {
        flex-direction: column;
    }
    
    .form1-preview {
        position: relative;
        top: 0;
        flex: 1;
    }
}

.form1-fields input[type="text"],
.form1-fields textarea,
.form1-fields select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.form1-fields input[type="text"]:focus,
.form1-fields textarea:focus,
.form1-fields select:focus {
    outline: none;
    border-color: #007bff;
}

.form1-fields label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #555;
}

.form-group {
    margin-bottom: 20px;
}

.avatar-upload-section {
    text-align: center;
    margin-bottom: 25px;
}

.avatar-upload-section img.avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 15px;
    border: 3px solid #e0e0e0;
}

.birthday-selects {
    display: flex;
    gap: 10px;
}

.birthday-selects select {
    flex: 1;
}

.form1-fields button[type="submit"] {
    width: 100%;
    padding: 12px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.form1-fields button[type="submit"]:hover {
    background: #0056b3;
}

.btn-delete-avatar {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
    margin-top: 10px;
}

.btn-delete-avatar:hover {
    background: #c82333;
}

.chat-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: none;
}

#chat-toggle:checked ~ .chat-overlay {
    display: block;
}

.chat-container {
    position: fixed;
    top: 0;
    left: 300px;
    right: 0;
    bottom: 0;
    width: calc(100% - 300px);
    height: 100vh;
    border: none;
    border-radius: 0;
    display: none;
    flex-direction: column;
    box-shadow: none;
    z-index: 2000;
    background: inherit !important;
    color: inherit !important;
    transition: none !important;
}

#chat-toggle:checked ~ .chat-container {
    display: flex !important;
}

.chat-overlay {
    display: none !important;
}

.close-chat {
    display: none !important;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    background: white;
    flex-shrink: 0;
    z-index: 2001;
    cursor: pointer !important;
}

.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f9f9f9;
    display: flex;
    flex-direction: column;
    padding-bottom: 0;
    z-index: 2000;
}

.chat-input-container {
    display: flex;
    padding: 20px;
    gap: 10px;
    background: white;
    border-top: 1px solid #eee;
    margin-top: auto;
    z-index: 2001;
}

.message {
    margin-bottom: 10px;
    padding: 12px;
    border-radius: 8px;
    max-width: 70%;
    word-wrap: break-word;
    margin-left: 0;
    margin-right: 0;
}

.message.sent {
    background: #d5ffa5;
    color: rgb(0, 0, 0);
    margin-left: auto;
    text-align: left; 
}

.message.received {
    background: #e9ecef;
    color: black;
    margin-right: auto;
    text-align: left;
}

.message-sender {
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 4px;
    opacity: 0.8;
}

.message.sent .message-sender {
    color: rgba(255,255,255,0.8);
    text-align: right;
}

.message.received .message-sender {
    color: #666;
    text-align: left;
}

.chat-messages {
    background: #f9f9f9 !important;
}

.chat-container .message.received {
    background: #e9ecef !important;
    color: black !important;
}

.chat-container .message.sent {
    background: #000000 !important;
    color: rgb(0, 0, 0) !important;
}

.chat-header {
    background: white !important;
}

.chat-input-container {
    background: white !important;
    border-top: 1px solid #eee !important;
}

.chat-input {
    background: white !important;
    color: #000000 !important;
    border: 1px solid #ddd !important;
}

.chat-input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
}

.chat-send-btn {
    padding: 12px 24px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    white-space: nowrap;
}

.chat-send-btn:hover {
    background: #0056b3;
}

.chat-header h3 {
    margin: 0;
    font-size: 18px;
}

.close-chat {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
}

.close-chat:hover {
    color: #000;
    background: #f0f0f0;
    border-radius: 50%;
}

.chat-messages-spacer {
    height: 20px;
    flex-shrink: 0;
}

@media (max-width: 768px) {
    .chat-container {
        left: 0;
        width: 100%;
    }
    
    #menu-toggle:checked ~ .chat-container {
        left: 300px;
        width: calc(100% - 300px);
    }
    
    .message {
        max-width: 85%;
    }
}

.attach-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 50%;
    transition: all 0.2s ease;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
}

.attach-btn:hover {
    background-color: #f0f0f0;
    color: #007bff;
    transform: scale(1.1);
}

.attach-btn:active {
    transform: scale(0.95);
}

.chat-input-container {
    display: flex;
    padding: 15px;
    gap: 10px;
    background: white;
    border-top: 1px solid #eee;
    margin-top: auto;
    z-index: 2001;
    align-items: center;
}

.chat-input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
}

.chat-send-btn {
    padding: 12px 24px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    white-space: nowrap;
    transition: background 0.2s;
}

.chat-send-btn:hover {
    background: #0056b3;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

body.chat-open-light .chat-container,
body.chat-open-light .chat-container * {
    background: linear-gradient(to right, #ffffff, #e0e0e0) !important;
    color: #000000 !important;
}


.theme-light .chat-container,
.theme-light .chat-header,
.theme-light .chat-input-container {
    background: linear-gradient(to right, #ffffff, #e0e0e0) !important;
    color: #000000 !important;
}

.theme-light .chat-messages {
    background: #f9f9f9 !important;
}

.theme-light .message.sent {
    background: #d5ffa5 !important;
    color: #ff0000 !important;
}

.theme-light .message.received {
    background: #e9ecef !important;
    color: #000000 !important;
}

.theme-dark .chat-container,
.theme-dark .chat-header,
.theme-dark .chat-input-container {
    background: linear-gradient(to right, #2c2c2c, #1a1a1a) !important;
    color: #ffffff !important;
}

.theme-dark .chat-messages {
    background: #1a1a1a !important;
}

.theme-dark .message.sent {
    background: #007bff !important;
    color: #ffffff !important;
}

.theme-dark .message.received {
    background: #3a3a3a !important;
    color: #ffffff !important;
}

#chat-toggle:checked ~ .chat-container .message.received {
    background: #e9ecef !important;
    color: black !important;
}

#chat-toggle:checked ~ .chat-container .message.sent {
    background: #d5ffa5 !important;
    color: rgb(0, 0, 0) !important;
}

.message-mention {
    color: #007bff;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s ease;
    padding: 1px 3px;
    border-radius: 3px;
}

.message-mention:hover {
    color: #0056b3;
}

.profile-link {
    color: #007bff;
    cursor: pointer;
    transition: color 0.2s ease;
    font-weight: 500;
}

.profile-link:hover {
    color: #0056b3;
}

.theme-light .chat-container {
    background: linear-gradient(to right, #ffffff, #e0e0e0);
    color: #000000;
}

.theme-light .chat-messages {
    background: #f9f9f9;
}

.theme-light .message.received {
    background: #e9ecef;
    color: black;
}

.theme-light .message.sent {
    background: #d5ffa5;
    color: rgb(0, 0, 0);
}

.theme-dark .chat-container {
    background: linear-gradient(to right, #2c2c2c, #1a1a1a);
    color: #ffffff;
}

.theme-dark .chat-messages {
    background: #1a1a1a;
}

.theme-dark .message.received {
    background: #3a3a3a;
    color: white;
}

.theme-dark .message.sent {
    background: #007bff;
    color: white;
}

.theme-pink .chat-container {
    background: linear-gradient(to right, #ffb6c1, #b30086);
    color: #000000;
}

.theme-pink .chat-messages {
    background: #ffe6eb;
}

.theme-pink .message.received {
    background: #ffd1dc;
    color: #000000;
}

.theme-pink .message.sent {
    background: #b30086;
    color: white;
}

.theme-green .chat-container {
    background: linear-gradient(to right, #a8e6a2, #2e7d32);
    color: #ffffff;
}

.theme-green .chat-messages {
    background: #c8e6c9;
}

.theme-green .message.received {
    background: #a5d6a7;
    color: #000000;
}

.theme-green .message.sent {
    background: #2e7d32;
    color: white;
}

.user-search-result {
    cursor: pointer;
    transition: background 0.2s;
}

.user-search-result:hover {
    background: #f8f9fa !important;
    border-color: #007bff !important;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#chat-toggle:checked ~ .chat-container {
    display: flex;
}

#chat-toggle:checked ~ .chat-overlay {
    display: block;
}

.recent-contact {
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    background: white;
    transition: all 0.2s ease;
}

.recent-contact:hover {
    background: #f8f9fa !important;
    border-color: #007bff !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.recent-contact.unread {
    border-left: 4px solid #007bff;
    background: #f0f8ff;
}

.contact-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.contact-last-message {
    color: #666;
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 180px;
}

.contact-info {
    flex: 1;
    min-width: 0;
}

.contact-username {
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.contact-last-message {
    color: #666;
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.contact-time {
    color: #999;
    font-size: 11px;
    text-align: right;
}

.unread-badge {
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 8px;
}

.security-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 500px;
    max-width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.security-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    z-index: 1500;
}

#security-toggle:checked ~ .security-form {
    display: flex;
}

#security-toggle:checked ~ .security-overlay {
    display: block;
}

.security-section {
    border-bottom: 1px solid #eee;
    padding-bottom: 20px;
    margin-bottom: 20px;
}

.security-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.security-section h3 {
    margin-bottom: 15px;
    color: #333;
    font-size: 18px;
}

.security-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

.security-btn:hover {
    background: #0056b3;
}

.enable-btn {
    background: #28a745;
}

.enable-btn:hover {
    background: #218838;
}

.disable-btn {
    background: #dc3545;
}

.disable-btn:hover {
    background: #c82333;
}

.terminate-btn {
    background: #ffc107;
    color: #212529;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.terminate-btn:hover {
    background: #e0a800;
}

.session-item, .login-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 6px;
    margin-bottom: 8px;
    background: #f8f9fa;
}

.session-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.session-info span {
    font-size: 12px;
    color: #666;
}

.current-session {
    color: #28a745;
    font-weight: bold;
    font-size: 12px;
}

.status.success {
    color: #28a745;
    font-weight: bold;
}

.status.failed {
    color: #dc3545;
    font-weight: bold;
}

.sessions-list, .login-history {
    max-height: 200px;
    overflow-y: auto;
}

.theme-light .security-form {
    background: linear-gradient(to right, #ffffff, #e0e0e0);
    color: #000000;
}

.theme-dark .security-form {
    background: linear-gradient(to right, #2c2c2c, #1a1a1a);
    color: #ffffff;
}

.theme-pink .security-form {
    background: linear-gradient(to right, #ffb6c1, #b30086);
    color: #000000;
}

.theme-green .security-form {
    background: linear-gradient(to right, #a8e6a2, #2e7d32);
    color: #ffffff;
}

.theme-light .security-form input {
    background: rgba(255, 255, 255, 0.8);
    color: #000000;
    border: 1px solid #999999;
}

.theme-dark .security-form input {
    background: rgba(0, 0, 0, 0.5);
    color: #ffffff;
    border: 1px solid #555555;
}

.theme-pink .security-form input {
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    border: 1px solid #000000;
}

.theme-green .security-form input {
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    border: 1px solid #2e7d32;
}

.password-section {
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
    overflow: hidden;
    max-height: 50px;
    transition: all 0.4s ease-in-out;
    min-height: 50px;
}

.password-section.expanded {
    max-height: 600px;
    padding-bottom: 25px;
    min-height: 380px;
}

.password-form {
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease 0.1s;
    height: 0;
    overflow: hidden;
    display: none;
    min-height: 280px;
}

.password-section.expanded .password-form {
    opacity: 1;
    transform: translateY(0);
    height: auto;
    margin-top: 15px;
    display: block;
    min-height: 280px;
}

.password-toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 10px 0;
    user-select: none;
    min-height: 40px;
}

.password-toggle h4 {
    margin: 0;
    font-size: 16px;
    color: #333;
    line-height: 1.4;
}

.password-toggle-arrow {
    transition: transform 0.3s ease;
    font-size: 18px;
    color: #666;
    min-width: 20px;
}

.password-section.expanded .password-toggle-arrow {
    transform: rotate(180deg);
}

.password-form .form-group {
    margin-bottom: 20px;
    min-height: 70px;
}

.password-form label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #555;
    font-size: 14px;
}

.password-form input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 15px;
    transition: border-color 0.2s;
    box-sizing: border-box;
    min-height: 44px;
}

.password-form input:focus {
    outline: none;
    border-color: #007bff;
}

.security-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 14px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.2s;
    width: 100%;
    min-height: 50px;
    margin-top: 10px;
}

.security-btn:hover {
    background: #0056b3;
}

.password-form-content {
    min-height: 300px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.theme-light .password-toggle h4 { color: #000000; }
.theme-light .password-toggle-arrow { color: #000000; }
.theme-light .password-form input { 
    background: rgba(255, 255, 255, 0.8);
    color: #000000;
    border: 1px solid #999999;
}

.theme-dark .password-toggle h4 { color: #ffffff; }
.theme-dark .password-toggle-arrow { color: #ffffff; }
.theme-dark .password-form input { 
    background: rgba(0, 0, 0, 0.5);
    color: #ffffff;
    border: 1px solid #555555;
}

.theme-pink .password-toggle h4 { color: #000000; }
.theme-pink .password-toggle-arrow { color: #000000; }
.theme-pink .password-form input { 
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    border: 1px solid #000000;
}

.theme-green .password-toggle h4 { color: #ffffff; }
.theme-green .password-toggle-arrow { color: #ffffff; }
.theme-green .password-form input { 
    background: rgba(255, 255, 255, 0.2);
    color: #000000;
    border: 1px solid #2e7d32;
}

.other-profile-form .message-mention,
.other-profile-form .profile-mention {
    color: #007bff;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s ease;
    padding: 1px 3px;
    border-radius: 3px;
}

.other-profile-form .message-mention:hover,
.other-profile-form .profile-mention:hover {
    color: #0056b3;
}

body.modal-open .chat-container {
    opacity: 0.7;
    filter: brightness(0.8);
    transition: opacity 0.3s ease, filter 0.3s ease;
}

.file-preview {
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.message img {
    max-width: 250px;
    max-height: 250px;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s;
}

.message img:hover {
    transform: scale(1.02);
}

.file-attachment {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    margin: 5px 0;
}

.file-attachment a {
    color: #007bff;
    text-decoration: none;
}

.file-attachment a:hover {
    text-decoration: underline;
}

.attach-btn {
    transition: all 0.2s;
}

.attach-btn:hover {
    color: #007bff;
    transform: scale(1.1);
}

.attach-btn:active {
    transform: scale(0.95);
}

.bin-login-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 2000;
    width: 400px;
    max-width: 90%;
    box-sizing: border-box;
    flex-direction: column;
    gap: 20px;
}

.bin-login-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    z-index: 1500;
}

#bin-login-toggle:checked ~ .bin-login-form {
    display: flex;
}

#bin-login-toggle:checked ~ .bin-login-overlay {
    display: block;
}

.theme-light .bin-login-form {
    background: linear-gradient(to right, #ffffff, #e0e0e0);
    color: #000000;
}

.theme-dark .bin-login-form {
    background: linear-gradient(to right, #2c2c2c, #1a1a1a);
    color: #ffffff;
}

.theme-pink .bin-login-form {
    background: linear-gradient(to right, #ffb6c1, #b30086);
    color: #000000;
}

.theme-green .bin-login-form {
    background: linear-gradient(to right, #a8e6a2, #2e7d32);
    color: #ffffff;
}

.bin-login-form input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 15px;
    box-sizing: border-box;
}

.theme-light .bin-login-form input {
    background: rgba(255, 255, 255, 0.8);
    color: #000000;
    border: 1px solid #999999;
}

.theme-dark .bin-login-form input {
    background: rgba(0, 0, 0, 0.5);
    color: #ffffff;
    border: 1px solid #555555;
}

.bin-login-form button {
    padding: 12px 24px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    width: 100%;
    transition: background 0.2s;
}

.bin-login-form button:hover {
    background: #0056b3;
}

.bin-login-form .error-message {
    color: #dc3545;
    font-size: 14px;
    margin-top: 5px;
    display: none;
}

.bin-login-form .success-message {
    color: #28a745;
    font-size: 14px;
    margin-top: 5px;
    display: none;
}

.bin-chat {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bin-chat .message.received {
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    border: 1px solid #764ba2;
}

.bin-chat .message.sent {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    color: white;
}

.message-mention.bin-mention {
    color: #007bff !important;
    background-color: #e6f7ff !important;
    border: 1px solid #b3e0ff !important;
    border-radius: 12px !important;
    padding: 2px 8px !important;
    font-weight: bold !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
}

.message-mention.bin-mention:hover {
    background-color: #cceeff !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2) !important;
}

#chat-toggle:checked ~ .profile-form,
#chat-toggle:checked ~ .setting-form,
#chat-toggle:checked ~ .form1,
#chat-toggle:checked ~ .form2,
#chat-toggle:checked ~ .wallet-form,
#chat-toggle:checked ~ .other-profile-form,
#chat-toggle:checked ~ .security-form,
#chat-toggle:checked ~ .color_theme-form,
#chat-toggle:checked ~ .deposit-form,
#chat-toggle:checked ~ .add_card-form,
#chat-toggle:checked ~ .subscribe-form-month,
#chat-toggle:checked ~ .subscribe-form-year,
#chat-toggle:checked ~ .bin_mouth-form,
#chat-toggle:checked ~ .bin_premium_mouth-form,
#chat-toggle:checked ~ .bin_years-form,
#chat-toggle:checked ~ .bin_premium_years-form,
#chat-toggle:checked ~ .check-subscription-form {
    pointer-events: auto;
    z-index: 2001;
}

.profile-form,
.setting-form,
.form1,
.form2,
.wallet-form,
.other-profile-form,
.security-form,
.color_theme-form,
.deposit-form,
.add_card-form,
.subscribe-form-month,
.subscribe-form-year,
.bin_mouth-form,
.bin_premium_mouth-form,
.bin_years-form,
.bin_premium_years-form,
.check-subscription-form {
    z-index: 2001;
}

#chat-toggle:checked ~ .profile-overlay,
#chat-toggle:checked ~ .other-profile-overlay,
#chat-toggle:checked ~ .setting-overlay,
#chat-toggle:checked ~ .form1-overlay,
#chat-toggle:checked ~ .form2-overlay,
#chat-toggle:checked ~ .color_theme-overlay,
#chat-toggle:checked ~ .wallet-overlay,
#chat-toggle:checked ~ .check-subscription-overlay,
#chat-toggle:checked ~ .subscribe-month-overlay,
#chat-toggle:checked ~ .subscribe-year-overlay,
#chat-toggle:checked ~ .deposit-overlay,
#chat-toggle:checked ~ .add_card-overlay,
#chat-toggle:checked ~ .bin_mouth-overlay,
#chat-toggle:checked ~ .bin_premium_mouth-overlay,
#chat-toggle:checked ~ .bin_years-overlay,
#chat-toggle:checked ~ .bin_premium_years-overlay,
#chat-toggle:checked ~ .security-overlay {
    z-index: 2000;
}

#menu-toggle,
#profile-toggle,
#other-profile-toggle,
#setting-toggle,
#form1-toggle,
#form2-toggle,
#color_theme-toggle,
#wallet-toggle,
#check-subscription-toggle,
#subscribe-month-toggle,
#subscribe-year-toggle,
#bin_mouth-toggle,
#bin_premium_mouth-toggle,
#bin_years-toggle,
#bin_premium_years-toggle,
#deposit-toggle,
#add_card-toggle,
#security-toggle,
#chat-toggle {
    display: none;
}
</style>
{% endblock %}

{% block body %}
<input type="checkbox" id="menu-toggle">
<input type="checkbox" id="profile-toggle">
<input type="checkbox" id="other-profile-toggle">
<input type="checkbox" id="setting-toggle">
<input type="checkbox" id="form1-toggle">
<input type="checkbox" id="form2-toggle">
<input type="checkbox" id="color_theme-toggle">
<input type="checkbox" id="wallet-toggle">
<input type="checkbox" id="check-subscription-toggle">
<input type="checkbox" id="subscribe-month-toggle">
<input type="checkbox" id="subscribe-year-toggle">
<input type="checkbox" id="deposit-toggle">
<input type="checkbox" id="add_card-toggle">
<input type="checkbox" id="bin_mouth-toggle">
<input type="checkbox" id="bin_premium_mouth-toggle">
<input type="checkbox" id="bin_years-toggle">
<input type="checkbox" id="bin_premium_years-toggle">
<input type="checkbox" id="security-toggle">
<input type="checkbox" id="chat-toggle">
<input type="checkbox" id="security-toggle">

<div class="profile-overlay"></div>
<div class="other-profile-overlay"></div>
<div class="setting-overlay"></div>
<div class="form1-overlay"></div>
<div class="form2-overlay"></div>
<div class="color_theme-overlay"></div>
<div class="wallet-overlay"></div>
<div class="check-subscription-overlay"></div>
<div class="subscribe-month-overlay"></div>
<div class="subscribe-year-overlay"></div>
<div class="deposit-overlay"></div>
<div class="add_card-overlay"></div>
<div class="bin_mouth-overlay"></div>
<div class="bin_premium_mouth-overlay"></div>
<div class="bin_years-overlay"></div>
<div class="security-overlay"></div>
<div class="bin_premium_years-overlay"></div>
<div class="chat-overlay"></div>
<div class="security-overlay"></div>
<!-- <div class="chat-overlay"></div> -->
{% with lang=lang %}
    {% if lang == "English"|default:"English" %}

    {% if messages %}
        <div style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            {% for message in messages %}
                <div style="background: {% if message.tags == 'error' %}#f44336{% else %}#4CAF50{% endif %}; color: white; padding: 15px 20px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); animation: slideIn 0.3s;">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
        <style>
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        </style>
        <script>
            setTimeout(() => {
                document.querySelectorAll('[style*="slideIn"]').forEach(el => {
                    el.style.animation = 'slideOut 0.3s';
                    setTimeout(() => el.remove(), 300);
                });
            }, 5000);
        </script>
    {% endif %}

        <label class="hamburger" for="menu-toggle"><span></span><span></span><span></span></label>
        <label for="menu-toggle" class="overlay"></label>

        <div class="side-menu">
            <img class="avatar" src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'pictures/login.png' %}{% endif %}" alt="Avatar">
            <div class="username">{{ user.username }}</div>
            {% if user.subscribe == "Bin+" %}
                <div style="color:#0056b3" class="username-line">{{ user.subscribe }}</div>
            {% elif user.subscribe == "Bin_premium" %}
                <div style="color:#b3009b" class="username-line">{{ user.subscribe }}</div>
            {% endif %}
            <label for="profile-toggle" class="profile-btn">My profile</label>
            <label for="wallet-toggle" class="profile-btn">Wallet</label>
            <label for="setting-toggle" class="profile-btn">Setting</label>
        </div>

        <div class="profile-form">
            <div class="profile-preview-card">
                <div class="profile-preview-background" id="main-profile-background"
                     style="{% if user.background and user.background.url %}background-image: url('{{ user.background.url }}'); display: block;{% else %}display: none;{% endif %}"></div>
                
                <div class="profile-preview-header">
                    <img class="profile-preview-avatar avatar" 
                         src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'pictures/login.png' %}{% endif %}" 
                         alt="Avatar">
                    <div class="profile-preview-info">
                        <h3 class="username-text">{{ user.username }}</h3>
                        <div class="profile-preview-status">
                            <span class="status-value {% if user.status == 'Online' %}online{% else %}offline{% endif %}">
                                ● {{ user.status|default:"Offline" }}
                            </span>
                        </div>
                        <div class="profile-preview-tag tag-copy" id="user-tag">{{ user.your_tag }}</div>
                        <br>
                        <label for="form1-toggle" class="edit-icon">Edit profile</label>
                    </div>
                </div>      

                <hr class="profile-preview-divider">        

                <div class="profile-preview-section">
                    <div class="profile-preview-label">Description</div>
                    <div class="profile-preview-value" id="my-profile-description">
                        {{ user.description }}
                    </div>
                </div>      

                <div class="profile-preview-section">
                    <div class="profile-preview-label">Birthday</div>
                    <div class="profile-preview-birthday">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span class="birthday-value">{{ user.birthday|default:"Not specified" }}</span>
                    </div>
                </div>

                <div class="user-info">
                    {% if role == 'Administrator' %}
                        <span class="badge bg-danger">👑 Administrator</span>
                    {% elif role == 'Moderator' %}
                        <span class="badge bg-warning">🛡️ Moderator</span>
                    {% endif %}
                </div>
            </div>
        </div>  

        <div class="other-profile-form">
            <div class="profile-preview-card">
                <div class="profile-preview-background" id="main-profile-background"
                     style="{% if user.background and user.background.url %}background-image: url('{{ user.background.url }}'); display: block;{% else %}display: none;{% endif %}"></div>
                
                    <div class="profile-preview-header">
                        <img class="profile-preview-avatar other-profile-avatar" 
                             src="{% static 'pictures/login.png' %}" 
                             alt="Avatar">
                        <div class="profile-preview-info">
                            <h3 class="username-text other-profile-username">Username</h3>
                            <div class="profile-preview-status">
                                <span class="status-value offline other-profile-status">
                                    ● Offline
                                </span>
                            </div>
                           <div class="profile-preview-tag tag-copy other-profile-tag" onclick="copyOtherUserTag()">@tag</div>
                        </div>
                    </div>              

                    <hr class="profile-preview-divider">          
                          
                    <div class="profile-preview-section">
                        <div class="profile-preview-label" id="role-label"></div>
                        <div class="profile-preview-value" id="other-profile-role"></div>
                    </div>

                    <div class="profile-preview-section">
                        <div class="profile-preview-label">Description</div>
                        <div class="profile-preview-value other-profile-description">
                            No description
                        </div>
                    </div>              

                    <div class="profile-preview-section">
                        <div class="profile-preview-label">Birthday</div>
                        <div class="profile-preview-birthday">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span class="birthday-value other-profile-birthday">Not specified</span>
                        </div>
                    <button class="other-profile-message-btn" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; flex:1;">
                        Message
                    </button>
                    </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                </div>
            </div>
        </div>

        <div class="setting-form">
            <h2>Setting</h2>
            <label for="form1-toggle" class="profile-btn">Edit profile</label>
            <label for="form2-toggle" class="profile-btn">Language</label>
            <label for="color_theme-toggle" class="profile-btn">Color theme</label>
            <label for="subscribe-month-toggle" class="profile-btn">Subscribe</label>
            <label for="security-toggle" class="profile-btn">Security</label>
            <form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">
            {% csrf_token %}
            </form>
            <label class="profile-btn" a href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                    Logout
                </a>
            </label>
        </div>

        <div class="form1">
            <h2>Edit Profile</h2>
            <div class="form1-inner">
                <div class="form1-fields">
                    <form action="{% url 'update_profile' %}" method="post" enctype="multipart/form-data" id="edit-profile-form">
                        {% csrf_token %}        

                        <div class="avatar-upload-section">
                            <img id="avatarInput-img" class="avatar" 
                                 src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'pictures/login.png' %}{% endif %}" 
                                 alt="Avatar">
                            <br>                        

                            <label for="avatarInput" style="display: inline-block; padding: 8px 16px; background: #007bff; color: white; border-radius: 6px; cursor: pointer;">
                                Choose New Avatar
                                <input type="file" id="avatarInput" name="photo" accept="image/*" style="display: none;">
                            </label>
                            <button type="button" class="btn-delete-avatar" onclick="confirmAvatarReset()">
                                Delete Avatar
                            </button>                       

                            <!-- Фон -->
                            <!-- <label for="backgroundInput" style="display: inline-block; padding: 8px 16px; background: #28a745; color: white; border-radius: 6px; cursor: pointer; margin-top: 10px; {% if user.subscribe == 'Basic' %}opacity: 0.6; cursor: not-allowed;{% endif %}" -->
                                   <!-- title="{% if user.subscribe == 'Basic' %}Backgrounds available for Bin+ and Bin Premium{% elif user.subscribe == 'Bin+' %}Images only (GIF for Bin Premium){% else %}All image formats including GIF{% endif %}"> -->
                                <!-- Choose New Background -->
                                <!-- <input type="file" id="backgroundInput" name="background"  -->
                                       <!-- accept="{% if user.subscribe == 'Bin+' %}image/*{% else %}image/*,image/gif{% endif %}" -->
                                       <!-- {% if user.subscribe == 'Basic' %}disabled{% endif %}  -->
                                       <!-- style="display: none;"> -->
                            <!-- </label> -->
                            <!-- <button type="button" class="btn-delete-background" onclick="confirmBackgroundReset()"  -->
                                    <!-- style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 10px;" -->
                                    <!-- {% if not user.background or not user.background.url %}disabled{% endif %}> -->
                                <!-- Remove Background -->
                            <!-- </button>        -->
                        </div>    

                        <div class="form-group">
                            <label for="username-input"><strong>Username:</strong></label>
                            <input type="text" id="username-input" name="username" value="{{ user.username }}" maxlength="18">
                        </div>      

                        <div class="form-group">
                            <label for="description-input"><strong>Description:</strong></label>
                            <textarea id="description-input" name="description" maxlength="100" rows="4" style="resize: none;">{{ user.description }}</textarea>
                        </div>      

                        <div class="form-group">
                            <label for="tag-input"><strong>Tag:</strong></label>
                            <input type="text" id="tag-input" name="your_tag" value="{{ user.your_tag }}">
                        </div>          

                        <div class="form-group">
                            <label><strong>Birthday:</strong></label>
                            <div class="birthday-selects">
                                <select name="day" id="birthday-day">
                                    {% for d in days %}
                                    <option value="{{ d }}" {% if birthday.day == d %}selected{% endif %}>{{ d }}</option>
                                    {% endfor %}
                                </select>
                                <select name="month" id="birthday-month">
                                    {% for m in months %}
                                    <option value="{{ m }}" {% if birthday.month == m %}selected{% endif %}>{{ m }}</option>
                                    {% endfor %}
                                </select>
                                <select name="year" id="birthday-year">
                                    {% for y in years %}
                                    <option value="{{ y }}" {% if birthday.year == y %}selected{% endif %}>{{ y }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>          

                        <button type="submit">Save Changes</button>
                    </form>
                </div>          

                <div class="form1-preview">
                    <div class="profile-preview-card" id="profile-preview-card">
                        <div class="profile-preview-background" id="preview-background"
                             style="{% if user.background and user.background.url %}background-image: url('{{ user.background.url }}'); display: block;{% else %}display: none;{% endif %}"></div>              

                        <div class="preview-badge">PREVIEW</div>        

                        <div class="profile-preview-header">
                            <img id="preview-avatar" class="profile-preview-avatar" 
                                 src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'pictures/login.png' %}{% endif %}" 
                                 alt="Avatar">
                            <div class="profile-preview-info">
                                <h3 id="preview-username">{{ user.username }}</h3>
                                <div class="profile-preview-status">
                                    <span class="status-value {% if user.status == 'Online' %}online{% else %}offline{% endif %}">
                                        ● {{ user.status|default:"Offline" }}
                                    </span>
                                </div>
                                <div class="profile-preview-tag" id="preview-tag">{{ user.your_tag }}</div>
                            </div>
                        </div>          

                        <hr class="profile-preview-divider">            

                        <div class="profile-preview-section">
                            <div class="profile-preview-label">Description</div>
                            <div class="profile-preview-value" id="preview-description">
                                {{ user.description|default:"No description" }}
                            </div>
                        </div>          

                        <div class="profile-preview-section">
                            <div class="profile-preview-label">Birthday</div>
                            <div class="profile-preview-birthday">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <span id="preview-birthday">{{ user.birthday|default:"Not specified" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form2">
            <form class="language-form" method="POST" action="{% url 'change-language' %}">
                {% csrf_token %}
                <select name="language">
                    <option value="English" {% if lang == "English" %}selected{% endif %}>English</option>
                    <option value="Українська" {% if lang == "Українська" %}selected{% endif %}>Українська</option>
                </select>
                <button type="submit">Change</button>
            </form>
        </div>


        <div class="wallet wallet-form">
            <p id="wallet-amount">Wallet: {{ price_converted }}</p>
            <form action="{% url 'change-currency' %}" method="post">
                {% csrf_token %}
                <select name="currency" onchange="this.form.submit()">
                    <option value="USD" {% if user.currency == 'USD' %}selected{% endif %}>USD $</option>
                    <option value="UAH" {% if user.currency == 'UAH' %}selected{% endif %}>UAH ₴</option>
                </select>
            </form>     

            <div class="currency-converter" style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <strong>{% if lang == "Українська" %}Конвертація валют{% else %}Currency Conversion{% endif %}</strong>     

                <div id="all-currencies-display" style="margin-top: 10px;">
                    <div class="currency-item" style="display: flex; align-items: center; margin-bottom: 8px; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                        <span style="margin-right: 8px;">🇺🇸</span>
                        <span id="usd-amount">--</span>
                    </div>
                    <div class="currency-item" style="display: flex; align-items: center; margin-bottom: 8px; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                        <span style="margin-right: 8px;">🇪🇺</span>
                        <span id="eur-amount">--</span>
                    </div>
                    <div class="currency-item" style="display: flex; align-items: center; margin-bottom: 8px; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                        <span style="margin-right: 8px;">🇬🇧</span>
                        <span id="gbp-amount">--</span>
                    </div>
                    <div class="currency-item" style="display: flex; align-items: center; margin-bottom: 8px; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                        <span style="margin-right: 8px;">🇺🇦</span>
                        <span id="uah-amount">--</span>
                    </div>
                </div>
            </div>      

            <button type="button" class="deposit-btn" onclick="checkCardsAndOpenDeposit()">Deposit to wallet</button>
            <button type="button" class="add_card-btn" onclick="openAdd_card('add_card')">Add card</button>
            <div id="cards-list" style="margin-top:12px;">
                <strong>{% if lang == "Українська" %}Картки:{% else %}Cards:{% endif %}</strong>
                <div style="margin-top:6px;">
                    {% if cards and cards.count %}
                        {% for c in cards %}
                            <div class="card-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">
                                <span>**** **** ****{{ c.last4 }} — {{ c.cardholder|default:'-' }} — {{ c.expiry_month|stringformat:"02d" }}/{{ c.expiry_year }}</span>
                                <button type="button" onclick="deleteCard('{{ c.last4 }}')" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">🗑️</button>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="card-item" style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">{% if lang == "Українська" %}Карт не додано{% else %}No cards added{% endif %}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <label for="add_card-toggle" class="add_card-overlay"></label>
        <div class="add_card add_card-form">
            <h2>{% if lang == "Українська" %}Додати картку{% else %}Add card{% endif %}</h2>
            <form id="add-card-form" onsubmit="return false;">
                <label>{% if lang == "Українська" %}Номер картки{% else %}Card number{% endif %}</label>
                <input id="card-number" type="text" inputmode="numeric" pattern="[0-9\s]*" maxlength="19" placeholder="1235 9864 2134 1253" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">

                <label style="margin-top:8px;">{% if lang == "Українська" %}Ім'я власника{% else %}Cardholder name{% endif %}</label>
                <input id="card-cardholder" type="text" placeholder="NAME SURNAME" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">

                <div style="display:flex; gap:8px; margin-top:8px;">
                    <div style="flex:1;">
                        <label>{% if lang == "Українська" %}Місяць{% else %}Month{% endif %}</label>
                        <select id="card-expiry-month" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                            {% for m in months %}
                                <option value="{{ m }}">{{ m|stringformat:"02d" }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label>{% if lang == "Українська" %}Рік{% else %}Year{% endif %}</label>
                        <select id="card-expiry-year" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                            {% for y in expiry_years %}
                                <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <label style="margin-top:8px;">{% if lang == "Українська" %}CVV (не зберігається){% else %}CVV (not stored){% endif %}</label>
                <input id="card-cvv" type="password" maxlength="3" placeholder="123" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">

                <div style="display:flex; gap:8px; margin-top:12px;">
                    <button type="button" class="deposit-btn" onclick="submitAddCard()">{% if lang == "Українська" %}Додати{% else %}Add{% endif %}</button>
                    <button type="button" class="deposit-btn" onclick="(function(){ const cb=document.getElementById('add_card-toggle'); if(cb) cb.checked=false; })()">{% if lang == "Українська" %}Відмінити{% else %}Cancel{% endif %}</button>
                </div>
                <p id="add-card-result" style="margin-top:8px;color:#333;font-weight:600;"></p>
            </form>
        </div>

        <label for="deposit-toggle" class="deposit-overlay"></label>
        <div class="deposit deposit-form">
            <h2>Deposit</h2>
            <p>wallet: <span id="deposit-wallet">{{ price_converted }}</span></p>
            <select id="deposit-card" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;">
                {% if cards and cards.count %}
                    {% for c in cards %}
                        <option value="{{ c.last4 }}">**** **** **** {{ c.last4 }} — {{ c.cardholder|default:'-' }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            <input id="deposit-amount" type="number" placeholder="Amount" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
            <p id="deposit-result" style="margin-top:8px;color:#333;font-weight:600;"></p>
            <button type="button" class="deposit-btn" onclick="performDeposit()">Deposit</button>
        </div>

        <div class="subscribe-form-month">
            <div class="subscribe-buttons" style="display: flex; justify-content: center; gap: 40px; margin-bottom: 20px;">
                <button type="button" class="Subscribe-switching-button" onclick="openSubscribe('month')">Month</button>
                <button type="button" class="Subscribe-switching-button year-btn" onclick="openSubscribe('year')">
                    Year
                    <span class="discount">-17%</span>
                </button>
            </div>

            <div class="plans-container" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">

                <div class="plan">
                    <div class="inner">
                        <span class="pricing">
                            <span>
                                {% if user.currency == 'USD' %}
                                    $4.99 <small>/ m</small>
                                {% elif user.currency == 'UAH' %}
                                    ₴209.99 <small>/ m</small>
                                {% endif %}
                            </span>
                        </span>
                        <p class="title">Bin+</p>
                        <p class="info">Everything in Basic and:</p>
                        <ul class="features">
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong></strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>Can add GIF avatar</strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>Can change theme<br>add Pink and Green</strong></span>
                            </li>
                        </ul>
                        <div class="action">
                            <label for="bin_mouth-toggle" class="button">Choose plan</label>
                        </div>
                    </div>
                </div>      

                <div class="plan">
                    <div class="inner">
                        <span class="pricing">
                            <span>
                                {% if user.currency == 'USD' %}
                                    $9.99 <small>/ m</small>
                                {% elif user.currency == 'UAH' %}
                                    ₴419.99 <small>/ m</small>
                                {% endif %}
                            </span>
                        </span>
                        <p class="title">Bin premium</p>
                        <p class="info">Everything in Bin+ and:</p>
                        <ul class="features">
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>Can place a background in your profile</strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span>Plan <strong>team meetings</strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span>File sharing</span>
                            </li>
                        </ul>
                        <div class="action">
                            <label for="bin_premium_mouth-toggle" class="button">Choose plan</label>
                        </div>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <label for="check-subscription-toggle" class="check-subscription-btn">Check subscription status</label>
            </div>
        </div>

        <!-- Підписка на рік -->
        <div class="subscribe-form-year">
            <div class="subscribe-buttons" style="display: flex; justify-content: center; gap: 40px; margin-bottom: 20px;">
                <button type="button" class="Subscribe-switching-button" onclick="openSubscribe('month')">Month</button>
                <button type="button" class="Subscribe-switching-button year-btn" onclick="openSubscribe('year')">
                    Year
                    <span class="discount">-17%</span>
                </button>
            </div>

            <div class="plans-container" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                <div class="plan">
                    <div class="inner">
                        <span class="pricing">
                            <span>
                                {% if user.currency == 'USD' %}
                                    <span class="old-price">$59.88</span>
                                    <span class="new-price">$49.99</span> <small>/ y</small>
                                {% elif user.currency == 'UAH' %}
                                    <span class="old-price">₴2519.88</span>
                                    <span class="new-price">₴2099.99</span> <small>/ y</small>
                                {% endif %}
                            </span>
                        </span>
                        <p class="title">Bin+</p>
                        <p class="info">Everything in Basic and:</p>
                        <ul class="features">
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>20</strong> team members</span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>Can add GIF avatar</strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>Can change theme<br>add Pink and Green</strong></span>
                            </li>
                        </ul>
                        <div class="action">
                            <label for="bin_years-toggle" class="button">Choose plan</label>
                        </div>
                    </div>
                </div>      

                <div class="plan">
                    <div class="inner">
                        <span class="pricing">
                            <span>
                                {% if user.currency == 'USD' %}
                                    <span class="old-price">$119.88</span>
                                    <span class="new-price">$99.99</span> <small>/ y</small>
                                {% elif user.currency == 'UAH' %}
                                    <span class="old-price">₴5039.88</span>
                                    <span class="new-price">₴4199.99</span> <small>/ y</small>
                                {% endif %}
                            </span>
                        </span>
                        <p class="title">Bin premium</p>
                        <p class="info">Everything in Bin+ and:</p>
                        <ul class="features">
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>20</strong> team members</span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span>Plan <strong>team meetings</strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong></strong></span>
                            </li>
                        </ul>
                        <div class="action">
                            <label for="bin_premium_years-toggle" class="button">Choose plan</label>
                        </div>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <label for="check-subscription-toggle" class="check-subscription-btn">Check subscription status</label>
            </div>
        </div>

        <div style="display:flex; gap:5px; align-items:center;">
            <input type="text" id="searchInput"
                style="padding:8px; border-radius:6px; border:1px solid #ccc; margin-top: 16px; margin-left:60px;"
                placeholder="Search">
        </div>

        
        <div class="main">
            <div class="content">
                <div id="recent-contacts" style="margin-top:-30px; margin-left:-50px; width:300px;">
                    <div id="recent-contacts-list">
                    </div>
                </div>

                <div id="searchResults" style="margin-top:-30px; margin-left:-50px; width:300px;"></div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header" onclick="openUserProfile(currentChatUser)">
                <h3><span id="chat-username"></span></h3>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="chat-messages-spacer"></div>
            </div>
            <div class="chat-input-container">
                <button type="button" class="attach-btn" onclick="openFileInput()" title="Прикрепить файл">
                    📎
                </button>
                <input type="file" id="chat-file-input" style="display: none;" onchange="handleFileSelect(event)">

                <input type="text" class="chat-input" id="chat-input" placeholder="Type your message...">
                <button class="chat-send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <div class="check-subscription-form">
            <h2>Your subscription status: {{ user.subscribe }}</h2>     

            {% if user.subscription_end %}
                <p>Time left: <span id="countdown"></span></p>      

                {% if can_refund %}
                <div style="margin-top:10px;">
                    <span>You can return it within 24 hours after purchase.</span><br>
                    <form method="POST" style="text-align:center; margin-top:10px;">
                        {% csrf_token %}
                        <button type="submit" name="action" value="refund_subscription" class="btn-refund">
                            Refund
                        </button>
                    </form>
                </div>
        {% endif %}
            {% else %}
                <p>Your subscription is Basic</p>
            {% endif %}
        </div>      

        <div class="bin_mouth-form">
            <h2>Update your plan to Bin+</h2>
            <form method="post">
                {% csrf_token %}
                <p>Wallet: <span>{{ price_converted }}</span></p>
                {% if user.currency == 'USD' %}
                    $4.99 <small>/ m</small>
                {% elif user.currency == 'UAH' %}
                    ₴209.99 <small>/ m</small>
                {% endif %}
                <div>
                    <input type="checkbox" id="terms-bin">
                    <label for="terms-bin">I agree with the <a href="/terms" target="_blank">terms and conditions</a></label>
                </div>
                <button type="submit" name="subscription_plan" value="bin_plus_monthly" id="subscribe-bin" disabled class="subscribe-btn">Subscribe</button>
                <!-- <button type="submit" name="subscription_plan" value="bin_plus_test" id="subscribe-bin" disabled class="subscribe-btn">Subscribe</button> -->
            </form>
        </div>      

        <div class="bin_premium_mouth-form">
            <h2>Update your plan to Bin Premium</h2>
            <form method="post">
                {% csrf_token %}
                <p>Wallet: <span>{{ price_converted }}</span></p>
                {% if user.currency == 'USD' %}
                    $9.99 <small>/ m</small>
                {% elif user.currency == 'UAH' %}
                    ₴419.99 <small>/ m</small>
                {% endif %}
                <div>
                    <input type="checkbox" id="terms-premium">
                    <label for="terms-premium">I agree with the <a href="/terms" target="_blank">terms and conditions</a></label>
                </div>
                <button type="submit" name="subscription_plan" value="bin_premium_monthly" id="subscribe-premium" disabled class="subscribe-btn">Subscribe</button>
            </form>
        </div>      

        <div class="bin_years-form">
            <h2>Update your plan to Bin+ Yearly</h2>
            <form method="post">
                {% csrf_token %}
                <p>Wallet: <span>{{ price_converted }}</span></p>
                {% if user.currency == 'USD' %}
                    $49.99 <small>/ y</small>
                {% elif user.currency == 'UAH' %}
                    ₴2099.99 <small>/ y</small>
                {% endif %}
                <div>
                    <input type="checkbox" id="terms-bin-year">
                    <label for="terms-bin-year">I agree with the <a href="/terms" target="_blank">terms and conditions</a></label>
                </div>
                <button type="submit" name="subscription_plan" value="bin_plus_yearly" id="subscribe-bin-year" disabled class="subscribe-btn">Subscribe</button>
            </form>
        </div>      

        <div class="bin_premium_years-form">
            <h2>Update your plan to Bin Premium Yearly</h2>
            <form method="post">
                {% csrf_token %}
                <p>Wallet: <span>{{ price_converted }}</span></p>
                {% if user.currency == 'USD' %}
                    $99.99 <small>/ y</small>
                {% elif user.currency == 'UAH' %}
                    ₴4199.99 <small>/ y</small>
                {% endif %}
                <div>
                    <input type="checkbox" id="terms-premium-year">
                    <label for="terms-premium-year">I agree with the <a href="/terms" target="_blank">terms and conditions</a></label>
                </div>
                <button type="submit" name="subscription_plan" value="bin_premium_yearly" id="subscribe-premium-year" disabled class="subscribe-btn">Subscribe</button>
            </form>
        </div>      

        <div class="security-form">
            <h2>{% if lang == "Українська" %}Безпека{% else %}Security{% endif %}</h2>
            
            <div class="security-section password-section" id="password-section">
                <div class="password-toggle" onclick="togglePasswordForm()">
                    <h4>{% if lang == "Українська" %}Змінити пароль{% else %}Change Password{% endif %}</h4>
                    <div class="password-toggle-arrow">▼</div>
                </div>
                
                <div class="password-form" id="password-form">
                    <form method="POST" action="{% url 'change_password' %}">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="current-password">{% if lang == "Українська" %}Поточний пароль{% else %}Current Password{% endif %}</label>
                            <input type="password" id="current-password" name="current_password" required 
                                   placeholder="{% if lang == 'Українська' %}Введіть поточний пароль{% else %}Enter current password{% endif %}">
                        </div>
                        
                        <div class="form-group">
                            <label for="new-password">{% if lang == "Українська" %}Новий пароль{% else %}New Password{% endif %}</label>
                            <input type="password" id="new-password" name="new_password" required 
                                   placeholder="{% if lang == 'Українська' %}Введіть новий пароль{% else %}Enter new password{% endif %}"
                                   minlength="8">
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">{% if lang == "Українська" %}Підтвердіть пароль{% else %}Confirm Password{% endif %}</label>
                            <input type="password" id="confirm-password" name="confirm_password" required 
                                   placeholder="{% if lang == 'Українська' %}Підтвердіть новий пароль{% else %}Confirm new password{% endif %}">
                        </div>
                        
                        <button type="submit" class="security-btn">
                            {% if lang == "Українська" %}Змінити пароль{% else %}Change Password{% endif %}
                        </button>
                    </form>
                </div>
            </div>
            <div class="security-section">
                <h3>{% if lang == "Українська" %}Двофакторна аутентифікація{% else %}Two-Factor Authentication{% endif %}</h3>
                <p>{% if lang == "Українська" %}Статус: {% else %}Status: {% endif %}
                    <strong>
                        {% if user.two_factor_enabled %}
                            {% if lang == "Українська" %}Увімкнено{% else %}Enabled{% endif %}
                        {% else %}
                            {% if lang == "Українська" %}Вимкнено{% else %}Disabled{% endif %}
                        {% endif %}
                    </strong>
                </p>
                
                <div class="two-factor-buttons">
                    {% if not user.two_factor_enabled %}
                        <form method="POST" action="{% url 'enable_2fa' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="security-btn enable-btn">
                                {% if lang == "Українська" %}Увімкнути 2FA{% else %}Enable 2FA{% endif %}
                            </button>
                        </form>
                    {% else %}
                        <form method="POST" action="{% url 'disable_2fa' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="security-btn disable-btn">
                                {% if lang == "Українська" %}Вимкнути 2FA{% else %}Disable 2FA{% endif %}
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
            
            <div class="security-section">
                <h3>{% if lang == "Українська" %}Активні сесії{% else %}Active Sessions{% endif %}</h3>
                {% if active_sessions %}
                    <div class="sessions-list">
                        {% for session in active_sessions %}
                            <div class="session-item">
                                <div class="session-info">
                                    <strong>IP: {{ session.ip_address }}</strong>
                                    <span>{% if lang == "Українська" %}Остання активність: {% else %}Last activity: {% endif %}{{ session.last_activity|date:"Y-m-d H:i" }}</span>
                                </div>
                                {% if not session.is_current %}
                                    <form method="POST" action="{% url 'terminate_session' %}" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="session_key" value="{{ session.session_key }}">
                                        <button type="submit" class="terminate-btn">
                                            {% if lang == "Українська" %}Завершити{% else %}Terminate{% endif %}
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="current-session">{% if lang == "Українська" %}Поточна{% else %}Current{% endif %}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>{% if lang == "Українська" %}Немає активних сесій{% else %}No active sessions{% endif %}</p>
                {% endif %}
            </div>      

            <div class="security-section">
                <h3>{% if lang == "Українська" %}Історія входів{% else %}Login History{% endif %}</h3>
                {% if login_history %}
                    <div class="login-history">
                        {% for login in login_history %}
                            <div class="login-item">
                                <strong>IP: {{ login.ip_address }}</strong>
                                <span>{{ login.login_time|date:"Y-m-d H:i" }}</span>
                                <span class="status {% if login.success %}success{% else %}failed{% endif %}">
                                    {% if login.success %}
                                        {% if lang == "Українська" %}Успішно{% else %}Success{% endif %}
                                    {% else %}
                                        {% if lang == "Українська" %}Невдало{% else %}Failed{% endif %}
                                    {% endif %}
                                </span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>{% if lang == "Українська" %}Історія входів відсутня{% else %}No login history available{% endif %}</p>
                {% endif %}
            </div>
        </div>





































    {% elif lang == "Українська" %}

    {% if messages %}
        <div style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            {% for message in messages %}
                <div style="background: {% if message.tags == 'error' %}#f44336{% else %}#4CAF50{% endif %}; color: white; padding: 15px 20px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); animation: slideIn 0.3s;">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
        <style>
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        </style>
        <script>
            setTimeout(() => {
                document.querySelectorAll('[style*="slideIn"]').forEach(el => {
                    el.style.animation = 'slideOut 0.3s';
                    setTimeout(() => el.remove(), 300);
                });
            }, 5000);
        </script>
    {% endif %}

        <label class="hamburger" for="menu-toggle"><span></span><span></span><span></span></label>
        <label for="menu-toggle" class="overlay"></label>

        <div class="side-menu">
            <img class="avatar" src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'pictures/login.png' %}{% endif %}" alt="Avatar">
            <div class="username">{{ user.username }}</div>
            {% if user.subscribe == "Bin+" %}
                <div style="color:#0056b3" class="username-line">{{ user.subscribe }}</div>
            {% elif user.subscribe == "Bin_premium" %}
                <div style="color:#b3009b" class="username-line">{{ user.subscribe }}</div>
            {% endif %}
            <label for="profile-toggle" class="profile-btn">Мій профіль</label>
            <label for="wallet-toggle" class="profile-btn">Гаманець</label>
            <label for="setting-toggle" class="profile-btn">Налаштування</label>
        </div>

        <div class="profile-form">
            <div class="profile-preview-card">
                <div class="profile-preview-background" id="main-profile-background"
                     style="{% if user.background and user.background.url %}background-image: url('{{ user.background.url }}'); display: block;{% else %}display: none;{% endif %}"></div>
                
                <div class="profile-preview-header">
                    <img class="profile-preview-avatar avatar" 
                         src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'pictures/login.png' %}{% endif %}" 
                         alt="Avatar">
                    <div class="profile-preview-info">
                        <h3 class="username-text">{{ user.username }}</h3>
                        <div class="profile-preview-status">
                            <span class="status-value {% if user.status == 'Online' %}online{% else %}offline{% endif %}">
                                ● {{ user.status|default:"Offline" }}
                            </span>
                        </div>
                        <div class="profile-preview-tag tag-copy" id="user-tag">{{ user.your_tag }}</div>
                        <br>
                        <label for="form1-toggle" class="edit-icon">Редагувати профіль</label>
                    </div>
                </div>      

                <hr class="profile-preview-divider">        

                <div class="profile-preview-section">
                    <div class="profile-preview-label">Опис</div>
                    <div class="profile-preview-value">
                        {{ description_html|safe }}
                    </div>
                </div>      

                <div class="profile-preview-section">
                    <div class="profile-preview-label">День народження</div>
                    <div class="profile-preview-birthday">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span class="birthday-value">{{ user.birthday|default:"Не вказано" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="setting-form">
            <h2>Налаштування</h2>
            <label for="form1-toggle" class="profile-btn">Редагувати профіль</label>
            <label for="form2-toggle" class="profile-btn">Мова</label>
            <label for="color_theme-toggle" class="profile-btn">Тема кольору</label>
            <label for="subscribe-month-toggle" class="profile-btn">Підписка</label>
            <label for="security-toggle" class="profile-btn">Безпека</label>
            <form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">
            {% csrf_token %}
            </form>
            <label class="profile-btn" a href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                    Вихід з акаунту
                </a>
            </label>
        </div>

        <div class="form1">
            <h2>Редагувати профіль</h2>
            <div class="form1-inner">
                <div class="form1-fields">
                    <form action="{% url 'update_profile' %}" method="post" enctype="multipart/form-data" id="edit-profile-form">
                        {% csrf_token %}        

                        <div class="avatar-upload-section">
                            <img id="avatarInput-img" class="avatar" 
                                 src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'pictures/login.png' %}{% endif %}" 
                                 alt="Avatar">
                            <br>

                            <label for="avatarInput" style="display: inline-block; padding: 8px 16px; background: #007bff; color: white; border-radius: 6px; cursor: pointer;">
                                Вибрати новий аватар
                                <input type="file" id="avatarInput" name="photo" accept="image/*" style="display: none;">
                            </label>
                            <button type="button" class="btn-delete-avatar" onclick="confirmAvatarReset()">
                                Видалити аватар
                            </button>

                            <!-- <label for="backgroundInput" style="display: inline-block; padding: 8px 16px; background: #28a745; color: white; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                                Вибрати новий фон
                                <input type="file" id="backgroundInput" name="background" style="display: none;">
                            </label>
                            <button type="button" class="btn-delete-background" onclick="confirmBackgroundReset()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 10px;">
                                Видалити фон
                            </button>        -->

                        </div>          

                        <div class="form-group">
                            <label for="username-input"><strong>Ім'я користувача:</strong></label>
                            <input type="text" id="username-input" name="username" value="{{ user.username }}" maxlength="18">
                        </div>      

                        <div class="form-group">
                            <label for="description-input"><strong>Опис:</strong></label>
                            <textarea id="description-input" name="description" maxlength="100" rows="4" style="resize: none;">{{ user.description }}</textarea>
                        </div>      

                        <div class="form-group">
                            <label for="tag-input"><strong>Тег:</strong></label>
                            <input type="text" id="tag-input" name="your_tag" value="{{ user.your_tag }}">
                        </div>          

                        <div class="form-group">
                            <label><strong>День народження:</strong></label>
                            <div class="birthday-selects">
                                <select name="day" id="birthday-day">
                                    {% for d in days %}
                                    <option value="{{ d }}" {% if birthday.day == d %}selected{% endif %}>{{ d }}</option>
                                    {% endfor %}
                                </select>
                                <select name="month" id="birthday-month">
                                    {% for m in months %}
                                    <option value="{{ m }}" {% if birthday.month == m %}selected{% endif %}>{{ m }}</option>
                                    {% endfor %}
                                </select>
                                <select name="year" id="birthday-year">
                                    {% for y in years %}
                                    <option value="{{ y }}" {% if birthday.year == y %}selected{% endif %}>{{ y }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>          

                        <button type="submit">Зберегти зміни</button>
                    </form>
                </div>          

                <div class="form1-preview">
                    <div class="profile-preview-card" id="profile-preview-card">
                        <div class="profile-preview-background" id="preview-background"
                             style="{% if user.background and user.background.url %}background-image: url('{{ user.background.url }}'); display: block;{% else %}display: none;{% endif %}"></div>              

                        <div class="preview-badge">ПЕРЕГЛЯД</div>        

                        <div class="profile-preview-header">
                            <img id="preview-avatar" class="profile-preview-avatar" 
                                 src="{% if user.photo %}{{ user.photo.url }}{% else %}{% static 'pictures/login.png' %}{% endif %}" 
                                 alt="Avatar">
                            <div class="profile-preview-info">
                                <h3 id="preview-username">{{ user.username }}</h3>
                                <div class="profile-preview-status">
                                    <span class="status-value {% if user.status == 'Online' %}online{% else %}offline{% endif %}">
                                        ● {{ user.status|default:"Offline" }}
                                    </span>
                                </div>
                                <div class="profile-preview-tag" id="preview-tag">{{ user.your_tag }}</div>
                            </div>
                        </div>          

                        <hr class="profile-preview-divider">            

                        <div class="profile-preview-section">
                            <div class="profile-preview-label">Опис</div>
                            <div class="profile-preview-value" id="preview-description">
                                {{ user.description|default:"No description" }}
                            </div>
                        </div>          

                        <div class="profile-preview-section">
                            <div class="profile-preview-label">День народження</div>
                            <div class="profile-preview-birthday">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <span id="preview-birthday">{{ user.birthday|default:"Не вказано" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form2">
            <form class="language-form" method="POST" action="{% url 'change-language' %}">
                {% csrf_token %}
                <select name="language">
                    <option value="English" {% if lang == "English" %}selected{% endif %}>English</option>
                    <option value="Українська" {% if lang == "Українська" %}selected{% endif %}>Українська</option>
                </select>
                <button type="submit">Змінити</button>
            </form>
        </div>

        <div class="color_theme">
          <h2>Налаштування кольорової теми</h2>
          <select id="themeSelect">
              <option value="light">Світла</option>
              <option value="dark">Темна</option>
              <option value="pink">Рожева (тільки підписка)</option>
              <option value="green">Зелена (тільки підписка)</option>
          </select>
          <p>sub = підписка</p>
          <button id="applyThemeBtn">Застосувати</button>
        </div>      

        <div class="color_theme-overlay"></div>


        <div class="wallet wallet-form">
            <p id="wallet-amount">Гаманець: {{ price_converted }}</p>
            <form action="{% url 'change-currency' %}" method="post">
                {% csrf_token %}
                <select name="currency" onchange="this.form.submit()">
                    <option value="USD" {% if user.currency == 'USD' %}selected{% endif %}>USD $</option>
                    <option value="UAH" {% if user.currency == 'UAH' %}selected{% endif %}>UAH ₴</option>
                </select>
            </form>
            <button type="button" class="deposit-btn" onclick="checkCardsAndOpenDeposit()">Поповнити гаманець</button>
            <button type="button" class="add_card-btn" onclick="openAdd_card('add_card')">Додати картку</button>
            <div id="cards-list" style="margin-top:12px;">
                <strong>{% if lang == "Українська" %}Картки:{% else %}Cards:{% endif %}</strong>
                <div style="margin-top:6px;">
                    {% if cards and cards.count %}
                        {% for c in cards %}
                            <div class="card-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">
                                <span>**** **** ****{{ c.last4 }} — {{ c.cardholder|default:'-' }} — {{ c.expiry_month|stringformat:"02d" }}/{{ c.expiry_year }}</span>
                                <button type="button" onclick="deleteCard('{{ c.last4 }}')" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">🗑️</button>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="card-item" style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">{% if lang == "Українська" %}Карт не додано{% else %}No cards added{% endif %}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <label for="add_card-toggle" class="add_card-overlay"></label>
        <div class="add_card add_card-form">
            <h2>{% if lang == "Українська" %}Додати картку{% else %}Add card{% endif %}</h2>
            <form id="add-card-form" onsubmit="return false;">
                <label>{% if lang == "Українська" %}Номер картки{% else %}Card number{% endif %}</label>
                <input id="card-number" type="text" inputmode="numeric" pattern="[0-9\s]*" maxlength="19" placeholder="1235 9864 2134 1253" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">

                <label style="margin-top:8px;">{% if lang == "Українська" %}Ім'я власника{% else %}Cardholder name{% endif %}</label>
                <input id="card-cardholder" type="text" placeholder="NAME SURNAME" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">

                <div style="display:flex; gap:8px; margin-top:8px;">
                    <div style="flex:1;">
                        <label>{% if lang == "Українська" %}Місяць{% else %}Month{% endif %}</label>
                        <select id="card-expiry-month" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                            {% for m in months %}
                                <option value="{{ m }}">{{ m|stringformat:"02d" }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label>{% if lang == "Українська" %}Рік{% else %}Year{% endif %}</label>
                        <select id="card-expiry-year" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                            {% for y in expiry_years %}
                                <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <label style="margin-top:8px;">{% if lang == "Українська" %}CVV (не зберігається){% else %}CVV (not stored){% endif %}</label>
                <input id="card-cvv" type="password" maxlength="3" placeholder="123" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">

                <div style="display:flex; gap:8px; margin-top:12px;">
                    <button type="button" class="deposit-btn" onclick="submitAddCard()">{% if lang == "Українська" %}Додати{% else %}Add{% endif %}</button>
                    <button type="button" class="deposit-btn" onclick="(function(){ const cb=document.getElementById('add_card-toggle'); if(cb) cb.checked=false; })()">{% if lang == "Українська" %}Відмінити{% else %}Cancel{% endif %}</button>
                </div>
                <p id="add-card-result" style="margin-top:8px;color:#333;font-weight:600;"></p>
            </form>
        </div>

        <label for="deposit-toggle" class="deposit-overlay"></label>
        <div class="deposit deposit-form">
            <h2>Поповнення</h2>
            <p>Гаманець: <span id="deposit-wallet">{{ price_converted }}</span></p>
            <select id="deposit-card" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;">
                {% if cards and cards.count %}
                    {% for c in cards %}
                        <option value="{{ c.last4 }}">**** **** **** {{ c.last4 }} — {{ c.cardholder|default:'-' }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            <input id="deposit-amount" type="number" placeholder="Сума" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
            <p id="deposit-result" style="margin-top:8px;color:#333;font-weight:600;"></p>
            <button type="button" class="deposit-btn" onclick="performDeposit()">Поповнити</button>
        </div>

        <div class="subscribe-form-month">
            <div class="subscribe-buttons" style="display: flex; justify-content: center; gap: 40px; margin-bottom: 20px;">
                <button type="button" class="Subscribe-switching-button" onclick="openSubscribe('month')">Місяць</button>
                <button type="button" class="Subscribe-switching-button year-btn" onclick="openSubscribe('year')">
                    Рік
                    <span class="discount">-17%</span>
                </button>
            </div>

            <div class="plans-container" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">

                <div class="plan">
                    <div class="inner">
                        <span class="pricing">
                            <span>
                                {% if user.currency == 'USD' %}
                                    $4.99 <small>/ м</small>
                                {% elif user.currency == 'UAH' %}
                                    ₴209.99 <small>/ м</small>
                                {% endif %}
                            </span>
                        </span>
                        <p class="title">Бін+</p>
                        <p class="info">Все як звичайно та:</p>
                        <ul class="features">
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong></strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>Can add GIF avatar</strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>Can change theme add Pink and Green</strong></span>
                            </li>
                        </ul>
                        <div class="action">
                            <label for="bin_mouth-toggle" class="button">Обрати Підписку</label>
                        </div>
                    </div>
                </div>      

                <div class="plan">
                    <div class="inner">
                        <span class="pricing">
                            <span>
                                {% if user.currency == 'USD' %}
                                    $9.99 <small>/ м</small>
                                {% elif user.currency == 'UAH' %}
                                    ₴419.99 <small>/ м</small>
                                {% endif %}
                            </span>
                        </span>
                        <p class="title">Бін преміум</p>
                        <p class="info">Все як звичайно та:</p>
                        <ul class="features">
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>Can place a background in your profile</strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span>Plan <strong>team meetings</strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span>File sharing</span>
                            </li>
                        </ul>
                        <div class="action">
                            <label for="bin_premium_mouth-toggle" class="button">Обрати Підписку</label>
                        </div>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <label for="check-subscription-toggle" class="check-subscription-btn">Перевірте статус підписки</label>
            </div>
        </div>

        <div class="subscribe-form-year">
            <div class="subscribe-buttons" style="display: flex; justify-content: center; gap: 40px; margin-bottom: 20px;">
                <button type="button" class="Subscribe-switching-button" onclick="openSubscribe('month')">Місяць</button>
                <button type="button" class="Subscribe-switching-button year-btn" onclick="openSubscribe('year')">
                    Рік
                    <span class="discount">-17%</span>
                </button>
            </div>

            <div class="plans-container" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                <div class="plan">
                    <div class="inner">
                        <span class="pricing">
                            <span>
                                {% if user.currency == 'USD' %}
                                    <span class="old-price">$59.88</span>
                                    <span class="new-price">$49.99</span> <small>/ р</small>
                                {% elif user.currency == 'UAH' %}
                                    <span class="old-price">₴2519.88</span>
                                    <span class="new-price">₴2099.99</span> <small>/ р</small>
                                {% endif %}
                            </span>
                        </span>
                        <p class="title">Бін+</p>
                        <p class="info">Все з Бін+ та:</p>
                        <ul class="features">
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>20</strong> team members</span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span>Plan <strong>team meetings</strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span>File sharing</span>
                            </li>
                        </ul>
                        <div class="action">
                            <label for="bin_years-toggle" class="button">Обрати Підписку</label>
                        </div>
                    </div>
                </div>      

                <div class="plan">
                    <div class="inner">
                        <span class="pricing">
                            <span>
                                {% if user.currency == 'USD' %}
                                    <span class="old-price">$119.88</span>
                                    <span class="new-price">$99.99</span> <small>/ р</small>
                                {% elif user.currency == 'UAH' %}
                                    <span class="old-price">₴5039.88</span>
                                    <span class="new-price">₴4199.99</span> <small>/ р</small>
                                {% endif %}
                            </span>
                        </span>
                        <p class="title">Бін преміум</p>
                        <p class="info">Все з Бін+ та:</p>
                        <ul class="features">
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span><strong>20</strong> team members</span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span>Plan <strong>team meetings</strong></span>
                            </li>
                            <li>
                                <span class="icon">
                                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0h24v24H0z" fill="none"></path>
                                        <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                                    </svg>
                                </span>
                                <span>File sharing</span>
                            </li>
                        </ul>
                        <div class="action">
                            <label for="bin_premium_years-toggle" class="button">Обрати Підписку</label>
                        </div>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <label for="check-subscription-toggle" class="check-subscription-btn">Перевірте статус підписки</label>
            </div>
        </div>
        
        <div class="main">
            <div class="content">
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="text" id="searchInput"
                        style="width:10%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-top:-35px; margin-left:10px;"
                        placeholder="Search"
                        onkeyup="searchUsers()">
                </div>      
                
                <div id="recent-contacts" style="margin-top:20px; margin-left:-50px; width:300px;">
                    <div id="recent-contacts-list">
                    </div>
                </div>
                
                <div id="searchResults" style="margin-top:10px;"></div>
            </div>
        </div>  

        <div class="chat-container">
            <div class="chat-header">
                <h3><span id="chat-username"></span></h3>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="chat-messages-spacer"></div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="Введіть своє повідомлення...">
                <button class="chat-send-btn" onclick="sendMessage()">Відправити</button>
            </div>
        </div>

        <div class="check-subscription-form">
            <h2>Ваш статус Підписку: 
                {% if user.subscribe == 'Bin_premium' %}
                    Бін преміум
                {% elif user.subscribe == 'Bin+' %}
                Бін+
                {% endif %}
            </h2>     

            {% if user.subscription_end %}
                <p>Залишилося: <span id="countdown"></span></p>      

                {% if can_refund %}
                <div style="margin-top:10px;">
                    <span>Ви можете повернути його протягом 24 годин після покупки.</span><br>
                    <form method="POST" style="text-align:center; margin-top:10px;">
                        {% csrf_token %}
                        <button type="submit" name="action" value="refund_subscription" class="btn-refund">
                            Повернути
                        </button>
                    </form>
                </div>
                {% endif %}
            {% else %}
                <p>Your subscription is Basic</p>
            {% endif %}
        </div>      

        <div class="bin_mouth-form">
            <h2>Оновлення вашого плану до Бін+</h2>
            <form method="post">
                {% csrf_token %}
                <p>Гаманець: <span>{{ price_converted }}</span></p>
                {% if user.currency == 'USD' %}
                    $4.99 <small>/ м</small>
                {% elif user.currency == 'UAH' %}
                    ₴209.99 <small>/ м</small>
                {% endif %}
                <div>
                    <input type="checkbox" id="terms-bin">
                    <label for="terms-bin">Я згоден з <a href="/terms" target="_blank">Умовами користування</a></label>
                </div>
                <button type="submit" name="subscription_plan" value="bin_plus_monthly" id="subscribe-bin" disabled class="subscribe-btn">Підписатися</button>
            </form>
        </div>      

        <div class="bin_premium_mouth-form">
            <h2>Оновлення вашого плану до Бін преміум</h2>
            <form method="post">
                {% csrf_token %}
                <p>Гаманець: <span>{{ price_converted }}</span></p>
                {% if user.currency == 'USD' %}
                    $9.99 <small>/ м</small>
                {% elif user.currency == 'UAH' %}
                    ₴419.99 <small>/ м</small>
                {% endif %}
                <div>
                    <input type="checkbox" id="terms-premium">
                    <label for="terms-premium">Я згоден з <a href="/terms" target="_blank">Умовами користування</a></label>
                </div>
                <button type="submit" name="subscription_plan" value="bin_premium_monthly" id="subscribe-premium" disabled class="subscribe-btn">Підписатися</button>
            </form>
        </div>      

        <div class="bin_years-form">
            <h2>Оновлення вашого плану до Бін+ Yearly</h2>
            <form method="post">
                {% csrf_token %}
                <p>Гаманець: <span>{{ price_converted }}</span></p>
                {% if user.currency == 'USD' %}
                    $49.99 <small>/ р</small>
                {% elif user.currency == 'UAH' %}
                    ₴2099.99 <small>/ р</small>
                {% endif %}
                <div>
                    <input type="checkbox" id="terms-bin-year">
                    <label for="terms-bin-year">Я згоден з <a href="/terms" target="_blank">Умовами користування</a></label>
                </div>
                <button type="submit" name="subscription_plan" value="bin_plus_yearly" id="subscribe-bin-year" disabled class="subscribe-btn">Підписатися</button>
            </form>
        </div>      

        <div class="bin_premium_years-form">
            <h2>Оновлення вашого плану до Бін преміум Yearly</h2>
            <form method="post">
                {% csrf_token %}
                <p>Гаманець: <span>{{ price_converted }}</span></p>
                {% if user.currency == 'USD' %}
                    $99.99 <small>/ р</small>
                {% elif user.currency == 'UAH' %}
                    ₴4199.99 <small>/ р</small>
                {% endif %}
                <div>
                    <input type="checkbox" id="terms-premium-year">
                    <label for="terms-premium-year">Я згоден з <a href="/terms" target="_blank">Умовами користування</a></label>
                </div>
                <button type="submit" name="subscription_plan" value="bin_premium_yearly" id="subscribe-premium-year" disabled class="subscribe-btn">Підписатися</button>
            </form>
        </div>
            {% endif %}

        <div class="security-form">
            <h2>{% if lang == "Українська" %}Безпека{% else %}Security{% endif %}</h2>
            
            <div class="security-section password-section" id="password-section">
                <div class="password-toggle" onclick="togglePasswordForm()">
                    <h4>{% if lang == "Українська" %}Змінити пароль{% else %}Change Password{% endif %}</h4>
                    <div class="password-toggle-arrow">▼</div>
                </div>
                
                <div class="password-form" id="password-form">
                    <form method="POST" action="{% url 'change_password' %}">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="current-password">{% if lang == "Українська" %}Поточний пароль{% else %}Current Password{% endif %}</label>
                            <input type="password" id="current-password" name="current_password" required 
                                   placeholder="{% if lang == 'Українська' %}Введіть поточний пароль{% else %}Enter current password{% endif %}">
                        </div>
                        
                        <div class="form-group">
                            <label for="new-password">{% if lang == "Українська" %}Новий пароль{% else %}New Password{% endif %}</label>
                            <input type="password" id="new-password" name="new_password" required 
                                   placeholder="{% if lang == 'Українська' %}Введіть новий пароль{% else %}Enter new password{% endif %}"
                                   minlength="8">
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">{% if lang == "Українська" %}Підтвердіть пароль{% else %}Confirm Password{% endif %}</label>
                            <input type="password" id="confirm-password" name="confirm_password" required 
                                   placeholder="{% if lang == 'Українська' %}Підтвердіть новий пароль{% else %}Confirm new password{% endif %}">
                        </div>
                        
                        <button type="submit" class="security-btn">
                            {% if lang == "Українська" %}Змінити пароль{% else %}Change Password{% endif %}
                        </button>
                    </form>
                </div>
            </div>
            <div class="security-section">
                <h3>{% if lang == "Українська" %}Двофакторна аутентифікація{% else %}Two-Factor Authentication{% endif %}</h3>
                <p>{% if lang == "Українська" %}Статус: {% else %}Status: {% endif %}
                    <strong>
                        {% if user.two_factor_enabled %}
                            {% if lang == "Українська" %}Увімкнено{% else %}Enabled{% endif %}
                        {% else %}
                            {% if lang == "Українська" %}Вимкнено{% else %}Disabled{% endif %}
                        {% endif %}
                    </strong>
                </p>
                
                <div class="two-factor-buttons">
                    {% if not user.two_factor_enabled %}
                        <form method="POST" action="{% url 'enable_2fa' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="security-btn enable-btn">
                                {% if lang == "Українська" %}Увімкнути 2FA{% else %}Enable 2FA{% endif %}
                            </button>
                        </form>
                    {% else %}
                        <form method="POST" action="{% url 'disable_2fa' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="security-btn disable-btn">
                                {% if lang == "Українська" %}Вимкнути 2FA{% else %}Disable 2FA{% endif %}
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
            
            <div class="security-section">
                <h3>{% if lang == "Українська" %}Активні сесії{% else %}Active Sessions{% endif %}</h3>
                {% if active_sessions %}
                    <div class="sessions-list">
                        {% for session in active_sessions %}
                            <div class="session-item">
                                <div class="session-info">
                                    <strong>IP: {{ session.ip_address }}</strong>
                                    <span>{% if lang == "Українська" %}Остання активність: {% else %}Last activity: {% endif %}{{ session.last_activity|date:"Y-m-d H:i" }}</span>
                                </div>
                                {% if not session.is_current %}
                                    <form method="POST" action="{% url 'terminate_session' %}" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="session_key" value="{{ session.session_key }}">
                                        <button type="submit" class="terminate-btn">
                                            {% if lang == "Українська" %}Завершити{% else %}Terminate{% endif %}
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="current-session">{% if lang == "Українська" %}Поточна{% else %}Current{% endif %}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>{% if lang == "Українська" %}Немає активних сесій{% else %}No active sessions{% endif %}</p>
                {% endif %}
            </div>      

            <div class="security-section">
                <h3>{% if lang == "Українська" %}Історія входів{% else %}Login History{% endif %}</h3>
                {% if login_history %}
                    <div class="login-history">
                        {% for login in login_history %}
                            <div class="login-item">
                                <strong>IP: {{ login.ip_address }}</strong>
                                <span>{{ login.login_time|date:"Y-m-d H:i" }}</span>
                                <span class="status {% if login.success %}success{% else %}failed{% endif %}">
                                    {% if login.success %}
                                        {% if lang == "Українська" %}Успішно{% else %}Success{% endif %}
                                    {% else %}
                                        {% if lang == "Українська" %}Невдало{% else %}Failed{% endif %}
                                    {% endif %}
                                </span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>{% if lang == "Українська" %}Історія входів відсутня{% else %}No login history available{% endif %}</p>
                {% endif %}
            </div>
        </div>
{% endwith %}

<script>
let currentChatUser = null;
let chatSocket = null;
let fileInput = null;
let selectedFile = null;

function openFileInput() {
    document.getElementById('chat-file-input').click();
}

function showFilePreview(file) {
    const oldPreview = document.querySelector('.file-preview');
    if (oldPreview) oldPreview.remove();
    
    const previewDiv = document.createElement('div');
    previewDiv.className = 'file-preview';
    previewDiv.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 2001;
        max-width: 300px;
        animation: slideUp 0.3s ease;
    `;
    
    let previewHTML = '';
    
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewHTML = `
                <div style="margin-bottom: 10px; font-weight: bold;">Изображение: ${file.name}</div>
                <img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 5px;">
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="sendFile()" style="flex:1; padding: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Отправить
                    </button>
                    <button onclick="cancelFile()" style="flex:1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Отмена
                    </button>
                </div>
            `;
            previewDiv.innerHTML = previewHTML;
        };
        reader.readAsDataURL(file);
    } else if (file.type.startsWith('video/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewHTML = `
                <div style="margin-bottom: 10px; font-weight: bold;">Видео: ${file.name}</div>
                <video controls style="max-width: 100%; max-height: 200px; border-radius: 5px;">
                    <source src="${e.target.result}" type="${file.type}">
                    Ваш браузер не поддерживает видео
                </video>
                <div style="color: #666; font-size: 14px; margin: 10px 0;">
                    Тип: ${file.type}<br>
                    Размер: ${(file.size / (1024 * 1024)).toFixed(2)} MB
                </div>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="sendFile()" style="flex:1; padding: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Отправить
                    </button>
                    <button onclick="cancelFile()" style="flex:1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Отмена
                    </button>
                </div>
            `;
            previewDiv.innerHTML = previewHTML;
        };
        reader.readAsDataURL(file);
    } else {
        previewHTML = `
            <div style="margin-bottom: 10px; font-weight: bold;">Файл: ${file.name}</div>
            <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                Тип: ${file.type || 'Неизвестно'}<br>
                Размер: ${(file.size / 1024).toFixed(1)} KB
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button onclick="sendFile()" style="flex:1; padding: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Отправить
                </button>
                <button onclick="cancelFile()" style="flex:1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Отмена
                </button>
            </div>
        `;
        previewDiv.innerHTML = previewHTML;
    }
    
    document.body.appendChild(previewDiv);
}

function createFileInput() {
    if (!fileInput) {
        fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'chat-file-input';
        fileInput.style.display = 'none';
        fileInput.multiple = false;
        fileInput.accept = 'image/*,video/*,.pdf,.doc,.docx,.txt,.zip,.mp4,.avi,.mov,.mkv,.webm';
        
        fileInput.addEventListener('change', handleFileSelect);
        document.body.appendChild(fileInput);
    }
    return fileInput;
}

function handleFileSelect(event) {
    const files = event.target.files;
    if (files.length > 0) {
        const file = files[0];
        
        const maxSize = 20 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('Файл слишком большой. Максимальный размер: 20MB');
            event.target.value = '';
            return;
        }
        
        const allowedTypes = [
            'image/jpeg', 'image/png', 'image/gif', 'image/webp',
            'application/pdf', 'text/plain',
            'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/zip', 'application/x-rar-compressed',
            'video/mp4', 'video/avi', 'video/quicktime', 'video/x-msvideo',
            'video/x-matroska', 'video/webm', 'video/mpeg'
        ];
        
        if (!allowedTypes.includes(file.type) && !file.type.startsWith('video/')) {
            alert('Недопустимый тип файла. Разрешены: изображения, видео, PDF, текстовые файлы, документы');
            event.target.value = '';
            return;
        }
        
        selectedFile = file;
        showFilePreview(selectedFile);
    }
    event.target.value = '';
}

function sendFile() {
    if (!selectedFile || !currentChatUser) {
        cancelFile();
        return;
    }
    
    const textInput = document.getElementById('chat-input');
    const text = textInput.value.trim() || '';
    
    if (currentChatUser === "Bin") {
        alert("Bin only provides verification codes. Please send a text message to get your code.");
        cancelFile();
        return;
    }
    
    if (currentChatUser === "{{ user.username }}") {
        alert("Cannot send files to notes");
        cancelFile();
        return;
    }
    
    const tempMessageId = 'temp-' + Date.now();
    const messagesContainer = document.getElementById('chat-messages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message sent';
    messageDiv.id = tempMessageId;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        let fileContent = '';
        
        if (selectedFile.type.startsWith('image/')) {
            fileContent = `
                <div style="margin: 5px 0;">
                    <strong>Изображение:</strong>
                </div>
                <img src="${e.target.result}" 
                     style="max-width: 250px; max-height: 250px; border-radius: 5px; cursor: pointer;" 
                     onclick="openFileModal('${e.target.result}', '${selectedFile.name}')">
            `;
        } else if (selectedFile.type.startsWith('video/')) {
            fileContent = `
                <div style="margin: 5px 0;">
                    <strong>Видео:</strong>
                </div>
                <video controls style="max-width: 250px; max-height: 250px; border-radius: 5px;"
                       onclick="openVideoModal('${e.target.result}', '${selectedFile.name}', '${selectedFile.type}')">
                    <source src="${e.target.result}" type="${selectedFile.type}">
                    Ваш браузер не поддерживает видео
                </video>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    ${selectedFile.name} (${(selectedFile.size / (1024 * 1024)).toFixed(2)} MB)
                </div>
            `;
        } else {
            fileContent = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin: 5px 0;">
                    <div style="font-weight: bold;">${selectedFile.name}</div>
                    <div style="font-size: 12px; color: #666;">
                        ${selectedFile.type || 'Неизвестный формат'} • 
                        ${(selectedFile.size / 1024).toFixed(1)} KB
                    </div>
                    <div style="color: #999; font-size: 12px; margin-top: 5px;">
                        Отправляется...
                    </div>
                </div>
            `;
        }
        
        messageDiv.innerHTML = `
            <div class="message-sender">Вы</div>
            ${text ? `<div style="margin-bottom: 5px;">${text}</div>` : ''}
            ${fileContent}
            <div class="message-time" style="font-size: 11px; color: #999; margin-top: 4px; text-align: right">
                Отправляется...
            </div>
        `;
        
        const spacer = messagesContainer.querySelector('.chat-messages-spacer');
        if (spacer) {
            messagesContainer.insertBefore(messageDiv, spacer);
        } else {
            messagesContainer.appendChild(messageDiv);
        }
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        sendMessageViaAJAX(text, {
            file: selectedFile,
            fileName: selectedFile.name,
            fileType: selectedFile.type
        });
    };
    
    reader.readAsDataURL(selectedFile);
    
    textInput.value = '';
    selectedFile = null;
    cancelFile();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function cancelFile() {
    selectedFile = null;
    const preview = document.querySelector('.file-preview');
    if (preview) preview.remove();
    if (fileInput) fileInput.value = '';
}

function displayFileMessage(data, isSent) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    
    let fileContent = '';
    const lang = "{{ user.language|default:'English' }}";
    
    if (data.file_type && data.file_type.startsWith('image/')) {
        fileContent = `
            <div style="margin: 5px 0; position: relative;">
                <img src="${data.file_url}" 
                     style="max-width: 250px; max-height: 250px; border-radius: 5px; cursor: pointer;" 
                     onclick="toggleImageZoom('${data.file_url}', event)"
                     oncontextmenu="showImageContextMenu(event, '${data.file_url}', '${data.file_name || 'image'}')"
                     class="zoomable-image"
                     data-fullscreen="false">
            </div>
        `;
    } else if (data.file_type && data.file_type.startsWith('video/')) {
        const videoText = lang === 'Українська' ? 'Відео:' : 'Video:';
        
        fileContent = `
            <div style="margin: 5px 0;">
                <strong>${videoText}</strong>
            </div>
            <div style="position: relative;">
                <video controls style="max-width: 250px; max-height: 250px; border-radius: 5px;"
                       onclick="openVideoModal('${data.file_url}', '${data.file_name}', '${data.file_type}')">
                    <source src="${data.file_url}" type="${data.file_type}">
                    ${lang === 'Українська' ? 'Ваш браузер не підтримує відео' : 'Your browser does not support video'}
                </video>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    ${data.file_name} (${data.file_size ? (data.file_size / (1024 * 1024)).toFixed(2) + ' MB' : ''})
                </div>
            </div>
        `;
    } else {
        const downloadText = lang === 'Українська' ? 'Завантажити' : 'Download';
        const fileText = lang === 'Українська' ? 'Файл:' : 'File:';
        const unknownFormat = lang === 'Українська' ? 'Невідомий формат' : 'Unknown format';
        
        fileContent = `
            <div style="margin: 5px 0;">
                <strong>${fileText}</strong> ${data.file_name}
            </div>
            <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; display: flex; align-items: center; gap: 10px;">
                <div style="font-size: 24px;">📎</div>
                <div>
                    <div style="font-weight: bold;">${data.file_name}</div>
                    <div style="font-size: 12px; color: #666;">
                        ${data.file_type || unknownFormat} • 
                        ${data.file_size ? (data.file_size / 1024).toFixed(1) + ' KB' : ''}
                    </div>
                    <a href="${data.file_url}" download="${data.file_name}" 
                       style="display: inline-block; margin-top: 5px; padding: 3px 10px; background: #007bff; color: white; border-radius: 3px; text-decoration: none; font-size: 12px;">
                        ${downloadText}
                    </a>
                </div>
            </div>
        `;
    }
    
    messageDiv.innerHTML = `
        <div class="message-sender">${isSent ? 'Вы' : data.sender || currentChatUser}</div>
        ${data.text ? `<div style="margin-bottom: 5px;">${data.text}</div>` : ''}
        ${fileContent}
        <div class="message-time" style="font-size: 11px; color: #999; margin-top: 4px; text-align: ${isSent ? 'right' : 'left'}">
            ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
        </div>
    `;
    
    const spacer = messagesContainer.querySelector('.chat-messages-spacer');
    if (spacer) {
        messagesContainer.insertBefore(messageDiv, spacer);
    } else {
        messagesContainer.appendChild(messageDiv);
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showImageContextMenu(event, imageUrl, fileName) {
    event.preventDefault();
    
    const existingMenu = document.querySelector('.image-context-menu');
    if (existingMenu) existingMenu.remove();
    
    const lang = "{{ user.language|default:'English' }}";
    const downloadText = lang === 'Українська' ? 'Завантажити' : 'Download';
    const zoomInText = lang === 'Українська' ? 'Збільшити' : 'Zoom in';
    const zoomOutText = lang === 'Українська' ? 'Зменшити' : 'Zoom out';
    
    const imageElement = event.target;
    const isFullscreen = imageElement.getAttribute('data-fullscreen') === 'true';
    
    const contextMenu = document.createElement('div');
    contextMenu.className = 'image-context-menu';
    contextMenu.style.cssText = `
        position: fixed;
        top: ${event.clientY}px;
        left: ${event.clientX}px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 10000;
        min-width: 150px;
    `;
    
    contextMenu.innerHTML = `
        <div style="display: flex; flex-direction: column;">
            <button type="button" 
                    style="padding: 10px 15px; border: none; background: white; text-align: left; cursor: pointer; border-bottom: 1px solid #eee;"
                    onclick="downloadImage('${imageUrl}', '${fileName}')">
                ${downloadText}
            </button>
            <button type="button" 
                    style="padding: 10px 15px; border: none; background: white; text-align: left; cursor: pointer;"
                    onclick="${isFullscreen ? 'zoomOutImage(event)' : 'zoomInImage(event)'}; this.parentNode.parentNode.remove();">
                ${isFullscreen ? '' + zoomOutText : '' + zoomInText}
            </button>
        </div>
    `;
    
    document.body.appendChild(contextMenu);
    
    const closeMenu = (e) => {
        if (!contextMenu.contains(e.target)) {
            contextMenu.remove();
            document.removeEventListener('click', closeMenu);
        }
    };
    
    setTimeout(() => {
        document.addEventListener('click', closeMenu);
    }, 100);
}

function zoomInImage(event) {
    event.preventDefault();
    const img = event.target.closest('img') || document.elementFromPoint(event.clientX, event.clientY);
    if (!img || !img.classList.contains('zoomable-image')) return;
    
    img.setAttribute('data-fullscreen', 'true');
    img.setAttribute('data-original-style', img.style.cssText);
    
    const originalWidth = img.offsetWidth;
    const originalHeight = img.offsetHeight;
    img.setAttribute('data-original-width', originalWidth);
    img.setAttribute('data-original-height', originalHeight);
    
    const rect = img.getBoundingClientRect();
    img.style.position = 'fixed';
    img.style.top = `${rect.top}px`;
    img.style.left = `${rect.left}px`;
    img.style.width = `${originalWidth}px`;
    img.style.height = `${originalHeight}px`;
    img.style.zIndex = '9998';
    img.style.transition = 'all 0.3s ease';
    img.style.cursor = 'zoom-out';
    
    setTimeout(() => {
        img.style.top = '50%';
        img.style.left = '50%';
        img.style.transform = 'translate(-50%, -50%)';
        img.style.width = 'auto';
        img.style.height = 'auto';
        img.style.maxWidth = '95vw';
        img.style.maxHeight = '95vh';
        img.style.objectFit = 'contain';
        img.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
        img.style.padding = '20px';
        img.style.borderRadius = '0';
        img.style.boxShadow = '0 0 30px rgba(0, 0, 0, 0.5)';
        
        addZoomOverlay();
    }, 10);
}

function zoomOutImage(event) {
    event.preventDefault();
    const img = event.target.closest('img') || document.querySelector('img[data-fullscreen="true"]');
    if (!img) return;
    
    img.setAttribute('data-fullscreen', 'false');
    
    const originalWidth = img.getAttribute('data-original-width');
    const originalHeight = img.getAttribute('data-original-height');
    const originalStyle = img.getAttribute('data-original-style');
    
    img.style.transform = '';
    img.style.transition = 'all 0.3s ease';
    img.style.width = `${originalWidth}px`;
    img.style.height = `${originalHeight}px`;
    
    setTimeout(() => {
        if (originalStyle) {
            img.style.cssText = originalStyle;
        } else {
            img.style.position = '';
            img.style.top = '';
            img.style.left = '';
            img.style.transform = '';
            img.style.zIndex = '';
            img.style.backgroundColor = '';
            img.style.padding = '';
            img.style.borderRadius = '5px';
            img.style.maxWidth = '250px';
            img.style.maxHeight = '250px';
            img.style.width = '';
            img.style.height = '';
            img.style.cursor = 'pointer';
            img.style.boxShadow = '';
            img.style.objectFit = '';
        }
        
        removeZoomOverlay();
    }, 300);
}

function toggleImageZoom(imageUrl, event) {
    event.stopPropagation();
    event.preventDefault();
    const img = event.target;
    const isFullscreen = img.getAttribute('data-fullscreen') === 'true';
    
    if (isFullscreen) {
        zoomOutImage({ target: img, preventDefault: () => {} });
    } else {
        zoomInImage({ target: img, preventDefault: () => {} });
    }
}

function addZoomOverlay() {
    const existingOverlay = document.querySelector('.zoom-overlay');
    if (existingOverlay) existingOverlay.remove();
    
    const overlay = document.createElement('div');
    overlay.className = 'zoom-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9997;
        cursor: zoom-out;
    `;
    
    overlay.addEventListener('click', function(e) {
        const fullscreenImg = document.querySelector('img[data-fullscreen="true"]');
        if (fullscreenImg) {
            zoomOutImage({ target: fullscreenImg, preventDefault: () => {} });
        }
    });
    
    document.body.appendChild(overlay);
}

function removeZoomOverlay() {
    const overlay = document.querySelector('.zoom-overlay');
    if (overlay) overlay.remove();
}

function downloadImage(url, filename) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename || 'image.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    const contextMenu = document.querySelector('.image-context-menu');
    if (contextMenu) contextMenu.remove();
}

function openFileModal(url, filename) {
    const lang = "{{ user.language|default:'English' }}";
    const closeText = lang === 'Українська' ? 'Закрити' : '';
    const downloadText = lang === 'Українська' ? 'Завантажити' : '';
    
    const modal = document.createElement('div');
    modal.className = 'file-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 3000;
    `;
    
    modal.innerHTML = `
        <div style="position: relative; text-align: center;">
            <img src="${url}" 
                 style="max-width: 90vw; max-height: 85vh; border-radius: 5px; cursor: pointer;"
                 alt="${filename}"
                 onclick="closeFileModal()"
                 oncontextmenu="showImageContextMenu(event, '${url}', '${filename}')">
        </div>
    `;
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeFileModal();
        }
    });
    
    document.body.appendChild(modal);
}

function closeFileModal() {
    const modal = document.querySelector('.file-modal');
    if (modal) modal.remove();
}

const zoomStyles = `
    img.zoomable-image[data-fullscreen="true"] {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: auto !important;
        height: auto !important;
        max-width: 95vw !important;
        max-height: 95vh !important;
        object-fit: contain !important;
        background-color: rgba(0, 0, 0, 0.9) !important;
        z-index: 9998 !important;
        cursor: zoom-out !important;
        border-radius: 0 !important;
        padding: 20px !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.5) !important;
    }
    
    .zoom-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9997;
        cursor: zoom-out;
    }
    
    .image-context-menu {
        animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
`;

if (!document.querySelector('#zoom-styles')) {
    const styleEl = document.createElement('style');
    styleEl.id = 'zoom-styles';
    styleEl.textContent = zoomStyles;
    document.head.appendChild(styleEl);
}

// rest ========================================================================================================

function addAttachmentButton() {
    const chatInputContainer = document.querySelector('.chat-input-container');
    if (!chatInputContainer) return;
    
    const oldButton = chatInputContainer.querySelector('.attach-btn');
    if (oldButton) oldButton.remove();
    
    const attachButton = document.createElement('button');
    attachButton.className = 'attach-btn';
    attachButton.type = 'button';
    attachButton.innerHTML = '📎';
    attachButton.title = 'Прикрепить файл';
    attachButton.style.cssText = `
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 5px 10px;
        color: #666;
    `;
    
    attachButton.addEventListener('click', function() {
        const fileInput = createFileInput();
        fileInput.click();
    });
    
    const chatInput = document.getElementById('chat-input');
    chatInputContainer.insertBefore(attachButton, chatInput);
}

function openChat(username) {
    currentChatUser = username;
    document.getElementById('chat-username').textContent = username;
    document.getElementById('chat-toggle').checked = true;
    
    addAttachmentButton();
}

document.addEventListener('DOMContentLoaded', function() {
    const newPassword = document.getElementById('new-password');
    const confirmPassword = document.getElementById('confirm-password');
    
    function validatePasswords() {
        if (newPassword.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('Passwords do not match');
        } else {
            confirmPassword.setCustomValidity('');
        }
    }
    
    if (newPassword && confirmPassword) {
        newPassword.addEventListener('input', validatePasswords);
        confirmPassword.addEventListener('input', validatePasswords);
    }
});

function togglePasswordForm() {
    const passwordSection = document.getElementById('password-section');
    const passwordForm = document.getElementById('password-form');
    
    if (passwordSection.classList.contains('expanded')) {
        passwordSection.classList.remove('expanded');
        setTimeout(() => {
            passwordForm.style.display = 'none';
        }, 300);
    } else {
        passwordForm.style.display = 'block';
        setTimeout(() => {
            passwordSection.classList.add('expanded');
        }, 10);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        const passwordSection = document.getElementById('password-section');
        if (passwordSection && passwordSection.classList.contains('expanded') && 
            !passwordSection.contains(e.target)) {
            passwordSection.classList.remove('expanded');
            setTimeout(() => {
                const passwordForm = document.getElementById('password-form');
                if (passwordForm) passwordForm.style.display = 'none';
            }, 300);
        }
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const newPassword = document.getElementById('new-password');
    const confirmPassword = document.getElementById('confirm-password');
    
    function validatePasswords() {
        if (newPassword.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('Passwords do not match');
        } else {
            confirmPassword.setCustomValidity('');
        }
    }
    
    if (newPassword && confirmPassword) {
        newPassword.addEventListener('input', validatePasswords);
        confirmPassword.addEventListener('input', validatePasswords);
    }
    
    document.addEventListener('click', function(e) {
        const passwordSection = document.getElementById('password-section');
        if (passwordSection && passwordSection.classList.contains('expanded') && 
            !passwordSection.contains(e.target)) {
            passwordSection.classList.remove('expanded');
            setTimeout(() => {
                const passwordForm = document.getElementById('password-form');
                if (passwordForm) passwordForm.style.display = 'none';
            }, 300);
        }
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const backgroundInput = document.getElementById('backgroundInput');
    const previewBackground = document.getElementById('preview-background');
    const mainProfileBackground = document.getElementById('main-profile-background');
    const deleteBackgroundBtn = document.querySelector('.btn-delete-background');
    const userSubscribe = "{{ user.subscribe }}";

    function syncBackgrounds() {
        if (previewBackground && mainProfileBackground) {
            if (previewBackground.style.backgroundImage && previewBackground.style.backgroundImage !== 'none') {
                mainProfileBackground.style.backgroundImage = previewBackground.style.backgroundImage;
                mainProfileBackground.style.display = previewBackground.style.display;
            }
            else if (mainProfileBackground.style.backgroundImage && mainProfileBackground.style.backgroundImage !== 'none') {
                previewBackground.style.backgroundImage = mainProfileBackground.style.backgroundImage;
                previewBackground.style.display = mainProfileBackground.style.display;
            }
        }
        
        if (deleteBackgroundBtn) {
            const hasBackground = (previewBackground && previewBackground.style.backgroundImage && previewBackground.style.backgroundImage !== 'none') ||
                                (mainProfileBackground && mainProfileBackground.style.backgroundImage && mainProfileBackground.style.backgroundImage !== 'none');
            deleteBackgroundBtn.disabled = !hasBackground;
        }
    }

    syncBackgrounds();

    if (backgroundInput) {
        if (userSubscribe === 'Bin+') {
            backgroundInput.accept = "image/*";
        } else if (userSubscribe === 'Bin_premium') {
            backgroundInput.accept = "image/*,image/gif";
        }

        backgroundInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (userSubscribe === 'Basic') {
                alert('Background feature available only for Bin+ and Bin Premium subscriptions');
                e.target.value = '';
                return;
            }
            
            if (userSubscribe === 'Bin+' && file.type === 'image/gif') {
                alert('GIF backgrounds available only for Bin Premium subscription');
                e.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                previewBackground.style.backgroundImage = `url('${event.target.result}')`;
                previewBackground.style.display = 'block';
                
                if (deleteBackgroundBtn) {
                    deleteBackgroundBtn.disabled = false;
                }
                
                syncBackgrounds();
            };
            reader.readAsDataURL(file);
        });
    }

    const themeSelect = document.getElementById('themeSelect');
    if (themeSelect) {
        themeSelect.addEventListener('change', function() {
            setTimeout(syncBackgrounds, 100);
        });
    }
});

window.confirmBackgroundReset = function() {
    const lang = "{{ user.language|default:'English' }}";
    const confirmMsg = lang === 'Українська'
        ? "Ви впевнені, що хочете видалити фон профілю?"
        : "Are you sure you want to remove the background?";

    if (confirm(confirmMsg)) {
        const previewBackground = document.getElementById('preview-background');
        const mainProfileBackground = document.getElementById('main-profile-background');
        const deleteBackgroundBtn = document.querySelector('.btn-delete-background');
        
        if (previewBackground) {
            previewBackground.style.backgroundImage = 'none';
            previewBackground.style.display = 'none';
        }
        
        if (mainProfileBackground) {
            mainProfileBackground.style.backgroundImage = 'none';
            mainProfileBackground.style.display = 'none';
        }
        
        if (deleteBackgroundBtn) {
            deleteBackgroundBtn.disabled = true;
        }
        
        let removeBackgroundInput = document.getElementById('remove-background-input');
        if (!removeBackgroundInput) {
            removeBackgroundInput = document.createElement('input');
            removeBackgroundInput.type = 'hidden';
            removeBackgroundInput.name = 'remove_background';
            removeBackgroundInput.id = 'remove-background-input';
            const editProfileForm = document.getElementById('edit-profile-form');
            if (editProfileForm) {
                editProfileForm.appendChild(removeBackgroundInput);
            }
        }
        removeBackgroundInput.value = 'true';
        
        const successMsg = lang === 'Українська' 
            ? 'Фон успішно видалено!' 
            : 'Background successfully removed!';
        alert(successMsg);
    }
};

function updateBackgroundAccessibility() {
    const backgroundInput = document.getElementById('backgroundInput');
    const backgroundLabel = backgroundInput ? backgroundInput.closest('label') : null;
    const userSubscribe = "{{ user.subscribe }}";
    
    if (backgroundInput && backgroundLabel) {
        if (userSubscribe === 'Basic') {
            backgroundInput.disabled = true;
            backgroundLabel.style.opacity = '0.6';
            backgroundLabel.style.cursor = 'not-allowed';
            backgroundInput.title = "Background feature available for Bin+ and Bin Premium subscribers";
        } else {
            backgroundInput.disabled = false;
            backgroundLabel.style.opacity = '1';
            backgroundLabel.style.cursor = 'pointer';
            
            if (userSubscribe === 'Bin+') {
                backgroundInput.accept = "image/*";
                backgroundInput.title = "Images only (GIF backgrounds available for Bin Premium)";
            } else if (userSubscribe === 'Bin_premium') {
                backgroundInput.accept = "image/*,image/gif";
                backgroundInput.title = "All image formats including GIF";
            }
        }
    }
}

document.addEventListener('DOMContentLoaded', updateBackgroundAccessibility); 

function formatNumber(number) {
    return number.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$& ');
}

function getUserWalletAmount() {
    const walletText = document.getElementById('wallet-amount').textContent;
    const amountMatch = walletText.match(/([\d\s,]+\.?\d*)/);
    if (amountMatch) {
        const amountStr = amountMatch[1].replace(/\s/g, '').replace(',', '');
        return parseFloat(amountStr);
    }
    return 0;
}

function getUserCurrency() {
    const select = document.querySelector('select[name="currency"]');
    return select ? select.value : 'USD';
}

function updateAllCurrenciesFromUserWallet() {
    const userAmount = getUserWalletAmount();
    const userCurrency = getUserCurrency();
    
    if (userAmount === 0) return;
    
    const exchangeRates = {
        'USD': {'USD': 1.0, 'EUR': 0.87, 'GBP': 0.773, 'UAH': 42.1},
        'UAH': {'USD': 0.024, 'EUR': 0.021, 'GBP': 0.0186, 'UAH': 1.0}
    };
    
    const rates = exchangeRates[userCurrency];
    
    if (userCurrency !== 'USD') {
        document.getElementById('usd-amount').textContent = `${formatNumber(userAmount * rates.USD)}$ USD`;
    } else {
        document.getElementById('usd-amount').textContent = `${formatNumber(userAmount)}$ USD`;
    }
    
    document.getElementById('eur-amount').textContent = `${formatNumber(userAmount * rates.EUR)}€ EUR`;
    document.getElementById('gbp-amount').textContent = `${formatNumber(userAmount * rates.GBP)}£ GBP`;
    
    if (userCurrency !== 'UAH') {
        document.getElementById('uah-amount').textContent = `${formatNumber(userAmount * rates.UAH)}₴ UAH`;
    } else {
        document.getElementById('uah-amount').textContent = `${formatNumber(userAmount)}₴ UAH`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        updateAllCurrenciesFromUserWallet();
    }, 100);
});

document.querySelector('select[name="currency"]').addEventListener('change', function() {
    setTimeout(() => {
        updateAllCurrenciesFromUserWallet();
    }, 500);
});

function observeWalletChanges() {
    const walletElement = document.getElementById('wallet-amount');
    if (walletElement) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'characterData' || mutation.type === 'childList') {
                    updateAllCurrenciesFromUserWallet();
                }
            });
        });
        
        observer.observe(walletElement, {
            characterData: true,
            childList: true,
            subtree: true
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        updateAllCurrenciesFromUserWallet();
        observeWalletChanges();
    }, 100);
});

// Чат
// ====================================================================================================================
function processMentionsStrict(text) {
    if (!text || typeof text !== 'string') {
        return '';
    }
    
    if (/<[^>]*>/.test(text)) {
        return text;
    }
    
    const mentionRegex = /(^|\s|\(|\[)@([\wа-яА-ЯёЁ_\d]+)/gi;
    
    return text.replace(mentionRegex, function(match, prefix, username) {
        const fullMention = `@${username}`;
        const lowerUsername = username.toLowerCase();
        
        if (lowerUsername === 'bin_bot') {
            return `${prefix}<span class="message-mention profile-mention bin-mention" 
                    data-username="@Bin_bot"
                    title="Открыть чат с ботом Bin">
                    @Bin_bot
                    </span>`;
        }
        
        return `${prefix}<span class="message-mention profile-mention" 
                data-username="@${username}">
                @${username}
                </span>`;
    });
}

function processMentions(text) {
    if (!text || typeof text !== 'string') {
        return '';
    }
    
    const mentionRegex = /@(\w+)/gi;
    
    return text.replace(mentionRegex, function(match, username) {
        const lowerUsername = username.toLowerCase();
        
        if (lowerUsername === 'bin_bot') {
            return `<span class="message-mention bin-mention" 
                    data-username="@Bin_bot"
                    onclick="openChat('Bin')"
                    style="cursor:pointer; color:#007bff; font-weight:bold;">
                    @Bin_bot
                    </span>`;
        }
        
        return `<span class="message-mention" 
                data-username="@${username}">
                @${username}
                </span>`;
    });
}

function processMentionsWithBin(text) {
    if (!text) return '';
    
    const mentionRegex = /(@[\wа-яА-ЯёЁ_\d]+)/gi;
    
    return text.replace(mentionRegex, function(match) {
        const username = match.toLowerCase();
        if (username === "@bin_bot") {
            return `<span class="message-mention profile-mention" data-username="${match}" onclick="openChat('Bin')">${match}</span>`;
        }
        return `<span class="message-mention profile-mention" data-username="${match}">${match}</span>`;
    });
}

function addMentionEventListeners(element) {
    const mentions = element.querySelectorAll('.message-mention, .profile-mention');
    
    mentions.forEach(mention => {
        const username = mention.getAttribute('data-username');
        
        if (!username) {
            mention.classList.remove('message-mention', 'profile-mention');
            mention.style.color = '';
            mention.style.cursor = 'default';
            mention.style.fontWeight = 'normal';
            mention.style.textDecoration = 'none';
            return;
        }
        
        const usernameLower = username.toLowerCase();
        const cleanUsername = username.replace('@', '');
        
        if (usernameLower === "@bin_bot") {
            mention.replaceWith(mention.cloneNode(true));
            const newMention = element.querySelector(`[data-username="${username}"]`);
            
            newMention.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                closeProfileModals();
                openChat('Bin');
            });
            
            newMention.style.cursor = 'pointer';
            newMention.style.color = '#007bff';
            newMention.style.fontWeight = 'bold';
            newMention.style.textDecoration = 'none';
            newMention.classList.add('bin-mention');
            return;
        }
        
        checkUserExists(cleanUsername).then(exists => {
            if (!exists) {
                mention.classList.remove('message-mention', 'profile-mention');
                mention.style.color = '';
                mention.style.fontWeight = 'normal';
                mention.style.cursor = 'text';
                mention.style.textDecoration = 'none';
                mention.removeAttribute('data-username');
                mention.removeAttribute('onclick');
                return;
            }
            
            mention.replaceWith(mention.cloneNode(true));
            const newMention = element.querySelector(`[data-username="${username}"]`);
            
            newMention.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                closeProfileModals();
                openUserProfile(cleanUsername);
            });
            
            newMention.addEventListener('mouseenter', function() {
                this.style.textDecoration = 'underline';
                this.style.opacity = '0.9';
            });
            
            newMention.addEventListener('mouseleave', function() {
                this.style.textDecoration = 'none';
                this.style.opacity = '1';
            });
            
            newMention.style.cursor = 'pointer';
            newMention.style.color = '#007bff';
            newMention.style.fontWeight = 'bold';
        }).catch(error => {
            console.error('Error checking user existence:', error);
            mention.classList.remove('message-mention', 'profile-mention');
            mention.style.color = '';
            mention.style.cursor = 'default';
        });
    });
}

function displayMessage(data, isSent) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    
    if (data.sender === "Bin") {
        messageDiv.style.borderLeft = '3px solid #007bff';
        messageDiv.style.background = 'linear-gradient(135deg, #f0f8ff, #e6f7ff)';
    }
    
    if (data.text && data.text.trim()) {
        const textDiv = document.createElement('div');
        const processedText = processMentions(data.text);
        textDiv.innerHTML = processedText;
        contentDiv.appendChild(textDiv);
        
        addMentionEventListeners(textDiv);
    }
    
    if (data.file_url) {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-attachment';
        
        if (data.file_type && data.file_type.startsWith('image/')) {
            fileDiv.innerHTML = `
                <div style="margin: 5px 0;">
                    <img src="${data.file_url}" 
                         style="max-width: 250px; max-height: 250px; border-radius: 5px; cursor: pointer;" 
                         onclick="openFileModal('${data.file_url}', '${data.file_name || 'image'}')">
                </div>
            `;
        } else {
            fileDiv.innerHTML = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin: 5px 0;">
                    <a href="${data.file_url}" download="${data.file_name || 'file'}" 
                       style="color: #007bff; text-decoration: none;">
                        📎 ${data.file_name || 'Файл'}
                    </a>
                </div>
            `;
        }
        contentDiv.appendChild(fileDiv);
    }
    
    messageDiv.appendChild(contentDiv);
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.style.fontSize = '11px';
    timeDiv.style.color = '#999';
    timeDiv.style.marginTop = '4px';
    timeDiv.style.textAlign = isSent ? 'right' : 'left';
    
    const messageDate = data.timestamp ? new Date(data.timestamp) : new Date();
    timeDiv.textContent = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    messageDiv.appendChild(timeDiv);
    
    const spacer = messagesContainer.querySelector('.chat-messages-spacer');
    if (spacer) {
        messagesContainer.insertBefore(messageDiv, spacer);
    } else {
        messagesContainer.appendChild(messageDiv);
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function processProfileDescription() {
    const descriptionElements = document.querySelectorAll('.profile-preview-value, .other-profile-description');
    
    descriptionElements.forEach(element => {
        const originalText = element.innerHTML;
        const processedText = processMentions(originalText);
        element.innerHTML = processedText;
        addMentionEventListeners(element);
    });
}

function showUserProfileModal(userData) {
    closeAllModals();
    
    const otherProfileForm = document.querySelector('.other-profile-form');
    if (!otherProfileForm) return;
    
    const userLang = "{{ user.language|default:'English' }}";
    
    const avatarImg = otherProfileForm.querySelector('.other-profile-avatar');
    if (avatarImg) {
        avatarImg.src = userData.photo_url || '/static/pictures/login.png';
        avatarImg.alt = userData.username;
    }
    
    const usernameEl = otherProfileForm.querySelector('.other-profile-username');
    if (usernameEl) {
        usernameEl.textContent = userData.username;
    }
    
    const tagEl = otherProfileForm.querySelector('.other-profile-tag');
    if (tagEl) {
        const tagText = userData.your_tag || `@${userData.username}`;
        tagEl.textContent = tagText;
        tagEl.onclick = function() {
            navigator.clipboard.writeText(tagText)
                .then(() => {
                    const lang = "{{ user.language|default:'English' }}";
                    alert(lang === 'Українська' ? 'Тег скопійовано!' : 'Tag copied!');
                })
                .catch(err => console.error('Copy failed:', err));
        };
    }
    
    const statusEl = otherProfileForm.querySelector('.other-profile-status');
    if (statusEl) {
        const statusText = userData.status || 'Offline';
        statusEl.textContent = `● ${statusText}`;
        statusEl.className = `status-value ${(statusText || '').toLowerCase() === 'online' ? 'online' : 'offline'}`;
    }
    
    const roleContainer = otherProfileForm.querySelector('#other-profile-role');
    if (roleContainer) {
        roleContainer.innerHTML = '';
        
        let roleHtml = '';
        let displayText = '';
        
        if (userData.role === "System Bot" || (userData.display_role && userData.display_role.includes("🤖"))) {
            displayText = userData.display_role || '🤖 System Bot';
            roleHtml = `<span style="background: linear-gradient(135deg, #667eea, #764ba2); 
                        color: white; 
                        padding: 4px 12px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: bold;
                        display: inline-block;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ${displayText}
            </span>`;
        } 
        else if (userData.role === "Administrator" || (userData.display_role && userData.display_role.includes("👑"))) {
            displayText = userData.display_role || '👑 Administrator';
            roleHtml = `<span style="background: linear-gradient(135deg, #dc3545, #c82333); 
                        color: white; 
                        padding: 4px 12px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: bold;
                        display: inline-block;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ${displayText}
            </span>`;
        } 
        else if (userData.role === "Moderator" || (userData.display_role && userData.display_role.includes("🛡️"))) {
            displayText = userData.display_role || '🛡️ Moderator';
            roleHtml = `<span style="background: linear-gradient(135deg, #ffc107, #e0a800); 
                        color: #212529; 
                        padding: 4px 12px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: bold;
                        display: inline-block;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ${displayText}
            </span>`;
        }
        else if (userData.role === "User" || !userData.role) {
            displayText = userData.subscribe === 'System' ? '🤖 Bot' : (userLang === 'Українська' ? '👤 Користувач' : '👤 User');
            roleHtml = `<span style="background: #f8f9fa; 
                        color: #6c757d; 
                        padding: 4px 12px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: 500;
                        display: inline-block;
                        border: 1px solid #dee2e6;">
                ${displayText}
            </span>`;
        }
        
        if (roleHtml) {
            roleContainer.innerHTML = roleHtml;
            roleContainer.style.display = 'block';
        } else {
            roleContainer.style.display = 'none';
        }
    }
    
    const descriptionEl = otherProfileForm.querySelector('.other-profile-description');
    if (descriptionEl) {
        let processedDescription = userData.description || (userLang === 'Українська' ? 'Немає опису' : 'No description');
        
        if (userData.username === "Bin") {
            processedDescription = processedDescription.replace(
                /@Bin_bot\b/gi, 
                '@Bin_bot'
            );
        }
        
        processedDescription = processMentionsStrict(processedDescription);
        descriptionEl.innerHTML = processedDescription;
        
        addMentionEventListeners(descriptionEl);
    }
    
    const birthdayEl = otherProfileForm.querySelector('.other-profile-birthday');
    if (birthdayEl) {
        const birthdayText = userData.birthday || (userLang === 'Українська' ? 'Не вказано' : 'Not specified');
        birthdayEl.textContent = birthdayText;
    }
    
    const backgroundEl = otherProfileForm.querySelector('.profile-preview-background');
    if (backgroundEl && userData.background_url) {
        backgroundEl.style.backgroundImage = `url('${userData.background_url}')`;
        backgroundEl.style.display = 'block';
    }
    
    const roleLabel = otherProfileForm.querySelector('.profile-preview-label[for="role"]');
    if (!roleLabel) {
        const roleSection = document.createElement('div');
        roleSection.className = 'profile-preview-section';
        roleSection.innerHTML = `
            <div class="profile-preview-label">${userLang === 'Українська' ? 'Роль' : 'Role'}</div>
            <div id="other-profile-role" class="profile-preview-value"></div>
        `;
        
        const descriptionSection = otherProfileForm.querySelector('.profile-preview-section');
        if (descriptionSection) {
            descriptionSection.parentNode.insertBefore(roleSection, descriptionSection.nextSibling);
        }
    }
    
    const messageBtn = otherProfileForm.querySelector('.other-profile-message-btn');
    if (messageBtn) {
        messageBtn.onclick = function() {
            const otherProfileToggle = document.getElementById('other-profile-toggle');
            if (otherProfileToggle) otherProfileToggle.checked = false;
            
            if (userData.username === "Bin") {
                openBinLogin();
            } else {
                openChat(userData.username);
            }
        };
        
        if (userData.username === "Bin") {
            messageBtn.textContent = userLang === 'Українська' ? "Отримати код верифікації" : "Get Verification Code";
            messageBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        } else {
            messageBtn.textContent = userLang === 'Українська' ? "Написати повідомлення" : "Message";
            messageBtn.style.background = '#007bff';
        }
    }
    
    const otherProfileToggle = document.getElementById('other-profile-toggle');
    if (otherProfileToggle) {
        otherProfileToggle.checked = true;
    }
    
    console.log('User profile loaded:', {
        username: userData.username,
        role: userData.role,
        display_role: userData.display_role,
        subscribe: userData.subscribe,
        status: userData.status
    });
    
    setTimeout(() => {
        const otherProfileDesc = otherProfileForm.querySelector('.other-profile-description');
        if (otherProfileDesc) {
            const processedText = processMentionsStrict(otherProfileDesc.innerHTML);
            otherProfileDesc.innerHTML = processedText;
            addMentionEventListeners(otherProfileDesc);
        }
    }, 100);
}

document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        if (e.target.matches('.other-profile-form .message-mention, .other-profile-form .profile-mention')) {
            e.preventDefault();
            e.stopPropagation();
            const username = e.target.getAttribute('data-username').replace('@', '');
            openUserProfile(username);
        }
    });
});

function loadChatMessages(username) {
    if (username === "Bin") {
        fetch(`/get-bin-messages/`)
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(messages => {
                console.log('Loaded Bin messages:', messages);
                displayBinMessages(messages);
                
                if (messages.length === 0) {
                    const lang = "{{ user.language|default:'English' }}";
                    const welcomeMessage = lang === 'Українська' 
                        ? "Привіт! Я Bin. Надішліть будь-яке повідомлення, щоб отримати код верифікації."
                        : "Hello! I'm Bin. Send any message to get your verification code.";
                    
                    setTimeout(() => {
                        displayMessage({
                            text: welcomeMessage,
                            sender: "Bin",
                            timestamp: new Date().toISOString(),
                            is_sent: false
                        }, false);
                    }, 300);
                }
            })
            .catch(error => {
                console.error('Error loading Bin messages:', error);
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = '<div class="chat-messages-spacer"></div>';
                    
                    const lang = "{{ user.language|default:'English' }}";
                    const welcomeMessage = lang === 'Українська' 
                        ? "Привіт! Я Bin. Надішліть будь-яке повідомлення, щоб отримати код верифікації."
                        : "Hello! I'm Bin. Send any message to get your verification code.";
                    
                    setTimeout(() => {
                        displayMessage({
                            text: welcomeMessage,
                            sender: "Bin",
                            timestamp: new Date().toISOString(),
                            is_sent: false
                        }, false);
                    }, 300);
                }
            });
        return;
    }
    if (username === "{{ user.username }}") {
        fetch(`/get-notes/`)
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(notes => {
                displayNotes(notes);
            })
            .catch(error => {
                console.error('Error loading notes from server:', error);
                const localNotes = JSON.parse(localStorage.getItem('user_notes') || '[]');
                displayNotes(localNotes);
            });
        return;
    }
    
    fetch(`/get-chat-messages/?username=${encodeURIComponent(username)}`)
        .then(response => response.json())
        .then(messages => {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            const spacer = messagesContainer.querySelector('.chat-messages-spacer');
            messagesContainer.innerHTML = '';
            if (spacer) {
                messagesContainer.appendChild(spacer);
            } else {
                const newSpacer = document.createElement('div');
                newSpacer.className = 'chat-messages-spacer';
                messagesContainer.appendChild(newSpacer);
            }
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.is_sent ? 'sent' : 'received'}`;
                
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = msg.sender;
                messageDiv.appendChild(senderDiv);
                
                const contentDiv = document.createElement('div');
                
                if (msg.text) {
                    const textDiv = document.createElement('div');
                    const processedText = processMentions(msg.text);
                    textDiv.innerHTML = processedText;
                    contentDiv.appendChild(textDiv);
                }
                
                if (msg.file_url) {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-attachment';
                    
                    if (msg.file_type && msg.file_type.startsWith('image/')) {
                        fileDiv.innerHTML = `
                            <div style="margin: 5px 0;">
                                <img src="${msg.file_url}" 
                                     style="max-width: 250px; max-height: 250px; border-radius: 5px; cursor: pointer;" 
                                     onclick="openFileModal('${msg.file_url}', '${msg.file_name || 'image'}')">
                            </div>
                        `;
                    } else {
                        fileDiv.innerHTML = `
                            <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin: 5px 0;">
                                <a href="${msg.file_url}" download="${msg.file_name || 'file'}" 
                                   style="color: #007bff; text-decoration: none;">
                                    📎 ${msg.file_name || 'Файл'}
                                </a>
                            </div>
                        `;
                    }
                    contentDiv.appendChild(fileDiv);
                }
                
                messageDiv.appendChild(contentDiv);
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.style.fontSize = '11px';
                timeDiv.style.color = '#999';
                timeDiv.style.marginTop = '4px';
                timeDiv.style.textAlign = msg.is_sent ? 'right' : 'left';
                
                const messageDate = new Date(msg.timestamp);
                timeDiv.textContent = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                messageDiv.appendChild(timeDiv);
                
                const spacer = messagesContainer.querySelector('.chat-messages-spacer');
                if (spacer) {
                    messagesContainer.insertBefore(messageDiv, spacer);
                } else {
                    messagesContainer.appendChild(messageDiv);
                }
                
                if (msg.text) {
                    addMentionEventListeners(messageDiv);
                }
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        })
        .catch(error => {
            console.error('Error loading chat messages:', error);
        });
}

function sendFile() {
    if (!selectedFile || !currentChatUser) {
        cancelFile();
        return;
    }
    
    if (currentChatUser === "Bin") {
        alert("Bin only provides verification codes. Please send a text message to get your code.");
        cancelFile();
        return;
    }
}

const binContact = {
    username: "Bin",
    avatar_url: "/static/pictures/Bin.jpg", 
    last_message: "Get verification code",
    last_activity: new Date().toISOString(),
    unread_count: 0
};

document.addEventListener('DOMContentLoaded', function() {
    processProfileDescription();
    
    document.addEventListener('click', function(e) {
        if (e.target.matches('.message-mention, .profile-mention')) {
            e.preventDefault();
            const username = e.target.getAttribute('data-username').replace('@', '');
            openUserProfile(username);
        }
        
        if (e.target.matches('.profile-preview-value a[href*="profile="]')) {
            e.preventDefault();
            const url = new URL(e.target.href);
            const profileUsername = url.searchParams.get('profile');
            if (profileUsername) {
                openUserProfile(profileUsername);
            }
        }
    });
    
    const chatOverlay = document.querySelector('.chat-overlay');
    if (chatOverlay) {
        chatOverlay.addEventListener('click', closeChat);
    }
    
    const closeChatBtn = document.querySelector('.close-chat');
    if (closeChatBtn) {
        closeChatBtn.addEventListener('click', closeChat);
    }
    
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }

    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', searchUsers);
        
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !document.getElementById('searchResults').contains(e.target)) {
                document.getElementById('searchResults').innerHTML = '';
                const recentContactsDiv = document.getElementById('recent-contacts');
                if (recentContactsDiv && searchInput.value.trim().length === 0) {
                    recentContactsDiv.style.display = "block";
                }
            }
        });
    }

    setupWebSocketReconnect();
    loadRecentContacts();
    setInterval(loadRecentContacts, 30000);
});

const mentionStyles = `
.profile-mention {
    color: #007bff;
    font-weight: bold;
    cursor: pointer;
    text-decoration: none;
    transition: color 0.2s ease;
    padding: 1px 3px;
    border-radius: 3px;
}

.profile-mention:hover {
    color: #0056b3;
    text-decoration: underline;
}

.message-mention {
    color: #007bff;
    font-weight: bold;
    cursor: pointer;
    text-decoration: none;
    transition: color 0.2s ease;
    padding: 1px 3px;
    border-radius: 3px;
}

.message-mention:hover {
    color: #0056b3;
    text-decoration: underline;
}
`;

const styleElement = document.createElement('style');
styleElement.textContent = mentionStyles;
document.head.appendChild(styleElement);


document.addEventListener('DOMContentLoaded', function() {
    const chatOverlay = document.querySelector('.chat-overlay');
    if (chatOverlay) {
        chatOverlay.addEventListener('click', closeChat);
    }
    
    const closeChatBtn = document.querySelector('.close-chat');
    if (closeChatBtn) {
        closeChatBtn.addEventListener('click', closeChat);
    }
    
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }

    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', searchUsers);
        
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !document.getElementById('searchResults').contains(e.target)) {
                document.getElementById('searchResults').innerHTML = '';
                const recentContactsDiv = document.getElementById('recent-contacts');
                if (recentContactsDiv && searchInput.value.trim().length === 0) {
                    recentContactsDiv.style.display = "block";
                }
            }
        });
    }

    setupWebSocketReconnect();
    loadRecentContacts();
    setInterval(loadRecentContacts, 30000);
});

let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 1000;

function setupWebSocketReconnect() {
    setInterval(() => {
        if (currentChatUser && (!chatSocket || chatSocket.readyState === WebSocket.CLOSED || chatSocket.readyState === WebSocket.CLOSING)) {
            attemptReconnect();
        }
    }, 5000);
}

function attemptReconnect() {
    if (reconnectAttempts < maxReconnectAttempts && currentChatUser) {
        setTimeout(() => {
            console.log(`Attempting to reconnect... (${reconnectAttempts + 1}/${maxReconnectAttempts})`);
            openChat(currentChatUser);
            reconnectAttempts++;
        }, reconnectDelay * reconnectAttempts);
    }
}

function loadRecentContacts() {
    fetch('/get-recent-contacts/')
        .then(response => response.json())
        .then(contacts => {
            console.log('Loaded recent contacts:', contacts);
            
            const contactsList = document.getElementById('recent-contacts-list');
            const currentUser = "{{ user.username }}";
            const lang = "{{ user.language|default:'English' }}";
            
            const favoriteContact = {
                username: currentUser,
                avatar_url: "/static/pictures/notes.jpg",
                last_message: lang === 'Українська' ? 'Ваші нотатки' : 'Your notes',
                last_activity: new Date().toISOString(),
                unread_count: 0
            };
            
            const binContact = {
                username: "Bin",
                avatar_url: "/static/pictures/bin.jpg", 
                last_message: lang === 'Українська' ? 'Системний бот' : 'System bot',
                last_activity: new Date().toISOString(),
                unread_count: 0
            };
            
            const allContacts = [
                favoriteContact, 
                binContact,
                ...contacts.filter(contact => contact.username !== currentUser)
            ];
            
            if (allContacts.length === 0) {
                contactsList.innerHTML = '<div style="color:#999; padding:10px; text-align:center;">No recent chats</div>';
                return;
            }
            
            contactsList.innerHTML = allContacts.map(contact => {
                let displayName, lastMessage, avatarUrl, onClickFunction;
                
                if (contact.username === currentUser) {
                    displayName = lang === 'Українська' ? 'Избранное' : 'Notes';
                    lastMessage = getLastNoteMessage() || (lang === 'Українська' ? 'Ваші нотатки' : 'Your notes');
                    avatarUrl = "/static/pictures/notes.jpg";
                    onClickFunction = `openChat('${contact.username}')`;
                } 
                else if (contact.username === "Bin") {
                    displayName = "Bin";
                    lastMessage = contact.last_message;
                    avatarUrl = "/static/pictures/bin.jpg";
                    onClickFunction = `openBinLogin()`;
                }
                else {
                    displayName = contact.username;
                    lastMessage = contact.last_message || 'No messages yet';
                    avatarUrl = contact.avatar_url || '/static/pictures/login.png';
                    onClickFunction = `openChat('${contact.username}')`;
                }
                
                const truncatedMessage = truncateText(lastMessage, 25);
                
                return `
                <div class="recent-contact ${contact.unread_count > 0 ? 'unread' : ''}" 
                     onclick="${onClickFunction}">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${avatarUrl}" 
                             class="contact-avatar" 
                             alt="${contact.username}"
                             onerror="this.src='/static/pictures/login.png'">
                        <div class="contact-info">
                            <div class="contact-username">${displayName}</div>
                            <div class="contact-last-message" title="${lastMessage}">
                                ${truncatedMessage}
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:2px;">
                            ${contact.last_activity ? `
                                <div class="contact-time">
                                    ${formatTime(contact.last_activity)}
                                </div>
                            ` : ''}
                            ${contact.unread_count > 0 ? `
                                <div class="unread-badge">${contact.unread_count}</div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        })
        .catch(error => {
            console.error('Error loading recent contacts:', error);
        });
}

function getVerificationCodeForBin() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('CSRF token not found. Please refresh the page.');
        return;
    }
    
    const message = document.getElementById('chat-input').value.trim();
    if (message) {
        displayMessage({
            text: message,
            sender: "{{ user.username }}",
            timestamp: new Date().toISOString(),
            is_sent: true
        }, true);
    }
    
    fetch('/get-verification-code-bin/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            action: 'get_code'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log('Verification code received from Bin:', data.code);
            
            setTimeout(() => {
                displayMessage({
                    text: data.message || `Your verification code: ${data.code}`,
                    sender: "Bin",
                    timestamp: new Date().toISOString(),
                    is_sent: false
                }, false);
                
                loadRecentContacts();
                
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                }
            }, 300);
        } else {
            console.error('Failed to get verification code:', data.error);
            alert('Error getting verification code: ' + data.error);
        }
    })
    .catch(error => {
        console.error('AJAX get verification code error:', error);
        alert('Error getting verification code: ' + error.message);
    });
}

function openBinLogin() {
    closeProfileModals();
    
    currentChatUser = "Bin";
    document.getElementById('chat-username').textContent = "Bin";
    
    document.getElementById('chat-toggle').checked = true;
    
    reconnectAttempts = 0;
    
    if (chatSocket) {
        chatSocket.close();
        chatSocket = null;
    }
    
    console.log('Opening chat with Bin');
    
    loadChatMessages("Bin");
    
    setTimeout(() => {
        displayMessage({
            text: "Hello! I'm Bin. Send any message to get your verification code.",
            sender: "Bin",
            timestamp: new Date().toISOString(),
            is_sent: false
        }, false);
    }, 300);
    
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
    
    const recentContactsDiv = document.getElementById('recent-contacts');
    if (recentContactsDiv) {
        recentContactsDiv.style.display = "block";
    }
    
    addAttachmentButton();
}

function sendMessageToBin(message) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('CSRF token not found. Please refresh the page.');
        return;
    }
    
    fetch('/get-verification-code-bin/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log('Verification code received from Bin:', data.code);
            
            setTimeout(() => {
                displayMessage({
                    text: data.message || `Ваш код верифікації: ${data.code}. Код дійсний 10 хвилин.`,
                    sender: "Bin",
                    timestamp: new Date().toISOString(),
                    is_sent: false
                }, false);
                
                loadRecentContacts();
                
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                }
            }, 300);
        } else {
            console.error('Failed to get verification code:', data.error);
            alert('Error getting verification code: ' + data.error);
        }
    })
    .catch(error => {
        console.error('AJAX get verification code error:', error);
        alert('Error getting verification code: ' + error.message);
    });
}

function loadChatMessages(username) {
    if (username === "Bin") {
        fetch(`/get-bin-messages/`)
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(messages => {
                console.log('Loaded Bin messages:', messages);
                displayBinMessages(messages);
            })
            .catch(error => {
                console.error('Error loading Bin messages:', error);
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = '<div class="chat-messages-spacer"></div>';
                }
            });
        return;
    }
    
    if (username === "{{ user.username }}") {
        fetch(`/get-notes/`)
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(notes => {
                displayNotes(notes);
            })
            .catch(error => {
                console.error('Error loading notes from server:', error);
                const localNotes = JSON.parse(localStorage.getItem('user_notes') || '[]');
                displayNotes(localNotes);
            });
        return;
    }
    
    fetch(`/get-chat-messages/?username=${encodeURIComponent(username)}`)
        .then(response => response.json())
        .then(messages => {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            const spacer = messagesContainer.querySelector('.chat-messages-spacer');
            messagesContainer.innerHTML = '';
            if (spacer) {
                messagesContainer.appendChild(spacer);
            } else {
                const newSpacer = document.createElement('div');
                newSpacer.className = 'chat-messages-spacer';
                messagesContainer.appendChild(newSpacer);
            }
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.is_sent ? 'sent' : 'received'}`;
                
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = msg.sender;
                messageDiv.appendChild(senderDiv);
                
                const contentDiv = document.createElement('div');
                
                if (msg.text) {
                    const textDiv = document.createElement('div');
                    const processedText = processMentions(msg.text);
                    textDiv.innerHTML = processedText;
                    contentDiv.appendChild(textDiv);
                }
                
                if (msg.file_url) {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-attachment';
                    
                    if (msg.file_type && msg.file_type.startsWith('image/')) {
                        fileDiv.innerHTML = `
                            <div style="margin: 5px 0;">
                                <img src="${msg.file_url}" 
                                     style="max-width: 250px; max-height: 250px; border-radius: 5px; cursor: pointer;" 
                                     onclick="openFileModal('${msg.file_url}', '${msg.file_name || 'image'}')">
                            </div>
                        `;
                    } else {
                        fileDiv.innerHTML = `
                            <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin: 5px 0;">
                                <a href="${msg.file_url}" download="${msg.file_name || 'file'}" 
                                   style="color: #007bff; text-decoration: none;">
                                    📎 ${msg.file_name || 'Файл'}
                                </a>
                            </div>
                        `;
                    }
                    contentDiv.appendChild(fileDiv);
                }
                
                messageDiv.appendChild(contentDiv);
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.style.fontSize = '11px';
                timeDiv.style.color = '#999';
                timeDiv.style.marginTop = '4px';
                timeDiv.style.textAlign = msg.is_sent ? 'right' : 'left';
                
                const messageDate = new Date(msg.timestamp);
                timeDiv.textContent = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                messageDiv.appendChild(timeDiv);
                
                const spacer = messagesContainer.querySelector('.chat-messages-spacer');
                if (spacer) {
                    messagesContainer.insertBefore(messageDiv, spacer);
                } else {
                    messagesContainer.appendChild(messageDiv);
                }
                
                if (msg.text) {
                    addMentionEventListeners(messageDiv);
                }
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        })
        .catch(error => {
            console.error('Error loading chat messages:', error);
        });
}

function displayBinMessages(messages) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    const spacer = messagesContainer.querySelector('.chat-messages-spacer');
    messagesContainer.innerHTML = '';
    if (spacer) {
        messagesContainer.appendChild(spacer);
    } else {
        const newSpacer = document.createElement('div');
        newSpacer.className = 'chat-messages-spacer';
        messagesContainer.appendChild(newSpacer);
    }
    
    messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.is_sent ? 'sent' : 'received'}`;
        
        const senderDiv = document.createElement('div');
        senderDiv.className = 'message-sender';
        senderDiv.textContent = msg.sender === "Bin" ? "Bin" : msg.sender;
        messageDiv.appendChild(senderDiv);
        
        const textDiv = document.createElement('div');
        
        const processedText = processMentions(msg.text);
        textDiv.innerHTML = processedText;
        
        messageDiv.appendChild(textDiv);
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.style.fontSize = '11px';
        timeDiv.style.color = '#999';
        timeDiv.style.marginTop = '4px';
        timeDiv.style.textAlign = msg.is_sent ? 'right' : 'left';
        
        const messageDate = new Date(msg.timestamp);
        timeDiv.textContent = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        messageDiv.appendChild(timeDiv);
        
        const spacer = messagesContainer.querySelector('.chat-messages-spacer');
        if (spacer) {
            messagesContainer.insertBefore(messageDiv, spacer);
        } else {
            messagesContainer.appendChild(messageDiv);
        }
        
        addMentionEventListeners(messageDiv);
    });
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function sendFile() {
    if (!selectedFile || !currentChatUser) {
        cancelFile();
        return;
    }
    
    const textInput = document.getElementById('chat-input');
    const text = textInput.value.trim() || '';
    
    if (currentChatUser === "Bin") {
        alert("Bin currently only supports text messages");
        cancelFile();
        return;
    }
    
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('receiver', currentChatUser);
    if (text) {
        formData.append('text', text);
    }
    
    const csrfToken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    if (!csrfToken) {
        alert('CSRF token not found. Please refresh the page.');
        cancelFile();
        return;
    }
    
    fetch('/upload-chat-file/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            displayMessage({
                text: text || '',
                file_url: data.file_url,
                file_name: data.file_name,
                file_type: data.file_type,
                file_size: data.file_size,
                sender: "{{ user.username }}",
                timestamp: data.timestamp
            }, true);
            
            textInput.value = '';
            selectedFile = null;
            cancelFile();
            
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'message': text || '[Файл]',
                    'sender': "{{ user.username }}",
                    'receiver': currentChatUser,
                    'file_url': data.file_url,
                    'file_name': data.file_name,
                    'file_type': data.file_type
                }));
            }
        } else {
            alert('Ошибка отправки файла: ' + data.error);
            cancelFile();
        }
    })
    .catch(error => {
        console.error('Error sending file:', error);
        alert('Ошибка отправки файла: ' + error.message);
        cancelFile();
    });
}

function truncateText(text, maxLength) {
    if (!text || text.length <= maxLength) {
        return text;
    }
    return text.substring(0, maxLength) + '...';
}

function getLastNoteMessage() {
    const notes = JSON.parse(localStorage.getItem('user_notes') || '[]');
    if (notes.length > 0) {
        return notes[notes.length - 1].text;
    }
    return null;
}

function saveNoteToStorage(noteText) {
    const notes = JSON.parse(localStorage.getItem('user_notes') || '[]');
    notes.push({
        text: noteText,
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('user_notes', JSON.stringify(notes));
    
    setTimeout(() => {
        loadRecentContacts();
    }, 100);
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'now';
    if (diffMins < 60) return `${diffMins}m`;
    if (diffHours < 24) return `${diffHours}h`;
    if (diffDays < 7) return `${diffDays}d`;
    
    return date.toLocaleDateString();
}

function openChat(username) {
    currentChatUser = username;
    document.getElementById('chat-username').textContent = username;
    
    document.getElementById('chat-toggle').checked = true;

    reconnectAttempts = 0;
    
    if (chatSocket) {
        chatSocket.close();
    }
    
    const currentUser = "{{ user.username }}";
    const roomName = [currentUser, username].sort().join('_').replace(/[^\w]/g, '');
    
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsPath = wsScheme + '://' + window.location.host + '/ws/chat/' + roomName + '/';
    
    console.log('Connecting to WebSocket:', wsPath);
    
    chatSocket = new WebSocket(wsPath);
    
    chatSocket.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            console.log('Received WebSocket message:', data);
            
            if (data.sender !== "{{ user.username }}") {
                displayMessage(data.message, data.sender, false);
                loadRecentContacts();
            } else {
                console.log('Ignoring own message from WebSocket');
            }
        } catch (error) {
            console.error('Error parsing WebSocket message:', error);
        }
    };
    
    chatSocket.onopen = function(e) {
        console.log('WebSocket connection established successfully');
        loadChatMessages(username);
    };
    
    chatSocket.onclose = function(e) {
        console.log('WebSocket connection closed:', e.code, e.reason);
        if (document.getElementById('chat-toggle').checked) {
            setTimeout(() => attemptReconnect(), 2000);
        }
    };
    
    chatSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
    
    loadChatMessages(username);
    markMessagesAsRead(username);
    
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
    
    const recentContactsDiv = document.getElementById('recent-contacts');
    if (recentContactsDiv) {
        recentContactsDiv.style.display = "block";
    }
    
    document.addEventListener('keydown', blockEscapeClose);
}


function blockEscapeClose(e) {
    if (e.key === 'Escape' && document.getElementById('chat-toggle').checked) {
        e.preventDefault();
        e.stopPropagation();
        showTemporaryMessage("Chat cannot be closed", 2000);
    }
}

function showTemporaryMessage(message, duration) {
    const tempMsg = document.createElement('div');
    tempMsg.textContent = message;
    tempMsg.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 10000;
    `;
    document.body.appendChild(tempMsg);
    
    setTimeout(() => {
        tempMsg.remove();
    }, duration);
}

function markMessagesAsRead(username) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/mark-messages-read/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
            sender: username
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRecentContacts();
        }
    })
    .catch(error => {
        console.error('Error marking messages as read:', error);
    });
}

function processMentions(text) {
    if (!text) return '';
    
    const mentionRegex = /(@[\wа-яА-ЯёЁ]+)/gi;
    
    return text.replace(mentionRegex, '<span class="message-mention profile-mention" data-username="$1">$1</span>');
}

function addMentionEventListeners(element) {
    const mentions = element.querySelectorAll('.message-mention, .profile-mention');
    
    mentions.forEach(mention => {
        const username = mention.getAttribute('data-username');
        
        if (!isValidMention(username)) {
            mention.classList.remove('message-mention', 'profile-mention');
            mention.style.color = '';
            mention.style.cursor = 'default';
            mention.style.textDecoration = 'none';
            mention.style.backgroundColor = '';
            return;
        }
        
        checkUserExists(username.replace('@', '')).then(exists => {
            if (!exists) {
                mention.classList.remove('message-mention', 'profile-mention');
                mention.style.color = '';
                mention.style.cursor = 'default';
                mention.style.textDecoration = 'none';
                mention.style.backgroundColor = '';
                mention.removeAttribute('data-username');
                return;
            }
            
            mention.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const cleanUsername = username.replace('@', '');
                openUserProfile(cleanUsername);
            });
            
            mention.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-1px)';
                this.style.cursor = 'pointer';
            });
            
            mention.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    });
}

function checkUserExists(username) {
    return fetch(`/check-user-exists/?username=${encodeURIComponent(username)}`)
        .then(response => response.json())
        .then(data => {
            return data.exists || false;
        })
        .catch(error => {
            console.error('Error checking user existence:', error);
            return false;
        });
}

function isValidMention(username) {
    const cleanUsername = username.replace('@', '');
    
    return username.startsWith('@') && cleanUsername.length > 0;
}

function isValidMention(username) {
    if (!username || !username.startsWith('@')) return false;
    
    const cleanUsername = username.replace('@', '');
    return /^[\wа-яА-ЯёЁ]+$/.test(cleanUsername);
}

function isValidMention(username) {
    if (!username || !username.startsWith('@')) return false;
    
    const cleanUsername = username.replace('@', '');
    return /^[\wа-яА-ЯёЁ_\d]+$/.test(cleanUsername) && cleanUsername.length > 0;
}

function displayMessage(text, sender, isSent) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) {
        console.error('Chat messages container not found');
        return;
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    
    const senderDiv = document.createElement('div');
    senderDiv.className = 'message-sender';
    senderDiv.textContent = getSenderDisplayName(isSent, sender);
    messageDiv.appendChild(senderDiv);
    
    const textDiv = document.createElement('div');
    
    const processedText = processMentionsStrict(text);
    textDiv.innerHTML = processedText;
    
    messageDiv.appendChild(textDiv);
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.style.fontSize = '11px';
    timeDiv.style.color = '#999';
    timeDiv.style.marginTop = '4px';
    timeDiv.style.textAlign = isSent ? 'right' : 'left';
    timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    messageDiv.appendChild(timeDiv);
    
    const spacer = messagesContainer.querySelector('.chat-messages-spacer');
    if (spacer) {
        messagesContainer.insertBefore(messageDiv, spacer);
    } else {
        messagesContainer.appendChild(messageDiv);
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    addMentionEventListeners(messageDiv);
}

function processProfileDescription() {
    const descriptionElements = document.querySelectorAll('.profile-preview-value, .other-profile-description, #my-profile-description');
    
    descriptionElements.forEach(element => {
        const originalText = element.innerHTML;
        
        if (element.classList.contains('other-profile-description')) {
            const profileUsername = document.querySelector('.other-profile-username');
            if (profileUsername && profileUsername.textContent === 'Bin') {
                let cleanedText = originalText;
                cleanedText = cleanedText.replace(
                    /<span[^>]*data-username="@?Bin_bot"?[^>]*>@?Bin_bot<\/span>/gi,
                    '@Bin_bot'
                );
                element.innerHTML = cleanedText;
            }
        }
        
        const processedText = processMentionsStrict(originalText);
        element.innerHTML = processedText;
        
        addMentionEventListeners(element);
    });
}

function closeProfileModalsOnly() {
    const profileModals = [
        'menu-toggle', 'profile-toggle', 'setting-toggle', 'form1-toggle', 
        'form2-toggle', 'color_theme-toggle', 'wallet-toggle', 'check-subscription-toggle',
        'subscribe-month-toggle', 'subscribe-year-toggle', 'deposit-toggle', 'add_card-toggle',
        'bin_mouth-toggle', 'bin_premium_mouth-toggle', 'bin_years-toggle', 'bin_premium_years-toggle',
        'other-profile-toggle'
    ];
    
    profileModals.forEach(id => {
        const cb = document.getElementById(id);
        if (cb) cb.checked = false;
    });
}

document.addEventListener('mousedown', (event) => {
    const forms = [
        { form: '.side-menu', toggle: '#menu-toggle' },
        { form: '.wallet-form', toggle: '#wallet-toggle' },
        { form: '.profile-form', toggle: '#profile-toggle' },
        { form: '.setting-form', toggle: '#setting-toggle' },
        { form: '.form1', toggle: '#form1-toggle' },
        { form: '.form2', toggle: '#form2-toggle' },
        { form: '.deposit-form', toggle: '#deposit-toggle' },
        { form: '.add_card-form', toggle: '#add_card-toggle' },
        { form: '.other-profile-form', toggle: '#other-profile-toggle' },
        { form: '.security-form', toggle: '#security-toggle' }
    ];

    let clickedInsideAnyForm = false;

    forms.forEach(({form, toggle}) => {
        const formElement = document.querySelector(form);
        const toggleElement = document.getElementById(toggle.replace('#', ''));
        
        if (formElement && toggleElement && toggleElement.checked) {
            if (formElement.contains(event.target) || event.target.closest(form)) {
                clickedInsideAnyForm = true;
            }
        }
    });

    if (!clickedInsideAnyForm) {
        forms.forEach(({toggle}) => {
            const toggleElement = document.getElementById(toggle.replace('#', ''));
            if (toggleElement && toggleElement.checked) {
                toggleElement.checked = false;
            }
        });
    }
});

function displayNotes(notes) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    const spacer = messagesContainer.querySelector('.chat-messages-spacer');
    messagesContainer.innerHTML = '';
    if (spacer) {
        messagesContainer.appendChild(spacer);
    } else {
        const newSpacer = document.createElement('div');
        newSpacer.className = 'chat-messages-spacer';
        messagesContainer.appendChild(newSpacer);
    }
    
    notes.forEach(note => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message sent';
        
        const textDiv = document.createElement('div');
        
        const processedText = processMentions(note.text);
        textDiv.innerHTML = processedText;
        
        messageDiv.appendChild(textDiv);
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.style.fontSize = '11px';
        timeDiv.style.color = '#999';
        timeDiv.style.marginTop = '4px';
        timeDiv.style.textAlign = 'right';
        
        const noteDate = new Date(note.timestamp);
        timeDiv.textContent = noteDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        messageDiv.appendChild(timeDiv);
        
        const spacer = messagesContainer.querySelector('.chat-messages-spacer');
        if (spacer) {
            messagesContainer.insertBefore(messageDiv, spacer);
        } else {
            messagesContainer.appendChild(messageDiv);
        }
        
        addMentionEventListeners(messageDiv);
    });
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function getSenderDisplayName(isSent, sender) {
    const lang = "{{ user.language|default:'English' }}";
    const currentUser = "{{ user.username }}";
    
    if (isSent) {
        return lang === 'Українська' ? 'Відправляється' : 'Іs sent';
    } else {
        return sender;
    }
}

function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!currentChatUser || !message) return;
    
    const tempMessageId = 'temp-' + Date.now();
    const messagesContainer = document.getElementById('chat-messages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message sent';
    messageDiv.id = tempMessageId;
    
    const senderDiv = document.createElement('div');
    senderDiv.className = 'message-sender';
    senderDiv.textContent = 'Вы';
    messageDiv.appendChild(senderDiv);
    
    const textDiv = document.createElement('div');
    const processedText = processMentions(message);
    textDiv.innerHTML = processedText;
    messageDiv.appendChild(textDiv);
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.style.fontSize = '11px';
    timeDiv.style.color = '#999';
    timeDiv.style.marginTop = '4px';
    timeDiv.style.textAlign = 'right';
    timeDiv.textContent = 'Отправляется...';
    messageDiv.appendChild(timeDiv);
    
    const spacer = messagesContainer.querySelector('.chat-messages-spacer');
    if (spacer) {
        messagesContainer.insertBefore(messageDiv, spacer);
    } else {
        messagesContainer.appendChild(messageDiv);
    }
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    addMentionEventListeners(messageDiv);
    
    input.value = '';
    
    if (currentChatUser === "Bin") {
        getVerificationCodeForBin();
    } else if (currentChatUser === "{{ user.username }}") {
        sendMessageViaAJAX(message);
    } else {
        sendMessageViaAJAX(message);
    }
}

function getVerificationCodeForBin() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        return;
    }
    
    fetch('/get-verification-code-bin/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            action: 'get_code'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const tempMessage = document.querySelector('#temp-' + tempMessageId);
            if (tempMessage) {
                const timeDiv = tempMessage.querySelector('.message-time');
                if (timeDiv) {
                    timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            }
            
            setTimeout(() => {
                displayMessage({
                    text: data.message || `Your verification code: ${data.code}`,
                    sender: "Bin",
                    timestamp: new Date().toISOString(),
                    is_sent: false
                }, false);
                
                loadRecentContacts();
            }, 300);
        } else {
            console.error('Failed to get verification code:', data.error);
            alert('Error getting verification code: ' + data.error);
        }
    })
    .catch(error => {
        console.error('AJAX get verification code error:', error);
        alert('Error getting verification code: ' + error.message);
    });
}

function sendMessageViaAJAX(message, fileData = null) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('CSRF token not found. Please refresh the page.');
        return;
    }
    
    if (!currentChatUser) {
        console.error('No chat user selected');
        return;
    }
    
    let url, method, body, headers;
    
    if (fileData) {
        url = '/upload-chat-file/';
        method = 'POST';
        
        const formData = new FormData();
        formData.append('text', message || '');
        formData.append('receiver', currentChatUser);
        formData.append('file', fileData.file);
        
        body = formData;
        headers = {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        };
        
    } else if (currentChatUser === "{{ user.username }}") {
        url = '/save-note/';
        method = 'POST';
        body = JSON.stringify({
            text: message
        });
        headers = {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        };
        
    } else {
        url = '/send-message/';
        method = 'POST';
        body = JSON.stringify({
            text: message,
            receiver: currentChatUser
        });
        headers = {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        };
    }
    
    console.log('Sending AJAX request:', { url, method, message, receiver: currentChatUser });
    
    fetch(url, {
        method: method,
        headers: headers,
        body: body
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('AJAX response:', data);
        
        if (data.success) {
            console.log('Message sent successfully via AJAX');
            
            loadRecentContacts();
            
            if (!fileData) {
                console.log('Message displayed in UI');
            }
            
        } else {
            console.error('Server reported error:', data.error);
            alert('Failed to send message: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('AJAX send error:', error);
        alert('Error sending message: ' + error.message);
    });
}

function sendMessageToSelfViaAJAX(message) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        return;
    }
    
    fetch('/save-note/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            text: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Note saved:', message);
            
            saveNoteToStorage(message);
            
            loadChatMessages("{{ user.username }}");
            
            loadRecentContacts();
        } else {
            console.error('Failed to save note:', data.error);
            saveNoteToStorage(message);
            loadChatMessages("{{ user.username }}");
        }
    })
    .catch(error => {
        console.error('AJAX save note error:', error);
        saveNoteToStorage(message);
        loadChatMessages("{{ user.username }}");
    });
}

function closeChat() {
    document.getElementById('chat-toggle').checked = false;
    currentChatUser = null;
    if (chatSocket) {
        chatSocket.close();
        chatSocket = null;
    }
}

function searchUsers() {
    const searchInput = document.getElementById("searchInput");
    const resultsDiv = document.getElementById("searchResults");
    const recentContactsDiv = document.getElementById("recent-contacts");
    const query = searchInput.value.trim();
    const currentUser = "{{ user.username }}";
    const lang = "{{ user.language|default:'English' }}";
    
    if (query.length === 0) {
        resultsDiv.innerHTML = "";
        if (recentContactsDiv) {
            recentContactsDiv.style.display = "block";
        }
        return;
    }

    if (recentContactsDiv) {
        recentContactsDiv.style.display = "none";
    }

    fetch(`/search-users/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(users => {
            const filteredUsers = users.filter(user => user.username !== currentUser);
            
            const searchTerms = ['избранное', 'заметки', 'notes', 'favorites'];
            const queryLower = query.toLowerCase();
            const shouldShowNotes = searchTerms.some(term => 
                queryLower.includes(term.toLowerCase())
            );
            
            let resultsHTML = '';
            
            if (shouldShowNotes) {
                const notesDisplayName = lang === 'Українська' ? 'Избранное' : 'Notes';
                const notesDescription = lang === 'Українська' ? 'Ваши заметки' : 'Your notes';
                
                resultsHTML += `
                <div class="recent-contact" onclick="openChat('${currentUser}')">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="/static/pictures/notes.jpg" 
                             class="contact-avatar" 
                             alt="${notesDisplayName}">
                        <div class="contact-info">
                            <div class="contact-username">${notesDisplayName}</div>
                            <div class="contact-last-message" title="${notesDescription}">
                                ${notesDescription}
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            
            if (filteredUsers.length > 0) {
                resultsHTML += filteredUsers
                    .map(user => {
                        const displayName = user.username;
                        const userTag = user.your_tag || user.username;
                        const truncatedDesc = truncateText(userTag, 25);
                        
                        let avatarUrl = user.avatar_url || '/static/pictures/login.png';
                        
                        if (user.username === "Bin") {
                            avatarUrl = '/static/pictures/bin.jpg';
                        }
                        
                        let onClickFunction = `openChat('${user.username}')`;
                        if (user.username === "Bin") {
                            onClickFunction = `openBinLogin()`;
                        }
                        
                        return `
                        <div class="recent-contact" onclick="${onClickFunction}">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${avatarUrl}" 
                                     class="contact-avatar" 
                                     alt="${user.username}"
                                     onerror="this.onerror=null; this.src='/static/pictures/login.png'">
                                <div class="contact-info">
                                    <div class="contact-username">${displayName}</div>
                                    <div class="contact-last-message" title="${userTag}">
                                        ${truncatedDesc}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    })
                    .join("");
            }
            
            if (resultsHTML) {
                resultsDiv.innerHTML = resultsHTML;
            } else {
                const noResultsMsg = lang === 'Українська' 
                    ? `Користувачів не знайдено за "${query}"`
                    : `No users found for "${query}"`;
                resultsDiv.innerHTML = `<div style="color:#999; padding:10px; width:250px;">${noResultsMsg}</div>`;
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            const errorMsg = lang === 'Українська' 
                ? 'Помилка пошуку'
                : 'Search error';
            resultsDiv.innerHTML = `<div style="color:red; padding:10px; width:250px;">${errorMsg}</div>`;
        });
}

document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        if (e.target.matches('.profile-preview-value a[href*="profile="]')) {
            e.preventDefault();
            const url = new URL(e.target.href);
            const profileUsername = url.searchParams.get('profile');
            if (profileUsername) {
                openUserProfile(profileUsername);
            }
        }
    });
});

function openUserProfile(username) {
    if (username === "{{ user.username }}") {
        closeProfileModals();
        document.getElementById('profile-toggle').checked = true;
        return;
    }
    
    closeProfileModals();
    
    fetch(`/get-user-profile/?username=${encodeURIComponent(username)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showUserProfileModal(data);
            } else {
                alert('User not found: ' + username);
            }
        })
        .catch(error => {
            console.error('Error loading user profile:', error);
            alert('Error loading user profile');
        });
}

function closeAllModals() {
    const checkboxes = [
        'menu-toggle', 'profile-toggle', 'setting-toggle', 'form1-toggle', 
        'form2-toggle', 'color_theme-toggle', 'wallet-toggle', 'check-subscription-toggle',
        'subscribe-month-toggle', 'subscribe-year-toggle', 'deposit-toggle', 'add_card-toggle',
        'bin_mouth-toggle', 'bin_premium_mouth-toggle', 'bin_years-toggle', 'bin_premium_years-toggle',
        'other-profile-toggle'
    ];
    
    checkboxes.forEach(id => {
        const cb = document.getElementById(id);
        if (cb) cb.checked = false;
    });
}

function showUserProfileModal(userData) {
    closeAllModals();
    
    const otherProfileForm = document.querySelector('.other-profile-form');
    if (otherProfileForm) {
        const avatarImg = otherProfileForm.querySelector('.other-profile-avatar');
        if (avatarImg) {
            avatarImg.src = userData.photo_url;
            avatarImg.alt = userData.username;
        }
        
        const usernameEl = otherProfileForm.querySelector('.other-profile-username');
        if (usernameEl) {
            usernameEl.textContent = userData.username;
        }
        
        const tagEl = otherProfileForm.querySelector('.other-profile-tag');
        if (tagEl) {
            tagEl.textContent = userData.your_tag || userData.username;
        }
        
        const statusEl = otherProfileForm.querySelector('.other-profile-status');
        if (statusEl) {
            statusEl.textContent = userData.status;
            statusEl.className = `status-value ${userData.status === 'Online' ? 'online' : 'offline'}`;
        }
        
        const descriptionEl = otherProfileForm.querySelector('.other-profile-description');
        if (descriptionEl) {
            const processedDescription = processMentionsStrict(userData.description || 'No description');
            descriptionEl.innerHTML = processedDescription;
            addMentionEventListeners(descriptionEl);
        }
        
        const birthdayEl = otherProfileForm.querySelector('.other-profile-birthday');
        if (birthdayEl) {
            birthdayEl.textContent = userData.birthday;
        }
        
        const messageBtn = otherProfileForm.querySelector('.other-profile-message-btn');
        if (messageBtn) {
            messageBtn.onclick = function() {
                openChatWithUser(userData.username);
            };
        }
    }

    const otherProfileToggle = document.getElementById('other-profile-toggle');
    if (otherProfileToggle) {
        otherProfileToggle.checked = true;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const otherProfileOverlay = document.querySelector('.other-profile-overlay');
    if (otherProfileOverlay) {
        otherProfileOverlay.addEventListener('click', function() {
            const otherProfileToggle = document.getElementById('other-profile-toggle');
            if (otherProfileToggle) {
                otherProfileToggle.checked = false;
            }
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        if (e.target.matches('.other-profile-form .message-mention, .other-profile-form .profile-mention')) {
            e.preventDefault();
            e.stopPropagation();
            const username = e.target.getAttribute('data-username').replace('@', '');
            openUserProfile(username);
        }
    });
    
    const originalShowUserProfileModal = window.showUserProfileModal;
    window.showUserProfileModal = function(userData) {
        if (originalShowUserProfileModal) {
            originalShowUserProfileModal(userData);
        }
        
        setTimeout(() => {
            const otherProfileDesc = document.querySelector('.other-profile-description');
            if (otherProfileDesc) {
                const processedText = processMentionsStrict(otherProfileDesc.innerHTML);
                otherProfileDesc.innerHTML = processedText;
                addMentionEventListeners(otherProfileDesc);
            }
        }, 100);
    };
});

function closeProfileModals() {
    const profileModals = [
        'menu-toggle', 'profile-toggle', 'setting-toggle', 'form1-toggle', 
        'form2-toggle', 'color_theme-toggle', 'wallet-toggle', 'check-subscription-toggle',
        'subscribe-month-toggle', 'subscribe-year-toggle', 'deposit-toggle', 'add_card-toggle',
        'bin_mouth-toggle', 'bin_premium_mouth-toggle', 'bin_years-toggle', 'bin_premium_years-toggle',
        'other-profile-toggle'
    ];
    
    profileModals.forEach(id => {
        const cb = document.getElementById(id);
        if (cb) cb.checked = false;
    });
}

function openChatWithUser(username) {
    const otherProfileToggle = document.getElementById('other-profile-toggle');
    if (otherProfileToggle) {
        otherProfileToggle.checked = false;
    }
    
    openChat(username);
}

function closeUserProfileModal() {
    const modal = document.querySelector('.user-profile-modal');
    const overlay = document.querySelector('.user-profile-overlay');
    if (modal) modal.remove();
    if (overlay) overlay.remove();
}

// фон
function syncBackgrounds() {
    console.log('Syncing backgrounds...');
    
    const previewBackground = document.getElementById('preview-background');
    const mainProfileBackground = document.getElementById('main-profile-background');
    
    console.log('Preview background:', previewBackground.style.backgroundImage);
    console.log('Main background:', mainProfileBackground.style.backgroundImage);
    
    if (previewBackground && mainProfileBackground) {
        if (previewBackground.style.backgroundImage && previewBackground.style.backgroundImage !== 'none') {
            mainProfileBackground.style.backgroundImage = previewBackground.style.backgroundImage;
            mainProfileBackground.style.display = previewBackground.style.display;
            console.log('Synced from preview to main');
        }
        else if (mainProfileBackground.style.backgroundImage && mainProfileBackground.style.backgroundImage !== 'none') {
            previewBackground.style.backgroundImage = mainProfileBackground.style.backgroundImage;
            previewBackground.style.display = mainProfileBackground.style.display;
            console.log('Synced from main to preview');
        }
    }
}

// color theme
document.addEventListener('DOMContentLoaded', function() {
    const themeSelect = document.getElementById('themeSelect');
    const applyBtn = document.getElementById('applyThemeBtn');
    const userSubscribe = "{{ user.subscribe }}";  
    const body = document.body;

    const savedTheme = localStorage.getItem('selectedTheme');
    if (savedTheme) {
        body.classList.add(`theme-${savedTheme}`);
        themeSelect.value = savedTheme;
    }

    if (userSubscribe === "Basic") {
        themeSelect.querySelector('option[value="pink"]').disabled = true;
        themeSelect.querySelector('option[value="green"]').disabled = true;
    }

    applyBtn.addEventListener('click', () => {
        const selected = themeSelect.value;

        if ((selected === "pink" || selected === "green") && userSubscribe === "Basic") {
            alert("❌ This theme is available only for subscribers!");
            return;
        }

        body.classList.remove('theme-light', 'theme-dark', 'theme-pink', 'theme-green');

        body.classList.add(`theme-${selected}`);

        localStorage.setItem('selectedTheme', selected);
    });
});


document.addEventListener('DOMContentLoaded', function() {
    const usernameInput = document.getElementById('username-input');
    const descriptionInput = document.getElementById('description-input');
    const tagInput = document.getElementById('tag-input');
    const birthdayDay = document.getElementById('birthday-day');
    const birthdayMonth = document.getElementById('birthday-month');
    const birthdayYear = document.getElementById('birthday-year');
    const avatarInput = document.getElementById('avatarInput');
    
    const previewUsername = document.getElementById('preview-username');
    const previewDescription = document.getElementById('preview-description');
    const previewTag = document.getElementById('preview-tag');
    const previewBirthday = document.getElementById('preview-birthday');
    const previewAvatar = document.getElementById('preview-avatar');
    const avatarInputImg = document.getElementById('avatarInput-img');

    // Username preview
    if (usernameInput) {
        usernameInput.addEventListener('input', function() {
            const value = this.value.trim();
            previewUsername.textContent = value || '{{ user.username }}';
        });
    }

    // Description preview
    if (descriptionInput) {
        descriptionInput.addEventListener('input', function() {
            const value = this.value.trim();
            previewDescription.textContent = value || 'No description';
        });
    }

    // Tag preview
    if (tagInput) {
        tagInput.addEventListener('input', function() {
            const value = this.value.trim();
            previewTag.textContent = value || '{{ user.your_tag }}';
        });
    }

    // Birthday preview
    function updateBirthdayPreview() {
        const day = birthdayDay.value;
        const month = birthdayMonth.value;
        const year = birthdayYear.value;
        
        if (day && month && year) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            const monthName = monthNames[parseInt(month) - 1];
            previewBirthday.textContent = `${monthName} ${day}, ${year}`;
        }
    }

    if (birthdayDay) birthdayDay.addEventListener('change', updateBirthdayPreview);
    if (birthdayMonth) birthdayMonth.addEventListener('change', updateBirthdayPreview);
    if (birthdayYear) birthdayYear.addEventListener('change', updateBirthdayPreview);

    // Avatar upload
    if (avatarInput) {
        avatarInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('⚠️ Only JPG, PNG, GIF or WEBP images are allowed.');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                previewAvatar.src = imageUrl;
                avatarInputImg.src = imageUrl;
            };
            reader.readAsDataURL(file);
        });
    }

    const backgroundInput = document.getElementById('backgroundInput');
    const previewBackground = document.getElementById('preview-background');
    const mainProfileBackground = document.getElementById('main-profile-background');
    const subscribe = "{{ user.subscribe }}";

    function syncBackgrounds() {
        if (previewBackground && mainProfileBackground) {
            if (previewBackground.style.backgroundImage && previewBackground.style.backgroundImage !== 'none') {
                mainProfileBackground.style.backgroundImage = previewBackground.style.backgroundImage;
                mainProfileBackground.style.display = previewBackground.style.display;
            }
            else if (mainProfileBackground.style.backgroundImage && mainProfileBackground.style.backgroundImage !== 'none') {
                previewBackground.style.backgroundImage = mainProfileBackground.style.backgroundImage;
                previewBackground.style.display = mainProfileBackground.style.display;
            }
        }
    }

    syncBackgrounds();

    if (backgroundInput) {
        if (subscribe === 'Basic') {
            backgroundInput.disabled = true;
            backgroundInput.title = "Background feature available for Bin+ and Bin_premium subscribers";
            backgroundInput.closest('label').style.opacity = '0.6';
            backgroundInput.closest('label').style.cursor = 'not-allowed';
        } else if (subscribe === 'Bin+') {
            backgroundInput.accept = "image/*";
        } else if (subscribe === 'Bin_premium') {
            backgroundInput.accept = "image/*,image/gif";
        }

        backgroundInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (subscribe === 'Bin+' && !file.type.startsWith('image/')) {
                    alert('Only images are allowed for Bin+ subscription');
                    return;
                }
                
                if (subscribe === 'Bin_premium' && !file.type.startsWith('image/') && file.type !== 'image/gif') {
                    alert('Only images and GIFs are allowed for Bin_premium subscription');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    previewBackground.style.backgroundImage = `url('${event.target.result}')`;
                    previewBackground.style.display = 'block';
                    
                    syncBackgrounds();
                };
                reader.readAsDataURL(file);
            }
        });
    }

    const searchInput = document.getElementById("searchInput");
    const resultsDiv = document.getElementById("searchResults");
    
    if (searchInput && resultsDiv) {
        searchInput.addEventListener("input", async () => {
            const query = searchInput.value.trim();
            if (query.length === 0) {
                resultsDiv.innerHTML = "";
                return;
            }

            const response = await fetch(`/search-users/?q=${encodeURIComponent(query)}`);
            const data = await response.json();
        });
    }

    {% if user.subscription_end %}
    const endDate = new Date("{{ user.subscription_end|date:'Y-m-d H:i:s' }}").getTime();
    const countdownEl = document.getElementById('countdown');

    if (countdownEl) {
        function updateCountdown() {
            const now = new Date().getTime();
            const distance = endDate - now;

            if (distance < 0) {
                countdownEl.innerHTML = "Expired";
                location.reload();
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownEl.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    }
    {% endif %}

    const cardMessages = {
        invalid_card_number: "{{ card_messages.invalid_card_number }}",
        card_added: "{{ card_messages.card_added }}",
        add_card_failed: "{{ card_messages.add_card_failed }}",
        cards_label: "{{ card_messages.cards_label }}",
        no_cards: "{{ card_messages.no_cards }}",
    };

    const tagElement = document.getElementById('user-tag');
    if (tagElement) {
        tagElement.addEventListener('click', () => {
            const text = tagElement.textContent;
            navigator.clipboard.writeText(text)
                .then(() => showCopyNotification('Tag copied!'))
                .catch(err => console.error('Error copying tag:', err));
        });
    }

    document.addEventListener('mousedown', (event) => {
        const forms = [
            { form: '.side-menu', toggle: '#menu-toggle' },
            { form: '.wallet-form', toggle: '#wallet-toggle' },
            { form: '.profile-form', toggle: '#profile-toggle' },
            { form: '.setting-form', toggle: '#setting-toggle' },
            { form: '.form1', toggle: '#form1-toggle' },
            { form: '.form2', toggle: '#form2-toggle' },
            { form: '.deposit-form', toggle: '#deposit-toggle' },
            { form: '.add_card-form', toggle: '#add_card-toggle' },
            { form: '.other-profile-form', toggle: '#other-profile-toggle' }
        ];

        forms.forEach(({form, toggle}) => {
            const formElement = document.querySelector(form);
            const toggleElement = document.querySelector(toggle);
            
            if (formElement && toggleElement && toggleElement.checked) {
                if (!formElement.contains(event.target) && !event.target.closest(form)) {
                    toggleElement.checked = false;
                }
            }
        });
    });

    const overlays = document.querySelectorAll('.overlay, .profile-overlay, .other-profile-overlay, .setting-overlay, .form1-overlay, .form2-overlay, .color_theme-overlay, .wallet-overlay, .check-subscription-overlay, .subscribe-month-overlay, .subscribe-year-overlay, .bin_mouth-overlay, .bin_premium_mouth-overlay, .bin_years-overlay, .bin_premium_years-overlay, .deposit-overlay, .add_card-overlay, .security-overlay');
    
    overlays.forEach(overlay => {
        overlay.addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('#menu-toggle, #profile-toggle, #other-profile-toggle, #setting-toggle, #form1-toggle, #form2-toggle, #color_theme-toggle, #wallet-toggle, #check-subscription-toggle, #subscribe-month-toggle, #subscribe-year-toggle, #bin_mouth-toggle, #bin_premium_mouth-toggle, #bin_years-toggle, #bin_premium_years-toggle, #deposit-toggle, #add_card-toggle, #security-toggle');
            
            checkboxes.forEach(cb => {
                if(cb) cb.checked = false;
            });
        });
    });

    const depositInput = document.getElementById('deposit-amount');
    const depositResult = document.getElementById('deposit-result');
    const depositWalletSpan = document.getElementById('deposit-wallet');
    const currencySelect = document.querySelector('.wallet form select');

    function parseAmountAndCurrency(text) {
        if (!text) return { amount: 0, currency: ("{{ user.currency|default:'USD' }}") };
        const t = text.replace(/,/g, '').trim();
        const uah = t.indexOf('₴') !== -1 || /UAH/i.test(t);
        const usd = t.indexOf('$') !== -1 || /USD/i.test(t);
        const m = t.match(/([-+]?\d*\.?\d+)/);
        const amount = m ? Number(m[0]) : 0;
        const currency = uah ? 'UAH' : (usd ? 'USD' : ("{{ user.currency|default:'USD' }}"));
        return { amount, currency };
    }

    function formatCurrency(amount, currency) {
        if (amount === null || amount === undefined) return '';
        const a = Number(amount) || 0;
        if (currency === 'UAH') return a.toFixed(2) + ' ₴';
        return a.toFixed(2) + ' $';
    }

    function convertAmount(value, sourceCurrency, targetCurrency) {
        const v = Number(value) || 0;
        if (sourceCurrency === targetCurrency) return v;
        if (sourceCurrency === 'USD' && targetCurrency === 'UAH') return v * 42.1;
        if (sourceCurrency === 'UAH' && targetCurrency === 'USD') return v / 42.1;
        return v;
    }

    function updateDepositResult() {
        if (!depositInput || !depositResult || !depositWalletSpan) return;

        const walletRaw = depositWalletSpan.textContent || depositWalletSpan.innerText || '';
        const wallet = parseAmountAndCurrency(walletRaw);

        const depositVal = Number(depositInput.value) || 0;
        const depositCurrency = (currencySelect && currencySelect.value) ? currencySelect.value : ("{{ user.currency|default:'USD' }}");

        const depositConverted = convertAmount(depositVal, depositCurrency, wallet.currency);
        const total = (Number(wallet.amount) || 0) + depositConverted;

        const pageLang = "{{ user.language|default:'English' }}";
        const willBeText = pageLang === 'Українська' ? 'Буде' : 'Will be';
        depositResult.textContent = depositVal ? `${willBeText}: ${formatCurrency(total, wallet.currency)}` : '';
    }

    function formatCardNumber(val) {
        const digits = val.replace(/\D/g, '').slice(0, 16);
        return digits.replace(/(.{4})/g, '$1 ').trim();
    }

    const cardNumberInput = document.getElementById('card-number');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', (e) => {
            const el = e.target;
            const selectionStart = el.selectionStart || 0;
            const rawBefore = el.value.slice(0, selectionStart).replace(/\D/g, '');
            const formatted = formatCardNumber(el.value);
            el.value = formatted;
            let pos = 0;
            let digitsSeen = 0;
            while (digitsSeen < rawBefore.length && pos < el.value.length) {
                if (/\d/.test(el.value.charAt(pos))) digitsSeen++;
                pos++;
            }
            el.setSelectionRange(pos, pos);
        });
        
        cardNumberInput.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text') || '';
            const digits = paste.replace(/\D/g, '').slice(0, 16);
            cardNumberInput.value = formatCardNumber(digits);
        });
    }

    if (depositInput) {
        depositInput.addEventListener('input', updateDepositResult);
    }
    if (currencySelect) {
        currencySelect.addEventListener('change', updateDepositResult);
    }

    const sideMenuLinks = document.querySelectorAll('.side-menu label, .side-menu a');
    sideMenuLinks.forEach(link => {
        link.addEventListener('click', () => {
            const menuToggle = document.getElementById('menu-toggle');
            if(menuToggle) menuToggle.checked = false;
        });
    });

    const formCheckboxes = [
        'profile-toggle', 'other-profile-toggle', 'setting-toggle', 'form1-toggle', 
        'form2-toggle', 'color_theme-toggle', 'check-subscription-toggle', 
        'subscribe-month-toggle', 'subscribe-year-toggle', 'bin_mouth-toggle', 
        'bin_premium_mouth-toggle', 'bin_years-toggle', 'bin_premium_years-toggle',
        'deposit-toggle', 'add_card-toggle', 'security-toggle'
    ];
    
    formCheckboxes.forEach(id => {
        const cb = document.getElementById(id);
        if(cb) {
            cb.addEventListener('change', () => {
                if(cb.checked) {
                    formCheckboxes.forEach(otherId => {
                        if(otherId !== id) {
                            const otherCb = document.getElementById(otherId);
                            if(otherCb) otherCb.checked = false;
                        }
                    });
                }
            });
        }
    });

    const walletForm = document.querySelector('.wallet form');
    if (walletForm) {
        walletForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(walletForm);
            const csrf = formData.get('csrfmiddlewaretoken');

            fetch(walletForm.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrf,
                },
                body: formData,
            })
            .then(resp => {
                if (!resp.ok) throw new Error('Network response was not ok');
                return resp.json();
            })
            .then(data => {
                if (data && data.price_converted) {
                    const el = document.getElementById('wallet-amount');
                    if (el) el.textContent = 'Wallet: ' + data.price_converted;
                    const depositWallet = document.getElementById('deposit-wallet');
                    if (depositWallet) depositWallet.textContent = data.price_converted;
                    updateDepositResult();
                }
            })
            .catch(err => console.error('Currency change failed:', err));
        });
    }

    setupSubscription('terms-bin', 'subscribe-bin');
    setupSubscription('terms-premium', 'subscribe-premium');
    setupSubscription('terms-bin-year', 'subscribe-bin-year');
    setupSubscription('terms-premium-year', 'subscribe-premium-year');
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function setupSubscription(checkboxId, buttonId) {
    const checkbox = document.getElementById(checkboxId);
    const button = document.getElementById(buttonId);

    if (checkbox && button) {
        button.disabled = true;
        checkbox.addEventListener('change', () => {
            button.disabled = !checkbox.checked;
        });
    }
}

window.confirmAvatarReset = function() {
    const lang = "{{ user.language|default:'English' }}";
    const confirmMsg = lang === 'Українська'
        ? "Ви впевнені, що хочете скинути аватар?"
        : "Are you sure you want to reset your avatar?";

    if (confirm(confirmMsg)) {
        const csrfToken = '{{ csrf_token }}';
        
        fetch('{% url "reset_avatar" %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=reset_photo'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const defaultAvatarUrl = data.avatar_url + '?t=' + new Date().getTime();
                
                document.querySelectorAll('.avatar, img.avatar').forEach(img => {
                    img.src = defaultAvatarUrl;
                });
                
                const previewAvatar = document.getElementById('preview-avatar');
                if (previewAvatar) previewAvatar.src = defaultAvatarUrl;
                
                const avatarInputImg = document.getElementById('avatarInput-img');
                if (avatarInputImg) avatarInputImg.src = defaultAvatarUrl;

                const successMsg = lang === 'Українська'
                    ? 'Аватар успішно скинуто!'
                    : 'Avatar successfully reset';
                showCopyNotification(successMsg);
            } else {
                console.error('Error resetting avatar:', data.error);
                const errorMsg = lang === 'Українська'
                    ? 'Помилка скидання аватара'
                    : 'Error resetting avatar';
                showCopyNotification(errorMsg);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const errorMsg = lang === 'Українська'
                ? 'Помилка скидання аватара'
                : 'Error resetting avatar';
                showCopyNotification(errorMsg);
        });
    }
};

window.confirmBackgroundReset = function() {
    const lang = "{{ user.language|default:'English' }}";
    const confirmMsg = lang === 'Українська'
        ? "Ви впевнені, що хочете видалити фон профілю?"
        : "Are you sure you want to remove the background?";

    if (confirm(confirmMsg)) {
        const previewBackground = document.getElementById('preview-background');
        const mainProfileBackground = document.getElementById('main-profile-background');
        
        if (previewBackground) {
            previewBackground.style.backgroundImage = 'none';
            previewBackground.style.display = 'none';
        }
        
        if (mainProfileBackground) {
            mainProfileBackground.style.backgroundImage = 'none';
            mainProfileBackground.style.display = 'none';
        }
        
        let removeBackgroundInput = document.getElementById('remove-background-input');
        if (!removeBackgroundInput) {
            removeBackgroundInput = document.createElement('input');
            removeBackgroundInput.type = 'hidden';
            removeBackgroundInput.name = 'remove_background';
            removeBackgroundInput.id = 'remove-background-input';
            const editProfileForm = document.getElementById('edit-profile-form');
            if (editProfileForm) {
                editProfileForm.appendChild(removeBackgroundInput);
            }
        }
        removeBackgroundInput.value = 'true';
    }
};

window.deleteCard = function(last4) {
    const lang = "{{ user.language|default:'English' }}";
    const confirmMsg = lang === 'Українська' 
        ? `Ви впевнені, що хочете видалити картку ****${last4}?`
        : `Are you sure you want to delete card ****${last4}?`;
    
    if (!confirm(confirmMsg)) return;

    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrf = csrfInput ? csrfInput.value : '';

    fetch('/delete-card/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrf,
        },
        body: JSON.stringify({ last4: last4 })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }
        
        const cardsList = document.getElementById('cards-list');
        const cardMessages = {
            cards_label: lang === 'Українська' ? 'Картки:' : 'Cards:',
            no_cards: lang === 'Українська' ? 'Карт не додано' : 'No cards added',
        };
        
        if (cardsList && data.cards !== undefined) {
            let html = `<strong>${cardMessages.cards_label}</strong><div style="margin-top:6px;">`;
            if (data.cards.length === 0) {
                html += `<div class="card-item" style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">${cardMessages.no_cards}</div>`;
            } else {
                data.cards.forEach(c => {
                    html += `<div class="card-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">
                        <span>**** **** ****${c.last4} — ${c.cardholder || '-'} — ${c.expiry}</span>
                        <button type="button" onclick="deleteCard('${c.last4}')" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">🗑️</button>
                    </div>`;
                });
            }
            html += '</div>';
            cardsList.innerHTML = html;
        }
        
        const successMsg = lang === 'Українська' ? 'Картку видалено!' : 'Card deleted!';
        alert(successMsg);
    })
    .catch(err => {
        console.error('Delete card failed', err);
        const errorMsg = lang === 'Українська' ? 'Помилка видалення картки' : 'Error deleting card';
        alert(errorMsg);
    });
};

function checkCardsAndOpenDeposit() {
    const cardsList = document.getElementById('cards-list');
    const noCardsMessage = '{% if lang == "Українська" %}Карт не додано{% else %}No cards added{% endif %}';
    
    if (cardsList.textContent.includes(noCardsMessage)) {
        openAdd_card('add_card');
        document.getElementById('add-card-result').textContent = '{% if lang == "Українська" %}Спочатку додайте картку{% else %}Please add a card first{% endif %}';
    } else {
        openSubscribe('deposit');
    }
}

window.performDeposit = function() {
    const depositInput = document.getElementById('deposit-amount');
    const depositWalletSpan = document.getElementById('deposit-wallet');
    const currencySelect = document.querySelector('.wallet form select');
    const depositResult = document.getElementById('deposit-result');
    
    if (!depositInput || !depositWalletSpan) return;
    
    const v = Number(depositInput.value) || 0;
    if (v <= 0) {
        alert('Please enter an amount greater than 0');
        return;
    }

    const depositCurrency = (currencySelect && currencySelect.value) ? currencySelect.value : ("{{ user.currency|default:'USD' }}");

    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrf = csrfInput ? csrfInput.value : '';

    const formData = new FormData();
    formData.append('amount', v);
    formData.append('currency', depositCurrency);

    fetch('{% url "deposit-funds" %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrf,
        },
        body: formData,
    })
    .then(resp => {
        if (!resp.ok) throw new Error('Network response was not ok');
        return resp.json();
    })
    .then(data => {
        if (data && data.price_converted) {
            depositWalletSpan.textContent = data.price_converted;
            const walletAmountEl = document.getElementById('wallet-amount');
            if (walletAmountEl) walletAmountEl.textContent = 'Wallet: ' + data.price_converted;
            const depositToggle = document.getElementById('deposit-toggle');
            const walletToggle = document.getElementById('wallet-toggle');
            if (depositToggle) depositToggle.checked = false;
            if (walletToggle) walletToggle.checked = true;
            depositInput.value = '';
            if (depositResult) depositResult.textContent = '';
        } else if (data && data.error) {
            alert('Deposit failed: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Deposit failed:', err);
        alert('Deposit failed');
    });
};

window.openSubscribe = function(period) {
    const monthToggle = document.getElementById('subscribe-month-toggle');
    const yearToggle = document.getElementById('subscribe-year-toggle');
    const depositToggle = document.getElementById('deposit-toggle');

    if (period === 'month') {
        if (monthToggle) monthToggle.checked = true;
        if (yearToggle) yearToggle.checked = false;
        if (depositToggle) depositToggle.checked = false;
    } else if (period === 'year') {
        if (yearToggle) yearToggle.checked = true;
        if (monthToggle) monthToggle.checked = false;
        if (depositToggle) depositToggle.checked = false;
    } else if (period === 'deposit') {
        if (depositToggle) depositToggle.checked = true;
        if (monthToggle) monthToggle.checked = false;
        if (yearToggle) yearToggle.checked = false;
    }
};

window.openAdd_card = function() {
    const addToggle = document.getElementById('add_card-toggle');
    if (addToggle) addToggle.checked = true;
    const monthToggle = document.getElementById('subscribe-month-toggle');
    const yearToggle = document.getElementById('subscribe-year-toggle');
    if (monthToggle) monthToggle.checked = false;
    if (yearToggle) yearToggle.checked = false;
    const depositToggle = document.getElementById('deposit-toggle');
    if (depositToggle) depositToggle.checked = false;
};

window.submitAddCard = function() {
    const numberEl = document.getElementById('card-number');
    const holderEl = document.getElementById('card-cardholder');
    const monthEl = document.getElementById('card-expiry-month');
    const yearEl = document.getElementById('card-expiry-year');
    const resultEl = document.getElementById('add-card-result');

    const cardMessages = {
        invalid_card_number: "{{ card_messages.invalid_card_number }}",
        card_added: "{{ card_messages.card_added }}",
        add_card_failed: "{{ card_messages.add_card_failed }}",
        cards_label: "{{ card_messages.cards_label }}",
        no_cards: "{{ card_messages.no_cards }}",
    };

    if (!numberEl || !monthEl || !yearEl) return;
    const number = (numberEl.value || '').replace(/\s+/g, '');
    const holder = holderEl ? holderEl.value : '';
    const month = monthEl.value;
    const year = yearEl.value;

    if (number.length < 13 || number.length > 16 || !/^[0-9]+$/.test(number)) {
        if (resultEl) resultEl.textContent = cardMessages.invalid_card_number;
        return;
    }

    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrf = csrfInput ? csrfInput.value : '';

    const fd = new FormData();
    fd.append('card_number', number);
    fd.append('cardholder', holder);
    fd.append('expiry_month', month);
    fd.append('expiry_year', year);

    fetch('{% url "add-card" %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrf,
        },
        body: fd,
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            if (resultEl) resultEl.textContent = data.error;
            return;
        }
        const cardsList = document.getElementById('cards-list');
        if (cardsList && data.cards) {
            let html = '<strong>' + cardMessages.cards_label + '</strong><div style="margin-top:6px;">';
            if (data.cards.length === 0) html += '<div class="card-item">' + cardMessages.no_cards + '</div>';
            data.cards.forEach(c => {
                html += `<div class="card-item" style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">**** **** ****${c.last4} — ${c.cardholder || '-'} — ${c.expiry}</div>`;
            });
            html += '</div>';
            cardsList.innerHTML = html;
        }
        const addToggle = document.getElementById('add_card-toggle');
        if (addToggle) addToggle.checked = false;
        if (resultEl) resultEl.textContent = cardMessages.card_added;
        if (numberEl) numberEl.value = '';
        if (holderEl) holderEl.value = '';
    })
    .catch(err => {
        console.error('Add card failed', err);
        if (resultEl) resultEl.textContent = cardMessages.add_card_failed;
    });
};

function copyOtherUserTag() {
    const otherProfileTag = document.querySelector('.other-profile-tag');
    if (otherProfileTag) {
        const tagText = otherProfileTag.textContent;
        navigator.clipboard.writeText(tagText)
            .then(() => {
                showCopyNotification('Tag copied!');
            })
            .catch(err => {
                console.error('Error copying tag:', err);
                showCopyNotification('Failed to copy tag');
            });
    }
}

function showCopyNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 2000);
}

const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}