{% extends 'base/base.html' %}
{% load static %}

{% block title %}
<title>Main</title>
<link rel="icon" href="{% static 'icons/Bin.jpg' %}" type="image/png">
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<!-- <link rel="stylesheet" href="{% static 'js/home.js' %}"> -->

<style>
.chat-input:empty::before {
    content: "–í–≤–µ–¥—ñ—Ç—å —Å–≤–æ—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...";
    color: #aaa;
    pointer-events: none;
}
</style>

{% endblock %}

{% block body %}
<input type="checkbox" id="menu-toggle">
<input type="checkbox" id="profile-toggle">
<input type="checkbox" id="other-profile-toggle">
<input type="checkbox" id="setting-toggle">
<input type="checkbox" id="form1-toggle">
<input type="checkbox" id="form2-toggle">
<input type="checkbox" id="color_theme-toggle">
<input type="checkbox" id="chat-settings-toggle">
<input type="checkbox" id="wallpaper-toggle">
<input type="checkbox" id="wallet-toggle">
<input type="checkbox" id="check-subscription-toggle">
<input type="checkbox" id="subscribe-month-toggle">
<input type="checkbox" id="subscribe-year-toggle">
<input type="checkbox" id="deposit-toggle">
<input type="checkbox" id="add_card-toggle">
<input type="checkbox" id="bin_mouth-toggle">
<input type="checkbox" id="bin_premium_mouth-toggle">
<input type="checkbox" id="bin_years-toggle">
<input type="checkbox" id="bin_premium_years-toggle">
<input type="checkbox" id="security-toggle">
<input type="checkbox" id="chat-toggle">

<div class="profile-overlay"></div>
<div class="other-profile-overlay"></div>
<div class="setting-overlay"></div>
<div class="form1-overlay"></div>
<div class="form2-overlay"></div>
<div class="color_theme-overlay"></div>
<div class="chat-settings-overlay"></div>
<div class="wallpaper-overlay"></div>
<div class="wallet-overlay"></div>
<div class="check-subscription-overlay"></div>
<div class="subscribe-month-overlay"></div>
<div class="subscribe-year-overlay"></div>
<div class="deposit-overlay"></div>
<div class="add_card-overlay"></div>
<div class="bin_mouth-overlay"></div>
<div class="bin_premium_mouth-overlay"></div>
<div class="bin_years-overlay"></div>
<div class="security-overlay"></div>
<div class="bin_premium_years-overlay"></div>
<div class="chat-overlay"></div>

{% if messages %}
    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
        {% for message in messages %}
            <div style="background: {% if message.tags == 'error' %}#f44336{% else %}#4CAF50{% endif %}; color: white; padding: 15px 20px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); animation: slideIn 0.3s;">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
    <script>
        setTimeout(() => {
            document.querySelectorAll('[style*="slideIn"]').forEach(el => {
                el.style.animation = 'slideOut 0.3s';
                setTimeout(() => el.remove(), 300);
            });
        }, 5000);
    </script>
{% endif %}

<label class="hamburger" for="menu-toggle"><span></span><span></span><span></span></label>
<label for="menu-toggle" class="overlay"></label>
<div class="side-menu">
    {% if user.photo and user.photo.url %}
        <img class="avatar" src="{{ user.photo.url }}" alt="–ê–≤–∞—Ç–∞—Ä" onerror="this.src='{% static 'pictures/login.png' %}'">
    {% else %}
        <img class="avatar" src="{% static 'pictures/login.png' %}" alt="–ê–≤–∞—Ç–∞—Ä">
    {% endif %}
    <div class="username">{{ user.username }}</div>
    {% if user.subscribe == "Bin+" %}
        <div style="color:#0056b3" class="username-line">Bin+</div>
    {% elif user.subscribe == "Bin_premium" %}
        <div style="color:#b3009b" class="username-line">Bin Premium</div>
    {% else %}
        <div class="username-line"></div>
    {% endif %}
    <label for="profile-toggle" class="main-btn main-btn-style-1">–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</label>
    <label for="wallet-toggle" class="main-btn main-btn-style-1">–ì–∞–º–∞–Ω–µ—Ü—å</label>
    <label for="setting-toggle" class="main-btn main-btn-style-1">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</label> 
</div>      

<div class="setting-form">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <label for="form1-toggle" class="main-btn main-btn-style-1">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</label>
    <label for="form2-toggle" class="main-btn main-btn-style-1">–ú–æ–≤–∞</label>
    <label for="color_theme-toggle" class="main-btn main-btn-style-1">–ö–æ–ª—ñ—Ä–Ω–∞ —Ç–µ–º–∞</label>
    <label for="chat-settings-toggle" class="main-btn main-btn-style-1">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —á–∞—Ç—É</label>
    <a class="main-btn main-btn-style-1" href="https://t.me/lakilach_bot" target="_blank" style="text-decoration: none; color: inherit;">–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</a>
    <label for="subscribe-month-toggle" class="main-btn main-btn-style-1">–ü—ñ–¥–ø–∏—Å–∫–∞</label>
    <label for="security-toggle" class="main-btn main-btn-style-1">–ë–µ–∑–ø–µ–∫–∞</label>
    <form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">
    {% csrf_token %}
    </form>
    <label class="main-btn main-btn-style-1" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
        –í–∏–π—Ç–∏
    </label>
</div>

<div class="profile-form">
    <div class="profile-preview-card">
        <div class="profile-preview-background" id="main-profile-background"
             style="{% if user.background and user.background.url %}background-image: url('{{ user.background.url }}'); display: block;{% else %}display: none;{% endif %}"></div>
        
        <div class="profile-preview-header">
            {% if user.photo and user.photo.url %}
                <img id="avatarInput-img" class="profile-preview-avatar" src="{{ user.photo.url }}" alt="–ê–≤–∞—Ç–∞—Ä" onerror="this.src='{% static 'pictures/login.png' %}'">
            {% else %}
                <img id="avatarInput-img" class="profile-preview-avatar" src="{% static 'pictures/login.png' %}" alt="–ê–≤–∞—Ç–∞—Ä">
            {% endif %}
            <div class="profile-preview-info">
                <h3 class="username-text">{{ user.username }}</h3>
                <div class="profile-preview-status">
                    <span class="status-value {% if user.status == 'Online' %}online{% else %}offline{% endif %}">
                        ‚óè {{ user.status|default:"–ù–µ –≤ –º–µ—Ä–µ–∂—ñ" }}
                    </span>
                </div>
                <div class="profile-preview-tag tag-copy" id="user-tag">{{ user.your_tag }}</div>
                <br>
                <label for="form1-toggle" class="edit-icon">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</label>
            </div>
        </div>
        
        <hr class="profile-preview-divider">
        {% if profile_user.role == "Administrator" or profile_user.role == "Moderator" or profile_user.subscribe == "Bin_premium" or profile_user.subscribe == "Bin+" %}
            <div class="profile-preview-section" style="display: inline-flex; align-items: center; gap: 6px;">
                <div class="profile-preview-value">
                    {% if profile_user.role == 'Administrator' %}
                        <span style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            üëë –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä
                        </span>
                        {% if profile_user.subscribe == 'Bin_premium' or profile_user.subscribe == 'Bin+' %}
                            &nbsp;|
                        {% endif %}
                    {% elif profile_user.role == 'Moderator' %}
                        <span style="background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä
                        </span>
                        {% if profile_user.subscribe == 'Bin_premium' or profile_user.subscribe == 'Bin+' %}
                            &nbsp;|
                        {% endif %}
                    {% endif %}
                </div>      

                <div class="profile-preview-value">
                    {% if profile_user.subscribe == 'Bin_premium' %}
                        <span style="background: linear-gradient(135deg, #6f42c1, #5a32a3); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            üíé Bin Premium
                        </span>
                    {% elif profile_user.subscribe == 'Bin+' %}
                        <span style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            üåü Bin+
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endif %}
        
        <div class="profile-preview-section">
            <div class="profile-preview-label">–û–ø–∏—Å</div>
            <div class="profile-preview-value" id="my-profile-description">
                {{ user.description|default:"–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π" }}
            </div>
        </div>
                
        <span class="birthday-value">
            {% if user.show_birthday and user.birthday %}
                <div class="profile-preview-section">
                    <div class="profile-preview-label">–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</div>        

                    <div class="profile-preview-birthday" style="display: flex; align-items: center; gap: 10px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>     

                        <span class="birthday-value">
                            {% if user.show_birthday and user.birthday %}
                                {{ user.birthday|date:"d.m.Y" }}
                            {% endif %}
                        </span>
                    </div>
                </div>
            {% endif %}
        </span>
    </div>
</div>

<div class="other-profile-form">
    <div class="profile-preview-card">
        <div class="profile-preview-background" id="other-profile-background"
             style="{% if profile_user.background and profile_user.background.url %}background-image: url('{{ profile_user.background.url }}'); display: block;{% else %}display: none;{% endif %}"></div>
        
        <div class="profile-preview-header">
            <img class="profile-preview-avatar other-profile-avatar" 
                 src="{% if profile_user.photo and profile_user.photo.url %}{{ profile_user.photo.url }}{% else %}{% static 'pictures/login.png' %}{% endif %}" 
                 alt="–ê–≤–∞—Ç–∞—Ä">
            <div class="profile-preview-info">
                <h3 class="username-text other-profile-username">{{ profile_user.username }}</h3>
                <div class="profile-preview-status">
                    <span class="status-value {% if profile_user.status == 'Online' %}online{% else %}offline{% endif %} other-profile-status">
                        ‚óè {{ profile_user.status|default:"–ù–µ –≤ –º–µ—Ä–µ–∂—ñ" }}
                    </span>
                </div>
                <div class="profile-preview-tag tag-copy other-profile-tag" onclick="copyOtherUserTag()">
                    @{{ profile_user.your_tag|default:profile_user.username }}
                </div>
            </div>
        </div>
        
        <hr class="profile-preview-divider">
        
        {% if profile_user.role in 'Administrator,Moderator,System Bot' or profile_user.subscribe in 'Bin_premium,Bin+' %}
            <div class="profile-preview-section" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <div class="profile-preview-value" id="other-profile-role">
                    {% if profile_user.role == 'Administrator' %}
                        <span style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            üëë –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä
                        </span>
                    {% elif profile_user.role == 'Moderator' %}
                        <span style="background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä
                        </span>
                    {% elif profile_user.role == 'System Bot' %}
                        <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            ü§ñ –°–∏—Å—Ç–µ–º–Ω–∏–π –±–æ—Ç
                        </span>
                    {% endif %}
                </div>      

                {% if profile_user.role in 'Administrator,Moderator,System Bot' and profile_user.subscribe in 'Bin_premium,Bin+' %}
                    <span style="color: #6c757d; font-weight: bold; user-select: none; margin: 0 4px;">|</span>
                {% endif %}     

                <div class="profile-preview-value" id="other-profile-subscribe">
                    {% if profile_user.subscribe == 'Bin_premium' %}
                        <span style="background: linear-gradient(135deg, #6f42c1, #5a32a3); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            üíé –ë—ñ–Ω –ø—Ä–µ–º—ñ—É–º
                        </span>
                    {% elif profile_user.subscribe == 'Bin+' %}
                        <span style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            üåü –ë—ñ–Ω+
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <div class="profile-preview-section">
            <div class="profile-preview-label">–û–ø–∏—Å</div>
            <div class="profile-preview-value other-profile-description">
                {{ profile_user.description|default:"–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π" }}
            </div>
        </div>
        
        {% if profile_user.show_birthday and profile_user.birthday %}
            <div class="profile-preview-section">
                <div class="profile-preview-label">Birthday</div>
                <div class="profile-preview-birthday" style="display: flex; align-items: center; gap: 10px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>              
                    <span class="birthday-value other-profile-birthday">
                        {{ profile_user.birthday|date:"d.m.Y" }}
                    </span>
                </div>
            </div>
        {% endif %}
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="other-profile-message-btn main-btn-style-1" onclick="openChatWithOtherUser()">
                –ù–∞–ø–∏—Å–∞—Ç–∏
            </button>
        </div>
    </div>
</div>

<div class="color_theme-form">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä–æ–≤–æ—ó —Ç–µ–º–∏</h2>
    <select id="themeSelect">
        <option value="" disabled>=== –ë–∞–∑–æ–≤—ñ ===</option>
        <option value="light">–°–≤—ñ—Ç–ª–∞</option>
        <option value="dark">–¢–µ–º–Ω–∞</option>
        <option value="" disabled>=== –î–ª—è –ø—ñ–¥–ø–∏—Å–∫–∏ ===</option>
        <option value="pink">–†–æ–∂–µ–≤–∞</option>
        <!-- <option value="green">–ó–µ–ª–µ–Ω–∞</option> -->
    </select>
    <button id="applyThemeBtn">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>   

    <div class="icon-checkbox-container">
        <input type="checkbox" id="customThemeToggle" class="icon-checkbox" {% if user.custom_button_enabled %}checked{% endif %}>
        <label for="customThemeToggle">
            <span class="check-icon">
                <svg viewBox="0 0 20 20" style="display: none;">
                    <polyline points="4 10 8 14 16 6"></polyline>
                </svg>
            </span>
            <span id="customThemeLabel">{% if user.custom_button_enabled %}–ö–∞—Å—Ç–æ–º —É–≤—ñ–º–∫–Ω–µ–Ω–æ{% else %}–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞—Å—Ç–æ–º–Ω—É –∫–Ω–æ–ø–∫—É{% endif %}</span>
        </label>
    </div>

    <div id="additional-checkboxes-container" style="{% if not user.custom_button_enabled %}display: none;{% endif %} margin-top: 15px; padding: 10px; border-radius: 6px;">
        <h4 style="margin-top: 0; margin-bottom: 10px;">–ö–∞—Å—Ç–æ–º–Ω—ñ –æ–ø—Ü—ñ—ó</h4>         

        <div style="display: flex; flex-direction: column; gap: 15px; align-items: flex-start;">
            <div class="icon-checkbox2-container" style="margin: 0;">
                <input type="radio" name="customOption" id="customOption1" class="icon-checkbox2" 
                       value="1"
                       {% if user.custom_option == '1' or not user.custom_option %}checked{% endif %}>
                <label for="customOption1" style="display: flex; align-items: center; gap: 10px;">
                    <span class="check-icon2 radio-icon">
                        <svg viewBox="0 0 20 20" style="display: none;">
                            <polyline points="4 10 8 14 16 6"></polyline>
                        </svg>
                    </span>
                    <span>–°–≤—ñ—Ç–ª–æ-—Ç–µ–º–Ω–∞</span>
                </label>
            </div>          

            <div class="icon-checkbox2-container" style="margin: 0;">
                <input type="radio" name="customOption" id="customOption2" class="icon-checkbox2" 
                       value="2"
                       {% if user.custom_option == '2' %}checked{% endif %}>
                <label for="customOption2" style="display: flex; align-items: center; gap: 10px;">
                    <span class="check-icon2 radio-icon">
                        <svg viewBox="0 0 20 20" style="display: none;">
                            <polyline points="4 10 8 14 16 6"></polyline>
                        </svg>
                    </span>
                    <span>–í–µ—Å–µ–ª–∫–∞</span>
                </label>
            </div>          

            <div class="icon-checkbox2-container" style="margin: 0;">
                <input type="radio" name="customOption" id="customOption3" class="icon-checkbox2" 
                       value="3"
                       {% if user.custom_option == '3' %}checked{% endif %}>
                <label for="customOption3" style="display: flex; align-items: center; gap: 10px;">
                    <span class="check-icon2 radio-icon">
                        <svg viewBox="0 0 20 20" style="display: none;">
                            <polyline points="4 10 8 14 16 6"></polyline>
                        </svg>
                    </span>
                    <span>–Ø—Å–∫—Ä–∞–≤–∞</span>
                </label>
            </div>  

            <div class="icon-checkbox2-container" style="margin: 0;">
                <input type="radio" name="customOption" id="customOption4" class="icon-checkbox2" 
                       value="4"
                       {% if user.custom_option == '4' %}checked{% endif %}>
                <label for="customOption4" style="display: flex; align-items: center; gap: 10px;">
                    <span class="check-icon2 radio-icon">
                        <svg viewBox="0 0 20 20" style="display: none;">
                            <polyline points="4 10 8 14 16 6"></polyline>
                        </svg>
                    </span>
                    <span>–¢–µ–º–Ω–∞</span>
                </label>
            </div>
        </div>
    </div>

    <div id="text-color-container" style="margin-top: 15px; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
        <h4 style="margin-top: 0; margin-bottom: 10px;">–ö–æ–ª—ñ—Ä —Ç–µ–∫—Å—Ç—É –∫–Ω–æ–ø–æ–∫</h4>                              

        <div style="display: flex; flex-direction: column; gap: 15px; align-items: flex-start;">
            <div class="icon-checkbox3-container" style="margin: 0;">
                <input type="radio" name="textColorOption" id="textColorWhite" class="icon-checkbox3" 
                       value="white"
                       {% if user.color_text_button == 'white' %}checked{% endif %}>
                <label for="textColorWhite" style="display: flex; align-items: center; gap: 10px;">
                    <span class="check-icon3 radio-icon">
                        <svg viewBox="0 0 20 20" style="display: none;">
                            <polyline points="4 10 8 14 16 6"></polyline>
                        </svg>
                    </span>
                    <span>–ë—ñ–ª–∏–π —Ç–µ–∫—Å—Ç</span>
                </label>
            </div>                                                      

            <div class="icon-checkbox3-container" style="margin: 0;">
                <input type="radio" name="textColorOption" id="textColorBlack" class="icon-checkbox3" 
                       value="black"
                       {% if user.color_text_button == 'black' %}checked{% endif %}>
                <label for="textColorBlack" style="display: flex; align-items: center; gap: 10px;">
                    <span class="check-icon3 radio-icon">
                        <svg viewBox="0 0 20 20" style="display: none;">
                            <polyline points="4 10 8 14 16 6"></polyline>
                        </svg>
                    </span>
                    <span>–ß–æ—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç</span>
                </label>
            </div>
        </div>
    </div>

    <label class="main-btn main-btn-style-1">–ì–∞–º–∞–Ω–µ—Ü—å</label>
</div>         

<div class="chat-settings-form">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —á–∞—Ç—É</h2>
    
    <div class="form-group">
        <label class="toggle-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="hour-format-toggle-checkbox" style="display: none;">
            <div class="toggle-switch" id="hour-format-toggle" style="width: 50px; height: 24px; background: #ddd; border-radius: 12px; position: relative; transition: background 0.3s;">
                <div class="toggle-slider" style="position: absolute; left: 2px; top: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.3s;"></div>
            </div>
            <span id="hour-format-text" style="user-select: none;">12-–≥–æ–¥–∏–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç (AM/PM)</span>
        </label>
    </div>
</div>

<div class="form1">
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
    <div class="form1-inner">
        <div class="form1-fields">
            <form action="{% url 'update_profile' %}" method="post" enctype="multipart/form-data" id="edit-profile-form">
                {% csrf_token %}        

                <div class="avatar-upload-section">
                    {% if user.photo and user.photo.url %}
                        <img id="edit-avatar-preview" class="avatar" src="{{ user.photo.url }}" alt="–ê–≤–∞—Ç–∞—Ä" onerror="this.src='{% static 'pictures/login.png' %}'">
                    {% else %}
                        <img id="edit-avatar-preview" class="avatar" src="{% static 'pictures/login.png' %}" alt="–ê–≤–∞—Ç–∞—Ä">
                    {% endif %}
                    <br><br>

                    <label for="avatarInput" style="display: inline-block; padding: 8px 16px; background: #007bff; color: white; border-radius: 6px; cursor: pointer;">
                        –í–∏–±—Ä–∞—Ç–∏ –Ω–æ–≤–∏–π –∞–≤–∞—Ç–∞—Ä
                        <input type="file" id="avatarInput" name="photo" accept="image/*" style="display: none;">
                    </label>
                    <button type="button" class="btn-delete-avatar" onclick="confirmAvatarReset()">
                        –í–∏–¥–∞–ª–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä
                    </button>   
                </div>  

                <div class="form-group">
                    <label for="username-input"><strong>–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:</strong></label>
                    <input type="text" id="username-input" name="username" value="{{ user.username }}" maxlength="18">
                </div>      

                <div class="form-group">
                    <label><strong>–û–ø–∏—Å:</strong></label>
                    <textarea class="description-input" name="description" maxlength="{% if user.subscribe == 'Bin+' %}100{% elif user.subscribe == 'Bin_premium' %}150{% else %}70{% endif %}" rows="4" style="resize: none;">{{ user.description }}</textarea>
                    <div class="desc-counter" style="font-size:12px;color:#666;margin-top:6px;"></div>
                </div>      

                <div class="form-group">
                    <label for="tag-input"><strong>–¢–µ–≥:</strong></label>
                    <input type="text" id="tag-input" name="your_tag" value="{{ user.your_tag }}" maxlength="20">
                </div>          

                <div class="form-group">
                    <label><strong>–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è:</strong></label>
                    <div class="birthday-selects">
                        <select name="day" id="birthday-day">
                            {% for d in days %}
                            <option value="{{ d }}" {% if birthday.day == d %}selected{% endif %}>{{ d }}</option>
                            {% endfor %}
                        </select>
                        <select name="month" id="birthday-month">
                            {% for m in months %}
                            <option value="{{ m }}" {% if birthday.month == m %}selected{% endif %}>{{ m }}</option>
                            {% endfor %}
                        </select>
                        <select name="year" id="birthday-year">
                            {% for y in years %}
                            <option value="{{ y }}" {% if birthday.year == y %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>   
                
                <div class="form-group" style="margin-top: 12px;">
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" 
                               name="show_birthday" 
                               id="show-birthday-checkbox"
                               {% if user.show_birthday %}checked{% endif %}>
                        <span>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –¥–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</span>
                    </label>
                </div>

                <button id="savechangesform1" type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
            </form>
        </div>          

        <div class="form1-preview">
            <div class="profile-preview-card" id="profile-preview-card">
                <div class="profile-preview-background" id="preview-background"
                     style="{% if user.background and user.background.url %}background-image: url('{{ user.background.url }}'); display: block;{% else %}display: none;{% endif %}"></div>              

                <div class="preview-badge">–ü–ï–†–ï–ì–õ–Ø–î</div>        

                <div class="profile-preview-header">
                    {% if user.photo and user.photo.url %}
                        <img id="edit-avatar-preview" class="avatar" src="{{ user.photo.url }}" alt="–ê–≤–∞—Ç–∞—Ä" onerror="this.src='{% static 'pictures/login.png' %}'">
                    {% else %}
                        <img id="edit-avatar-preview" class="avatar" src="{% static 'pictures/login.png' %}" alt="–ê–≤–∞—Ç–∞—Ä">
                    {% endif %}
                    <div class="profile-preview-info">
                        <h3 id="preview-username" class="other-profile-username">{{ user.username }}</h3>
                        <div class="profile-preview-status">
                            <span class="status-value other-profile-status {% if user.status == 'Online' %}online{% else %}offline{% endif %}">
                                ‚óè {{ user.status|default:"–ù–µ –≤ –º–µ—Ä–µ–∂—ñ" }}
                            </span>
                        </div>
                        <div class="profile-preview-tag other-profile-tag" id="preview-tag">{{ user.your_tag }}</div>
                    </div>
                </div>          

                <hr class="profile-preview-divider">            

                <div class="profile-preview-section">
                    <div class="profile-preview-label">–û–ø–∏—Å</div>
                    <div class="profile-preview-value" id="preview-description">
                        {{ user.description|default:"–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π" }}
                    </div>
                </div>          

                <div class="profile-preview-section" id="preview-birthday-section">
                    <div class="profile-preview-label">–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</div>
                    <div class="profile-preview-birthday">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span id="preview-birthday">{{ user.birthday|default:"–ù–µ –≤–∫–∞–∑–∞–Ω–æ" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="form2">
    <form class="language-form" method="POST" action="{% url 'change-language' %}">
        {% csrf_token %}
        <select name="language">
            <option value="English" {% if lang == "English" %}selected{% endif %}>English</option>
            <option value="–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" {% if lang == "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" %}selected{% endif %}>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
        </select>
        <button class="language-change-btn" type="submit">–ó–º—ñ–Ω–∏—Ç–∏</button>
    </form>
</div>

<div class="wallet wallet-form">
    <p id="wallet-amount">–ì–∞–º–∞–Ω–µ—Ü—å: {{ price_converted }}</p>
    <form action="{% url 'change-currency' %}" method="post">
        {% csrf_token %}
        <select name="currency" onchange="this.form.submit()">
            <option value="USD" {% if user.currency == 'USD' %}selected{% endif %}>USD $</option>
            <option value="UAH" {% if user.currency == 'UAH' %}selected{% endif %}>UAH ‚Ç¥</option>
        </select>
    </form>     

    <div class="currency-converter" style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        <strong>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –≤–∞–ª—é—Ç</strong>     

        <div id="all-currencies-display" style="margin-top: 10px;">
            <div class="currency-item" style="display: flex; align-items: center; margin-bottom: 8px; padding: 6px; border-radius: 4px;">
                <span style="margin-right: 8px;">üá∫üá∏</span>
                <span id="usd-amount">--</span>
            </div>
            <div class="currency-item" style="display: flex; align-items: center; margin-bottom: 8px; padding: 6px; border-radius: 4px;">
                <span style="margin-right: 8px;">üá™üá∫</span>
                <span id="eur-amount">--</span>
            </div>
            <div class="currency-item" style="display: flex; align-items: center; margin-bottom: 8px; padding: 6px; border-radius: 4px;">
                <span style="margin-right: 8px;">üá¨üáß</span>
                <span id="gbp-amount">--</span>
            </div>
            <div class="currency-item" style="display: flex; align-items: center; margin-bottom: 8px; padding: 6px; border-radius: 4px;">
                <span style="margin-right: 8px;">üá∫üá¶</span>
                <span id="uah-amount">--</span>
            </div>
        </div>
    </div>      

    <button type="button" id="deposit-btn" class="deposit-btn" onclick="checkCardsAndOpenDeposit()">
        –ü–æ–ø–æ–≤–Ω–∏—Ç–∏ –≥–∞–º–∞–Ω–µ—Ü—å
    </button>

    <button type="button" id="add_card-btn" class="add_card-btn" onclick="openAdd_card('add_card')">
        –î–æ–¥–∞—Ç–∏ –∫–∞—Ä—Ç–∫—É
    </button>

    <div id="cards-list" style="margin-top:12px;">
        <strong>–ö–∞—Ä—Ç–∫–∏:</strong>
        <div style="margin-top:6px;">
            {% if cards and cards.count %}
                {% for c in cards %}
                    <div class="card-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">
                        <span>**** **** ****{{ c.last4 }} ‚Äî {{ c.cardholder|default:'-' }} ‚Äî {{ c.expiry_month|stringformat:"02d" }}/{{ c.expiry_year }}</span>
                        <button type="button" onclick="deleteCard('{{ c.last4 }}')" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">üóëÔ∏è</button>
                    </div>
                {% endfor %}
            {% else %}
                <div class="card-item" style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">–ö–∞—Ä—Ç –Ω–µ –¥–æ–¥–∞–Ω–æ</div>
            {% endif %}
        </div>
    </div>
</div>

<label for="add_card-toggle" class="add_card-overlay"></label>
<div class="add_card add_card-form">
    <h2>–î–æ–¥–∞—Ç–∏ –∫–∞—Ä—Ç–∫—É</h2>
    <form id="add-card-form" onsubmit="return false;">
        <label>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏</label>
        <input id="card-number" type="text" inputmode="numeric" pattern="[0-9\s]*" maxlength="19" placeholder="1235 9864 2134 1253" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">

        <label style="margin-top:8px;">–Ü–º'—è –≤–ª–∞—Å–Ω–∏–∫–∞</label>
        <input id="card-cardholder" type="text" placeholder="–Ü–ú'–Ø –ü–†–Ü–ó–í–ò–©–ï" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">

        <div style="display:flex; gap:8px; margin-top:8px;">
            <div style="flex:1;">
                <label>–ú—ñ—Å—è—Ü—å</label>
                <select id="card-expiry-month" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                    {% for m in months %}
                        <option value="{{ m }}">{{ m|stringformat:"02d" }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="flex:1;">
                <label>–†—ñ–∫</label>
                <select id="card-expiry-year" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                    {% for y in expiry_years %}
                        <option value="{{ y }}">{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <label style="margin-top:8px;">CVV</label>
        <input id="card-cvv" type="password" maxlength="3" placeholder="123" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">

        <div style="display:flex; gap:8px; margin-top:12px;">
            <button type="button" class="deposit-btn" onclick="submitAddCard()">–î–æ–¥–∞—Ç–∏</button>
            <button type="button" class="deposit-btn" onclick="(function(){ const cb=document.getElementById('add_card-toggle'); if(cb) cb.checked=false; })()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
        <p id="add-card-result" style="margin-top:8px;color:#333;font-weight:600;"></p>
    </form>
</div>

<label for="deposit-toggle" class="deposit-overlay"></label>
<div class="deposit deposit-form">
    <h2>–ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è</h2>
    <p>–ì–∞–º–∞–Ω–µ—Ü—å: <span id="deposit-wallet">{{ price_converted }}</span></p>
    <select id="deposit-card" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;">
        {% if cards and cards.count %}
            {% for c in cards %}
                <option value="{{ c.last4 }}">**** **** **** {{ c.last4 }} ‚Äî {{ c.cardholder|default:'-' }}</option>
            {% endfor %}
        {% endif %}
    </select>
    <input id="deposit-amount" type="number" placeholder="–°—É–º–∞" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
    <p id="deposit-result" style="margin-top:8px;color:#333;font-weight:600;"></p>
    <button type="button" class="deposit-btn" onclick="performDeposit()">–ü–æ–ø–æ–≤–Ω–∏—Ç–∏</button>
</div>

<div class="subscribe-form-month">
    <div class="subscribe-buttons" style="display: flex; justify-content: center; gap: 40px; margin-bottom: 20px;">
        <button type="button" class="Subscribe-switching-button" onclick="openSubscribe('month')">–ú—ñ—Å—è—Ü—å</button>
        <button type="button" class="Subscribe-switching-button year-btn" onclick="openSubscribe('year')">
            –†—ñ–∫
            <span class="discount">-17%</span>
        </button>
    </div>

    <div class="plans-container" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">

        <div class="plan">
            <div class="inner">
                <span class="pricing">
                    <span>
                        {% if user.currency == 'USD' %}
                            $4.99 <small>/ –º—ñ—Å</small>
                        {% elif user.currency == 'UAH' %}
                            ‚Ç¥209.99 <small>/ –º—ñ—Å</small>
                        {% endif %}
                    </span>
                </span>
                <p class="title">Bin+</p>
                <p class="info">–£—Å–µ –∑ Basic, –∞ —Ç–∞–∫–æ–∂:</p>
                <ul class="features" style="list-style: none; padding: 0; margin: 0;">
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span>
                            <strong>–ú–æ–∂–Ω–∞ –ø–∏—Å–∞—Ç–∏ –¥–æ 100 —Å–∏–º–≤–æ–ª—ñ–≤ –≤ –æ–ø–∏—Å—ñ</strong>
                        </span>
                    </li>
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span>
                            <strong>–ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ GIF-–∞–≤–∞—Ç–∞—Ä</strong>
                        </span>
                    </li>
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span>
                            <strong>–ú–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Ç–µ–º—É (–¥–æ—Å—Ç—É–ø–Ω–∞ —Ä–æ–∂–µ–≤–∞)</strong>
                        </span>
                    </li>
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span>
                            <strong>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –¥–æ 20 –ú–ë</strong>
                        </span>
                    </li>
                </ul>
                <div class="action">
                    <label for="bin_mouth-toggle" class="button">–û–±—Ä–∞—Ç–∏ —Ç–∞—Ä–∏—Ñ</label>
                </div>
            </div>
        </div>      

        <div class="plan">
            <div class="inner">
                <span class="pricing">
                    <span>
                        {% if user.currency == 'USD' %}
                            $9.99 <small>/ –º—ñ—Å</small>
                        {% elif user.currency == 'UAH' %}
                            ‚Ç¥419.99 <small>/ –º—ñ—Å</small>
                        {% endif %}
                    </span>
                </span>
                <p class="title">Bin Premium</p>
                <p class="info">–£—Å–µ –∑ Bin+, –∞ —Ç–∞–∫–æ–∂:</p>
                <ul class="features" style="list-style: none; padding: 0; margin: 0;">
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span>
                            <strong>–ú–æ–∂–Ω–∞ –ø–∏—Å–∞—Ç–∏ –¥–æ 150 —Å–∏–º–≤–æ–ª—ñ–≤ –≤ –æ–ø–∏—Å—ñ</strong>
                        </span>
                    </li>
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span>
                            <strong>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –¥–æ 50 –ú–ë</strong>
                        </span>
                    </li>
                </ul>
                <br><br><br><br><br>
                <div class="action">
                    <label for="bin_premium_mouth-toggle" class="button">–û–±—Ä–∞—Ç–∏ —Ç–∞—Ä–∏—Ñ</label>
                </div>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <label for="check-subscription-toggle" class="check-subscription-btn">
            –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –ø—ñ–¥–ø–∏—Å–∫–∏
        </label>
    </div>
</div>

<div class="subscribe-form-year">
    <div class="subscribe-buttons" style="display: flex; justify-content: center; gap: 40px; margin-bottom: 20px;">
        <button type="button" class="Subscribe-switching-button" onclick="openSubscribe('month')">–ú—ñ—Å—è—Ü—å</button>
        <button type="button" class="Subscribe-switching-button year-btn" onclick="openSubscribe('year')">
            –†—ñ–∫
            <span class="discount">-17%</span>
        </button>
    </div>

    <div class="plans-container" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
        <div class="plan">
            <div class="inner">
                <span class="pricing">
                    <span>
                        {% if user.currency == 'USD' %}
                            <span class="old-price">$59.88</span>
                            <span class="new-price">$49.99</span> <small>/ —Ä—ñ–∫</small>
                        {% elif user.currency == 'UAH' %}
                            <span class="old-price">‚Ç¥2519.88</span>
                            <span class="new-price">‚Ç¥2099.99</span> <small>/ —Ä—ñ–∫</small>
                        {% endif %}
                    </span>
                </span>
                <p class="title">Bin+</p>
                <p class="info">–£—Å–µ –∑ Basic, –∞ —Ç–∞–∫–æ–∂:</p>
                <ul class="features" style="list-style: none; padding: 0; margin: 0;">
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span><strong>–ú–æ–∂–Ω–∞ –ø–∏—Å–∞—Ç–∏ –¥–æ 100 —Å–∏–º–≤–æ–ª—ñ–≤ –≤ –æ–ø–∏—Å—ñ</strong></span>
                    </li>
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span><strong>–ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ GIF-–∞–≤–∞—Ç–∞—Ä</strong></span>
                    </li>
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span>
                            <strong>–ú–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É (–¥–æ–¥–∞—Ç–∏ —Ä–æ–∂–µ–≤—É)</strong>
                        </span>
                    </li>
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span><strong>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –¥–æ 20 –ú–ë</strong></span>
                    </li>
                </ul>
                <div class="action">
                    <label for="bin_years-toggle" class="button">–û–±—Ä–∞—Ç–∏ –ø–ª–∞–Ω</label>
                </div>
            </div>
        </div>

        <div class="plan">
            <div class="inner">
                <span class="pricing">
                    <span>
                        {% if user.currency == 'USD' %}
                            <span class="old-price">$119.88</span>
                            <span class="new-price">$99.99</span> <small>/ —Ä—ñ–∫</small>
                        {% elif user.currency == 'UAH' %}
                            <span class="old-price">‚Ç¥5039.88</span>
                            <span class="new-price">‚Ç¥4199.99</span> <small>/ —Ä—ñ–∫</small>
                        {% endif %}
                    </span>
                </span>
                <p class="title">Bin Premium</p>
                <p class="info">–£—Å–µ –∑ Bin+, –∞ —Ç–∞–∫–æ–∂:</p>
                <ul class="features" style="list-style: none; padding: 0; margin: 0;">
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span><strong>–ú–æ–∂–Ω–∞ –ø–∏—Å–∞—Ç–∏ –¥–æ 150 —Å–∏–º–≤–æ–ª—ñ–≤ –≤ –æ–ø–∏—Å—ñ</strong></span>
                    </li>
                    <li>
                        <span class="icon" style="margin-right: 10px; flex-shrink: 0;">
                            <svg height="24" width="24" viewBox="0 0 24 24">
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path fill="currentColor" d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"></path>
                            </svg>
                        </span>
                        <span><strong>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –¥–æ 50 –ú–ë</strong></span>
                    </li>
                    <br><br><br><br>
                </ul>
                <div class="action">
                    <label for="bin_premium_years-toggle" class="button">–û–±—Ä–∞—Ç–∏ –ø–ª–∞–Ω</label>
                </div>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <label for="check-subscription-toggle" class="check-subscription-btn">
            –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –ø—ñ–¥–ø–∏—Å–∫–∏
        </label>
    </div>
</div>

<div class="check-subscription-form">
    <h2>–°—Ç–∞—Ç—É—Å –≤–∞—à–æ—ó –ø—ñ–¥–ø–∏—Å–∫–∏:
    {% if user.subscribe == "Bin+" %}
        <div style="color:#0056b3" class="username-line">–ë—ñ–Ω+</div>
    {% elif user.subscribe == "Bin_premium" %}
        <div style="color:#b3009b" class="username-line">–ë—ñ–Ω –ø—Ä–µ–º—ñ—É–º</div>
    {% endif %}</h2>

    {% if user.subscription_end %}
        <p>–ó–∞–ª–∏—à–∏–ª–æ—Å—å —á–∞—Å—É: <span id="countdown"></span></p>
    {% else %}
        <p>–í–∞—à–∞ –ø—ñ–¥–ø–∏—Å–∫–∞ ‚Äî –ë–∞–∑–æ–≤–∞</p>
    {% endif %}

    {% if can_refund %}
        <div style="margin-top:10px;">
            <span>–í–∏ –º–æ–∂–µ—Ç–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∫–æ—à—Ç–∏ –ø—Ä–æ—Ç—è–≥–æ–º 24 –≥–æ–¥–∏–Ω –ø—ñ—Å–ª—è –ø–æ–∫—É–ø–∫–∏.</span><br>
            <form method="POST" style="text-align:center; margin-top:10px;">
                {% csrf_token %}
                <button type="submit" name="action" value="refund_subscription" class="btn-refund">
                    –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∫–æ—à—Ç–∏
                </button>
            </form>
        </div>
    {% endif %}
</div>

<div class="bin_mouth-form">
    <h2>–û–Ω–æ–≤—ñ—Ç—å —Å–≤—ñ–π –ø–ª–∞–Ω –¥–æ Bin+</h2>
    <form method="post">
        {% csrf_token %}
        <p>–ì–∞–º–∞–Ω–µ—Ü—å: <span>{{ price_converted }}</span></p>
        {% if user.currency == 'USD' %}
            $4.99 <small>/ –º—ñ—Å</small>
        {% elif user.currency == 'UAH' %}
            ‚Ç¥209.99 <small>/ –º—ñ—Å</small>
        {% endif %}
        <div>
            <input type="checkbox" id="terms-bin">
            <label for="terms-bin">–Ø –ø–æ–≥–æ–¥–∂—É—é—Å—å –∑ <a href="/terms" target="_blank">—É–º–æ–≤–∞–º–∏ —Ç–∞ –ø–æ–ª–æ–∂–µ–Ω–Ω—è–º–∏</a></label>
        </div>
        <button type="submit" name="subscription_plan" value="bin_plus_monthly" id="subscribe-bin" disabled class="subscribe-btn">
            –ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è
        </button>
    </form>
</div>

<div class="bin_premium_mouth-form">
    <h2>–û–Ω–æ–≤—ñ—Ç—å —Å–≤—ñ–π –ø–ª–∞–Ω –¥–æ Bin Premium</h2>
    <form method="post">
        {% csrf_token %}
        <p>–ì–∞–º–∞–Ω–µ—Ü—å: <span>{{ price_converted }}</span></p>
        {% if user.currency == 'USD' %}
            $9.99 <small>/ –º—ñ—Å</small>
        {% elif user.currency == 'UAH' %}
            ‚Ç¥419.99 <small>/ –º—ñ—Å</small>
        {% endif %}
        <div>
            <input type="checkbox" id="terms-premium">
            <label for="terms-premium">–Ø –ø–æ–≥–æ–¥–∂—É—é—Å—å –∑ <a href="/terms" target="_blank">—É–º–æ–≤–∞–º–∏ —Ç–∞ –ø–æ–ª–æ–∂–µ–Ω–Ω—è–º–∏</a></label>
        </div>
        <button type="submit" name="subscription_plan" value="bin_premium_monthly" id="subscribe-premium" disabled class="subscribe-btn">
            –ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è
        </button>
    </form>
</div>

<div class="bin_years-form">
    <h2>–û–Ω–æ–≤—ñ—Ç—å —Å–≤—ñ–π –ø–ª–∞–Ω –¥–æ Bin+ (—Ä—ñ—á–Ω–∞)</h2>
    <form method="post">
        {% csrf_token %}
        <p>–ì–∞–º–∞–Ω–µ—Ü—å: <span>{{ price_converted }}</span></p>
        {% if user.currency == 'USD' %}
            $49.99 <small>/ —Ä—ñ–∫</small>
        {% elif user.currency == 'UAH' %}
            ‚Ç¥2099.99 <small>/ —Ä—ñ–∫</small>
        {% endif %}
        <div>
            <input type="checkbox" id="terms-bin-year">
            <label for="terms-bin-year">–Ø –ø–æ–≥–æ–¥–∂—É—é—Å—å –∑ <a href="/terms" target="_blank">—É–º–æ–≤–∞–º–∏ —Ç–∞ –ø–æ–ª–æ–∂–µ–Ω–Ω—è–º–∏</a></label>
        </div>
        <button type="submit" name="subscription_plan" value="bin_plus_yearly" id="subscribe-bin-year" disabled class="subscribe-btn">
            –ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è
        </button>
    </form>
</div>

<div class="bin_premium_years-form">
    <h2>–û–Ω–æ–≤—ñ—Ç—å —Å–≤—ñ–π –ø–ª–∞–Ω –¥–æ Bin Premium (—Ä—ñ—á–Ω–∞)</h2>
    <form method="post">
        {% csrf_token %}
        <p>–ì–∞–º–∞–Ω–µ—Ü—å: <span>{{ price_converted }}</span></p>
        {% if user.currency == 'USD' %}
            $99.99 <small>/ —Ä—ñ–∫</small>
        {% elif user.currency == 'UAH' %}
            ‚Ç¥4199.99 <small>/ —Ä—ñ–∫</small>
        {% endif %}
        <div>
            <input type="checkbox" id="terms-premium-year">
            <label for="terms-premium-year">–Ø –ø–æ–≥–æ–¥–∂—É—é—Å—å –∑ <a href="/terms" target="_blank">—É–º–æ–≤–∞–º–∏ —Ç–∞ –ø–æ–ª–æ–∂–µ–Ω–Ω—è–º–∏</a></label>
        </div>
        <button type="submit" name="subscription_plan" value="bin_premium_yearly" id="subscribe-premium-year" disabled class="subscribe-btn">
            –ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è
        </button>
    </form>
</div>   

<div style="display:flex; gap:5px; align-items:center;">
    <input type="text" id="searchInput"
        style="padding:8px; border-radius:6px; border:1px solid #ccc; margin-top: 16px; margin-left:60px;"
        placeholder="–ü–æ—à—É–∫">
</div>

<div class="main">
    <div class="content">
        <div id="recent-contacts" style="margin-top:-30px; margin-left:-50px; width:300px;">
            <div id="recent-contacts-list">
            </div>
        </div>

        <div id="searchResults" style="margin-top:-30px; margin-left:-50px; width:300px;"></div>
    </div>
</div>

<div class="chat-container">
    <div class="chat-header">
        <h3 onclick="openUserProfile(currentChatUser)" style="flex:1; cursor:pointer; margin:0;"><span id="chat-username"></span></h3>
        <div class="chat-header-kebab" id="chat-kebab" style="position:relative;">
            <button class="kebab-btn" aria-label="Menu" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px;">‚ãÆ</button>
            <div class="kebab-menu" id="kebab-menu" style="display:none; position:absolute; right:0; top:30px; background:var(--surface,#fff); border:1px solid #ccc; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.12); z-index:2200;">
                <button type="button" class="kebab-item" id="view-profile-btn" style="display:block; padding:8px 12px; width:160px; background:transparent; border:none; text-align:left; cursor:pointer; color:var(--text);">View profile</button>
                <!-- <button type="button" class="kebab-item" id="set-wallpaper-btn" onclick="document.getElementById('wallpaper-toggle').checked = true" style="display:block; padding:8px 12px; width:160px; background:transparent; border:none; text-align:left; cursor:pointer; color:var(--text);">Set Wallpaper</button> -->
            </div>
        </div>
    </div>
    <div class="chat-messages" id="chat-messages">
        <div class="chat-messages-spacer"></div>
    </div>

    <button id="chat-scroll-bottom-btn" title="Scroll to bottom" style="display:none; position: absolute; right: 20px; bottom: 100px; z-index:2100; padding:10px 12px; border-radius:8px; background: #007bff; color: #fff; border: none; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.12);">‚ñº</button>

    <div class="chat-input-container">
        <button type="button" class="attach-btn" onclick="openFileInput()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
            üìé
        </button>
        <input type="file" id="chat-file-input" style="display: none;" onchange="handleFileSelect(event)">

        <div id="chat-input" class="chat-input" contenteditable="true" role="textbox" aria-multiline="true" value="–í–≤–µ–¥—ñ—Ç—å —Å–≤–æ—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."></div>
        <input type="hidden" id="chat-input-hidden" name="message" />
        <button type="button" id="sticker-btn" title="Stickers" style="padding:10px; border-radius:8px; background:none; border:none; font-size:20px; cursor:pointer;">üôÇ</button>
        <button class="chat-send-btn" onclick="sendMessage()">Send</button>
    </div>
</div>

<div id="sticker-panel" style="position:fixed; top:80px; right:0; width:320px; height:calc(100% - 160px); background: var(--bg-color,#fff); box-shadow: -4px 0 20px rgba(0,0,0,0.15); transform: translateX(100%); transition: transform 0.25s ease; z-index:2101; padding: 16px; overflow-y:auto; overflow-x:hidden; border-radius:12px; display:flex; flex-direction:column; gap:10px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong id="sticker-panel-title">Stickers</strong>
        <button type="button" id="sticker-close" style="background:none; border:none; font-size:20px; cursor:pointer;" aria-label="Close">‚úï</button>
    </div>
    <div id="sticker-list" style="display:flex; gap:10px; flex-wrap:wrap;">
    </div>
</div>

<div class="security-form">
    <h2>{% if lang == "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" %}–ë–µ–∑–ø–µ–∫–∞{% else %}Security{% endif %}</h2>
    
    <div class="security-section password-section" id="password-section">
        <div class="password-toggle">
            <h4>{% if lang == "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" %}–ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å{% else %}Change Password{% endif %}</h4>
            <div class="password-toggle-arrow">‚ñº</div>
        </div>
        
        <div class="password-form" id="password-form">
            <form method="POST" action="{% url 'change_password' %}">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="current-password">{% if lang == "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" %}–ü–æ—Ç–æ—á–Ω–∏–π –ø–∞—Ä–æ–ª—å{% else %}Current Password{% endif %}</label>
                    <input type="password" id="current-password" name="current_password" required 
                           placeholder="{% if lang == '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' %}–í–≤–µ–¥—ñ—Ç—å –ø–æ—Ç–æ—á–Ω–∏–π –ø–∞—Ä–æ–ª—å{% else %}Enter current password{% endif %}">
                </div>
                
                <div class="form-group">
                    <label for="new-password">{% if lang == "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" %}–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å{% else %}New Password{% endif %}</label>
                    <input type="password" id="new-password" name="new_password" required 
                           placeholder="{% if lang == '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' %}–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å{% else %}Enter new password{% endif %}"
                           minlength="8">
                </div>
                
                <div class="form-group">
                    <label for="confirm-password">{% if lang == "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" %}–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å{% else %}Confirm Password{% endif %}</label>
                    <input type="password" id="confirm-password" name="confirm_password" required 
                           placeholder="{% if lang == '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' %}–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å{% else %}Confirm new password{% endif %}">
                </div>
                
                <button type="submit" class="security-btn">
                    {% if lang == "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" %}–ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å{% else %}Change Password{% endif %}
                </button>
            </form>
        </div>
    </div>
</div>

<script>
let currentChatUser = null;
let chatSocket = null;
let isVideoModalOpen = false;
const perChatLastMessageId = {};
const pendingRefreshOnModalClose = {}; 
let openVideoUrl = null;
let fileInput = null;
let selectedFile = null;
let isUploadingFile = false;
let editingMessageId = null;
let isEditingMode = false;
let editingMessageOriginalText = '';
const lang = "{{ user.language|default:'English' }}";

function initDescriptionCounters() {
    document.querySelectorAll('.description-input').forEach(function(el){
        const max = parseInt(el.getAttribute('maxlength')) || 0;
        const counter = el.parentElement?.querySelector('.desc-counter') || null;

        if (!counter || max <= 0) return;

        function update() {
            const len = el.value.length;
            const left = max - len;
            if (left <= 0) {
                counter.textContent = "0 characters left";
                counter.style.color = "#ff4d4d";
                counter.style.fontWeight = "600";
            } else if (left <= 10) {
                counter.textContent = left + " characters left";
                counter.style.color = "#ff9800";
                counter.style.fontWeight = "500";
            } else {
                counter.textContent = left + " characters left";
                counter.style.color = "#666";
                counter.style.fontWeight = "normal";
            }

            if (len > max) {
                el.value = el.value.slice(0, max);
            }
        }

        el.addEventListener('input', update);
        update();
    });
}

initDescriptionCounters();

function openFileInput() {
    try {
        const fi = createFileInput();
        if (fi) fi.click();
    } catch(e) { console.error('openFileInput error', e); }
}

function showFilePreview(file) {
    const oldPreview = document.querySelector('.file-preview');
    if (oldPreview) oldPreview.remove();
    
    const previewDiv = document.createElement('div');
    previewDiv.className = 'file-preview';
    previewDiv.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 2001;
        max-width: 300px;
        animation: slideUp 0.3s ease;
    `;
    
    let previewHTML = '';
    
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewHTML = `
                <div style="margin-bottom: 10px; font-weight: bold;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${file.name}</div>
                <img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 5px;">
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="sendFile()" style="flex:1; padding: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                    <button onclick="cancelFile()" style="flex:1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            `;
            previewDiv.innerHTML = previewHTML;
        };
        reader.readAsDataURL(file);
    } else if (file.type.startsWith('video/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewHTML = `
                <div style="margin-bottom: 10px; font-weight: bold;">–í–∏–¥–µ–æ: ${file.name}</div>
                <video controls style="max-width: 100%; max-height: 200px; border-radius: 5px;">
                    <source src="${e.target.result}" type="${file.type}">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ
                </video>
                <div style="color: #666; font-size: 14px; margin: 10px 0;">
                    –¢–∏–ø: ${file.type}<br>
                    –†–∞–∑–º–µ—Ä: ${(file.size / (1024 * 1024)).toFixed(2)} MB
                </div>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="sendFile()" style="flex:1; padding: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                    <button onclick="cancelFile()" style="flex:1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            `;
            previewDiv.innerHTML = previewHTML;
        };
        reader.readAsDataURL(file);
    } else {
        previewHTML = `
            <div style="margin-bottom: 10px; font-weight: bold;">–§–∞–π–ª: ${file.name}</div>
            <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                –¢–∏–ø: ${file.type || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
                –†–∞–∑–º–µ—Ä: ${(file.size / 1024).toFixed(1)} KB
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button onclick="sendFile()" style="flex:1; padding: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
                <button onclick="cancelFile()" style="flex:1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        `;
        previewDiv.innerHTML = previewHTML;
    }
    
    document.body.appendChild(previewDiv);
}

function createFileInput() {
    try {
        const existing = document.getElementById('chat-file-input');
        if (existing) {
            fileInput = existing;
            if (!fileInput._hasHandleFileSelect) {
                fileInput.addEventListener('change', handleFileSelect);
                fileInput._hasHandleFileSelect = true;
            }
            return fileInput;
        }
    } catch(e) {}

    if (!fileInput) {
        fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'chat-file-input';
        fileInput.style.display = 'none';
        fileInput.multiple = false;
        fileInput.accept = 'image/*,video/*,.pdf,.doc,.docx,.txt,.zip,.mp4,.avi,.mov,.mkv,.webm';
        
        fileInput.addEventListener('change', handleFileSelect);
        fileInput._hasHandleFileSelect = true;
        document.body.appendChild(fileInput);
    }
    return fileInput;
}

function getMaxFileSize() {
    const userSubscribe = "{{ user.subscribe }}";
    
    if (userSubscribe === "Bin_premium") {
        return 50 * 1024 * 1024; 
    } else if (userSubscribe === "Bin+") {
        return 20 * 1024 * 1024; 
    } else {
        return 10 * 1024 * 1024; 
    }
}

function handleFileSelect(event) {
    const files = event.target.files;
    const userLang = "{{ user.language|default:'English' }}";
    console.log('handleFileSelect triggered', { targetId: event.target.id, filesCount: files.length, userLang });
    if (files.length > 0) {
        const file = files[0];
        const maxSize = getMaxFileSize();
        
        if (file.size > maxSize) {
            const limitMB = maxSize / (1024 * 1024);
            const userLang = "{{ user.language|default:'English' }}";
            
            if (userLang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
                alert(`–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä –¥–ª—è –≤–∞—à–æ—ó –ø—ñ–¥–ø–∏—Å–∫–∏ ({{ user.subscribe }}) - ${limitMB}MB —Ä–æ–∑–º—ñ—Ä —Ñ–∞–π–ª—É: ${(file.size / (1024 * 1024)).toFixed(2)}MB.`);
            } else {
                alert(`File is too large. Maximum file size for your subscription ({{ user.subscribe }}) is ${limitMB}MB file large: ${(file.size / (1024 * 1024)).toFixed(2)}MB.`);
            }
            
            event.target.value = '';
            return;
        }
        
        const allowedTypes = [
            'image/jpeg', 'image/png', 'image/gif', 'image/webp',
            'application/pdf', 'text/plain',
            'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/zip', 'application/x-rar-compressed',
            'video/mp4', 'video/avi', 'video/quicktime', 'video/x-msvideo',
            'video/x-matroska', 'video/webm', 'video/mpeg'
        ];
        
        if (!allowedTypes.includes(file.type) && !file.type.startsWith('video/')) {
            alert('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω—ã: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ, PDF, —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã');
            event.target.value = '';
            return;
        }
        
        selectedFile = file;
        showFilePreview(selectedFile);
    }
    event.target.value = '';
}

function sendFile() {
    if (!selectedFile || !currentChatUser) {
        cancelFile();
        return;
    }
    
    const textInput = document.getElementById('chat-input');
    const text = textInput.value.trim() || '';
    
    if (currentChatUser === "Bin") {
        alert("Bin only provides verification codes. Please send a text message to get your code.");
        cancelFile();
        return;
    }
    
    if (currentChatUser === "{{ user.username }}") {
        alert("Cannot send files to notes");
        cancelFile();
        return;
    }
    
    const tempMessageId = 'temp-' + Date.now();
    const messagesContainer = document.getElementById('chat-messages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message sent';
    messageDiv.id = tempMessageId;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        let fileContent = '';
        
        if (selectedFile.type.startsWith('image/')) {
            fileContent = `
                <div style="margin: 5px 0;">
                    <strong>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</strong>
                </div>
                <img src="${e.target.result}" 
                     style="max-width: 250px; max-height: 250px; border-radius: 5px; cursor: pointer;" 
                     onclick="openFileModal('${e.target.result}', '${selectedFile.name}')">
            `;
        } else if (selectedFile.type.startsWith('video/')) {
            fileContent = `
                <div style="margin: 5px 0;">
                    <strong>–í–∏–¥–µ–æ:</strong>
                </div>
                <div class="video-thumb" style="position:relative; display:inline-block; border-radius:5px; overflow:hidden; width:250px; cursor:pointer; background:var(--surface);" onclick="openVideoModal('${e.target.result}', '${selectedFile.name}', '${selectedFile.type}')">
                    <video muted playsinline preload="metadata" style="width:100%; height:auto; display:block; background:var(--surface);">
                        <source src="${e.target.result}" type="${selectedFile.type}">
                    </video>
                    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:46px; height:46px; border-radius:50%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;">
                        <div style="width:0;height:0;border-left:12px solid #fff;border-top:8px solid transparent;border-bottom:8px solid transparent;margin-left:4px;"></div>
                    </div>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    ${selectedFile.name} (${(selectedFile.size / (1024 * 1024)).toFixed(2)} MB)
                </div>
            `;
        } else {
            fileContent = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin: 5px 0;">
                    <div style="font-weight: bold;">${selectedFile.name}</div>
                    <div style="font-size: 12px; color: #666;">
                        ${selectedFile.type || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'} ‚Ä¢ 
                        ${(selectedFile.size / 1024).toFixed(1)} KB
                    </div>
                    <div style="color: #999; font-size: 12px; margin-top: 5px;">
                        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...
                    </div>
                </div>
            `;
        }
        
        messageDiv.innerHTML = `
            <div class="message-sender">–í—ã</div>
            ${text ? `<div style="margin-bottom: 5px;">${text}</div>` : ''}
            ${fileContent}
            <div class="message-time" style="font-size: 11px; color: #999; margin-top: 4px; text-align: right">
                –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...
            </div>
        `;
        
        const spacer = messagesContainer.querySelector('.chat-messages-spacer');
        if (spacer) {
            messagesContainer.insertBefore(messageDiv, spacer);
        } else {
            messagesContainer.appendChild(messageDiv);
        }
        try { scrollIfAtBottom(messagesContainer); } catch(e) {}
        
        sendMessageViaAJAX(text, {
            file: selectedFile,
            fileName: selectedFile.name,
            fileType: selectedFile.type
        });
    };
    
    reader.readAsDataURL(selectedFile);
    
    textInput.value = '';
    selectedFile = null;
    cancelFile();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function cancelFile() {
    selectedFile = null;
    const preview = document.querySelector('.file-preview');
    if (preview) preview.remove();
    if (fileInput) fileInput.value = '';
}

function displayFileMessage(data, isSent) {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const msgId    = data.id || data.message_id || null;
    const fileUrl  = data.file_url  || null;

    let existing = null;
    if (msgId) {
        existing = document.querySelector(`[data-message-id="${msgId}"]`);
    }
    if (!existing && fileUrl) {
        existing = document.querySelector(`[data-file-url="${CSS.escape(fileUrl)}"]`);
    }

    if (existing) {
        if (isVideoModalOpen && data.file_type?.startsWith('video/')) {
            return;
        }

        const timeEl = existing.querySelector('.message-time');
        if (timeEl && data.timestamp) {
            timeEl.textContent = formatChatTime(data.timestamp);
            timeEl.dataset.timestamp = data.timestamp;
        }
        return;
    }

    if (isVideoModalOpen && data.file_type?.startsWith('video/')) {
        return;
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

    if (msgId)    messageDiv.dataset.messageId = msgId;
    if (fileUrl)  messageDiv.dataset.fileUrl   = fileUrl;

    if (data.file_type?.startsWith('image/')) {
        messageDiv.dataset.mediaType = 'image';
    } else if (data.file_type?.startsWith('video/')) {
        messageDiv.dataset.mediaType = 'video';
    } else {
        messageDiv.dataset.mediaType = 'file';
    }

    messageDiv.dataset.tokenText = String(data.text || '').trim();

    let fileContent = '';
    const lang = "{{ user.language|default:'English' }}";

    if (data.file_type?.startsWith('image/')) {
        fileContent = `
            <div style="margin: 5px 0; position: relative;">
                <img class="chat-image" src="${data.file_url}" 
                     data-file-name="${data.file_name || ''}" 
                     style="max-width: 100%; height: auto; border-radius: 5px; display:block; cursor:pointer;" 
                     alt="${data.file_name || 'image'}">
            </div>
        `;
    } 
    else if (data.file_type?.startsWith('video/')) {
        const videoText = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '' : '';

        fileContent = `
            <div style="margin: 5px 0;">
                <strong>${videoText}</strong>
            </div>
            <div style="position: relative;">
                <div class="video-thumb" style="position:relative; display:inline-block; border-radius:5px; overflow:hidden; width:250px; cursor:pointer; background:var(--surface);" 
                     onclick="openVideoModal('${data.file_url}', '${data.file_name || 'video'}', '${data.file_type}')">
                    <video muted playsinline preload="metadata" style="width:100%; height:auto; display:block; background:var(--surface);" data-video-processed="1">
                        <source src="${data.file_url}" type="${data.file_type}">
                    </video>
                    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:46px; height:46px; border-radius:50%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;">
                        <div style="width:0;height:0;border-left:12px solid #fff;border-top:8px solid transparent;border-bottom:8px solid transparent;margin-left:4px;"></div>
                    </div>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    ${data.file_size ? (data.file_size / (1024 * 1024)).toFixed(2) + ' MB' : ''}
                </div>
            </div>
        `;
    } 
    else {
        const downloadText = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏' : 'Download';
        const fileText     = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–§–∞–π–ª:' : 'File:';
        const unknownFmt   = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ù–µ–≤—ñ–¥–æ–º–∏–π —Ñ–æ—Ä–º–∞—Ç' : 'Unknown format';

        fileContent = `
            <div style="margin: 5px 0;">
                <strong>${fileText}</strong> ${data.file_name}
            </div>
            <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; display: flex; align-items: center; gap: 10px;">
                <div style="font-size: 24px;">üìé</div>
                <div>
                    <div style="font-weight: bold;">${data.file_name}</div>
                    <div style="font-size: 12px; color: #666;">
                        ${data.file_type || unknownFmt} ‚Ä¢ 
                        ${data.file_size ? (data.file_size / 1024).toFixed(1) + ' KB' : ''}
                    </div>
                    <a href="${data.file_url}" download="${data.file_name}" 
                       style="display: inline-block; margin-top: 5px; padding: 3px 10px; background: #007bff; color: white; border-radius: 3px; text-decoration: none; font-size: 12px;">
                        ${downloadText}
                    </a>
                </div>
            </div>
        `;
    }

    let fileTextHtml = '';
    if (data.text && String(data.text).trim()) {
        const stickerMatch = String(data.text).trim().match(/^\[sticker:([a-zA-Z0-9_-]+)\]$/);
        if (stickerMatch) {
            const stickerName = stickerMatch[1];
            fileTextHtml = `<div style="margin-bottom: 5px;"><div class="sticker-render" data-sticker="${stickerName}" style="font-size:44px; display:inline-block; cursor:pointer;" onclick="sendSticker('${stickerName}')">${STICKER_MAP[stickerName] || '‚ùì'}</div></div>`;
            messageDiv.dataset.mediaType = 'sticker';
            messageDiv.dataset.stickerName = stickerName;
        } else {
            const processed = processMentionsStrict(data.text);
            fileTextHtml = `<div style="margin-bottom: 5px;">${renderStickersInline(processed)}</div>`;
        }
    }

    let timeText = data.timestamp ? formatChatTime(data.timestamp) : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    messageDiv.innerHTML = `
        ${fileTextHtml}
        ${fileContent}
        <div class="message-time" data-timestamp="${data.timestamp || new Date().toISOString()}" style="font-size: 11px; color: #999; margin-top: 4px; text-align: ${isSent ? 'right' : 'left'}">
            ${timeText}
        </div>
    `;

    messageDiv.addEventListener('contextmenu', function(e){
        e.preventDefault();
        showMessageContextMenu(e.clientX, e.clientY, messageDiv, msgId);
    });

    const spacer = container.querySelector('.chat-messages-spacer');
    if (spacer) {
        container.insertBefore(messageDiv, spacer);
    } else {
        container.appendChild(messageDiv);
    }

    try { scrollIfAtBottom(container); } catch(e) {}
    try { addMentionEventListeners(messageDiv); } catch(e) {}
}

function showImageContextMenu(event, imageUrl, fileName) {
    event.preventDefault();

    const existingMenu = document.querySelector('.image-context-menu');
    if (existingMenu) existingMenu.remove();

    const lang = "{{ user.language|default:'English' }}";
    const downloadText = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏' : 'Download';
    const zoomInText = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ó–±—ñ–ª—å—à–∏—Ç–∏' : 'Zoom in';
    const zoomOutText = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ó–º–µ–Ω—à–∏—Ç–∏' : 'Zoom out';

    const imageElement = event.target;
    const isFullscreen = imageElement && imageElement.getAttribute('data-fullscreen') === 'true';

    const contextMenu = document.createElement('div');
    contextMenu.className = 'image-context-menu';
    contextMenu.style.cssText = `position: fixed; top: ${event.clientY}px; left: ${event.clientX}px; background: white; border: 1px solid #ddd; padding:6px; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.16); z-index: 10000; min-width:150px;`;

    const dl = document.createElement('button');
    dl.type = 'button';
    dl.textContent = downloadText;
    dl.style.cssText = 'display:block; padding:8px 10px; border:none; background:transparent; width:100%; text-align:left; cursor:pointer; color:#000;';
    dl.addEventListener('click', function(ev){ ev.stopPropagation(); downloadImage(imageUrl, fileName || 'image'); contextMenu.remove(); });
    contextMenu.appendChild(dl);

    if (imageElement && imageElement.classList.contains('zoomable-image')) {
        const zoomBtn = document.createElement('button');
        zoomBtn.type = 'button';
        zoomBtn.textContent = isFullscreen ? zoomOutText : zoomInText;
        zoomBtn.style.cssText = 'display:block; padding:8px 10px; border:none; background:transparent; width:100%; text-align:left; cursor:pointer; color:#000;';
        zoomBtn.addEventListener('click', function(ev){ ev.stopPropagation(); if (isFullscreen) zoomOutImage({ target: imageElement, preventDefault: function(){} }); else zoomInImage({ target: imageElement, preventDefault: function(){} }); contextMenu.remove(); });
        contextMenu.appendChild(zoomBtn);
    }

    document.body.appendChild(contextMenu);

    const closeMenu = (e) => { if (!contextMenu.contains(e.target)) { contextMenu.remove(); document.removeEventListener('click', closeMenu); } };
    setTimeout(() => { document.addEventListener('click', closeMenu); }, 100);
} 

function zoomInImage(event) {
    event.preventDefault();
    const img = event.target.closest('img') || document.elementFromPoint(event.clientX, event.clientY);
    if (!img || !img.classList.contains('zoomable-image')) return;
    
    img.setAttribute('data-fullscreen', 'true');
    img.setAttribute('data-original-style', img.style.cssText);
    
    const originalWidth = img.offsetWidth;
    const originalHeight = img.offsetHeight;
    img.setAttribute('data-original-width', originalWidth);
    img.setAttribute('data-original-height', originalHeight);
    
    const rect = img.getBoundingClientRect();
    img.style.position = 'fixed';
    img.style.top = `${rect.top}px`;
    img.style.left = `${rect.left}px`;
    img.style.width = `${originalWidth}px`;
    img.style.height = `${originalHeight}px`;
    img.style.zIndex = '9998';
    img.style.transition = 'all 0.3s ease';
    img.style.cursor = 'zoom-out';
    img.style.filter = 'none';
    img.style.backgroundColor = 'white';
    
    setTimeout(() => {
        img.style.top = '50%';
        img.style.left = '50%';
        img.style.transform = 'translate(-50%, -50%)';
        img.style.width = 'auto';
        img.style.height = 'auto';
        img.style.maxWidth = '95vw';
        img.style.maxHeight = '95vh';
        img.style.objectFit = 'contain';
        img.style.backgroundColor = 'white';
        img.style.padding = '20px';
        img.style.borderRadius = '0';
        img.style.boxShadow = '0 0 30px rgba(0, 0, 0, 0.5)';
        
        addZoomOverlay();
    }, 10);
}

function zoomOutImage(event) {
    event.preventDefault();
    const img = event.target.closest('img') || document.querySelector('img[data-fullscreen="true"]');
    if (!img) return;
    
    img.setAttribute('data-fullscreen', 'false');
    
    const originalWidth = img.getAttribute('data-original-width');
    const originalHeight = img.getAttribute('data-original-height');
    const originalStyle = img.getAttribute('data-original-style');
    
    img.style.transform = '';
    img.style.transition = 'all 0.3s ease';
    img.style.width = `${originalWidth}px`;
    img.style.height = `${originalHeight}px`;
    img.style.filter = ''; 
    img.style.backgroundColor = ''; 
    
    setTimeout(() => {
        if (originalStyle) {
            img.style.cssText = originalStyle;
        } else {
            img.style.position = '';
            img.style.top = '';
            img.style.left = '';
            img.style.transform = '';
            img.style.zIndex = '';
            img.style.backgroundColor = '';
            img.style.padding = '';
            img.style.borderRadius = '5px';
            img.style.maxWidth = '250px';
            img.style.maxHeight = '250px';
            img.style.width = '';
            img.style.height = '';
            img.style.cursor = 'pointer';
            img.style.boxShadow = '';
            img.style.objectFit = '';
            img.style.filter = '';
        }
        
        removeZoomOverlay();
    }, 300);
}

function toggleImageZoom(imageUrl, event) {
    event.stopPropagation();
    event.preventDefault();
    const img = event.target;
    const isFullscreen = img.getAttribute('data-fullscreen') === 'true';
    
    if (isFullscreen) {
        zoomOutImage({ target: img, preventDefault: () => {} });
    } else {
        zoomInImage({ target: img, preventDefault: () => {} });
    }
}

function addZoomOverlay() {
    const existingOverlay = document.querySelector('.zoom-overlay');
    if (existingOverlay) existingOverlay.remove();
    
    const overlay = document.createElement('div');
    overlay.className = 'zoom-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9997;
        cursor: zoom-out;
    `;
    
    overlay.addEventListener('click', function(e) {
        const fullscreenImg = document.querySelector('img[data-fullscreen="true"]');
        if (fullscreenImg) {
            zoomOutImage({ target: fullscreenImg, preventDefault: () => {} });
        }
    });
    
    document.body.appendChild(overlay);
}

function removeZoomOverlay() {
    const overlay = document.querySelector('.zoom-overlay');
    if (overlay) overlay.remove();
}

function downloadImage(url, filename) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename || 'image.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    const contextMenu = document.querySelector('.image-context-menu');
    if (contextMenu) contextMenu.remove();
}

function openFileModal(url, filename) {
    const lang = "{{ user.language|default:'English' }}";
    const closeText = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ó–∞–∫—Ä–∏—Ç–∏' : '';
    const downloadText = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏' : '';
    
    const modal = document.createElement('div');
    modal.className = 'file-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 3000;
    `;
    
    modal.innerHTML = `
        <div style="position: relative; text-align: center;">
            <img src="${url}" 
                 style="max-width: 90vw; max-height: 85vh; border-radius: 5px; cursor: pointer;"
                 alt="${filename}"
                 onclick="closeFileModal()"
                 oncontextmenu="showImageContextMenu(event, '${url}', '${filename}')">
        </div>
    `;
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeFileModal();
        }
    });
    
    document.body.appendChild(modal);
}

function closeFileModal() {
    const modal = document.querySelector('.file-modal');
    if (modal) modal.remove();
}

function openVideoModal(url, filename, filetype) {
    const lang = "{{ user.language|default:'English' }}";
    const modal = document.createElement('div');
    modal.className = 'video-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 3000;
    `;

    modal.innerHTML = `
        <div style="position: relative; text-align: center; max-width: 95vw; max-height: 95vh;">
            <video controls autoplay style="width: auto; height: auto; max-width: 95vw; max-height: 85vh; border-radius: 5px; background: black;">
                <source src="${url}" type="${filetype || ''}">
                ${lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤—ñ–¥–µ–æ' : 'Your browser does not support the video element.'}
            </video>
            <div style="display:flex; gap:10px; justify-content:center; align-items:center; margin-top:8px; color:#fff;">
            </div>
        </div>
    `;

    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeVideoModal();
        }
    });

    document.body.appendChild(modal);
    isVideoModalOpen = true;
    openVideoUrl = url;
    const videoEl = modal.querySelector('video');
    if (videoEl) {
        videoEl.play().catch(() => {});
    }
    document.addEventListener('keydown', handleVideoEsc);
}

function closeVideoModal() {
    const modal = document.querySelector('.video-modal');
    if (modal) {
        const video = modal.querySelector('video');
        if (video) {
            try { video.pause(); } catch(e) {}
        }
        modal.remove();
    }
    isVideoModalOpen = false;
    openVideoUrl = null;
    document.removeEventListener('keydown', handleVideoEsc);

    try {
        if (currentChatUser && pendingRefreshOnModalClose[currentChatUser]) {
            pendingRefreshOnModalClose[currentChatUser] = false;
            loadChatMessages(currentChatUser);
        }
    } catch (e) { console.error('Error running deferred refresh:', e); }
}

function handleVideoEsc(e) {
    if (e.key === 'Escape') closeVideoModal();
}

const zoomStyles = `
    img.zoomable-image[data-fullscreen="true"] {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: auto !important;
        height: auto !important;
        max-width: 95vw !important;
        max-height: 95vh !important;
        object-fit: contain !important;
        z-index: 9998 !important;
        cursor: zoom-out !important;
        border-radius: 0 !important;
        padding: 20px !important;
        filter: none !important;
        background-color: rgba(255, 255, 255, 1) !important;
    }   

    .zoom-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9997;
        cursor: zoom-out;
    }

    .video-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 3000;
        background: rgba(0,0,0,0.95);
    }
    .video-modal video {
        max-width: 95vw;
        max-height: 85vh;
        outline: none;
    }
    
    .image-context-menu {
        animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
`;


function normalizeFileAttachments(container) {
    if (!container) return;
    if (isVideoModalOpen) return;
    const videoExts = ['mp4','webm','mov','avi','mkv','m4v','mpeg'];
    container.querySelectorAll('.file-attachment a[href]').forEach(a => {
        try {
            const wrapper = a.closest('.file-attachment');
            if (!wrapper) return;
            if (wrapper.dataset.attachmentProcessed === '1') return;

            const href = a.href;
            const urlNoQuery = href.split('?')[0];
            const parts = urlNoQuery.split('.');
            const ext = parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';
            if (videoExts.includes(ext)) {
                const filename = a.getAttribute('download') || a.textContent.trim() || '';
                const thumbHtml = `
                    <div style="margin: 5px 0;"><strong>${filename}</strong></div>
                    <div class="video-thumb" style="position:relative; display:inline-block; border-radius:5px; overflow:hidden; width:250px; cursor:pointer;" onclick="openVideoModal('${href}', '${filename}', 'video/${ext}')">
                        <video muted playsinline preload="metadata" style="width:100%; height:auto; display:block; background:black;">
                            <source src="${href}" type="video/${ext}">
                        </video>
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:46px; height:46px; border-radius:50%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;">
                            <div style="width:0;height:0;border-left:12px solid #fff;border-top:8px solid transparent;border-bottom:8px solid transparent;margin-left:4px;"></div>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">${filename}</div>
                `;
                if (wrapper) {
                    wrapper.innerHTML = thumbHtml;
                    wrapper.dataset.attachmentProcessed = '1';
                }
            }
        } catch (e) {
        }
    });
}

(function initAttachmentObserver(){
    const chatContainer = document.getElementById('chat-messages');
    if (!chatContainer) return;
    try {
        const obs = new MutationObserver((mutations) => {
            normalizeFileAttachments(chatContainer);
        });
        obs.observe(chatContainer, { childList: true, subtree: true });
    } catch (e) {
    }
})();

function addAttachmentButton() {
    const chatInputContainer = document.querySelector('.chat-input-container');
    if (!chatInputContainer) return;
    
    const oldButton = chatInputContainer.querySelector('.attach-btn');
    if (oldButton) oldButton.remove();
    
    const attachButton = document.createElement('button');
    attachButton.className = 'attach-btn';
    attachButton.type = 'button';
    attachButton.innerHTML = 'üìé';
    attachButton.title = '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª';
    attachButton.style.cssText = `
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 5px 10px;
        color: #666;
    `;
    
    attachButton.addEventListener('click', function() {
        const fileInput = createFileInput();
        fileInput.click();
    });
    
    const chatInput = document.getElementById('chat-input');
    chatInputContainer.insertBefore(attachButton, chatInput);
}

function openChat(username) {
    currentChatUser = username;
    document.getElementById('chat-username').textContent = username;
    startChatRefresh();
    loadChatMessages(username);
    
    const input = document.getElementById('chat-input');
    if (input) {
        try {
            const stored = localStorage.getItem('chat_input_' + username) || '';
            tokenTextToContent(input, stored);
        } catch(e) {}
    }

    addAttachmentButton();
}

document.addEventListener('DOMContentLoaded', function() {
    const newPassword = document.getElementById('new-password');
    const confirmPassword = document.getElementById('confirm-password');
    
    function validatePasswords() {
        if (newPassword.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('Passwords do not match');
        } else {
            confirmPassword.setCustomValidity('');
        }
    }
    
    if (newPassword && confirmPassword) {
        newPassword.addEventListener('input', validatePasswords);
        confirmPassword.addEventListener('input', validatePasswords);
    }

    document.querySelectorAll('.password-toggle').forEach(el => {
        el.addEventListener('click', function(e){ e.stopPropagation(); togglePasswordForm(); });
    });
});

function togglePasswordForm(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const passwordSection = document.getElementById('password-section');
    const passwordForm = document.getElementById('password-form');
    const arrow = passwordSection.querySelector('.password-toggle-arrow');
    
    const isExpanded = passwordSection.getAttribute('data-expanded') === 'true';
    
    if (isExpanded) {
        passwordSection.classList.remove('expanded');
        passwordSection.setAttribute('data-expanded', 'false');
        arrow.textContent = '‚ñº';
        
        setTimeout(() => {
            passwordForm.style.display = 'none';
        }, 300);
    } else {
        passwordForm.style.display = 'block';
        passwordSection.setAttribute('data-expanded', 'true');
        arrow.textContent = '‚ñ≤';
        
        setTimeout(() => {
            passwordSection.classList.add('expanded');
        }, 10);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    
    const passwordSection = document.getElementById('password-section');
    if (!passwordSection) return;
    
    const passwordToggle = passwordSection.querySelector('.password-toggle');
    const passwordForm = document.getElementById('password-form');
    
    passwordForm.style.display = 'none';
    passwordSection.setAttribute('data-expanded', 'false');
    
    passwordToggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const isExpanded = passwordSection.getAttribute('data-expanded') === 'true';
        const arrow = this.querySelector('.password-toggle-arrow');
        
        if (isExpanded) {
            passwordSection.classList.remove('expanded');
            passwordSection.setAttribute('data-expanded', 'false');
            arrow.textContent = '‚ñº';
            
            setTimeout(() => {
                passwordForm.style.display = 'none';
            }, 300);
        } else {
            passwordForm.style.display = 'block';
            passwordSection.setAttribute('data-expanded', 'true');
            arrow.textContent = '‚ñ≤';
            
            setTimeout(() => {
                passwordSection.classList.add('expanded');
            }, 10);
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!passwordSection.contains(e.target) && 
            passwordSection.getAttribute('data-expanded') === 'true') {
            
            const arrow = passwordSection.querySelector('.password-toggle-arrow');
            passwordSection.classList.remove('expanded');
            passwordSection.setAttribute('data-expanded', 'false');
            arrow.textContent = '‚ñº';
            
            setTimeout(() => {
                passwordForm.style.display = 'none';
            }, 300);
        }
    });
    
    passwordForm.addEventListener('click', function(e) {
        e.stopPropagation();
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const backgroundInput = document.getElementById('backgroundInput');
    const previewBackground = document.getElementById('preview-background');
    const mainProfileBackground = document.querySelector('.profile-form .profile-preview-background');
    const deleteBackgroundBtn = document.querySelector('.btn-delete-background');
    const userSubscribe = "{{ user.subscribe }}";

    function syncBackgrounds() {
        if (previewBackground && mainProfileBackground) {
            if (previewBackground.style.backgroundImage && previewBackground.style.backgroundImage !== 'none') {
                mainProfileBackground.style.backgroundImage = previewBackground.style.backgroundImage;
                mainProfileBackground.style.display = previewBackground.style.display;
            }
            else if (mainProfileBackground.style.backgroundImage && mainProfileBackground.style.backgroundImage !== 'none') {
                previewBackground.style.backgroundImage = mainProfileBackground.style.backgroundImage;
                previewBackground.style.display = mainProfileBackground.style.display;
            }
        }
        
        if (deleteBackgroundBtn) {
            const hasBackground = (previewBackground && previewBackground.style.backgroundImage && previewBackground.style.backgroundImage !== 'none') ||
                                (mainProfileBackground && mainProfileBackground.style.backgroundImage && mainProfileBackground.style.backgroundImage !== 'none');
            deleteBackgroundBtn.disabled = !hasBackground;
        }
    }

    syncBackgrounds();

    if (backgroundInput) {
            backgroundInput.accept = "image/*";

            backgroundInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (userSubscribe === 'Basic') {
                    alert('Background feature available only for Bin+ and Bin Premium subscriptions');
                    e.target.value = '';
                    return;
                }
                
                if (file.type === 'image/gif') {
                    alert('GIF backgrounds are not supported. Please upload a static image.');
                    e.target.value = '';
                    return;
                }
            const reader = new FileReader();
            reader.onload = function(event) {
                previewBackground.style.backgroundImage = `url('${event.target.result}')`;
                previewBackground.style.display = 'block';
                
                if (deleteBackgroundBtn) {
                    deleteBackgroundBtn.disabled = false;
                }
                
                syncBackgrounds();
            };
            reader.readAsDataURL(file);


            const csrftoken = (document.cookie.match(/(^|;)\s*csrftoken\s*=\s*([^;]+)/) || [])[2];
            const formData = new FormData();
            formData.append('background', file);

            fetch('{% url "upload_background" %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'same-origin'
            }).then(r => r.json()).then(data => {
                if (data && data.success) {
                    const url = data.background_url;
                    if (url) {
                        previewBackground.style.backgroundImage = `url('${url}')`;
                        previewBackground.style.display = 'block';
                        if (mainProfileBackground) {
                            mainProfileBackground.style.backgroundImage = `url('${url}')`;
                            mainProfileBackground.style.display = 'block';
                        }
                    }

                } else {
                    location.reload();
                }
            }).catch(err => {
                console.error('Background upload failed', err);
                alert('Background upload failed.');
                location.reload();
            });
        });
    }

    const themeSelect = document.getElementById('themeSelect');
    if (themeSelect) {
        themeSelect.addEventListener('change', function() {
            setTimeout(syncBackgrounds, 100);
        });
    }
});

window.confirmBackgroundReset = function() {
    const lang = "{{ user.language|default:'English' }}";
    const confirmMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
        ? "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ–Ω –ø—Ä–æ—Ñ—ñ–ª—é?"
        : "Are you sure you want to remove the background?";

    if (confirm(confirmMsg)) {
        const previewBackground = document.getElementById('preview-background');
        const mainProfileBackground = document.querySelector('.profile-form .profile-preview-background');
        const deleteBackgroundBtn = document.querySelector('.btn-delete-background');
        
        if (previewBackground) {
            previewBackground.style.backgroundImage = 'none';
            previewBackground.style.display = 'none';
        }
        
        if (mainProfileBackground) {
            mainProfileBackground.style.backgroundImage = 'none';
            mainProfileBackground.style.display = 'none';
        }
        
        if (deleteBackgroundBtn) {
            deleteBackgroundBtn.disabled = true;
        }
        
        let removeBackgroundInput = document.getElementById('remove-background-input');
        if (!removeBackgroundInput) {
            removeBackgroundInput = document.createElement('input');
            removeBackgroundInput.type = 'hidden';
            removeBackgroundInput.name = 'remove_background';
            removeBackgroundInput.id = 'remove-background-input';
            const editProfileForm = document.getElementById('edit-profile-form');
            if (editProfileForm) {
                editProfileForm.appendChild(removeBackgroundInput);
            }
        }
        removeBackgroundInput.value = 'true';
        
        const successMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' 
            ? '–§–æ–Ω —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ!' 
            : 'Background successfully removed!';
        alert(successMsg);
    }
};

function updateBackgroundAccessibility() {
    const backgroundInput = document.getElementById('backgroundInput');
    const backgroundLabel = backgroundInput ? backgroundInput.closest('label') : null;
    const userSubscribe = "{{ user.subscribe }}";
    
    if (backgroundInput && backgroundLabel) {
        if (userSubscribe === 'Basic') {
            backgroundInput.disabled = true;
            backgroundLabel.style.opacity = '0.6';
            backgroundLabel.style.cursor = 'not-allowed';
            backgroundInput.title = "Background feature available for Bin+ and Bin Premium subscribers";
        } else {
            backgroundInput.disabled = false;
            backgroundLabel.style.opacity = '1';
            backgroundLabel.style.cursor = 'pointer';
            
            if (userSubscribe === 'Bin+') {
                backgroundInput.accept = "image/*";
                backgroundInput.title = "Images only (GIF backgrounds available for Bin Premium)";
            } else if (userSubscribe === 'Bin_premium') {
                backgroundInput.accept = "image/*,image/gif";
                backgroundInput.title = "All image formats including GIF";
            }
        }
    }
}

document.addEventListener('DOMContentLoaded', updateBackgroundAccessibility); 

function formatNumber(number) {
    return number.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$& ');
}

function getUserWalletAmount() {
    const walletText = document.getElementById('wallet-amount').textContent;
    const amountMatch = walletText.match(/([\d\s,]+\.?\d*)/);
    if (amountMatch) {
        const amountStr = amountMatch[1].replace(/\s/g, '').replace(',', '');
        return parseFloat(amountStr);
    }
    return 0;
}

function getUserCurrency() {
    const select = document.querySelector('select[name="currency"]');
    return select ? select.value : 'USD';
}

function updateAllCurrenciesFromUserWallet() {
    const userAmount = getUserWalletAmount();
    const userCurrency = getUserCurrency();
    
    if (userAmount === 0) return;
    
    const exchangeRates = {
        'USD': {'USD': 1.0, 'EUR': 0.87, 'GBP': 0.773, 'UAH': 42.1},
        'UAH': {'USD': 0.024, 'EUR': 0.021, 'GBP': 0.0186, 'UAH': 1.0}
    };
    
    const rates = exchangeRates[userCurrency];
    
    if (userCurrency !== 'USD') {
        document.getElementById('usd-amount').textContent = `${formatNumber(userAmount * rates.USD)}$ USD`;
    } else {
        document.getElementById('usd-amount').textContent = `${formatNumber(userAmount)}$ USD`;
    }
    
    document.getElementById('eur-amount').textContent = `${formatNumber(userAmount * rates.EUR)}‚Ç¨ EUR`;
    document.getElementById('gbp-amount').textContent = `${formatNumber(userAmount * rates.GBP)}¬£ GBP`;
    
    if (userCurrency !== 'UAH') {
        document.getElementById('uah-amount').textContent = `${formatNumber(userAmount * rates.UAH)}‚Ç¥ UAH`;
    } else {
        document.getElementById('uah-amount').textContent = `${formatNumber(userAmount)}‚Ç¥ UAH`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        updateAllCurrenciesFromUserWallet();
    }, 100);
});

document.querySelector('select[name="currency"]').addEventListener('change', function() {
    setTimeout(() => {
        updateAllCurrenciesFromUserWallet();
    }, 500);
});

function observeWalletChanges() {
    const walletElement = document.getElementById('wallet-amount');
    if (walletElement) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'characterData' || mutation.type === 'childList') {
                    updateAllCurrenciesFromUserWallet();
                }
            });
        });
        
        observer.observe(walletElement, {
            characterData: true,
            childList: true,
            subtree: true
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        updateAllCurrenciesFromUserWallet();
        observeWalletChanges();
    }, 100);
});



function processMentionsStrict(text) {
    if (!text || typeof text !== 'string') {
        return '';
    }
    
    if (/<[^>]*>/.test(text)) {
        return text;
    }
    
    const mentionRegex = /(^|\s|\(|\[)@([\w–∞-—è–ê-–Ø—ë–Å_\d]+)/gi;
    
    return text.replace(mentionRegex, function(match, prefix, username) {
        const fullMention = `@${username}`;
        const lowerUsername = username.toLowerCase();
        
        if (lowerUsername === 'bin_bot' || lowerUsername === 'bin') {
            return `${prefix}<span class="message-mention profile-mention bin-mention" 
                    data-username="@Bin_bot"
                    title="Open chat with Bin_bot">
                    @Bin_bot
                    </span>`;
        }
        
        return `${prefix}<span class="message-mention profile-mention" 
                data-username="@${username}">
                @${username}
                </span>`;
    });
}

function processMentions(text) {
    if (!text || typeof text !== 'string') {
        return '';
    }
    
    const mentionRegex = /@(\w+)/gi;
    
    return text.replace(mentionRegex, function(match, username) {
        const lowerUsername = username.toLowerCase();
        
        if (lowerUsername === 'bin_bot' || lowerUsername === 'bin') {
            return `<span class="message-mention bin-mention" 
                    data-username="@Bin_bot"
                    onclick="openChat('Bin_bot')"
                    style="cursor:pointer; color:#007bff; font-weight:bold;">
                    @Bin_bot
                    </span>`;
        }
        
        return `<span class="message-mention" 
                data-username="@${username}">
                @${username}
                </span>`;
    });
}

function processMentionsWithBin(text) {
    if (!text) return '';
    
    const mentionRegex = /(@[\w–∞-—è–ê-–Ø—ë–Å_\d]+)/gi;
    
    return text.replace(mentionRegex, function(match) {
        const username = match.toLowerCase();
        if (username === "@bin_bot" || username === "@bin") {
            return `<span class="message-mention profile-mention" data-username="@Bin_bot" onclick="openChat('Bin_bot')">@Bin_bot</span>`;
        }
        return `<span class="message-mention profile-mention" data-username="${match}">${match}</span>`;
    });
}

function addMentionEventListeners(element) {
    const mentions = element.querySelectorAll('.message-mention, .profile-mention');
    
    mentions.forEach(mention => {
        const username = mention.getAttribute('data-username');
        
        if (!username) {
            mention.classList.remove('message-mention', 'profile-mention');
            mention.style.color = '';
            mention.style.cursor = 'default';
            mention.style.fontWeight = 'normal';
            mention.style.textDecoration = 'none';
            return;
        }
        
        const usernameLower = username.toLowerCase();
        const cleanUsername = username.replace('@', '');
        
        if (usernameLower === "@bin_bot" || usernameLower === "@bin") {
            mention.replaceWith(mention.cloneNode(true));
            const newMention = element.querySelector(`[data-username="${username}"]`);
            
            newMention.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                closeProfileModals();
                openChat('Bin_bot');
            });
            
            newMention.style.cursor = 'pointer';
            newMention.style.color = '#007bff';
            newMention.style.fontWeight = 'bold';
            newMention.style.textDecoration = 'none';
            newMention.classList.add('bin-mention');
            return;
        }
        
        checkUserExists(cleanUsername).then(exists => {
            if (!exists) {
                mention.classList.remove('message-mention', 'profile-mention');
                mention.style.color = '';
                mention.style.fontWeight = 'normal';
                mention.style.cursor = 'text';
                mention.style.textDecoration = 'none';
                mention.removeAttribute('data-username');
                mention.removeAttribute('onclick');
                return;
            }
            
            mention.replaceWith(mention.cloneNode(true));
            const newMention = element.querySelector(`[data-username="${username}"]`);
            
            newMention.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                closeProfileModals();
                openUserProfile(cleanUsername);
            });
            
            newMention.addEventListener('mouseenter', function() {
                this.style.textDecoration = 'underline';
                this.style.opacity = '0.9';
            });
            
            newMention.addEventListener('mouseleave', function() {
                this.style.textDecoration = 'none';
                this.style.opacity = '1';
            });
            
            newMention.style.cursor = 'pointer';
            newMention.style.color = '#007bff';
            newMention.style.fontWeight = 'bold';
        }).catch(error => {
            console.error('Error checking user existence:', error);
            mention.classList.remove('message-mention', 'profile-mention');
            mention.style.color = '';
            mention.style.cursor = 'default';
        });
    });
}

function showUserProfileModal(userData) {
    closeAllModals();
    
    const otherProfileForm = document.querySelector('.other-profile-form');
    if (!otherProfileForm) return;

    try {
        otherProfileForm.style.maxWidth = '480px';
        otherProfileForm.style.padding = '20px';
        otherProfileForm.style.boxShadow = 'rgba(0, 0, 0, 0.35) 0px 12px 25px';
    } catch(e) {}
    
    const userLang = "{{ user.language|default:'English' }}";
    
    const avatarImg = otherProfileForm.querySelector('.other-profile-avatar');
    if (avatarImg) {
        avatarImg.src = userData.photo_url || '/static/pictures/login.png';
        avatarImg.alt = userData.username;
    }
    
    const usernameEl = otherProfileForm.querySelector('.other-profile-username');
    if (usernameEl) {
        usernameEl.textContent = userData.username;
        try { if (isBinUser(userData.username)) usernameEl.textContent = 'Bin'; } catch(e) {}
    }
    
    const tagEl = otherProfileForm.querySelector('.other-profile-tag');
    if (tagEl) {
        const tagText = userData.your_tag || `@${userData.username}`;
        tagEl.textContent = tagText;
        tagEl.onclick = function() {
            navigator.clipboard.writeText(tagText)
                .then(() => {
                    const lang = "{{ user.language|default:'English' }}";
                    alert(lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–¢–µ–≥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!' : 'Tag copied!');
                })
                .catch(err => console.error('Copy failed:', err));
        };
    }
    
    const statusEl = otherProfileForm.querySelector('.other-profile-status');
    if (statusEl) {
        let statusText = userData.status || 'Offline';
        if (userLang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
            statusText = (statusText || '').toLowerCase() === 'online' ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω';
        }
        statusEl.textContent = `‚óè ${statusText}`;
        statusEl.className = `status-value ${((userData.status || '').toLowerCase() === 'online') ? 'online' : 'offline'}`;
    }
    
    const roleContainer = otherProfileForm.querySelector('#other-profile-role');
    if (roleContainer) {
        roleContainer.innerHTML = '';
        
        let roleHtml = '';
        let displayText = '';
        
        if (userData.role === "System Bot" || (userData.display_role && userData.display_role.includes("ü§ñ"))) {
            displayText = userData.display_role || 'ü§ñ System Bot';
            roleHtml = `<span style="background: linear-gradient(135deg, #667eea, #764ba2); 
                        color: white; 
                        padding: 4px 12px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: bold;
                        display: inline-block;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ${displayText}
            </span>`;
        } 
        else if (userData.role === "Administrator" || (userData.display_role && userData.display_role.includes("üëë"))) {
            displayText = userData.display_role || 'üëë Administrator';
            roleHtml = `<span style="background: linear-gradient(135deg, #dc3545, #c82333); 
                        color: white; 
                        padding: 4px 12px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: bold;
                        display: inline-block;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ${displayText}
            </span>`;
        } 
        else if (userData.role === "Moderator" || (userData.display_role && userData.display_role.includes("üõ°Ô∏è"))) {
            displayText = userData.display_role || 'üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä';
            roleHtml = `<span style="background: linear-gradient(135deg, #ffc107, #e0a800); 
                        color: #212529; 
                        padding: 4px 12px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: bold;
                        display: inline-block;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ${displayText}
            </span>`;
        }
        else if (userData.role === "User" || !userData.role) {
            displayText = userData.subscribe === 'System' ? 'ü§ñ Bot' : (userLang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? 'üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á' : 'üë§ User');
            roleHtml = `<span style="background: #f8f9fa; 
                        color: #6c757d; 
                        padding: 4px 12px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: 500;
                        display: inline-block;
                        border: 1px solid #dee2e6;">
                ${displayText}
            </span>`;
        }
        
        if (roleHtml) {
            roleContainer.innerHTML = roleHtml;
            roleContainer.style.display = 'block';
        } else {
            roleContainer.style.display = 'none';
        }
    }
    
    const descriptionEl = otherProfileForm.querySelector('.other-profile-description');
    if (descriptionEl) {
        let processedDescription = userData.description || (userLang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ù–µ–º–∞—î –æ–ø–∏—Å—É' : 'No description');
        
        processedDescription = processMentionsStrict(processedDescription);
        descriptionEl.innerHTML = processedDescription;
        
        addMentionEventListeners(descriptionEl);
    }
    
    const birthdayEl = otherProfileForm.querySelector('.other-profile-birthday');
    if (birthdayEl) {
        const birthdayText = userData.birthday || (userLang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' : 'Not specified');
        birthdayEl.textContent = birthdayText;
    }
    
    const backgroundEl = otherProfileForm.querySelector('.profile-preview-background');
    if (backgroundEl && userData.background_url) {
        backgroundEl.style.backgroundImage = `url('${userData.background_url}')`;
        backgroundEl.style.display = 'block';
    }
    
    const roleLabel = otherProfileForm.querySelector('.profile-preview-label[for="role"]');
    if (!roleLabel) {
        const roleSection = document.createElement('div');
        roleSection.className = 'profile-preview-section';
        roleSection.innerHTML = `
            <div class="profile-preview-label">${userLang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–†–æ–ª—å' : 'Role'}</div>
            <div id="other-profile-role" class="profile-preview-value"></div>
        `;
        
        const descriptionSection = otherProfileForm.querySelector('.profile-preview-section');
        if (descriptionSection) {
            descriptionSection.parentNode.insertBefore(roleSection, descriptionSection.nextSibling);
        }
    }
    
    const messageBtn = otherProfileForm.querySelector('.other-profile-message-btn');
    if (messageBtn) {
        messageBtn.onclick = function() {
            const otherProfileToggle = document.getElementById('other-profile-toggle');
            if (otherProfileToggle) otherProfileToggle.checked = false;
            
            if (isBinUser(userData.username)) {
                openBinLogin();
            } else {
                openChat(userData.username);
            }
        };
        
        if (isBinUser(userData.username)) {
            messageBtn.textContent = userLang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? "–û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó" : "Get Verification Code";
            messageBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        } else {
            messageBtn.textContent = userLang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? "–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è" : "Message";
            messageBtn.style.background = '#007bff';
        }
    }
    
    const otherProfileToggle = document.getElementById('other-profile-toggle');
    if (otherProfileToggle) {
        otherProfileToggle.checked = true;
    }
    
    console.log('User profile loaded:', {
        username: userData.username,
        role: userData.role,
        display_role: userData.display_role,
        subscribe: userData.subscribe,
        status: userData.status
    });
    
    setTimeout(() => {
        const otherProfileDesc = otherProfileForm.querySelector('.other-profile-description');
        if (otherProfileDesc) {
            const processedText = processMentionsStrict(otherProfileDesc.innerHTML);
            otherProfileDesc.innerHTML = processedText;
            addMentionEventListeners(otherProfileDesc);
        }
    }, 100);
}

document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        if (e.target.matches('.other-profile-form .message-mention, .other-profile-form .profile-mention')) {
            e.preventDefault();
            e.stopPropagation();
            const username = e.target.getAttribute('data-username').replace('@', '');
            openUserProfile(username);
        }
    });
});

function isBinUser(name){ 
    if (!name) return false; 
        const n = String(name).toLowerCase(); 
        return n === 'bin' || n === 'bin_bot' || n === '@bin' || n === '@bin_bot'; 
}

function loadChatMessages(username) {
    if (isVideoModalOpen) {
        pendingRefreshOnModalClose[username] = true;
        return;
    }

    if (isBinUser(username)) {
        fetch(`/get-bin-messages/`)
            .then(r => r.ok ? r.json() : Promise.reject('Network error'))
            .then(messages => {
                displayBinMessages(messages);
                if (messages.length === 0) {
                    setTimeout(() => {
                        displayMessage({
                            text: welcomeMessage,
                            sender: "Bin",
                            timestamp: new Date().toISOString(),
                            is_sent: false
                        }, false);
                    }, 300);
                }
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞ Bin —Å–æ–æ–±—â–µ–Ω–∏–π:', err));
        return;
    }

    if (username === "{{ user.username }}") {
        fetch(`/get-notes/`)
            .then(r => r.ok ? r.json() : Promise.reject('Network error'))
            .then(notes => {
                displayNotes(notes);
                const mc = document.getElementById('chat-messages');
                if (mc) {
                    const saved = localStorage.getItem('chat_scroll_' + username);
                    if (saved) mc.scrollTop = parseInt(saved, 10);
                    else scrollIfAtBottom(mc, true);
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–º–µ—Ç–æ–∫:', err);
                const local = JSON.parse(localStorage.getItem('user_notes') || '[]');
                displayNotes(local);
            });
        return;
    }

    fetch(`/get-chat-messages/?username=${encodeURIComponent(username)}`)
        .then(r => r.json())
        .then(messages => {
            const container = document.getElementById('chat-messages');
            if (!container) return;

            const existingIds = new Set(
                Array.from(container.querySelectorAll('[data-message-id]'))
                    .map(el => el.dataset.messageId)
            );

            let spacer = container.querySelector('.chat-messages-spacer');
            if (!spacer) {
                spacer = document.createElement('div');
                spacer.className = 'chat-messages-spacer';
                container.appendChild(spacer);
            }

            messages.forEach(msg => {
                if (msg.id && existingIds.has(String(msg.id))) {
                    return;
                }

                if (msg.file_url) {
                    displayFileMessage(msg, msg.is_sent);
                } else {
                    displayMessage(msg);
                }
            });

            try { normalizeFileAttachments(container); } catch(e) {}

            const initialLoad = !perChatLastMessageId[username];
            const savedScroll = localStorage.getItem('chat_scroll_' + username);

            if (initialLoad) {
                if (savedScroll !== null) {
                    container.scrollTop = parseInt(savedScroll, 10);
                } else {
                    scrollIfAtBottom(container, true);
                }
            } else {
                scrollIfAtBottom(container);
            }

            container._lastScrollHeight = container.scrollHeight;

            if (messages.length) {
                const maxId = Math.max(...messages.map(m => m.id || 0));
                perChatLastMessageId[username] = Math.max(perChatLastMessageId[username] || 0, maxId);
            }
        })
        .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞:', err));
}


let formOpenState = false;

function updateFormOpenState() {
    const forms = [
        'profile-toggle', 'other-profile-toggle', 'setting-toggle',
        'form1-toggle', 'form2-toggle', 'color_theme-toggle', 'chat-settings-toggle',
        'wallpaper-toggle', 'wallet-toggle', 'check-subscription-toggle',
        'subscribe-month-toggle', 'subscribe-year-toggle', 'deposit-toggle',
        'add_card-toggle', 'bin_mouth-toggle', 'bin_premium_mouth-toggle',
        'bin_years-toggle', 'bin_premium_years-toggle', 'security-toggle'
    ];
    
    let isOpen = false;
    
    for (const id of forms) {
        const cb = document.getElementById(id);
        if (cb && cb.checked) {
            isOpen = true;
            break;
        }
    }
    
    formOpenState = isOpen;
    
    if (isOpen && document.getElementById('chat-toggle')?.checked) {
        document.body.classList.add('form-open');
    } else {
        document.body.classList.remove('form-open');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[type="checkbox"][id$="-toggle"]').forEach(cb => {
        cb.addEventListener('change', updateFormOpenState);
    });
    
    updateFormOpenState();
    
    setInterval(updateFormOpenState);
});

function sendFile() {
    if (window.__canonical_sendFile) return window.__canonical_sendFile();
    if (!selectedFile || !currentChatUser) { cancelFile(); return; }
    if (isBinUser(currentChatUser)) { alert("Bin only provides verification codes. Please send a text message to get your code."); cancelFile(); return; }
}

const binContact = {
    username: "Bin",
    avatar_url: "/static/pictures/bin.jpg", 
    last_message: "Get verification code",
    last_activity: new Date().toISOString(),
    unread_count: 0
};

document.addEventListener('DOMContentLoaded', function() {
    processProfileDescription();
    
    document.addEventListener('click', function(e) {
        if (e.target.matches('.message-mention, .profile-mention')) {
            e.preventDefault();
            const username = e.target.getAttribute('data-username').replace('@', '');
            openUserProfile(username);
        }
        
        if (e.target.matches('.profile-preview-value a[href*="profile="]')) {
            e.preventDefault();
            const url = new URL(e.target.href);
            const profileUsername = url.searchParams.get('profile');
            if (profileUsername) {
                openUserProfile(profileUsername);
            }
        }
    });
    
    const chatOverlay = document.querySelector('.chat-overlay');
    if (chatOverlay) {
        chatOverlay.addEventListener('click', closeChat);
    }
    
    const closeChatBtn = document.querySelector('.close-chat');
    if (closeChatBtn) {
        closeChatBtn.addEventListener('click', closeChat);
    }
    
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }

    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', searchUsers);
        
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !document.getElementById('searchResults').contains(e.target)) {
                document.getElementById('searchResults').innerHTML = '';
                const recentContactsDiv = document.getElementById('recent-contacts');
                if (recentContactsDiv && searchInput.value.trim().length === 0) {
                    recentContactsDiv.style.display = "block";
                }
            }
        });
    }

    setupWebSocketReconnect();
    loadRecentContacts();
    setInterval(loadRecentContacts, 30000);
});

const mentionStyles = `
.profile-mention {
    color: #007bff;
    font-weight: bold;
    cursor: pointer;
    text-decoration: none;
    transition: color 0.2s ease;
    padding: 1px 3px;
    border-radius: 3px;
}

.profile-mention:hover {
    color: #0056b3;
    text-decoration: underline;
}

.message-mention {
    color: #007bff;
    font-weight: bold;
    cursor: pointer;
    text-decoration: none;
    transition: color 0.2s ease;
    padding: 1px 3px;
    border-radius: 3px;
}

.message-mention:hover {
    color: #0056b3;
    text-decoration: underline;
}
`;

const styleElement = document.createElement('style');
styleElement.textContent = mentionStyles;
document.head.appendChild(styleElement);


document.addEventListener('DOMContentLoaded', function() {
    const chatOverlay = document.querySelector('.chat-overlay');
    if (chatOverlay) {
        chatOverlay.addEventListener('click', closeChat);
    }
    
    const closeChatBtn = document.querySelector('.close-chat');
    if (closeChatBtn) {
        closeChatBtn.addEventListener('click', closeChat);
    }
    
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            if (e.key === 'Enter' && e.shiftKey) {
                e.preventDefault();
                document.execCommand('insertHTML', false, '<br>');
            }
        });
    }

    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', searchUsers);
        
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !document.getElementById('searchResults').contains(e.target)) {
                document.getElementById('searchResults').innerHTML = '';
                const recentContactsDiv = document.getElementById('recent-contacts');
                if (recentContactsDiv && searchInput.value.trim().length === 0) {
                    recentContactsDiv.style.display = "block";
                }
            }
        });
    }

    setupWebSocketReconnect();
    loadRecentContacts();
    setInterval(loadRecentContacts, 30000);
});

let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 1000;

function setupWebSocketReconnect() {
    setInterval(() => {
        if (currentChatUser && (!chatSocket || chatSocket.readyState === WebSocket.CLOSED || chatSocket.readyState === WebSocket.CLOSING)) {
            attemptReconnect();
        }
    }, 5000);
}

function attemptReconnect() {
    if (reconnectAttempts < maxReconnectAttempts && currentChatUser) {
        setTimeout(() => {
            console.log(`Attempting to reconnect... (${reconnectAttempts + 1}/${maxReconnectAttempts})`);
            openChat(currentChatUser);
            reconnectAttempts++;
        }, reconnectDelay * reconnectAttempts);
    }
}

function loadRecentContacts() {
    try {
        if (isVideoModalOpen) return;
        if (document.getElementById('chat-toggle')?.checked) return;
    } catch(e) {}

    fetch('/get-recent-contacts/')
        .then(response => response.json())
        .then(contacts => {
            const contactsList = document.getElementById('recent-contacts-list');
            const currentUser = "{{ user.username }}";
            const lang = "{{ user.language|default:'English' }}";

            let lastNoteTime = localStorage.getItem('last_note_time');
            const notes = JSON.parse(localStorage.getItem('user_notes') || '[]');
            if (notes.length > 0) {
                const latestNote = notes[notes.length - 1];
                lastNoteTime = latestNote.timestamp;
                localStorage.setItem('last_note_time', lastNoteTime);
            }
            if (!lastNoteTime) {
                lastNoteTime = new Date().toISOString();
                localStorage.setItem('last_note_time', lastNoteTime);
            }

            const favoriteContact = {
                username: currentUser,
                avatar_url: "/static/pictures/notes.jpg",
                last_message: lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–í–∞—à—ñ –Ω–æ—Ç–∞—Ç–∫–∏' : 'Your notes',
                last_message_type: 'text',
                last_message_time: lastNoteTime,
                unread_count: 0
            };

            const binContact = {
                username: "Bin",
                avatar_url: "/static/pictures/bin.jpg",
                last_message: lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–°–∏—Å—Ç–µ–º–Ω–∏–π –±–æ—Ç' : 'System bot',
                last_message_type: 'text',
                last_message_time: localStorage.getItem('last_bin_time') || new Date().toISOString(),
                unread_count: 0
            };

            const allContacts = [
                favoriteContact,
                binContact,
                ...contacts.filter(c => c.username !== currentUser && c.username !== 'Bin' && c.username !== 'Bin_bot')
            ].sort((a, b) => {
                const ta = new Date(a.last_message_time || 0).getTime();
                const tb = new Date(b.last_message_time || 0).getTime();
                return tb - ta;
            });

            if (allContacts.length === 0) {
                contactsList.innerHTML = '<div style="color:#999; padding:10px; text-align:center;">No recent chats</div>';
                return;
            }

            contactsList.innerHTML = allContacts.map(contact => {
                let displayName, lastMessage, avatarUrl, onClickFunction, timeToShow;

                timeToShow = contact.last_message_time 
                    ? formatTime(contact.last_message_time) 
                    : '';

                if (contact.username === currentUser) {
                    displayName = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ' : 'Notes';
                    lastMessage = getLastNoteMessage() || (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–í–∞—à—ñ –Ω–æ—Ç–∞—Ç–∫–∏' : 'Your notes');
                    avatarUrl = "/static/pictures/notes.jpg";
                    onClickFunction = `openChat('${contact.username}')`;
                } 
                else if (contact.username === "Bin" || contact.username === "Bin_bot") {
                    displayName = "Bin";
                    lastMessage = contact.last_message || (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–°–∏—Å—Ç–µ–º–Ω–∏–π –±–æ—Ç' : 'System bot');
                    avatarUrl = "/static/pictures/bin.jpg";
                    onClickFunction = `openBinLogin()`;
                }
                else {
                    displayName = contact.username;
                    avatarUrl = contact.avatar_url || '/static/pictures/login.png';
                    onClickFunction = `openChat('${contact.username}')`;

                    if (contact.last_message_type === 'image') {
                        lastMessage = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? 'üñºÔ∏è –§–æ—Ç–æ' : 'üñºÔ∏è Photo';
                    } else if (contact.last_message_type === 'video') {
                        lastMessage = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? 'üé• –í—ñ–¥–µ–æ' : 'üé• Video';
                    } else if (contact.last_message_type === 'file') {
                        lastMessage = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? 'üìé –§–∞–π–ª' : 'üìé File';
                    } else if (contact.last_message?.includes('[sticker:')) {
                        lastMessage = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? 'üòÄ –°—Ç–∏–∫–µ—Ä' : 'üòÄ Sticker';
                    } else if (contact.last_message?.trim()) {
                        lastMessage = contact.last_message;
                    } else {
                        lastMessage = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å' : 'No messages';
                    }
                }

                const truncatedMessage = truncateText(lastMessage, 25);

                return `
                <div class="recent-contact ${contact.unread_count > 0 ? 'unread' : ''}" 
                     onclick="${onClickFunction}">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${avatarUrl}" 
                             class="contact-avatar" 
                             alt="${displayName}"
                             onerror="this.src='/static/pictures/login.png'">
                        <div class="contact-info">
                            <div class="contact-username">${displayName}</div>
                            <div class="contact-last-message" title="${lastMessage}">
                                ${truncatedMessage}
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:2px;">
                            ${timeToShow ? `
                                <div class="contact-time" data-timestamp="${contact.last_message_time}">
                                    ${timeToShow}
                                </div>
                            ` : ''}
                            ${contact.unread_count > 0 ? `
                                <div class="unread-badge">${contact.unread_count}</div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        })
        .catch(error => {
            console.error('Error loading recent contacts:', error);
        });
}

function getLastNoteMessage() {
    const notes = JSON.parse(localStorage.getItem('user_notes') || '[]');
    if (notes.length === 0) return null;
    return notes[notes.length - 1].text || '';
}

function getVerificationCodeForBin() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('CSRF token not found. Please refresh the page.');
        return;
    }
    
    const message = (function(){ const el = document.getElementById('chat-input'); return el ? contentEditableToTokenText(el).trim() : ''; })();
    if (message) {
        displayMessage({
            text: message,
            sender: "{{ user.username }}",
            timestamp: new Date().toISOString(),
            is_sent: true
        }, true);
    }
    
    fetch('/get-verification-code-bin/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            action: 'get_code'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log('Verification code received from Bin:', data.code);
            
            setTimeout(() => {
                displayMessage({
                    text: data.message || `Your verification code: ${data.code}`,
                    sender: "Bin_bot",
                    timestamp: new Date().toISOString(),
                    is_sent: false
                }, false);
                
                try { if (data.message_id) perChatLastMessageId['Bin_bot'] = Math.max(perChatLastMessageId['Bin_bot'] || 0, data.message_id); } catch(e) {}
                
                loadRecentContacts();
                
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    setTimeout(() => {
                        try { if (isAtBottom(messagesContainer)) messagesContainer.scrollTop = messagesContainer.scrollHeight; else { const btn = document.getElementById('chat-scroll-bottom-btn'); if (btn) btn.style.display = 'block'; } } catch(e) {}
                    }, 100);
                }
            }, 300);
        } else {
            console.error('Failed to get verification code:', data.error);
            alert('Error getting verification code: ' + data.error);
        }
    })
    .catch(error => {
        console.error('AJAX get verification code error:', error);
        alert('Error getting verification code: ' + error.message);
    });
}

function openBinLogin() {
    closeProfileModals();
    
    currentChatUser = "Bin_bot";
    document.getElementById('chat-username').textContent = "Bin";
    
    document.getElementById('chat-toggle').checked = true;
    
    reconnectAttempts = 0;
    
    if (chatSocket) {
        chatSocket.close();
        chatSocket = null;
    }
    
    console.log('Opening chat with Bin');
    
    loadChatMessages("Bin_bot");
    
    setTimeout(() => {
        displayMessage({
            sender: "Bin",
            timestamp: new Date().toISOString(),
            is_sent: false
        }, false);
    }, 300);
    
    document.getElementById('searchResults').innerHTML = '';
    
    const recentContactsDiv = document.getElementById('recent-contacts');
    if (recentContactsDiv) {
        recentContactsDiv.style.display = "block";
    }
    
    addAttachmentButton();
}

function sendMessageToBin(message) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('CSRF token not found. Please refresh the page.');
        return;
    }
    
    fetch('/get-verification-code-bin/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log('Verification code received from Bin:', data.code);
            
            setTimeout(() => {
                displayMessage({
                    text: data.message || `–í–∞—à –∫–æ–¥ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó: ${data.code}. –ö–æ–¥ –¥—ñ–π—Å–Ω–∏–π 10 —Ö–≤–∏–ª–∏–Ω.`,
                    sender: "Bin_bot",
                    timestamp: new Date().toISOString(),
                    is_sent: false
                }, false);
                
                try { if (data.message_id) perChatLastMessageId['Bin_bot'] = Math.max(perChatLastMessageId['Bin_bot'] || 0, data.message_id); } catch(e) {}
                
                loadRecentContacts();
                
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    setTimeout(() => {
                        try { if (isAtBottom(messagesContainer)) messagesContainer.scrollTop = messagesContainer.scrollHeight; else { const btn = document.getElementById('chat-scroll-bottom-btn'); if (btn) btn.style.display = 'block'; } } catch(e) {}
                    }, 100);
                }
            }, 300);
        } else {
            console.error('Failed to get verification code:', data.error);
            alert('Error getting verification code: ' + data.error);
        }
    })
    .catch(error => {
        console.error('AJAX get verification code error:', error);
        alert('Error getting verification code: ' + error.message);
    });
}


function displayBinMessages(messages) {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const wasAtBottom = isAtBottom(container);
    const prevScrollHeight = container.scrollHeight;
    const prevScrollTop = container.scrollTop;

    const existingTimestamps = new Set(
        Array.from(container.querySelectorAll('.message .message-time'))
            .map(el => el.dataset.timestamp)
    );

    messages.forEach(msg => {
        if (existingTimestamps.has(msg.timestamp)) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.is_sent ? 'sent' : 'received'}`;
        messageDiv.dataset.timestamp = msg.timestamp;

        const textDiv = document.createElement('div');
        const processedText = processMentions(msg.text || '');
        textDiv.innerHTML = renderStickersInline(processedText);

        messageDiv.appendChild(textDiv);

        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.dataset.timestamp = msg.timestamp;
        timeDiv.textContent = formatChatTime(msg.timestamp);

        timeDiv.style.fontSize    = '11px';
        timeDiv.style.color       = '#999';
        timeDiv.style.marginTop   = '4px';
        timeDiv.style.textAlign   = 'right';

        messageDiv.appendChild(timeDiv);

        const spacer = container.querySelector('.chat-messages-spacer');
        if (spacer) {
            container.insertBefore(messageDiv, spacer);
        } else {
            container.appendChild(messageDiv);
        }

        addMentionEventListeners(messageDiv);
    });

    if (wasAtBottom) {
        container.scrollTop = container.scrollHeight;
    } else {
        const heightDiff = container.scrollHeight - prevScrollHeight;
        container.scrollTop = prevScrollTop + heightDiff;
    }

    if (messages.length > 0) {
        const lastMsg = messages[messages.length - 1];
        localStorage.setItem('last_bin_time', lastMsg.timestamp || new Date().toISOString());
        loadRecentContacts();
    }
}

window.__canonical_sendFile = function() {
    if (!selectedFile || !currentChatUser) {
        cancelFile();
        return;
    }

    const inputEl = document.getElementById('chat-input');
    const text = inputEl ? contentEditableToTokenText(inputEl).trim() : '';

    if (isBinUser(currentChatUser)) {
        const msg = "{{ user.language|default:'English' }}" === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? 'Bin –Ω–∞—Ä–∞–∑—ñ –ø—ñ–¥—Ç—Ä–∏–º—É—î –ª–∏—à–µ —Ç–µ–∫—Å—Ç–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è' : 'Bin currently only supports text messages';
        alert(msg);
        cancelFile();
        return;
    }

    const userLang = "{{ user.language|default:'English' }}";
    if (isUploadingFile) {
        console.log('sendFile blocked: upload already in progress');
        alert(userLang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–Ü–Ω—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É –≤–∂–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è' : 'Another file upload is in progress');
        return;
    }
    isUploadingFile = true;

    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('receiver', currentChatUser);
    if (text) {
        formData.append('text', text);
    }

    const csrfToken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrfToken) {
        alert('CSRF token missing');
        cancelFile();
        isUploadingFile = false;
        return;
    }

    const tempId = 'temp-file-' + Date.now();
    const messagesContainer = document.getElementById('chat-messages');
    const tempDiv = document.createElement('div');
    tempDiv.id = tempId;
    tempDiv.className = 'message sent';
    if (selectedFile.type.startsWith('image/')) {
        tempDiv.innerHTML = `<img src="${URL.createObjectURL(selectedFile)}" data-file-name="${selectedFile.name}" style="max-width:100%; border-radius:6px; display:block; color: black;" alt="${selectedFile.name}">`;
    } else if (selectedFile.type.startsWith('video/')) {
        tempDiv.innerHTML = `<div class="video-thumb" style="width:250px;"> <video muted playsinline preload="metadata" style="width:100%; display:block;"><source src="${URL.createObjectURL(selectedFile)}" type="${selectedFile.type}"></video></div>`;
    } else {
        tempDiv.innerHTML = `<div style="background:#f8f9fa;padding:8px;border-radius:6px;">${selectedFile.name}</div>`;
    }
    const spacer = messagesContainer.querySelector('.chat-messages-spacer');
    if (spacer) messagesContainer.insertBefore(tempDiv, spacer); else messagesContainer.appendChild(tempDiv);
    try { 
        scrollIfAtBottom(messagesContainer); 
    } 
    catch(e) {}

    console.log('Uploading file to /upload-chat-file/', { 
        name: selectedFile.name, 
        type: selectedFile.type,
        size: selectedFile.size, 
        receiver: currentChatUser 
    });

    fetch('/upload-chat-file/', {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
    }).then(r => r.json()).then(data => {
        const el = document.getElementById(tempId);
        if (data && data.success) {
            console.log('Upload succeeded', data);
            if (el) el.remove();
            displayFileMessage({ file_url: data.file_url, file_name: data.file_name, file_type: data.file_type, text: data.text }, true);
            try { if (data.message_id) perChatLastMessageId[currentChatUser] = Math.max(perChatLastMessageId[currentChatUser] || 0, data.message_id); } catch(e) {}
            loadRecentContacts();

            const inputEl = document.getElementById('chat-input');
            try { if (inputEl) { inputEl.innerHTML = ''; localStorage.setItem('chat_input_' + currentChatUser, ''); } } catch(e) {}
            selectedFile = null;
            cancelFile();
            isUploadingFile = false;
        } else {
            console.warn('Upload failed', data);
            if (el) el.remove();
            alert('Failed to send file: ' + (data && data.error ? data.error : 'Unknown'));
            isUploadingFile = false;
            cancelFile();
        }
    }).catch(e => {
        console.error('Upload error', e);
        alert('Error uploading file: ' + e.message);
        const el = document.getElementById(tempId); if (el) el.remove();
        isUploadingFile = false;
        cancelFile();
    });
};

window.sendFile = function() { return window.__canonical_sendFile(); };

function truncateText(text, maxLength) {
    if (!text || text.length <= maxLength) {
        return text;
    }
    return text.substring(0, maxLength) + '...';
}

function getLastNoteMessage() {
    const notes = JSON.parse(localStorage.getItem('user_notes') || '[]');
    if (notes.length > 0) {
        return notes[notes.length - 1].text;
    }
    return null;
}

function saveNoteToStorage(noteText) {
    const notes = JSON.parse(localStorage.getItem('user_notes') || '[]');
    const now = new Date().toISOString();
    notes.push({
        text: noteText,
        timestamp: now
    });
    localStorage.setItem('user_notes', JSON.stringify(notes));
    localStorage.setItem('last_note_time', now);
    setTimeout(() => {
        loadRecentContacts();
    }, 100);
}

function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    const now = new Date();
    const lang = "{{ user.language|default:'English' }}";
    
    const format24Hour = localStorage.getItem('hourFormat') === '24';
    
    const isToday = date.toDateString() === now.toDateString();
    
    if (isToday) {
        if (format24Hour) {
            if (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
                return date.toLocaleTimeString('uk-UA', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                }).replace(/^24:/, '00:');
            } else {
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                }).replace(/^24:/, '00:');
            }
        } else {
            if (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
                return date.toLocaleTimeString('uk-UA', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            } else {
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            }
        }
    } else {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}.${month}.${year}`;
    }
}

function formatChatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const format24Hour = localStorage.getItem('hourFormat') === '24';
    
    if (!isToday) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();

        let timeString;
        if (format24Hour) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            timeString = `${hours}:${minutes}`;
        } else {
            timeString = date.toLocaleTimeString(lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? 'uk-UA' : 'en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        return `${day}.${month}.${year} ${timeString}`;
    }

    if (format24Hour) {
        if (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
            return date.toLocaleTimeString('uk-UA', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            }).replace(/^24:/, '00:');
        } else {
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            }).replace(/^24:/, '00:');
        }
    } else {
        if (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
            return date.toLocaleTimeString('uk-UA', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        } else {
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }
    }
}

let chatRefreshInterval = null;

function startChatRefresh() {
    if (chatRefreshInterval !== null) {
        return;
    }

    console.log("–ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã");

    chatRefreshInterval = setInterval(() => {
        if (!currentChatUser) {
            stopChatRefresh();
            return;
        }

        console.log("–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ ‚Üí", currentChatUser);

    }, 5000);
}

function stopChatRefresh() {
    if (chatRefreshInterval !== null) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
        console.log("–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞");
    }
}

function openChat(username) {
    if (username === 'Bin') {
        openBinLogin();
        return;
    }

    const container = document.getElementById('chat-messages');
    if (container) {
        container.innerHTML = '';
    }

    try {
        if (currentChatUser) {
            const mcPrev = document.getElementById('chat-messages');
            if (mcPrev) try { localStorage.setItem('chat_scroll_' + currentChatUser, mcPrev.scrollTop); } catch(e) {}
        }
    } catch(e) {}

    currentChatUser = username;
    document.getElementById('chat-username').textContent = username;
    

    const chatInputEl = document.getElementById('chat-input');
    if (chatInputEl) {
        try {
            const draft = localStorage.getItem('chat_input_' + username) || '';
            tokenTextToContent(chatInputEl, draft);
        } catch(e) {}
    }

    try { perChatLastMessageId[username] = null; } catch(e) {}

    document.getElementById('chat-toggle').checked = true;

    reconnectAttempts = 0;
    
    if (chatSocket) {
        try { chatSocket.close(); } catch(e) {}
        chatSocket = null;
    }

    try {
        const input = document.getElementById('chat-input');
        const sendBtn = document.querySelector('.chat-send-btn');
        if (input) { input.setAttribute('contenteditable', 'true'); input.classList.remove('disabled'); input.removeAttribute('placeholder'); }
        if (sendBtn) { sendBtn.disabled = false; sendBtn.title = ''; }
    } catch(e) {}

    try { loadChatMessages(username); } catch(e) { console.error('loadChatMessages immediate call failed', e); }

    setTimeout(() => {
        try {
            const mc = document.getElementById('chat-messages');
            if (mc) {
                const saved = localStorage.getItem('chat_scroll_' + username);
                if (saved !== null) mc.scrollTop = parseInt(saved, 10); else mc.scrollTop = mc.scrollHeight;
                const btn = document.getElementById('chat-scroll-bottom-btn'); if (btn) btn.style.display = isAtBottom(mc) ? 'none' : 'block';
            }
        } catch(e) {}
    }, 250);
    
    const currentUser = "{{ user.username }}";
    const roomName = [currentUser, username].sort().join('_').replace(/[^\w]/g, '');
    
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsPath = wsScheme + '://' + window.location.host + '/ws/chat/' + roomName + '/';
    
    console.log('Connecting to WebSocket:', wsPath);
    
    chatSocket = new WebSocket(wsPath);
    
    chatSocket.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            console.log('Received WebSocket message:', data);

            if (data.type === 'message_edited') {
                const msgEl = document.querySelector(`[data-message-id="${data.message_id}"]`);
                if (msgEl) {
                    const textDiv = msgEl.querySelector('div');
                    if (textDiv) {
                        msgEl.dataset.tokenText = data.text || '';
                        const processed = processMentionsStrict(data.text || '');
                        const stickerMatch = String(processed).trim().match(/^\[sticker:([a-zA-Z0-9_-]+)\]$/);
                        if (stickerMatch) {
                            const name = stickerMatch[1];
                            const emoji = renderSticker(name);
                            textDiv.innerHTML = `<div class="sticker-render" data-sticker="${name}" style="font-size:44px; display:inline-block; cursor:pointer;" onclick="sendSticker('${name}')">${emoji}</div>`;
                        } else {
                            textDiv.innerHTML = renderStickersInline(processed);
                        }
                    }
                    const timeDiv = msgEl.querySelector('.message-time');
                    if (timeDiv) {
                        timeDiv.textContent = formatChatTime(data.timestamp);
                        timeDiv.dataset.timestamp = data.timestamp;

                        if (!msgEl.querySelector('.message-edited')) {
                            const edited = document.createElement('span');
                            edited.className = 'message-edited';
                            edited.textContent = ("{{ user.language|default:'English' }}" === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') ? ' (–∑–º—ñ–Ω–µ–Ω–æ)' : ' (edited)';
                            edited.style.cssText = 'font-size:10px;color:#888;margin-left:6px;';
                            timeDiv.appendChild(edited);
                        }
                    }
                }
                return;
            }

            if (data.type === 'message_deleted') {
                const msgEl = document.querySelector(`[data-message-id="${data.message_id}"]`);
                if (msgEl) msgEl.remove();
                return;
            }

            if (isVideoModalOpen) {
                console.log('Video modal open ‚Äî deferring WebSocket updates for this chat');
                try { if (currentChatUser) pendingRefreshOnModalClose[currentChatUser] = true; } catch(e) {}
                return;
            }
            
            if (data.file_url) {
                if (isVideoModalOpen && openVideoUrl && data.file_url === openVideoUrl) {
                    console.log('Received file message for currently open video, skipping UI update to avoid interrupting playback');
                    return;
                }
                if (data.sender !== "{{ user.username }}") {
                    displayFileMessage({
                        file_url: data.file_url,
                        file_name: data.file_name,
                        file_type: data.file_type,
                        file_size: data.file_size,
                        text: data.message || '',
                        sender: data.sender,
                        timestamp: data.timestamp || new Date().toISOString()
                    }, false);
                    loadRecentContacts();
                } else {
                    console.log('Ignoring own file message from WebSocket');
                }
                return;
            }
            
            if (data.sender !== "{{ user.username }}") {
                if (typeof data.message !== 'string' || !data.message.trim()) {
                    console.log('Ignoring non-string/empty message from WebSocket:', data.message);
                } else {
                    if (data.message_id && document.querySelector(`[data-message-id="${data.message_id}"]`)) {
                        console.debug('Incoming message already present, skipping render', data.message_id);
                    } else {
                        displayMessage({ text: data.message, sender: data.sender, timestamp: data.timestamp || new Date().toISOString(), id: data.message_id, is_sent: false });
                        loadRecentContacts();
                    }
                }
            } else {
                console.log('Ignoring own message from WebSocket');
            }
        } catch (error) {
            console.error('Error parsing WebSocket message:', error);
        }
    };
    
    chatSocket.onopen = function(e) {
        console.log('WebSocket connection established successfully');
        loadChatMessages(username);
    };
    
    chatSocket.onclose = function(e) {
        console.log('WebSocket connection closed:', e.code, e.reason);
        if (document.getElementById('chat-toggle').checked) {
            setTimeout(() => attemptReconnect(), 2000);
        }
    };
    
    chatSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
    
    loadChatMessages(username);
    markMessagesAsRead(username);
    
    document.getElementById('searchResults').innerHTML = '';
    
    const recentContactsDiv = document.getElementById('recent-contacts');
    if (recentContactsDiv) {
        recentContactsDiv.style.display = "block";
    }
    
    document.addEventListener('keydown', blockEscapeClose);
}


function blockEscapeClose(e) {
    if (e.key === 'Escape' && document.getElementById('chat-toggle').checked) {
        e.preventDefault();
        e.stopPropagation();
        showTemporaryMessage("Chat cannot be closed", 2000);
    }
}

function showTemporaryMessage(message, duration) {
    const tempMsg = document.createElement('div');
    tempMsg.textContent = message;
    tempMsg.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 10000;
    `;
    document.body.appendChild(tempMsg);
    
    setTimeout(() => {
        tempMsg.remove();
    }, duration);
}

function markMessagesAsRead(username) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/mark-messages-read/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
            sender: username
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRecentContacts();
        }
    })
    .catch(error => {
        console.error('Error marking messages as read:', error);
    });
}

function processMentions(text) {
    if (!text) return '';
    
    const mentionRegex = /(@[\w–∞-—è–ê-–Ø—ë–Å]+)/gi;
    
    return text.replace(mentionRegex, '<span class="message-mention profile-mention" data-username="$1">$1</span>');
}

function addMentionEventListeners(element) {
    const mentions = element.querySelectorAll('.message-mention, .profile-mention');
    
    mentions.forEach(mention => {
        const username = mention.getAttribute('data-username');
        
        if (!isValidMention(username)) {
            mention.classList.remove('message-mention', 'profile-mention');
            mention.style.color = '';
            mention.style.cursor = 'default';
            mention.style.textDecoration = 'none';
            mention.style.backgroundColor = '';
            return;
        }
        
        checkUserExists(username.replace('@', '')).then(exists => {
            if (!exists) {
                mention.classList.remove('message-mention', 'profile-mention');
                mention.style.color = '';
                mention.style.cursor = 'default';
                mention.style.textDecoration = 'none';
                mention.style.backgroundColor = '';
                mention.removeAttribute('data-username');
                return;
            }
            
            mention.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const cleanUsername = username.replace('@', '');
                openUserProfile(cleanUsername);
            });
            
            mention.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-1px)';
                this.style.cursor = 'pointer';
            });
            
            mention.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    });
}

const userExistsCache = new Map();

function checkUserExists(username) {
    const cleanUsername = username.replace(/^@/, '').toLowerCase();

    if (userExistsCache.has(cleanUsername)) {
        const cached = userExistsCache.get(cleanUsername);
        if (cached instanceof Promise) return cached;
        return Promise.resolve(cached);
    }

    const promise = fetch(`/check-user-exists/?username=${encodeURIComponent(cleanUsername)}`)
        .then(response => response.json())
        .then(data => {
            const exists = data.exists || false;
            userExistsCache.set(cleanUsername, exists);
            return exists;
        })
        .catch(err => {
            console.error('checkUserExists error:', err);
            userExistsCache.set(cleanUsername, false);
            return false;
        });

    userExistsCache.set(cleanUsername, promise);
    return promise;
}

function isValidMention(username) {
    const cleanUsername = username.replace('@', '');
    
    return username.startsWith('@') && cleanUsername.length > 0;
}

function isValidMention(username) {
    if (!username || !username.startsWith('@')) return false;
    
    const cleanUsername = username.replace('@', '');
    return /^[\w–∞-—è–ê-–Ø—ë–Å]+$/.test(cleanUsername);
}

function isValidMention(username) {
    if (!username || !username.startsWith('@')) return false;
    
    const cleanUsername = username.replace('@', '');
    return /^[\w–∞-—è–ê-–Ø—ë–Å_\d]+$/.test(cleanUsername) && cleanUsername.length > 0;
}


const STICKER_CATEGORIES = (function(){
    const cats = {
        'people': {
            'smile': 'üòÄ',
            'laugh': 'üòÇ',
            'wink': 'üòâ',
            'grin': 'üòÅ',
            'sunglasses': 'üòé',
            'cool': 'üòé',
            'party': 'üéâ',
            'wave': 'üëã',
            'lol': 'ü§£',
            'blush': 'üòä',
            'relieved': 'üòå',
            'sleeping': 'üò¥',
            'joy': 'üòÑ',
            'sweat_smile': 'üòÖ',
            'rolling_eyes': 'üôÑ',
            'scream': 'üò±',
            'hushed': 'üòÆ',
            'cold_sweat': 'üò∞',
            'cry': 'üò¢',
            'disappointed': 'üòû',
            'angry': 'üò†',
            'rage': 'ü§¨',
            'swearing': 'ü§¨',
            'neutral': 'üòê',
            'expressionless': 'üòë',
            'no_mouth': 'üò∂',
            'smirk': 'üòè',
            'unamused': 'üòí',
            'roll_eyes': 'üôÑ',
            'thinking': 'ü§î',
            'lying_face': 'ü§•',
            'cowboy': 'ü§†',
            'hugging': 'ü§ó',
            'yum': 'üòã',
            'mask': 'üò∑',
            'nerd': 'ü§ì',
            'clown': 'ü§°',
            'kiss': 'üòò',
            'kissing_heart': 'üòç',
            'kissing_smiling_eyes': 'üòô',
            'kissing_closed_eyes': 'üòö',
            'stuck_out_tongue': 'üòú',
            'stuck_out_tongue_winking': 'üòú',
            'triumph': 'üò§',
            'open_mouth': 'üòÆ',
            'frowning': 'üò¶',
            'anguished': 'üòß',
            'flushed': 'üò≥',
            'disappointed_relieved': 'üò•',
            'worried': 'üòü',
            'fearful': 'üò®',
            'weary': 'üò©', 
            'sleepy': 'üò™',
            'tired_face': 'üò´'
        },
        'animals': {
            'cat': 'üê±', 
            'dog': 'üê∂', 
            'mouse': 'üê≠', 'panda': 'üêº', 'fox': 'ü¶ä', 'rabbit': 'üê∞', 'bear': 'üêª', 'lion': 'ü¶Å', 'tiger': 'üêØ', 'horse': 'üê¥'
        },
        'transport': {
            'car': 'üöó', 
            'bike': 'üö≤', 
            'bus': 'üöå', 'train': 'üöÜ', 'airplane': '‚úàÔ∏è', 'rocket': 'üöÄ', 'ship': 'üö¢', 'tram': 'üöä'
        },
        'nature': {
            'sun': '‚òÄÔ∏è', 
            'cloud': '‚òÅÔ∏è', 
            'rain': 'üåßÔ∏è', 'snow': '‚ùÑÔ∏è', 'tree': 'üå≥', 'flower': 'üå∏', 'mountain': '‚õ∞Ô∏è', 'beach': 'üèñÔ∏è'
        },
        'food': {
            'pizza': 'üçï', 'burger': 'üçî', 'sushi': 'üç£', 'cake': 'üç∞', 'apple': 'üçé', 'coffee': '‚òï', 'icecream': 'üç®', 'taco': 'üåÆ', 'ramen':'üçú', 'bento':'üç±', 'stew':'üç≤', 'pancakes':'ü•û', 'donut':'üç©', 'falafel':'üßÜ', 'baguette':'ü•ñ', 'croissant':'ü•ê'
        },
        'love': {
            'heart': '‚ù§Ô∏è', 'heart_eyes': 'üòç', 'kiss': 'üòò', 'hug': 'ü§ó', 'ring': 'üíç', 'rose': 'üåπ', 'sparkles': '‚ú®', 'couple': 'üë´', 'couple_kiss':'üíè', 'beating_heart':'üíì'
        },
        '–†—É–∫–∏': {
            'thumbs_up': 'üëç', 'thumbs_down': 'üëé', 'clap': 'üëè', 'raised_hands': 'üôå', 'handshake': 'ü§ù', 'victory': '‚úåÔ∏è', 'love_you_gesture': 'ü§ü', 'metal': 'ü§ò', 'call_me': 'ü§ô', 'raised_back_of_hand': 'ü§ö', 'raised_hand': '‚úã', 'open_hands': 'üëê', 'palms_up_together': 'ü§≤', 'folded_hands': 'üôè', 'pinching_hand': 'ü§è', 'point_up': '‚òùÔ∏è', 'point_up_2': 'üëÜ', 'point_down': 'üëá', 'point_left': 'üëà', 'point_right': 'üëâ', 'hand_with_fingers_splayed': 'üñêÔ∏è', 'vulcan': 'üññ', 'writing_hand': '‚úçÔ∏è', 'flexed_biceps': 'üí™', 'left_facing_fist': 'ü§õ', 'right_facing_fist': 'ü§ú', 'oncoming_fist': 'üëä', 'fist': '‚úä', 'raised_fist': '‚úä', 'hand_wave': 'üëã', 'ok_hand': 'üëå', 'thumbs_up_dark': 'üëçüèø', 'thumbs_up_light': 'üëçüèª', 'thumbs_up_medium': 'üëçüèΩ', 'thumbs_up_medium_light': 'üëçüèº', 'thumbs_up_medium_dark': 'üëçüèæ', 'clapping_dark': 'üëèüèø', 'clapping_light': 'üëèüèª', 'fist_light': '‚úäüèª', 'fist_dark': '‚úäüèø', 'hand_open': 'üñêÔ∏è', 'pinch': 'ü§è', 'pray': 'üôè', 'hand_back': 'ü§ö', 'hand_ok': 'üëå', 'hand_highfive': 'üôå', 'hand_point_right': 'üëâ', 'hand_point_left': 'üëà', 'raised_eyebrow':'ü§®', 'finger_point_up':'‚òùÔ∏è'
        },
        'animals': {
            'dog':'üê∂','cat':'üê±','mouse':'üê≠','hamster':'üêπ','rabbit':'üê∞','fox':'ü¶ä','bear':'üêª','panda':'üêº','koala':'üê®','lion':'ü¶Å','tiger':'üêØ','cow':'üêÆ','pig':'üê∑','frog':'üê∏','monkey':'üêµ','chicken':'üêî','rooster':'üêì','penguin':'üêß','bird':'üê¶'
        },
        'misc': {
            'thumbs': 'üëç', 'thumbs_down': 'üëé', 'star': '‚≠ê', 'fire': 'üî•', 'thinking': 'ü§î', 'eyes': 'üëÄ', 'poop': 'üí©', 'ok': 'üëå', 'clap': 'üëè', 'pray': 'üôè', 'tada':'üéâ','sparkle':'‚ú®','zzz':'üí§','alarm':'‚è∞'
        }
    };

    // const flagCodes = [
    //     'af',
    //     'al',
    //     'dz',
    //     'as','ad','ao','ai','aq','ag','ar','am','aw','au','at','az','bs','bh','bd','bb','by','be','bz','bj','bm','bt','bo','ba','bw','bv','br','io','bn','bg','bf','bi','kh','cm','ca','cv','ky','cf','td','cl','cn','cx','cc','co','km','cd','cg','ck','cr','ci','hr','cu','cy','cz','dk','dj','dm','do','ec','eg','sv','gq','er','ee','et','fk','fo','fj','fi','fr','gf','pf','tf','ga','gm','ge','de','gh','gi','gr','gl','gd','gp','gu','gt','gg','gn','gw','gy','ht','hm','va','hn','hk','hu','is','in','id','ir','iq','ie','im','il','it','jm','jp','je','jo','kz','ke','ki','kp','kr','kw','kg','la','lv','lb','ls','lr','ly','li','lt','lu','mo','mk','mg','mw','my','mv','ml','mt','mh','mq','mr','mu','yt','mx','fm','md','mc','mn','me','ms','ma','mz','mm','na','nr','np','nl','nc','nz','ni','ne','ng','nu','nf','mp','no','om','pk','pw','ps','pa','pg','py','pe','ph','pn','pl','pt','pr','qa','re','ro','ru','rw','sh','kn','lc','pm','vc','ws','sm','st','sa','sn','rs','sc','sl','sg','sk','si','sb','so','za','gs','ss','es','lk','sd','sr','sj','se','ch','sy','tw','tj','tz','th','tl','tg','tk','to','tt','tn','tr','tm','tc','tv','ug','ua','ae','gb','us','um','uy','uz','vu','ve','vn','vg','vi','wf','eh','ye','zm','zw'
    // ];

    // const flags = {};
    // flagCodes.forEach(cc => {
        // const name = 'flag_' + cc;
        // flags[name] = { src: `/static/flags/${cc}.svg`, code: cc };
    // });

    // cats['flags'] = flags;

    const extras = {
        'spark': '‚ú®','zap':'‚ö°','cloud_rain':'üåßÔ∏è','crescent':'üåô','umbrella':'‚òÇÔ∏è','phone':'üì±','laptop':'üíª','camera':'üì∑','gift':'üéÅ','medal':'üèÖ','trophy':'üèÜ','music':'üéµ','microphone':'üé§','movie':'üé¨','ball':'‚öΩ','basketball':'üèÄ','soccer':'‚öΩ','guitar':'üé∏','pencil':'‚úèÔ∏è','book':'üìö','lightbulb':'üí°','lock':'üîí','key':'üîë','money':'üí∞','credit_card':'üí≥','hourglass':'‚è≥','calendar':'üìÖ','map':'üó∫Ô∏è','compass':'üß≠','anchor':'‚öì','leaf':'üçÉ','cactus':'üåµ','herb':'üåø'
    };

    cats['extras'] = extras;

    return cats;
})();


const STICKER_MAP = {};
Object.keys(STICKER_CATEGORIES).forEach(cat => {
    Object.keys(STICKER_CATEGORIES[cat]).forEach(name => {
        STICKER_MAP[name] = STICKER_CATEGORIES[cat][name]; 
    });
});

const CATEGORY_LABELS = {{ sticker_category_labels_json|safe }};
function getCategoryLabel(cat) {
    return CATEGORY_LABELS[cat] || cat;
}

function codeToEmoji(code) {
    try {
        return code.toUpperCase().split('').map(c => String.fromCodePoint(0x1F1E6 - 65 + c.charCodeAt(0))).join('');
    } catch (e) { return 'üè≥Ô∏è'; }
}

// function flagImageError(imgEl, code) {
//     try {
//         if (imgEl.dataset.tried === 'png') {
//             const span = document.createElement('span');
//             span.textContent = codeToEmoji(code);
//             imgEl.replaceWith(span);
//         } else {
//             imgEl.dataset.tried = 'png';
//             imgEl.src = `/static/flags/${code}.png`;
//         }
//     } catch(e) {
//         try { imgEl.replaceWith(document.createTextNode(codeToEmoji(code))); } catch(_) {}
//     }
// } 

// const flagImageCache = new Map();

// function getOrCreateFlagImage(code) {
    // const cacheKey = 'flag_' + code;
    // 
    // if (flagImageCache.has(cacheKey)) {
        // return flagImageCache.get(cacheKey).cloneNode(true); 
    // }
// 
    // const img = document.createElement('img');
    // img.src = `/static/flags/${code}.svg`;
    // img.alt = code.toUpperCase();
    // img.className = 'sticker-img';
    // img.draggable = false;
    // img.onerror = () => flagImageError(img, code);
// 
    // flagImageCache.set(cacheKey, img);
// 
    // return img.cloneNode(true); 
// }

function renderSticker(name, size = 'normal') {
    const v = STICKER_MAP[name];
    if (!v) return '‚ùì';

    // if (typeof v === 'object' && v.src && v.code) {
        // const img = getOrCreateFlagImage(v.code);
        // if (size === 'large') {
            // img.className = 'sticker-img sticker-img-large';
        // }
        // return img.outerHTML;
    // }

    const text = String(v);
    if (size === 'large') {
        return `<span class="sticker-emoji sticker-emoji-large">${text}</span>`;
    }
    return `<span class="sticker-emoji">${text}</span>`;
}

function displayMessage(text, sender, isSent, messageId = null) {
    if (typeof text === 'object' && text !== null) {
        const msgObj = text;
        sender = msgObj.sender || sender;
        isSent = (msgObj.is_sent !== undefined) ? msgObj.is_sent : isSent;
        messageId = messageId || msgObj.id || msgObj.message_id || null;
        text = msgObj.text || '';
        var msgTimestamp = msgObj.timestamp || null;
        var msgEditedAt = msgObj.edited_at || null;
        var msgEdited = msgObj.edited || false;
    }

    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) {
        console.error('Chat messages container not found');
        return;
    }

    if (messageId && document.querySelector(`[data-message-id="${messageId}"]`)) {
        console.debug('Message already exists, skipping duplicate', messageId);
        return;
    }

    if (typeof text !== 'string' || !text.trim()) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    if (messageId) messageDiv.dataset.messageId = messageId;
    
    if (msgEdited) {
        messageDiv.dataset.edited = 'true';
        if (msgEditedAt) {
            messageDiv.dataset.editedAt = msgEditedAt;
        }
    }

    messageDiv.dataset.tokenText = String(text || '').trim();

    const textDiv = document.createElement('div');

    const stickerMatch = String(text).trim().match(/^\[sticker:([a-zA-Z0-9_-]+)\]$/);

    if (stickerMatch) {
        const stickerName = stickerMatch[1];
        messageDiv.dataset.mediaType = 'sticker';
        messageDiv.dataset.stickerName = stickerName;
        textDiv.innerHTML = `<div class="sticker-render large" data-sticker="${stickerName}" style="cursor:pointer; text-align:center;" onclick="sendSticker('${stickerName}')">${renderSticker(stickerName, 'large')}</div>`;
    } else {
        let processedText = processMentionsStrict(text);
        processedText = renderStickersInline(processedText);
        textDiv.innerHTML = processedText;
    }

    messageDiv.appendChild(textDiv);

    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.style.fontSize = '11px';
    timeDiv.style.color = '#999';
    timeDiv.style.marginTop = '4px';
    timeDiv.style.textAlign = isSent ? 'right' : 'left';

    var ts = msgTimestamp ? new Date(msgTimestamp) : new Date();
    const isoTs = (msgTimestamp ? new Date(msgTimestamp).toISOString() : new Date().toISOString());
    
    const format24Hour = localStorage.getItem('hourFormat') === '24';
    const lang = "{{ user.language|default:'English' }}";
    const now = new Date();
    const isToday = ts.toDateString() === now.toDateString();

    if (!isToday) {
        const day = String(ts.getDate()).padStart(2, '0');
        const month = String(ts.getMonth() + 1).padStart(2, '0');
        const year = ts.getFullYear();
        
        let timeString;
        if (format24Hour) {
            const hours = String(ts.getHours()).padStart(2, '0');
            const minutes = String(ts.getMinutes()).padStart(2, '0');
            timeString = `${hours}:${minutes}`;
        } else {
            timeString = ts.toLocaleTimeString(lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? 'uk-UA' : 'en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }
        
        timeDiv.textContent = `${day}.${month}.${year} ${timeString}`;
    } else {
        if (format24Hour) {
            if (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
                timeDiv.textContent = ts.toLocaleTimeString('uk-UA', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                }).replace(/^24:/, '00:');
            } else {
                timeDiv.textContent = ts.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                }).replace(/^24:/, '00:');
            }
        } else {
            if (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
                timeDiv.textContent = ts.toLocaleTimeString('uk-UA', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            } else {
                timeDiv.textContent = ts.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            }
        }
    }

    timeDiv.dataset.timestamp = isoTs;

    if (msgEdited || messageDiv.dataset.edited === 'true') {
        const editedSpan = document.createElement('span');
        editedSpan.className = 'message-edited';
        editedSpan.textContent = (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') ? ' (–∑–º—ñ–Ω–µ–Ω–æ)' : ' (edited)';
        editedSpan.style.cssText = 'font-size:10px;color:#888;margin-left:6px;';
        timeDiv.appendChild(editedSpan);
    }

    messageDiv.appendChild(timeDiv);
    messageDiv.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showMessageContextMenu(e.clientX, e.clientY, messageDiv, messageId);
    });

    const spacer = messagesContainer.querySelector('.chat-messages-spacer');
    if (spacer) {
        messagesContainer.insertBefore(messageDiv, spacer);
    } else {
        messagesContainer.appendChild(messageDiv);
    }
    try { scrollIfAtBottom(messagesContainer); } catch(e) {}

    addMentionEventListeners(messageDiv);
}

function processProfileDescription() {
    const descriptionElements = document.querySelectorAll('.profile-preview-value, .other-profile-description, #my-profile-description');
    
    descriptionElements.forEach(element => {
        const originalText = element.innerHTML;
    let cleanedText = originalText;

    cleanedText = cleanedText.replace(/data-username="@?Bin"/gi, 'data-username="@Bin_bot"');
    cleanedText = cleanedText.replace(/data-username='@?Bin'/gi, "data-username='@Bin_bot'");
    cleanedText = cleanedText.replace(/>@?Bin<\/span>/gi, '>@Bin_bot</span>');
    cleanedText = cleanedText.replace(/@bin\b/gi, '@Bin_bot');

    if (/<[^>]*>/.test(cleanedText)) {
        element.innerHTML = cleanedText;
    } else {
        element.innerHTML = processMentionsStrict(cleanedText);
    }

    addMentionEventListeners(element);
    });
}

function isAtBottom(container, threshold = 5) {
    return (container.scrollHeight - container.scrollTop - container.clientHeight) <= threshold;
}

function toggleScrollButtonVisibility(messagesContainer) {
    const btn = document.getElementById('chat-scroll-bottom-btn');
    if (!btn || !messagesContainer) return;
    if (isAtBottom(messagesContainer)) {
        btn.style.display = 'none';
    } else {
        btn.style.display = 'block';
    }
}

function scrollIfAtBottom(container, force=false) {
    try {
        if (!container) return;
        if (document.activeElement && document.activeElement.id === 'chat-input' && !force) return;
        const btn = document.getElementById('chat-scroll-bottom-btn');
        if (force || isAtBottom(container)) {
            container.scrollTop = container.scrollHeight;
            if (btn) btn.style.display = 'none';
        } else {
            if (btn) btn.style.display = 'block';
        }
    } catch(e) {}
}

function preserveScrollPosition(container, fn) {
    try {
        if (!container) { fn(); return; }
        const wasAtBottom = isAtBottom(container);
        const prevTop = container.scrollTop;
        const prevHeight = container.scrollHeight;
        fn();
        const newHeight = container.scrollHeight;
        if (wasAtBottom) {
            container.scrollTop = container.scrollHeight;
        } else {
            container.scrollTop = Math.max(0, Math.min(prevTop, container.scrollHeight - container.clientHeight));
        }
    } catch (e) { console.error('preserveScrollPosition error', e); }
}

document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('chat-messages');
    const scrollBtn = document.getElementById('chat-scroll-bottom-btn');
    const stickerBtn = document.getElementById('sticker-btn');
    const stickerPanel = document.getElementById('sticker-panel');
    const stickerClose = document.getElementById('sticker-close');

    function scrollToBottom(force=false) {
        try {
            if (!messagesContainer) return;
            scrollIfAtBottom(messagesContainer, force);
        } catch(e) {}
    }

    if (messagesContainer) {
        messagesContainer.addEventListener('scroll', function(){
            try { 
                toggleScrollButtonVisibility(messagesContainer);
                try { if (currentChatUser) localStorage.setItem('chat_scroll_' + currentChatUser, messagesContainer.scrollTop); } catch(e) {}
            } catch(e) {}
        });

        try {
            const obs = new MutationObserver((mutations) => {
                try {
                    if (document.activeElement && document.activeElement.id === 'chat-input') return;

                    scrollIfAtBottom(messagesContainer);
                } catch(e) {}
            });
            obs.observe(messagesContainer, { childList: true, subtree: true });
        } catch(e) {}
    }

    if (scrollBtn) {
        scrollBtn.addEventListener('click', function(){
            scrollToBottom(true);
        });
    }

    function closeStickers() { if (stickerPanel) stickerPanel.style.transform = 'translateX(100%)'; }
    function openStickers() { if (stickerPanel) stickerPanel.style.transform = 'translateX(0)'; }

    if (stickerBtn) {
        stickerBtn.addEventListener('click', function(e){
            e.stopPropagation();
            if (stickerPanel && stickerPanel.style.transform === 'translateX(0)') closeStickers(); else openStickers();
        });
    }
    if (stickerClose) stickerClose.addEventListener('click', closeStickers);

    function addDimOverlay() {
        try {
            const chat = document.querySelector('.chat-container');
            if (chat) chat.classList.add('dimmed');
        } catch(e) {}
    }

    function removeDimOverlay() {
        try {
            const chat = document.querySelector('.chat-container');
            if (chat) chat.classList.remove('dimmed');
        } catch(e) {}
    }

    function closeStickers() { if (stickerPanel) { stickerPanel.style.transform = 'translateX(100%)'; } }
    function openStickers() { if (stickerPanel) { stickerPanel.style.transform = 'translateX(0)'; } }

    try { buildStickerPanels(); } catch(e) { console.error('buildStickerPanels failed', e); }

    document.addEventListener('click', function(e){
        const item = e.target.closest('.sticker-item');
        if (item) {
            const name = item.getAttribute('data-sticker');
            const input = document.querySelector('#chat-input:not([disabled])');
            if (input) {
                insertStickerAtCaret(name);
            }
        }
        if (stickerPanel && !stickerPanel.contains(e.target) && !e.target.matches('#sticker-btn')) {
            stickerPanel.style.transform = 'translateX(100%)';
        }
    });
});

(function() {
    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('chat-scroll-bottom-btn');
        const messagesContainer = document.getElementById('chat-messages');
        if (!btn || !messagesContainer) return;

        btn.addEventListener('click', function() {
            try { scrollIfAtBottom(messagesContainer, true); } catch(e) {}
            btn.style.display = 'none';
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'ArrowDown') {
                if (messagesContainer) {
                    try { scrollIfAtBottom(messagesContainer, true); } catch(e) {}
                }
            }
        });

        const input = document.getElementById('chat-input');
        if (input) {
            input.addEventListener('input', function() {
                try {
                    if (currentChatUser) localStorage.setItem('chat_input_' + currentChatUser, contentEditableToTokenText(input));
                } catch(e) {}
            });

            input.addEventListener('focus', function() {
                try {
                    if (currentChatUser) {
                        const v = localStorage.getItem('chat_input_' + currentChatUser) || '';
                        const current = contentEditableToTokenText(input);
                        if (v !== current) tokenTextToContent(input, v);
                    }
                } catch(e) {}
            });
        }

    });
})();

const editPanelStyles = `
.edit-panel {
    animation: slideDown 0.2s ease;
    transition: all 0.2s ease;
}

@keyframes slideDown {
    from { transform: translateY(-10px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.cancel-edit-btn {
    transition: all 0.2s ease !important;
}

.cancel-edit-btn:hover {
    color: #000 !important;
    transform: scale(1.1) !important;
}

.cancel-edit-btn:active {
    transform: scale(0.95) !important;
}
`;

const styleEl = document.createElement('style');
styleEl.textContent = editPanelStyles;
document.head.appendChild(styleEl);

function showMessageContextMenu(x, y, messageDiv, messageId) {
    const existing = document.querySelector('.message-context-menu');
    if (existing) existing.remove();

    const lang = "{{ user.language|default:'English' }}";
    const editText    = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏' : 'Edit';
    const deleteText  = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–í–∏–¥–∞–ª–∏—Ç–∏'   : 'Delete';
    const copyText    = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ö–æ–ø—ñ—é–≤–∞—Ç–∏'  : 'Copy';
    const confirmDeleteText = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?' : 'Delete this message?';

    const isSent    = messageDiv.classList.contains('sent');
    const isNotes   = currentChatUser === "{{ user.username }}";
    const isBinChat = isBinUser(currentChatUser);

    const menu = document.createElement('div');
    menu.className = 'message-context-menu';
    menu.style.cssText = `position:fixed;left:${x}px;top:${y}px;z-index:10050;background:#fff;border:1px solid #ddd;padding:6px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.15);min-width:40px;`;

    const copyBtn = document.createElement('button');
    copyBtn.textContent = copyText;
    copyBtn.style.cssText = 'display:block;width:100%;padding:8px 10px;border:none;background:transparent;cursor:pointer;text-align:left;color:#000;';
    copyBtn.onclick = e => {
        e.stopPropagation();
        let text = messageDiv.dataset.tokenText || '';

        const sticker = messageDiv.querySelector('.sticker-render');
        if (sticker && sticker.dataset.sticker) {
            text = `[sticker:${sticker.dataset.sticker}]`;
        } else if (!text) {
            const tEl = messageDiv.querySelector('div:not(.message-time)');
            text = tEl ? tEl.textContent.trim() : '';
        }

        if (text) {
            navigator.clipboard.writeText(text).then(() => {
                showCopyNotification(lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!' : 'Copied!');
            }).catch(() => {
                showCopyNotification(lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏' : 'Copy failed');
            });
        }
        menu.remove();
    };
    menu.appendChild(copyBtn);

    if (isSent && !isBinChat) {
        const editBtn = document.createElement('button');
        editBtn.textContent = editText;
        editBtn.style.cssText = 'display:block;width:100%;padding:8px 10px;border:none;background:transparent;cursor:pointer;text-align:left;color:#000;';
        editBtn.onclick = e => {
            e.stopPropagation();
            const eid = messageId || messageDiv.dataset.messageId || messageDiv.id;
            startEditMessage(messageDiv, eid);
            menu.remove();
        };
        menu.appendChild(editBtn);
    }

    if (isSent && !isBinChat) {
        const delBtn = document.createElement('button');
        delBtn.textContent = deleteText;
        delBtn.style.cssText = 'display:block;width:100%;padding:8px 10px;border:none;background:transparent;cursor:pointer;text-align:left;color:#c82333;';
        delBtn.onclick = e => {
            e.stopPropagation();
            if (!confirm(confirmDeleteText)) return;

            const mid = messageId || messageDiv.dataset.messageId;
            if (mid && !String(mid).startsWith('temp-')) {
                deleteMessage(mid, messageDiv);
            } else {
                messageDiv.remove();
            }
            menu.remove();
        };
        menu.appendChild(delBtn);
    }

    if (!menu.hasChildNodes()) return;

    document.body.appendChild(menu);

    const menuWidth = menu.offsetWidth;
    menu.style.left = (x - menuWidth) + 'px';

    setTimeout(() => {
        document.addEventListener('click', function close(ev) {
            if (!menu.contains(ev.target)) {
                menu.remove();
                document.removeEventListener('click', close);
            }
        });
    }, 0);
}

function showEditPanel(messageText) {
    const oldPanel = document.querySelector('.edit-panel');
    if (oldPanel) oldPanel.remove();
    
    const panel = document.createElement('div');
    panel.className = 'edit-panel';
    panel.style.cssText = `
        position: relative;
        background: #f0f0f0;
        color: #333;
        padding: 12px 15px;
        margin: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
        border-bottom: 1px solid #ddd;
        width: 100%;
        box-sizing: border-box;
    `;
    
    const lang = "{{ user.language|default:'English' }}";
    const truncatedText = messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText;
    
    panel.innerHTML = `
        <button type="button" class="cancel-edit-btn" 
                style="background: none; border: none; color: #666; 
                       cursor: pointer; font-size: 18px; width: 24px; 
                       height: 24px; display: flex; align-items: center; 
                       justify-content: center; flex-shrink: 0; padding: 0;">
            ‚úï
        </button>
        <div style="display: flex; align-items: center; gap: 10px; flex: 1; margin-left: 10px;">
            <div style="font-size: 13px; color: #666; white-space: nowrap;">
                ${lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è:' : 'Editing:'}
            </div>
            <div style="font-size: 14px; font-weight: 500; overflow: hidden; 
                       text-overflow: ellipsis; white-space: nowrap; color: #333;">
                ${truncatedText}
            </div>
        </div>
    `;
    
    const chatInputContainer = document.querySelector('.chat-input-container');
    if (chatInputContainer) {
        const chatContainer = document.querySelector('.chat-container');
        if (chatContainer) {
            chatContainer.insertBefore(panel, chatInputContainer);
        }
    }
    
    const cancelBtn = panel.querySelector('.cancel-edit-btn');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            cancelEditMode();
        });
        
        cancelBtn.addEventListener('mouseenter', function() {
            this.style.color = '#000';
            this.style.transform = 'scale(1.1)';
        });
        
        cancelBtn.addEventListener('mouseleave', function() {
            this.style.color = '#666';
            this.style.transform = 'scale(1)';
        });
    }
    
    return panel;
}

function startEditMessage(messageDiv, messageId) {
    const textDiv = messageDiv.querySelector('div');
    if (!textDiv) return;
    
    editingMessageId = messageId || messageDiv.dataset.messageId || messageDiv.id;
    editingMessageOriginalText = messageDiv.dataset.tokenText || textDiv.textContent || '';
    
    const input = document.getElementById('chat-input');
    if (!input) return;
    
    if (!contentEditableToTokenText(input).trim()) {
        tokenTextToContent(input, editingMessageOriginalText);
    }
    input.focus();

    isEditingMode = true;
    
    showEditPanel(editingMessageOriginalText);
    
    const sendBtn = document.querySelector('.chat-send-btn');
    if (sendBtn) {
        sendBtn.textContent = "{{ user.language|default:'English' }}" === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ó–±–µ—Ä–µ–≥—Ç–∏' : 'Save';
        sendBtn.classList.add('editing-mode');
    }
}

function cancelEditMode() {
    const sendBtn = document.querySelector('.chat-send-btn');
    if (sendBtn) {
        sendBtn.textContent = "{{ user.language|default:'English' }}" === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏' : 'Send';
        sendBtn.classList.remove('editing-mode');
    }
    
    const panel = document.querySelector('.edit-panel');
    if (panel) panel.remove();
    
    editingMessageId = null;
    editingMessageOriginalText = '';
    isEditingMode = false;
}

function finishEditing() {
    const input = document.getElementById('chat-input');
    const sendBtn = document.querySelector('.chat-send-btn');
    const id = editingMessageId;
    const currentText = contentEditableToTokenText(input).trim();
    
    if (!currentText || currentText === editingMessageOriginalText) {
        cancelEditMode();
        return;
    }
    
    if (!id) {
        cancelEditMode();
        return;
    }

    const editPanel = document.querySelector('.edit-panel');
        if (editPanel) {
            editPanel.remove();
        }   

        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.innerHTML = '';
            chatInput.focus();
        }   

        const sendButton = document.querySelector('.send-btn');
        if (sendButton) {
            sendButton.classList.remove('editing-mode');
        }
    
    console.log('Editing message:', { id, currentText });
    
    if (String(id).startsWith('temp-')) {
        const msgEl = document.getElementById(id);
        if (msgEl) {
            msgEl.dataset.tokenText = currentText;
            const stickerOnly = String(currentText).trim().match(/^\[sticker:([a-zA-Z0-9_-]+)\]$/);
            const textDiv = msgEl.querySelector('div');
            if (stickerOnly) {
                const stickerName = stickerOnly[1];
                msgEl.dataset.mediaType = 'sticker';
                msgEl.dataset.stickerName = stickerName;
                if (textDiv) textDiv.innerHTML = `<div class="sticker-render large" data-sticker="${stickerName}" style="cursor:pointer; text-align:center;" onclick="sendSticker('${stickerName}')">${renderSticker(stickerName, 'large')}</div>`;
            } else if (textDiv) {
                msgEl.dataset.mediaType = msgEl.dataset.mediaType ? msgEl.dataset.mediaType : 'text';
                textDiv.innerHTML = renderStickersInline(processMentionsStrict(currentText));
            }
            const timeDiv = msgEl.querySelector('.message-time');
            if (timeDiv) {
                timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if (!msgEl.querySelector('.message-edited')) {
                    const edited = document.createElement('span');
                    edited.className = 'message-edited';
                    edited.textContent = ("{{ user.language|default:'English' }}" === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') ? ' (–∑–º—ñ–Ω–µ–Ω–æ)' : ' (edited)';
                    edited.style.cssText = 'font-size:10px;color:#888;margin-left:6px;';
                    timeDiv.appendChild(edited);
                }
            }
            input.innerHTML = '';
        }
        cancelEditMode();
        return;
    }
    
    editMessage(id, currentText).then(success => {
        if (success) {
            const input = document.getElementById('chat-input');
            if (input) input.innerHTML = '';
            
            cancelEditMode();
        } else {
            cancelEditMode();
        }
    });
}


function editMessage(messageId, newText) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrfToken) { 
        alert('CSRF token missing'); 
        return Promise.resolve(false); 
    }

    return fetch('/edit-message/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json', 
            'X-CSRFToken': csrfToken, 
            'X-Requested-With': 'XMLHttpRequest' 
        },
        body: JSON.stringify({ 
            message_id: messageId, 
            text: newText 
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const msgEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (msgEl) {
                msgEl.dataset.tokenText = newText;
                msgEl.dataset.edited = 'true';
                msgEl.dataset.editedAt = data.timestamp || new Date().toISOString();
                
                const textDiv = msgEl.querySelector('div');

                const stickerOnly = String(newText).trim().match(/^\[sticker:([a-zA-Z0-9_-]+)\]$/);
                if (stickerOnly) {
                    const stickerName = stickerOnly[1];
                    msgEl.dataset.mediaType = 'sticker';
                    msgEl.dataset.stickerName = stickerName;
                    if (textDiv) textDiv.innerHTML = `<div class="sticker-render large" data-sticker="${stickerName}" style="cursor:pointer; text-align:center;" onclick="sendSticker('${stickerName}')">${renderSticker(stickerName, 'large')}</div>`;
                } else if (textDiv) {
                    msgEl.dataset.mediaType = msgEl.dataset.mediaType ? msgEl.dataset.mediaType : 'text';
                    textDiv.innerHTML = renderStickersInline(processMentionsStrict(newText));
                }

                const timeDiv = msgEl.querySelector('.message-time');
                if (timeDiv) {
                    const timestamp = data.timestamp || new Date().toISOString();
                    timeDiv.textContent = formatChatTime(timestamp);
                    timeDiv.dataset.timestamp = timestamp;
                    
                    if (!msgEl.querySelector('.message-edited')) {
                        const edited = document.createElement('span');
                        edited.className = 'message-edited';
                        edited.textContent = (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') ? ' (–∑–º—ñ–Ω–µ–Ω–æ)' : ' (edited)';
                        edited.style.cssText = 'font-size:10px;color:#888;margin-left:6px;';
                        timeDiv.appendChild(edited);
                    }
                }
                
                localStorage.setItem(`message_${messageId}_edited`, 'true');
                localStorage.setItem(`message_${messageId}_editedAt`, timestamp);
            }
            return true;
        } else {
            alert('Failed to edit message: ' + (data.error || 'Unknown'));
            return false;
        }
    })
    .catch(e => { 
        console.error('Edit message error:', e); 
        return false; 
    });
}

function deleteMessage(messageId, messageDiv) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrfToken) { alert('CSRF token missing'); return; }

    fetch('/delete-message/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify({ message_id: messageId })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            if (messageDiv) messageDiv.remove();
        } else {
            alert('Failed to delete message: ' + (data.error || 'Unknown'));
        }
    }).catch(e => console.error('Delete message error:', e));
}

function closeProfileModalsOnly() {
    const profileModals = [
        'menu-toggle', 'profile-toggle', 'setting-toggle', 'form1-toggle', 
        'form2-toggle', 'color_theme-toggle', 'wallet-toggle', 'check-subscription-toggle',
        'subscribe-month-toggle', 'subscribe-year-toggle', 'deposit-toggle', 'add_card-toggle',
        'bin_mouth-toggle', 'bin_premium_mouth-toggle', 'bin_years-toggle', 'bin_premium_years-toggle',
        'other-profile-toggle'
    ];
    
    profileModals.forEach(id => {
        const cb = document.getElementById(id);
        if (cb) cb.checked = false;
    });
}

let _lastModalClose = 0;

document.addEventListener('mousedown', (event) => {
    const now = Date.now();
    if (now - (_lastModalClose || 0) < 300) return;

    const forms = [
        { form: '.side-menu', toggle: '#menu-toggle' },
        { form: '.wallet-form', toggle: '#wallet-toggle' },
        { form: '.profile-form', toggle: '#profile-toggle' },
        { form: '.setting-form', toggle: '#setting-toggle' },
        { form: '.chat-settings-form', toggle: '#chat-settings-toggle' },
        { form: '.wallpaper-form', toggle: '#wallpaper-toggle' },
        { form: '.form1', toggle: '#form1-toggle' },
        { form: '.form2', toggle: '#form2-toggle' },
        { form: '.deposit-form', toggle: '#deposit-toggle' },
        { form: '.add_card-form', toggle: '#add_card-toggle' },
        { form: '.other-profile-form', toggle: '#other-profile-toggle' },
        { form: '.security-form', toggle: '#security-toggle' }
    ];

    let clickedInsideAnyForm = false;

    forms.forEach(({form, toggle}) => {
        const formElement = document.querySelector(form);
        const toggleElement = document.getElementById(toggle.replace('#', ''));
        
        if (formElement && toggleElement && toggleElement.checked) {
            if (formElement.contains(event.target) || event.target.closest(form)) {
                clickedInsideAnyForm = true;
            }
        }
    });

    if (!clickedInsideAnyForm) {
        _lastModalClose = now;
        forms.forEach(({toggle}) => {
            const toggleElement = document.getElementById(toggle.replace('#', ''));
            if (toggleElement && toggleElement.checked) {
                toggleElement.checked = false;
            }
        });
    }
});

function displayNotes(notes) {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    const wasAtBottom = isAtBottom(container);
    const prevScrollTop = container.scrollTop;
    const prevScrollHeight = container.scrollHeight;

    const existingKeys = new Set();
    container.querySelectorAll('.message.sent').forEach(msg => {
        const ts = msg.querySelector('.message-time')?.dataset.timestamp;
        const text = msg.dataset.tokenText || '';
        const fileUrl = msg.dataset.fileUrl || '';
        if (ts) {
            existingKeys.add(`${ts}|${text}|${fileUrl}`);
        }
    });

    const newNotes = notes.filter(note => {
        const key = `${note.timestamp || ''}|${note.text || ''}|${note.file_url || ''}`;
        return !existingKeys.has(key);
    });

    if (newNotes.length === 0) {
        if (wasAtBottom) container.scrollTop = container.scrollHeight;
        return;
    }

    const spacer = container.querySelector('.chat-messages-spacer') ||
                   (function(){
                       const sp = document.createElement('div');
                       sp.className = 'chat-messages-spacer';
                       container.appendChild(sp);
                       return sp;
                   })();

    newNotes.forEach(note => {
        if (note.file_url) {
            if (isVideoModalOpen && openVideoUrl === note.file_url) {
                console.log("–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –≤–∏–¥–µ–æ –≤ –∑–∞–º–µ—Ç–∫–∞—Ö");
                return;
            }
            displayFileMessage({
                file_url: note.file_url,
                file_name: note.file_name,
                file_type: note.file_type,
                text: note.text,
                file_size: note.file_size,
                timestamp: note.timestamp
            }, true);
        } else {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            messageDiv.dataset.tokenText = note.text || '';

            const textDiv = document.createElement('div');
            const processed = processMentionsStrict(note.text || '');
            textDiv.innerHTML = renderStickersInline(processed);

            messageDiv.appendChild(textDiv);

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.dataset.timestamp = note.timestamp || new Date().toISOString();
            timeDiv.textContent = formatChatTime(timeDiv.dataset.timestamp);

            timeDiv.style.fontSize    = '11px';
            timeDiv.style.color       = '#999';
            timeDiv.style.marginTop   = '4px';
            timeDiv.style.textAlign   = 'right';

            messageDiv.appendChild(timeDiv);

            messageDiv.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showMessageContextMenu(e.clientX, e.clientY, messageDiv);
            });

            container.insertBefore(messageDiv, spacer);

            addMentionEventListeners(messageDiv);
        }
    });

    if (wasAtBottom) {
        container.scrollTop = container.scrollHeight;
    } else {
        const heightDiff = container.scrollHeight - prevScrollHeight;
        container.scrollTop = prevScrollTop + heightDiff;
    }

    const scrollBtn = document.getElementById('chat-scroll-bottom-btn');
    if (scrollBtn) {
        scrollBtn.style.display = isAtBottom(container) ? 'none' : 'block';
    }
}

function getSenderDisplayName(isSent, sender) {
    const lang = "{{ user.language|default:'English' }}";
    const currentUser = "{{ user.username }}";
    
    if (isSent) {
        return lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–í—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è' : '–Üs sent';
    } else {
        return sender;
    }
}

function renderStickersInline(text) {
    if (!text) return text;
    return text.replace(/\[sticker:([a-zA-Z0-9_-]+)\]/g, function(_, name){
        const html = renderSticker(name);
        return `<span class="inline-sticker" contenteditable="false" data-name="${name}">${html}</span>`;
    });
} 

function buildStickerPanels() {
    const lang = "{{ user.language|default:'English' }}";
    const titleText = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–°–º–∞–π–ª–∏–∫–∏' : 'Stickers';
    document.querySelectorAll('#sticker-panel-title').forEach(el => { el.textContent = titleText; });

    document.querySelectorAll('#sticker-list').forEach(list => {
        list.innerHTML = '';

        const nav = document.createElement('div');
        nav.id = 'sticker-category-nav';
        nav.style.cssText = 'display:flex; gap:8px; padding:8px; overflow-x:auto; position:sticky; top:0; background:var(--surface); z-index:100; border-bottom:1px solid rgba(0,0,0,0.04);';
        list.appendChild(nav);

        const buttonMap = {};

        nav.addEventListener('wheel', (e) => {
            e.preventDefault();
            nav.scrollLeft += (e.deltaY > 0 ? 50 : -50);
        });

        Object.keys(STICKER_CATEGORIES).forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'sticker-cat-btn';
            btn.dataset.cat = cat;
            btn.textContent = getCategoryLabel(cat);
            btn.style.cssText = 'padding:6px 10px; border-radius:8px; border:none; background:transparent; cursor:pointer; white-space:nowrap; color:var(--text);';
            btn.addEventListener('click', function(){
                Object.values(buttonMap).forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const target = document.getElementById('sticker-cat-' + this.dataset.cat);
                if (target) target.scrollIntoView({behavior:'smooth', block:'start'});
            });
            nav.appendChild(btn);
            buttonMap[cat] = btn;

            const catWrap = document.createElement('div');
            catWrap.className = 'sticker-category';
            catWrap.id = 'sticker-cat-' + cat;
            catWrap.style.cssText = 'display:block; width:100%; clear:both; margin-bottom:12px;';
            const header = document.createElement('div');
            header.className = 'sticker-category-header';
            header.textContent = getCategoryLabel(cat);
            header.style.cssText = 'font-weight:700; margin:8px 0 4px;';
            catWrap.appendChild(header);

            const row = document.createElement('div');
            row.className = 'sticker-row';
            row.style.cssText = 'display:flex; gap:8px; flex-wrap:wrap; padding-bottom:12px;';

                const names = Object.keys(STICKER_CATEGORIES[cat] || {});
                names.forEach(nm => {
                    try {
                        const v = STICKER_CATEGORIES[cat][nm];
                        if (v && typeof v === 'object' && v.src) {
                            const img = new Image();
                            img.src = v.src;
                        }
                    } catch (e) {}
                });

                names.forEach(name => {
                    const div = document.createElement('div');
                    div.className = 'sticker-item';
                    div.dataset.sticker = name;
                    div.style.cssText = 'width:56px; height:56px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#fff,#f7f7f7); font-size:26px; cursor:pointer; padding:6px; overflow:hidden;';
                    div.innerHTML = renderSticker(name);
                    div.title = name;
                    row.appendChild(div);
                });

            catWrap.appendChild(row);
            list.appendChild(catWrap);
        });

        try {
            const firstCat = Object.keys(STICKER_CATEGORIES)[0];
            if (firstCat && buttonMap[firstCat]) buttonMap[firstCat].classList.add('active');
            if (buttonMap['extras']) buttonMap['extras'].style.color = '#000';
        } catch(e) {}

        try {
            const headers = list.querySelectorAll('.sticker-category-header');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const catId = entry.target.parentNode.id.replace('sticker-cat-','');
                    const btn = buttonMap[catId];
                    if (!btn) return;
                    if (entry.isIntersecting) {
                        document.querySelectorAll('.sticker-cat-btn.active').forEach(b=>b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                });
            }, { root: list, threshold: 0.5 });
            headers.forEach(h => observer.observe(h));
        } catch(e) {}

    });

    const stickerBtn = document.getElementById('sticker-btn');
    if (stickerBtn) stickerBtn.title = "{{ user.language|default:'English' }}" === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–°–º–∞–π–ª–∏–∫–∏' : 'Stickers';
    document.querySelectorAll('#sticker-close').forEach(btn => { btn.title = "{{ user.language|default:'English' }}" === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ó–∞–∫—Ä–∏—Ç–∏' : 'Close'; });
}  


function contentEditableToTokenText(el) {
    if (!el) return '';
    let out = '';
    el.childNodes.forEach(node => {
        if (node.nodeType === Node.TEXT_NODE) out += node.nodeValue;
        else if (node.nodeType === Node.ELEMENT_NODE) {
            if (node.classList && node.classList.contains('inline-sticker') && node.dataset.name) {
                out += `[sticker:${node.dataset.name}]`;
            } else if (node.tagName === 'BR') {
                out += '\n';
            } else {
                out += node.innerText || node.textContent || '';
            }
        }
    });
    return out;
}

function getCaretCharOffsetWithin(element) {
    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) return null;
    const range = sel.getRangeAt(0);
    if (!element.contains(range.endContainer)) return null;
    const preCaretRange = range.cloneRange();
    preCaretRange.selectNodeContents(element);
    preCaretRange.setEnd(range.endContainer, range.endOffset);
    return preCaretRange.toString().length;
}

function setCaretAtCharOffset(element, chars) {
    try {
        element.focus();
        const nodeStack = [element];
        let node, found = false;
        let count = 0;
        while (nodeStack.length && !found) {
            node = nodeStack.shift();
            if (node.nodeType === Node.TEXT_NODE) {
                const nextCount = count + node.nodeValue.length;
                if (chars <= nextCount) {
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.setStart(node, Math.max(0, chars - count));
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                    found = true;
                    break;
                }
                count = nextCount;
            } else {
                for (let i = 0; i < node.childNodes.length; i++) nodeStack.push(node.childNodes[i]);
            }
        }
        if (!found) {
            const range = document.createRange();
            range.selectNodeContents(element);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
    } catch(e) {}
}

function tokenTextToContent(el, text) {
    if (!el) return;
    const caretOffset = getCaretCharOffsetWithin(el);
    el.innerHTML = '';
    const re = /\[sticker:([a-zA-Z0-9_-]+)\]/g;
    let lastIndex = 0;
    let match;
    while ((match = re.exec(text)) !== null) {
        if (match.index > lastIndex) {
            el.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
        }
        const name = match[1];
        const span = document.createElement('span');
        span.className = 'inline-sticker';
        span.contentEditable = 'false';
        span.dataset.name = name;
        span.innerHTML = renderSticker(name);
        el.appendChild(span);
        lastIndex = re.lastIndex;
    }
    if (lastIndex < text.length) {
        el.appendChild(document.createTextNode(text.slice(lastIndex)));
    }
    if (caretOffset !== null) setCaretAtCharOffset(el, caretOffset);
}

function insertStickerAtCaret(name) {
    const input = document.getElementById('chat-input');
    if (!input) return;
    input.focus();

    const caretOffset = getCaretCharOffsetWithin(input);

    const sel = window.getSelection();
    let range = sel && sel.rangeCount ? sel.getRangeAt(0) : null;
    if (!range || !input.contains(range.commonAncestorContainer)) {
        range = document.createRange();
        range.selectNodeContents(input);
        range.collapse(false);
    }
    const span = document.createElement('span');
    span.className = 'inline-sticker';
    span.contentEditable = 'false';
    span.dataset.name = name;
    span.innerHTML = renderSticker(name);

    range.insertNode(span);

    const space = document.createTextNode(' ');
    span.parentNode.insertBefore(space, span.nextSibling);

    const newRange = document.createRange();
    newRange.setStartAfter(space);
    newRange.collapse(true);
    sel.removeAllRanges();
    sel.addRange(newRange);

    try { if (caretOffset !== null) setCaretAtCharOffset(input, caretOffset + 1); } catch(e) {}

    try { if (currentChatUser) localStorage.setItem('chat_input_' + currentChatUser, contentEditableToTokenText(input)); } catch(e) {}
    input.dispatchEvent(new Event('input'));
}


function openImageModal(url, filename) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.style.cssText = 'position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:3000;';
    modal.innerHTML = `<div style="max-width:95vw; max-height:95vh;"><img class="chat-image" src="${url}" data-file-name="${filename||''}" style="max-width:95vw; max-height:95vh; border-radius:6px; display:block;" alt="${filename||''}" /></div>`;
    modal.addEventListener('click', (e)=> { if (!e.target.closest('img')) modal.remove(); });
    document.body.appendChild(modal);
}

function sendSticker(name) {
    const input = document.getElementById('chat-input');
    if (!input) return;
    tokenTextToContent(input, `[sticker:${name}]`);
    input.focus();
    sendMessage();
}


document.addEventListener('click', function(e){
    const img = e.target.closest('.chat-messages img');
    if (img) {
        openImageModal(img.src, img.alt);
    }
});

document.addEventListener('click', function(e){
    const a = e.target.closest('a[href*="?profile="]');
    if (a) {
        try {
            e.preventDefault();
            const url = new URL(a.href, window.location.origin);
            const profileUsername = url.searchParams.get('profile');
            if (profileUsername) openUserProfile(profileUsername);
        } catch(err) { console.error(err); }
    }
});

document.addEventListener('click', function(e){
    const mention = e.target.closest('.message-mention, .profile-mention');
    if (mention) {
        e.preventDefault();
        const uname = (mention.dataset.username || mention.textContent || '').replace(/^@/, '');
        if (uname) openUserProfile(uname);
    }
});

let currentImageContextMenu = null;
function hideImageContextMenu() {
    if (currentImageContextMenu) { currentImageContextMenu.remove(); currentImageContextMenu = null; }
}

document.addEventListener('contextmenu', function(e){
    const img = e.target.closest('.chat-image');
    if (!img) return;
    e.preventDefault();
    hideImageContextMenu();

    const menu = document.createElement('div');
    menu.className = 'image-context-menu';
    menu.style.cssText = `position:fixed; left:${e.pageX}px; top:${e.pageY}px; z-index:4000; background:#fff; border:1px solid #ddd; padding:6px; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.16);`;

    const lang = "{{ user.language|default:'English' }}";
    const downloadText = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏' : 'Download';

    const dl = document.createElement('button');
    dl.textContent = downloadText;
    dl.style.cssText = 'display:block; padding:6px 10px; border:none; background:transparent; width:100%; text-align:left; cursor:pointer; color:#000;';
    dl.onclick = function(ev){
        ev.stopPropagation();
        hideImageContextMenu();
        const src = img.src;
        const filename = img.dataset.fileName || img.alt || 'image';
        const a = document.createElement('a');
        a.href = src;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
    };

    menu.appendChild(dl);
    document.body.appendChild(menu);
    currentImageContextMenu = menu;

    setTimeout(() => {
        document.addEventListener('click', hideImageContextMenu, { once: true });
    }, 10);
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isEditingMode) {
        cancelEditMode();
        e.preventDefault();
    }
});

function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = contentEditableToTokenText(input).trim();
    
    console.log('sendMessage called:', { 
        currentChatUser, 
        message, 
        isEditingMode, 
        editingMessageId 
    });
    
    if (!currentChatUser || !message) {
        console.log('No currentChatUser or message');
        return;
    }
    
    if (isEditingMode && editingMessageId) {
        console.log('Finishing edit mode');
        finishEditing();
        return;
    }
    
    if (isBinUser(currentChatUser)) {
        console.log('Sending to Bin');
        getVerificationCodeForBin();
        return;
    }
    
    console.log('Creating temp message');
    const tempMessageId = 'temp-' + Date.now();
    const messagesContainer = document.getElementById('chat-messages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message sent';
    messageDiv.id = tempMessageId;
    messageDiv.dataset.tokenText = message;
    
    const textDiv = document.createElement('div');
    const stickerMatchSend = String(message).trim().match(/^\[sticker:([a-zA-Z0-9_-]+)\]$/);
    if (stickerMatchSend) {
        const stickerName = stickerMatchSend[1];
        messageDiv.dataset.mediaType = 'sticker';
        messageDiv.dataset.stickerName = stickerName;
        const stickerEmoji = STICKER_MAP[stickerName] || '‚ùì';
        textDiv.innerHTML = `<div class="sticker-render" data-sticker="${stickerName}" style="font-size:44px; display:inline-block; cursor:pointer;" onclick="sendSticker('${stickerName}')">${stickerEmoji}</div>`;
    } else {
        const processedText = processMentions(message);
        textDiv.innerHTML = renderStickersInline(processedText);
    }
    messageDiv.appendChild(textDiv);
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.style.fontSize = '11px';
    timeDiv.style.color = '#999';
    timeDiv.style.marginTop = '4px';
    timeDiv.style.textAlign = 'right';
    
    const now = new Date();
    const format24Hour = localStorage.getItem('hourFormat') === '24';
    const lang = "{{ user.language|default:'English' }}";
    
    if (format24Hour) {
        if (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
            timeDiv.textContent = now.toLocaleTimeString('uk-UA', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            }).replace(/^24:/, '00:');
        } else {
            timeDiv.textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            }).replace(/^24:/, '00:');
        }
    } else {
        if (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
            timeDiv.textContent = now.toLocaleTimeString('uk-UA', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        } else {
            timeDiv.textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }
    }
    
    timeDiv.dataset.timestamp = now.toISOString();
    messageDiv.appendChild(timeDiv);
    
    const spacer = messagesContainer.querySelector('.chat-messages-spacer');
    if (spacer) {
        messagesContainer.insertBefore(messageDiv, spacer);
    } else {
        messagesContainer.appendChild(messageDiv);
    }
    
    try { 
        if (isAtBottom(messagesContainer)) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } else { 
            const btn = document.getElementById('chat-scroll-bottom-btn'); 
            if (btn) btn.style.display = 'block'; 
        } 
    } catch(e) {}
    
    addMentionEventListeners(messageDiv);
    
    input.innerHTML = '';
    try { 
        localStorage.setItem('chat_input_' + currentChatUser, ''); 
    } catch(e) {}
    
    console.log('Calling sendMessageViaAJAX');
    sendMessageViaAJAX(message, null, tempMessageId);
}


function getVerificationCodeForBin(tempMessageId = null) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        return;
    }
    
    fetch('/get-verification-code-bin/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            action: 'get_code'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            if (tempMessageId) {
                const tempMessage = document.querySelector('#' + tempMessageId);
                if (tempMessage) {
                    const timeDiv = tempMessage.querySelector('.message-time');
                    if (timeDiv) {
                        const ts = data.timestamp ? new Date(data.timestamp) : new Date();
                        timeDiv.textContent = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        if (!ts || (new Date(ts)).toDateString() !== (new Date()).toDateString()) {
                            timeDiv.textContent = (ts ? ts.toLocaleDateString() + ' ' : '') + timeDiv.textContent;
                        }
                    }
                    if (data.message_id) {
                        try { tempMessage.dataset.messageId = data.message_id; } catch(e) {}
                    }
                }
            }
            
            setTimeout(() => {
                displayMessage({
                    text: data.message || `Your verification code: ${data.code}`,
                    sender: "Bin",
                    timestamp: data.timestamp || new Date().toISOString(),
                    is_sent: false
                }, false);


                try { if (data.message_id) perChatLastMessageId['Bin'] = Math.max(perChatLastMessageId['Bin'] || 0, data.message_id); } catch(e) {}

                loadRecentContacts();
            }, 300);


            try { localStorage.removeItem('chat_input_Bin'); } catch(e) {}

        } else {
            console.error('Failed to get verification code:', data.error);
            alert('Error getting verification code: ' + data.error);
        }
    })
    .catch(error => {
        console.error('AJAX get verification code error:', error);
        alert('Error getting verification code: ' + error.message);
    });
}

function sendMessageViaAJAX(message, fileData = null, tempMessageId = null) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('CSRF token not found. Please refresh the page.');
        return;
    }
    
    if (!currentChatUser) {
        console.error('No chat user selected');
        return;
    }
    
    let url, method, body, headers;
    
    if (fileData) {
        url = '/upload-chat-file/';
        method = 'POST';
        
        const formData = new FormData();
        formData.append('text', message || '');
        formData.append('receiver', currentChatUser);
        formData.append('file', fileData.file);
        
        body = formData;
        headers = {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        };
        
    } else if (currentChatUser === "{{ user.username }}") {
        url = '/save-note/';
        method = 'POST';
        body = JSON.stringify({
            text: message
        });
        headers = {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        };
        
    } else {
        url = '/send-message/';
        method = 'POST';
        body = JSON.stringify({
            text: message,
            receiver: currentChatUser
        });
        headers = {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        };
    }
    
    console.log('Sending AJAX request:', { url, method, message, receiver: currentChatUser });
    
    fetch(url, {
        method: method,
        headers: headers,
        body: body
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('AJAX response:', data);
        
        if (data.success) {
            console.log('Message sent successfully via AJAX');
            
            loadRecentContacts();
            try { if (data.message_id && currentChatUser) perChatLastMessageId[currentChatUser] = Math.max(perChatLastMessageId[currentChatUser] || 0, data.message_id); } catch(e) {}
            

            if (tempMessageId) {
                const tempEl = document.getElementById(tempMessageId);
                if (tempEl) {
                    try {
                        tempEl.dataset.messageId = data.message_id;
                        const timeDiv = tempEl.querySelector('.message-time');
                        if (timeDiv && data.timestamp) {
                            const ts = new Date(data.timestamp);
                            const today = new Date();
                            if (ts.toDateString() === today.toDateString()) {
                                timeDiv.textContent = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            } else {
                                timeDiv.textContent = ts.toLocaleDateString() + ' ' + ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            }
                        }
                        tempEl.id = '';
                    } catch(e) { console.error('Temp update error', e); }
                }
            }


            try { localStorage.removeItem('chat_input_' + currentChatUser); } catch(e) {}

            if (!fileData) {
                console.log('Message displayed in UI');
            }
            
        } else {
            console.error('Server reported error:', data.error);
            alert('Failed to send message: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('AJAX send error:', error);
        alert('Error sending message: ' + error.message);
    });
}

function sendMessageToSelfViaAJAX(message) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        return;
    }
    
    fetch('/save-note/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            text: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Note saved:', message);
            
            saveNoteToStorage(message);
            
            loadChatMessages("{{ user.username }}");
            
            loadRecentContacts();
        } else {
            console.error('Failed to save note:', data.error);
            saveNoteToStorage(message);
            loadChatMessages("{{ user.username }}");
        }
    })
    .catch(error => {
        console.error('AJAX save note error:', error);
        saveNoteToStorage(message);
        loadChatMessages("{{ user.username }}");
    });
}

function closeChat() {
    document.getElementById('chat-toggle').checked = false;
    currentChatUser = null;

    stopChatRefresh();

    if (chatSocket) {
        chatSocket.close();
        chatSocket = null;
    }
}

function searchUsers() {
    const searchInput = document.getElementById("searchInput");
    const resultsDiv = document.getElementById("searchResults");
    const recentContactsDiv = document.getElementById("recent-contacts");
    const query = searchInput.value.trim();
    const currentUser = "{{ user.username }}";
    const lang = "{{ user.language|default:'English' }}";
    
    if (query.length === 0) {
        resultsDiv.innerHTML = "";
        if (recentContactsDiv) {
            recentContactsDiv.style.display = "block";
        }
        return;
    }

    if (recentContactsDiv) {
        recentContactsDiv.style.display = "none";
    }

    fetch(`/search-users/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(users => {
            const qNorm = query.toLowerCase().replace(/^@/, '');
            const showBot = qNorm === 'bin_bot';
            const filteredUsers = users.filter(user => {
                if (user.username === currentUser) return false;
                if (user.username === 'Bin' || user.username === 'Bin_bot') return showBot;
                return true;
            });
            
            const searchTerms = ['–∏–∑–±—Ä–∞–Ω–Ω–æ–µ', '–∑–∞–º–µ—Ç–∫–∏', 'notes', 'favorites'];
            const queryLower = query.toLowerCase();
            const shouldShowNotes = searchTerms.some(term => 
                queryLower.includes(term.toLowerCase())
            );
            
            let resultsHTML = '';
            
            if (shouldShowNotes) {
                const notesDisplayName = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ' : 'Notes';
                const notesDescription = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏' : 'Your notes';
                
                resultsHTML += `
                <div class="recent-contact" onclick="openChat('${currentUser}')">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="/static/pictures/notes.jpg" 
                             class="contact-avatar" 
                             alt="${notesDisplayName}">
                        <div class="contact-info">
                            <div class="contact-username">${notesDisplayName}</div>
                            <div class="contact-last-message" title="${notesDescription}">
                                ${notesDescription}
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            
            if (filteredUsers.length > 0) {
                resultsHTML += filteredUsers
                    .map(user => {
                        const displayName = user.username;
                        const userTag = user.your_tag || user.username;
                        const truncatedDesc = truncateText(userTag, 25);
                        
                        let avatarUrl = user.avatar_url || '/static/pictures/login.png';
                        
                        if (user.username === "Bin" || user.username === "Bin_bot") {
                            avatarUrl = '/static/pictures/bin.jpg';
                        }
                        
                        const resolvedUsername = user.username === 'Bin' ? 'Bin_bot' : user.username;
                        let onClickFunction = `openChat('${resolvedUsername}')`;
                        if (user.username === 'Bin' || user.username === 'Bin_bot') {
                            onClickFunction = `openBinLogin()`;
                        }
                        
                        return `
                        <div class="recent-contact" onclick="${onClickFunction}">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${avatarUrl}" 
                                     class="contact-avatar" 
                                     alt="${user.username}"
                                     onerror="this.onerror=null; this.src='/static/pictures/login.png'">
                                <div class="contact-info">
                                    <div class="contact-username">${displayName}</div>
                                    <div class="contact-last-message" title="${userTag}">
                                        ${truncatedDesc}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    })
                    .join("");
            }
            
            if (resultsHTML) {
                resultsDiv.innerHTML = resultsHTML;
            } else {
                const noResultsMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' 
                    ? `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ "${query}"`
                    : `No users found for "${query}"`;
                resultsDiv.innerHTML = `<div style="color:#999; padding:10px; width:250px;">${noResultsMsg}</div>`;
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            const errorMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' 
                ? '–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É'
                : 'Search error';
            resultsDiv.innerHTML = `<div style="color:red; padding:10px; width:250px;">${errorMsg}</div>`;
        });
}

document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        if (e.target.matches('.profile-preview-value a[href*="profile="]')) {
            e.preventDefault();
            const url = new URL(e.target.href);
            const profileUsername = url.searchParams.get('profile');
            if (profileUsername) {
                openUserProfile(profileUsername);
            }
        }
    });
});

function openUserProfile(username) {
    if (username === "{{ user.username }}") {
        closeProfileModals();
        document.getElementById('profile-toggle').checked = true;
        return;
    }
    
    closeProfileModals();
    
    fetch(`/get-user-profile/?username=${encodeURIComponent(username)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showUserProfileModal(data);
            } else {
                alert('User not found: ' + username);
            }
        })
        .catch(error => {
            console.error('Error loading user profile:', error);
            alert('Error loading user profile');
        });

    const roleSection = document.getElementById('other-profile-role-section');
    const roleValue   = document.getElementById('other-profile-role');  

    if (roleSection && roleValue) {
        if (data.role === 'Administrator' || data.role === 'Moderator') {
            let badge = '';
            if (data.role === 'Administrator') {
                badge = '<span style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">üëë Administrator</span>';
            } else if (data.role === 'Moderator') {
                badge = '<span style="background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>';
            }
            roleValue.innerHTML = badge;
            roleSection.style.display = 'block';
        } else {
            roleSection.style.display = 'none';
        }
    }
}

function closeAllModals() {
    const checkboxes = [
        'menu-toggle', 'profile-toggle', 'setting-toggle', 'form1-toggle', 
        'form2-toggle', 'wallet-toggle', 'check-subscription-toggle',
        'subscribe-month-toggle', 'subscribe-year-toggle', 'deposit-toggle', 'add_card-toggle',
        'bin_mouth-toggle', 'bin_premium_mouth-toggle', 'bin_years-toggle', 'bin_premium_years-toggle',
        'other-profile-toggle', 'security-toggle', 'chat-settings-toggle', 'wallpaper-toggle'
    ];
    
    checkboxes.forEach(id => {
        const cb = document.getElementById(id);
        if (cb) cb.checked = false;
    });
}

function showUserProfileModal(userData) {
    closeAllModals();
    
    const otherProfileForm = document.querySelector('.other-profile-form');
    if (otherProfileForm) {
        const avatarImg = otherProfileForm.querySelector('.other-profile-avatar');
        if (avatarImg) {
            avatarImg.src = userData.photo_url;
            avatarImg.alt = userData.username;
        }
        
        const usernameEl = otherProfileForm.querySelector('.other-profile-username');
        if (usernameEl) {
            usernameEl.textContent = userData.username;
        }
        
        const tagEl = otherProfileForm.querySelector('.other-profile-tag');
        if (tagEl) {
            tagEl.textContent = userData.your_tag || userData.username;
        }

        const roleEl = otherProfileForm.querySelector('#other-profile-role');
        if (roleEl) {
            let roleHtml = '';      

            if (userData.role === 'Administrator') {
                roleHtml = `<span style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                    üëë Administrator
                </span>`;
            } else if (userData.role === 'Moderator') {
                roleHtml = `<span style="background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                    üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä
                </span>`;
            } else if (userData.role === 'System Bot') {
                roleHtml = `<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                    ü§ñ System Bot
                </span>`;
            } else {
                roleHtml = '';
            }       

            roleEl.innerHTML = roleHtml;
        }       

        const subscribeEl = otherProfileForm.querySelector('#other-profile-subscribe');
        if (subscribeEl) {
            let subHtml = '';       

            if (userData.subscribe === 'Bin_premium') {
                subHtml = `<span style="background: linear-gradient(135deg, #6f42c1, #5a32a3); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                    üíé –ë—ñ–Ω –ø—Ä–µ–º—ñ—É–º
                </span>`;
            } else if (userData.subscribe === 'Bin+') {
                subHtml = `<span style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                    üåü –ë—ñ–Ω+
                </span>`;
            } else {
                subHtml = '';
            }       

            subscribeEl.innerHTML = subHtml;
        }       

        const separator = otherProfileForm.querySelector('#other-profile-role + span');     

        if (separator) {
            const hasRoleBadge    = roleEl     && roleEl.innerHTML.trim() !== '';
            const hasSubscribeBadge = subscribeEl && subscribeEl.innerHTML.trim() !== '';       

            separator.style.display = (hasRoleBadge && hasSubscribeBadge) ? 'inline' : 'none';
        }
        
        const statusEl = otherProfileForm.querySelector('.other-profile-status');
        if (statusEl) {
            statusEl.textContent = userData.status;
            statusEl.className = `status-value ${userData.status === 'Online' ? 'online' : 'offline'}`;
        }
        
        const descriptionEl = otherProfileForm.querySelector('.other-profile-description');
        if (descriptionEl) {
            const processedDescription = processMentionsStrict(userData.description || 'No description');
            descriptionEl.innerHTML = processedDescription;
            addMentionEventListeners(descriptionEl);
        }
        
        const birthdayEl = otherProfileForm.querySelector('.other-profile-birthday');
        if (birthdayEl) {
            birthdayEl.textContent = userData.birthday;
        }
        
        const messageBtn = otherProfileForm.querySelector('.other-profile-message-btn');
        if (messageBtn) {
            messageBtn.onclick = function() {
                openChatWithUser(userData.username);
            };
        }
    }

    const otherProfileToggle = document.getElementById('other-profile-toggle');
    if (otherProfileToggle) {
        otherProfileToggle.checked = true;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const otherProfileOverlay = document.querySelector('.other-profile-overlay');
    if (otherProfileOverlay) {
        otherProfileOverlay.addEventListener('click', function() {
            const otherProfileToggle = document.getElementById('other-profile-toggle');
            if (otherProfileToggle) {
                otherProfileToggle.checked = false;
            }
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        if (e.target.matches('.other-profile-form .message-mention, .other-profile-form .profile-mention')) {
            e.preventDefault();
            e.stopPropagation();
            const username = e.target.getAttribute('data-username').replace('@', '');
            openUserProfile(username);
        }
    });
    
    const originalShowUserProfileModal = window.showUserProfileModal;
    window.showUserProfileModal = function(userData) {
        if (originalShowUserProfileModal) {
            originalShowUserProfileModal(userData);
        }
        
        setTimeout(() => {
            const otherProfileDesc = document.querySelector('.other-profile-description');
            if (otherProfileDesc) {
                const processedText = processMentionsStrict(otherProfileDesc.innerHTML);
                otherProfileDesc.innerHTML = processedText;
                addMentionEventListeners(otherProfileDesc);
            }
        }, 100);
    };
});

function closeProfileModals() {
    const profileModals = [
        'menu-toggle', 'profile-toggle', 'setting-toggle', 'form1-toggle', 
        'form2-toggle', 'color_theme-toggle',
        'wallet-toggle', 'check-subscription-toggle',
        'subscribe-month-toggle', 'subscribe-year-toggle', 'deposit-toggle', 'add_card-toggle',
        'bin_mouth-toggle', 'bin_premium_mouth-toggle', 'bin_years-toggle', 'bin_premium_years-toggle',
        'other-profile-toggle', 'security-toggle', 'wallpaper-toggle', 'chat-settings-toggle'
    ];
    
    profileModals.forEach(id => {
        const cb = document.getElementById(id);
        if (cb) cb.checked = false;
    });
}

function openChatWithUser(username) {
    const otherProfileToggle = document.getElementById('other-profile-toggle');
    if (otherProfileToggle) {
        otherProfileToggle.checked = false;
    }
    
    openChat(username);
}

function closeUserProfileModal() {
    const modal = document.querySelector('.user-profile-modal');
    const overlay = document.querySelector('.user-profile-overlay');
    if (modal) modal.remove();
    if (overlay) overlay.remove();
}

function syncBackgrounds() {
    console.log('Syncing backgrounds...');
    
    const previewBackground = document.getElementById('preview-background');
    const mainProfileBackground = document.querySelector('.profile-form .profile-preview-background');
    
    console.log('Preview background:', previewBackground.style.backgroundImage);
    console.log('Main background:', mainProfileBackground && mainProfileBackground.style.backgroundImage);
    
    if (previewBackground && mainProfileBackground) {
        if (previewBackground.style.backgroundImage && previewBackground.style.backgroundImage !== 'none') {
            mainProfileBackground.style.backgroundImage = previewBackground.style.backgroundImage;
            mainProfileBackground.style.display = previewBackground.style.display;
            console.log('Synced from preview to main');
        }
        else if (mainProfileBackground.style.backgroundImage && mainProfileBackground.style.backgroundImage !== 'none') {
            previewBackground.style.backgroundImage = mainProfileBackground.style.backgroundImage;
            previewBackground.style.display = mainProfileBackground.style.display;
            console.log('Synced from main to preview');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const themeSelect = document.getElementById('themeSelect');
    const applyBtn = document.getElementById('applyThemeBtn');
    const resetBtn = document.getElementById('resetThemeBtn');
    const swatches = document.querySelectorAll('.color-swatch');
    const userSubscribe = "{{ user.subscribe }}";  
    const body = document.body;

    function setTheme(selected, persist = true) {
        if ((selected === 'pink' || selected === 'green') && userSubscribe === 'Basic') {
            alert("‚ùå This theme is available only for subscribers!");
            return;
        }

        body.classList.remove('theme-light', 'theme-dark', 'theme-pink', 'theme-green');
        body.classList.add(`theme-${selected}`);
        if (themeSelect) themeSelect.value = selected;

        swatches.forEach(s => s.classList.toggle('selected', s.dataset.theme === selected));

        if (persist) localStorage.setItem('selectedTheme', selected);
    }

    const savedTheme = localStorage.getItem('selectedTheme') || 'light';
    if (savedTheme) {
        setTheme(savedTheme, false);
        if (themeSelect) themeSelect.value = savedTheme;
    }

    if (userSubscribe === "Basic") {
        document.querySelectorAll('.color-swatch[data-theme="pink"], .color-swatch[data-theme="green"]').forEach(el => {
            el.style.opacity = '0.55';
            el.title += ' (subscribers only)';
            el.dataset.disabled = '1';
        });
        if (themeSelect) {
            const pinkOpt = themeSelect.querySelector('option[value="pink"]');
            const greenOpt = themeSelect.querySelector('option[value="green"]');
            if (pinkOpt) pinkOpt.disabled = true;
            if (greenOpt) greenOpt.disabled = true;
        }
    }

    swatches.forEach(s => {
        s.addEventListener('click', () => {
            if (s.dataset.disabled === '1') {
                alert('‚ùå This theme is available only for subscribers!');
                return;
            }
            setTheme(s.dataset.theme, false);
            if (themeSelect) themeSelect.value = s.dataset.theme;
        });
    });

    if (themeSelect) {
        themeSelect.addEventListener('change', function(e) {
            const val = e.target.value;
            setTheme(val, false);
        });
    }

    applyBtn.addEventListener('click', () => {
        const selected = themeSelect ? themeSelect.value : (document.querySelector('.color-swatch.selected')?.dataset.theme || 'light');
        setTheme(selected, true);
        showCopyNotification('Theme applied');
    });

    resetBtn.addEventListener('click', () => {
        localStorage.removeItem('selectedTheme');
        setTheme('light', true);
        showCopyNotification('Theme reset to default');
    });
});


document.addEventListener('DOMContentLoaded', function() {
    const usernameInput = document.getElementById('username-input');
    const descriptionInput = document.querySelector('.description-input');
    const tagInput = document.getElementById('tag-input');
    const birthdayDay = document.getElementById('birthday-day');
    const birthdayMonth = document.getElementById('birthday-month');
    const birthdayYear = document.getElementById('birthday-year');
    const avatarInput = document.getElementById('avatarInput');
    
    const previewUsername = document.getElementById('preview-username');
    const previewDescription = document.getElementById('preview-description');
    const previewTag = document.getElementById('preview-tag');
    const previewBirthday = document.getElementById('preview-birthday');
    const previewAvatar = document.getElementById('preview-avatar');
    const avatarInputImg = document.getElementById('avatarInput-img');

    if (usernameInput) {
        usernameInput.addEventListener('input', function() {
            const value = this.value.trim();
            previewUsername.textContent = value || '{{ user.username }}';
        });
    }

    if (descriptionInput) {
        descriptionInput.addEventListener('input', function() {
            const value = this.value.trim();
            previewDescription.textContent = value || 'No description';
        });
    }

    if (tagInput) {
        tagInput.addEventListener('input', function() {
            const value = this.value.trim();
            previewTag.textContent = value || '{{ user.your_tag }}';
        });
    }

    if (avatarInput) {
        avatarInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('‚ö†Ô∏è Only JPG, PNG, GIF or WEBP images are allowed.');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                previewAvatar.src = imageUrl;
                avatarInputImg.src = imageUrl;
            };
            reader.readAsDataURL(file);
        });
    }

    const backgroundInput = document.getElementById('backgroundInput');
    const previewBackground = document.getElementById('preview-background');
    const mainProfileBackground = document.querySelector('.profile-form .profile-preview-background');
    const subscribe = "{{ user.subscribe }}";

    function syncBackgrounds() {
        if (previewBackground && mainProfileBackground) {
            if (previewBackground.style.backgroundImage && previewBackground.style.backgroundImage !== 'none') {
                mainProfileBackground.style.backgroundImage = previewBackground.style.backgroundImage;
                mainProfileBackground.style.display = previewBackground.style.display;
            }
            else if (mainProfileBackground.style.backgroundImage && mainProfileBackground.style.backgroundImage !== 'none') {
                previewBackground.style.backgroundImage = mainProfileBackground.style.backgroundImage;
                previewBackground.style.display = mainProfileBackground.style.display;
            }
        }
    }

    syncBackgrounds();

    if (backgroundInput) {
        if (subscribe === 'Basic') {
            backgroundInput.disabled = true;
            backgroundInput.title = "Background feature available for Bin+ and Bin_premium subscribers";
            backgroundInput.closest('label').style.opacity = '0.6';
            backgroundInput.closest('label').style.cursor = 'not-allowed';
        } else if (subscribe === 'Bin+') {
            backgroundInput.accept = "image/*";
        } else if (subscribe === 'Bin_premium') {
            backgroundInput.accept = "image/*,image/gif";
        }

        backgroundInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (subscribe === 'Bin+' && !file.type.startsWith('image/')) {
                    alert('Only images are allowed for Bin+ subscription');
                    return;
                }
                
                if (subscribe === 'Bin_premium' && !file.type.startsWith('image/') && file.type !== 'image/gif') {
                    alert('Only images and GIFs are allowed for Bin_premium subscription');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    previewBackground.style.backgroundImage = `url('${event.target.result}')`;
                    previewBackground.style.display = 'block';
                    
                    syncBackgrounds();
                };
                reader.readAsDataURL(file);
            }
        });
    }

    const searchInput = document.getElementById("searchInput");
    const resultsDiv = document.getElementById("searchResults");
    
    if (searchInput && resultsDiv) {
        searchInput.addEventListener("input", async () => {
            const query = searchInput.value.trim();
            if (query.length === 0) {
                resultsDiv.innerHTML = "";
                return;
            }

            const response = await fetch(`/search-users/?q=${encodeURIComponent(query)}`);
            const data = await response.json();
        });
    }

    {% if user.subscription_end %}
    const endDate = new Date("{{ user.subscription_end|date:'Y-m-d H:i:s' }}").getTime();
    const countdownEl = document.getElementById('countdown');

    if (countdownEl) {
        function updateCountdown() {
            const now = new Date().getTime();
            const distance = endDate - now;

            if (distance < 0) {
                countdownEl.innerHTML = "Expired";
                location.reload();
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownEl.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    }
    {% endif %}

    const cardMessages = {
        invalid_card_number: "{{ card_messages.invalid_card_number }}",
        card_added: "{{ card_messages.card_added }}",
        add_card_failed: "{{ card_messages.add_card_failed }}",
        cards_label: "{{ card_messages.cards_label }}",
        no_cards: "{{ card_messages.no_cards }}",
    };

    const tagElement = document.getElementById('user-tag');
    if (tagElement) {
        tagElement.addEventListener('click', () => {
            const text = tagElement.textContent;
            navigator.clipboard.writeText(text)
                .then(() => showCopyNotification('Tag copied!'))
                .catch(err => console.error('Error copying tag:', err));
        });
    }

    document.addEventListener('mousedown', (event) => {
        const forms = [
            { form: '.side-menu', toggle: '#menu-toggle' },
            { form: '.wallet-form', toggle: '#wallet-toggle' },
            { form: '.profile-form', toggle: '#profile-toggle' },
            { form: '.setting-form', toggle: '#setting-toggle' },
            { form: '.color-theme-form', toggle: '#color_theme-toggle' },
            { form: '.chat-settings-form', toggle: '#chat-settings-toggle' },
            { form: '.wallpaper-form', toggle: '#wallpaper-toggle' },
            { form: '.form1', toggle: '#form1-toggle' },
            { form: '.form2', toggle: '#form2-toggle' },
            { form: '.deposit-form', toggle: '#deposit-toggle' },
            { form: '.add_card-form', toggle: '#add_card-toggle' },
            { form: '.other-profile-form', toggle: '#other-profile-toggle' }
        ];

        forms.forEach(({form, toggle}) => {
            const formElement = document.querySelector(form);
            const toggleElement = document.querySelector(toggle);
            
            if (formElement && toggleElement && toggleElement.checked) {
                if (!formElement.contains(event.target) && !event.target.closest(form)) {
                    toggleElement.checked = false;
                }
            }
        });
    });

    const overlays = document.querySelectorAll('.overlay, .profile-overlay, .other-profile-overlay, .setting-overlay, .form1-overlay, .form2-overlay, .color_theme-overlay, .wallet-overlay, .check-subscription-overlay, .subscribe-month-overlay, .subscribe-year-overlay, .bin_mouth-overlay, .bin_premium_mouth-overlay, .bin_years-overlay, .bin_premium_years-overlay, .deposit-overlay, .add_card-overlay, .security-overlay');
    
    overlays.forEach(overlay => {
        overlay.addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('#menu-toggle, #profile-toggle, #other-profile-toggle, #setting-toggle, #form1-toggle, #form2-toggle, #color_theme-toggle, #wallet-toggle, #check-subscription-toggle, #subscribe-month-toggle, #subscribe-year-toggle, #bin_mouth-toggle, #bin_premium_mouth-toggle, #bin_years-toggle, #bin_premium_years-toggle, #deposit-toggle, #add_card-toggle, #security-toggle');
            
            checkboxes.forEach(cb => {
                if(cb) cb.checked = false;
            });
        });
    });


document.querySelectorAll('.check-subscription-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const cb = document.getElementById('check-subscription-toggle');
        if (cb) cb.checked = true;
    });
}); 

    const depositInput = document.getElementById('deposit-amount');
    const depositResult = document.getElementById('deposit-result');
    const depositWalletSpan = document.getElementById('deposit-wallet');
    const currencySelect = document.querySelector('.wallet form select');

    function parseAmountAndCurrency(text) {
        if (!text) return { amount: 0, currency: ("{{ user.currency|default:'USD' }}") };
        const t = text.replace(/,/g, '').trim();
        const uah = t.indexOf('‚Ç¥') !== -1 || /UAH/i.test(t);
        const usd = t.indexOf('$') !== -1 || /USD/i.test(t);
        const m = t.match(/([-+]?\d*\.?\d+)/);
        const amount = m ? Number(m[0]) : 0;
        const currency = uah ? 'UAH' : (usd ? 'USD' : ("{{ user.currency|default:'USD' }}"));
        return { amount, currency };
    }

    function formatCurrency(amount, currency) {
        if (amount === null || amount === undefined) return '';
        const a = Number(amount) || 0;
        if (currency === 'UAH') return a.toFixed(2) + ' ‚Ç¥';
        return a.toFixed(2) + ' $';
    }

    function convertAmount(value, sourceCurrency, targetCurrency) {
        const v = Number(value) || 0;
        if (sourceCurrency === targetCurrency) return v;
        if (sourceCurrency === 'USD' && targetCurrency === 'UAH') return v * 42.1;
        if (sourceCurrency === 'UAH' && targetCurrency === 'USD') return v / 42.1;
        return v;
    }

    function updateDepositResult() {
        if (!depositInput || !depositResult || !depositWalletSpan) return;

        const walletRaw = depositWalletSpan.textContent || depositWalletSpan.innerText || '';
        const wallet = parseAmountAndCurrency(walletRaw);

        const depositVal = Number(depositInput.value) || 0;
        const depositCurrency = (currencySelect && currencySelect.value) ? currencySelect.value : ("{{ user.currency|default:'USD' }}");

        const depositConverted = convertAmount(depositVal, depositCurrency, wallet.currency);
        const total = (Number(wallet.amount) || 0) + depositConverted;

        const pageLang = "{{ user.language|default:'English' }}";
        const willBeText = pageLang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ë—É–¥–µ' : 'Will be';
        depositResult.textContent = depositVal ? `${willBeText}: ${formatCurrency(total, wallet.currency)}` : '';
    }

    function formatCardNumber(val) {
        const digits = val.replace(/\D/g, '').slice(0, 16);
        return digits.replace(/(.{4})/g, '$1 ').trim();
    }

    const cardNumberInput = document.getElementById('card-number');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', (e) => {
            const el = e.target;
            const selectionStart = el.selectionStart || 0;
            const rawBefore = el.value.slice(0, selectionStart).replace(/\D/g, '');
            const formatted = formatCardNumber(el.value);
            el.value = formatted;
            let pos = 0;
            let digitsSeen = 0;
            while (digitsSeen < rawBefore.length && pos < el.value.length) {
                if (/\d/.test(el.value.charAt(pos))) digitsSeen++;
                pos++;
            }
            el.setSelectionRange(pos, pos);
        });
        
        cardNumberInput.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text') || '';
            const digits = paste.replace(/\D/g, '').slice(0, 16);
            cardNumberInput.value = formatCardNumber(digits);
        });
    }

    if (depositInput) {
        depositInput.addEventListener('input', updateDepositResult);
    }
    if (currencySelect) {
        currencySelect.addEventListener('change', updateDepositResult);
    }

    const sideMenuLinks = document.querySelectorAll('.side-menu label, .side-menu a');
    sideMenuLinks.forEach(link => {
        link.addEventListener('click', () => {
            const menuToggle = document.getElementById('menu-toggle');
            if(menuToggle) menuToggle.checked = false;
        });
    });

    const formCheckboxes = [
        'profile-toggle', 'other-profile-toggle', 'setting-toggle', 'form1-toggle', 
        'form2-toggle', 'color_theme-toggle', 
        'check-subscription-toggle', 'wallet-toggle',
        'subscribe-month-toggle', 'subscribe-year-toggle', 'bin_mouth-toggle', 
        'bin_premium_mouth-toggle', 'bin_years-toggle', 'bin_premium_years-toggle',
        'deposit-toggle', 'add_card-toggle', 'security-toggle', 'wallpaper-toggle', 'chat-settings-toggle'
    ];

    const colorThemeToggle = document.getElementById('color_theme-toggle');
    if (colorThemeToggle) {
        colorThemeToggle.addEventListener('change', function() {
            if (this.checked) {
                formCheckboxes.forEach(otherId => {
                    if (otherId !== 'color_theme-toggle') {
                        const otherCb = document.getElementById(otherId);
                        if (otherCb) otherCb.checked = false;
                    }
                });
            }
        });
    }
    const chatSettingsToggle = document.getElementById('chat-settings-toggle');
    if (chatSettingsToggle) {
        chatSettingsToggle.addEventListener('change', function() {
            if (this.checked) {
                formCheckboxes.forEach(otherId => {
                    if (otherId !== 'chat-settings-toggle') {
                        const otherCb = document.getElementById(otherId);
                        if (otherCb) otherCb.checked = false;
                    }
                });
            }
        });
    }
    
    formCheckboxes.forEach(id => {
        const cb = document.getElementById(id);
        if(cb) {
            cb.addEventListener('change', () => {
                if(cb.checked) {
                    formCheckboxes.forEach(otherId => {
                        if(otherId !== id) {
                            const otherCb = document.getElementById(otherId);
                            if(otherCb) otherCb.checked = false;
                        }
                    });
                }
            });
        }
    });

    (function(){
        const themeButtons = document.querySelectorAll('.theme-option');
        const applyBtn = document.getElementById('apply-theme-btn');
        const toggle = document.getElementById('color_theme-toggle');
        const THEME_CLASSES = ['theme-light','theme-dark','theme-pink','theme-green'];

        function setThemeClass(cls){
            document.documentElement.classList.remove(...THEME_CLASSES);
            if(cls) document.documentElement.classList.add(cls);
            localStorage.setItem('siteTheme', cls || '');
        }

        const saved = localStorage.getItem('siteTheme');
        if(saved) setThemeClass(saved);

        let selected = saved || '';

        themeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                themeButtons.forEach(b=>b.classList.remove('selected'));
                btn.classList.add('selected');
                selected = btn.getAttribute('data-theme');
            });
        });

        if(applyBtn){
            applyBtn.addEventListener('click', () => {
                if(selected) setThemeClass(selected);
                if(toggle) toggle.checked = false;
            });
        }
    })();

    const walletForm = document.querySelector('.wallet form');
    if (walletForm) {
        walletForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(walletForm);
            const csrf = formData.get('csrfmiddlewaretoken');

            fetch(walletForm.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrf,
                },
                body: formData,
            })
            .then(resp => {
                if (!resp.ok) throw new Error('Network response was not ok');
                return resp.json();
            })
            .then(data => {
                if (data && data.price_converted) {
                    const el = document.getElementById('wallet-amount');
                    if (el) el.textContent = 'Wallet: ' + data.price_converted;
                    const depositWallet = document.getElementById('deposit-wallet');
                    if (depositWallet) depositWallet.textContent = data.price_converted;
                    updateDepositResult();
                }
            })
            .catch(err => console.error('Currency change failed:', err));
        });
    }

    setupSubscription('terms-bin', 'subscribe-bin');
    setupSubscription('terms-premium', 'subscribe-premium');
    setupSubscription('terms-bin-year', 'subscribe-bin-year');
    setupSubscription('terms-premium-year', 'subscribe-premium-year');
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function setupSubscription(checkboxId, buttonId) {
    const checkbox = document.getElementById(checkboxId);
    const button = document.getElementById(buttonId);

    if (checkbox && button) {
        button.disabled = true;
        checkbox.addEventListener('change', () => {
            button.disabled = !checkbox.checked;
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const avatarInput = document.getElementById('avatarInput');
    const usernameInput = document.getElementById('username-input');
    const descriptionInput = document.querySelector('.description-input');
    const tagInput = document.getElementById('tag-input');
    const birthdayDay = document.getElementById('birthday-day');
    const birthdayMonth = document.getElementById('birthday-month');
    const birthdayYear = document.getElementById('birthday-year');
    const backgroundInput = document.getElementById('backgroundInput');
    
    const editAvatarPreview = document.getElementById('edit-avatar-preview');
    const previewAvatar = document.getElementById('preview-avatar');
    const avatarInputImg = document.getElementById('avatarInput-img');
    const previewUsername = document.getElementById('preview-username');
    const previewDescription = document.getElementById('preview-description');
    const previewTag = document.getElementById('preview-tag');
    const previewBirthday = document.getElementById('preview-birthday');
    const previewBackground = document.getElementById('preview-background');
    const mainProfileBackground = document.querySelector('.profile-form .profile-preview-background');
    
    const initialValues = {
        avatar: '{% if user.photo and user.photo.url %}{{ user.photo.url }}{% else %}{% static "pictures/login.png" %}{% endif %}',
        username: '{{ user.username }}',
        description: '{{ user.description|default:"No description"|escapejs }}',
        tag: '{{ user.your_tag|default:"No tag"|escapejs }}',
        birthday: '{{ user.birthday|default:"Not specified"|escapejs }}',
        background: '{% if user.background and user.background.url %}{{ user.background.url }}{% else %}none{% endif %}'
    };
    
    if (avatarInput) {
        avatarInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('‚ö†Ô∏è Only JPG, PNG, GIF or WEBP images are allowed.');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                
                if (editAvatarPreview) editAvatarPreview.src = imageUrl;
                if (previewAvatar) previewAvatar.src = imageUrl;
                if (avatarInputImg) avatarInputImg.src = imageUrl;
            };
            reader.readAsDataURL(file);
        });
    }
    
    if (usernameInput && previewUsername) {
        usernameInput.addEventListener('input', function() {
            previewUsername.textContent = this.value || initialValues.username;
        });
    }
    
    if (descriptionInput && previewDescription) {
        descriptionInput.addEventListener('input', function() {
            previewDescription.textContent = this.value || initialValues.description;
        });
    }
    
    if (tagInput && previewTag) {
        tagInput.addEventListener('input', function() {
            previewTag.textContent = this.value || initialValues.tag;
        });
    }
    
const previewBirthdaySection = document.getElementById('preview-birthday-section');
    const previewBirthdayValue   = document.getElementById('preview-birthday-value');

    const daySelect   = document.getElementById('birthday-day');
    const monthSelect = document.getElementById('birthday-month');
    const yearSelect  = document.getElementById('birthday-year');

    const showBirthdayCheckbox = document.getElementById('show-birthday-checkbox');

    const monthNames = [
        '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç',     '–ê–ø—Ä–µ–ª—å',   '–ú–∞–π',      '–ò—é–Ω—å',
        '–ò—é–ª—å',   '–ê–≤–≥—É—Å—Ç',  '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å',  '–ù–æ—è–±—Ä—å',   '–î–µ–∫–∞–±—Ä—å'
    ];
    function updateBirthdayPreview() {
        const day   = daySelect?.value;
        const month = monthSelect?.value;
        const year  = yearSelect?.value;

        if (showBirthdayCheckbox?.checked && day && month && year) {
            const monthIndex = parseInt(month, 10) - 1;
            const monthName = monthNames[monthIndex] || month;

            const formatted = `${day} ${monthName} ${year}`;

            if (previewBirthdayValue) {
                previewBirthdayValue.textContent = formatted;
            }
            if (previewBirthdaySection) {
                previewBirthdaySection.style.display = 'block';
            }
        } else {
            if (previewBirthdaySection) {
                previewBirthdaySection.style.display = 'none';
            }
        }
    }

    [daySelect, monthSelect, yearSelect].forEach(select => {
        if (select) {
            select.addEventListener('change', updateBirthdayPreview);
        }
    });

    if (showBirthdayCheckbox) {
        showBirthdayCheckbox.addEventListener('change', updateBirthdayPreview);
    }

    updateBirthdayPreview();
    
    function syncBackgrounds() {
        if (previewBackground && mainProfileBackground) {
            if (previewBackground.style.backgroundImage && previewBackground.style.backgroundImage !== 'none') {
                mainProfileBackground.style.backgroundImage = previewBackground.style.backgroundImage;
                mainProfileBackground.style.display = previewBackground.style.display;
            }
            else if (mainProfileBackground.style.backgroundImage && mainProfileBackground.style.backgroundImage !== 'none') {
                previewBackground.style.backgroundImage = mainProfileBackground.style.backgroundImage;
                previewBackground.style.display = mainProfileBackground.style.display;
            }
        }
    }
    
    if (backgroundInput) {
        backgroundInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                if (previewBackground) {
                    previewBackground.style.backgroundImage = `url('${event.target.result}')`;
                    previewBackground.style.display = 'block';
                }
                syncBackgrounds();
            };
            reader.readAsDataURL(file);
        });
    }
    
    const form1Toggle = document.getElementById('form1-toggle');
    const form1Overlay = document.querySelector('.form1-overlay');
    
    function resetPreviewToInitialValues() {
        if (editAvatarPreview) editAvatarPreview.src = initialValues.avatar;
        if (previewAvatar) previewAvatar.src = initialValues.avatar;
        if (avatarInputImg) avatarInputImg.src = initialValues.avatar;
        
        if (previewUsername) previewUsername.textContent = initialValues.username;
        if (previewDescription) previewDescription.textContent = initialValues.description;
        if (previewTag) previewTag.textContent = initialValues.tag;
        if (previewBirthday) previewBirthday.textContent = initialValues.birthday;
        
        if (previewBackground) {
            if (initialValues.background !== 'none') {
                previewBackground.style.backgroundImage = `url('${initialValues.background}')`;
                previewBackground.style.display = 'block';
            } else {
                previewBackground.style.backgroundImage = 'none';
                previewBackground.style.display = 'none';
            }
        }
        
        if (avatarInput) avatarInput.value = '';
        if (backgroundInput) backgroundInput.value = '';
    }
    
    if (form1Overlay) {
        form1Overlay.addEventListener('click', function() {
            setTimeout(resetPreviewToInitialValues, 100);
        });
    }
    
    if (form1Toggle) {
        form1Toggle.addEventListener('change', function() {
            if (!this.checked) {
                setTimeout(resetPreviewToInitialValues, 100);
            }
        });
    }
    
    setTimeout(function() {
        if (previewBirthday && initialValues.birthday !== 'Not specified') {
            const dateParts = initialValues.birthday.split(' ');
            if (dateParts.length === 3) {
                previewBirthday.textContent = initialValues.birthday;
            }
        }
        
        if (previewBackground && initialValues.background !== 'none') {
            previewBackground.style.backgroundImage = `url('${initialValues.background}')`;
            previewBackground.style.display = 'block';
        }
    }, 500);
});

document.addEventListener('DOMContentLoaded', function () {
    const checkbox = document.querySelector('input[name="show_birthday"]');
    const previewSection = document.getElementById('preview-birthday-section');
    const previewValue = document.getElementById('preview-birthday-value');

    if (!checkbox || !previewSection) return;

    const birthdayDate = "{{ user.birthday|date:'d.m.Y'|default:'' }}";

    function updatePreview() {
        if (checkbox.checked && birthdayDate) {
            previewSection.style.display = 'block';
        } else {
            previewSection.style.display = 'none';
        }
    }

    updatePreview();

    checkbox.addEventListener('change', updatePreview);
});

window.confirmAvatarReset = function() {
    const lang = "{{ user.language|default:'English' }}";
    const confirmMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
        ? "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∏–Ω—É—Ç–∏ –∞–≤–∞—Ç–∞—Ä?"
        : "Are you sure you want to reset your avatar?";

    if (confirm(confirmMsg)) {
        const csrfToken = '{{ csrf_token }}';
        
        fetch('{% url "reset_avatar" %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=reset_photo'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const defaultAvatarUrl = data.avatar_url + '?t=' + new Date().getTime();
                
                document.querySelectorAll('.avatar, img.avatar, #preview-avatar, #upload-avatar').forEach(img => {
                    img.src = defaultAvatarUrl;
                });
                
                const previewAvatar = document.getElementById('preview-avatar');
                if (previewAvatar) previewAvatar.src = defaultAvatarUrl;
                
                const avatarInputImg = document.getElementById('avatarInput-img');
                if (avatarInputImg) avatarInputImg.src = defaultAvatarUrl;

                const successMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
                    ? '–ê–≤–∞—Ç–∞—Ä —É—Å–ø—ñ—à–Ω–æ —Å–∫–∏–Ω—É—Ç–æ!'
                    : 'Avatar successfully reset';
                showCopyNotification(successMsg);
            } else {
                console.error('Error resetting avatar:', data.error);
                const errorMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
                    ? '–ü–æ–º–∏–ª–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä–∞'
                    : 'Error resetting avatar';
                showCopyNotification(errorMsg);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const errorMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
                ? '–ü–æ–º–∏–ª–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä–∞'
                : 'Error resetting avatar';
                showCopyNotification(errorMsg);
        });
    }
};

window.confirmBackgroundReset = function() {
    const lang = "{{ user.language|default:'English' }}";
    const confirmMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
        ? "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ–Ω –ø—Ä–æ—Ñ—ñ–ª—é?"
        : "Are you sure you want to remove the background?";

    if (confirm(confirmMsg)) {
        const previewBackground = document.getElementById('preview-background');
        const mainProfileBackground = document.querySelector('.profile-form .profile-preview-background');
        
        if (previewBackground) {
            previewBackground.style.backgroundImage = 'none';
            previewBackground.style.display = 'none';
        }
        
        if (mainProfileBackground) {
            mainProfileBackground.style.backgroundImage = 'none';
            mainProfileBackground.style.display = 'none';
        }
        
        let removeBackgroundInput = document.getElementById('remove-background-input');
        if (!removeBackgroundInput) {
            removeBackgroundInput = document.createElement('input');
            removeBackgroundInput.type = 'hidden';
            removeBackgroundInput.name = 'remove_background';
            removeBackgroundInput.id = 'remove-background-input';
            const editProfileForm = document.getElementById('edit-profile-form');
            if (editProfileForm) {
                editProfileForm.appendChild(removeBackgroundInput);
            }
        }
        removeBackgroundInput.value = 'true';
    }
};

window.deleteCard = function(last4) {
    const lang = "{{ user.language|default:'English' }}";
    const confirmMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' 
        ? `–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ä—Ç–∫—É ****${last4}?`
        : `Are you sure you want to delete card ****${last4}?`;
    
    if (!confirm(confirmMsg)) return;

    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrf = csrfInput ? csrfInput.value : '';

    fetch('/delete-card/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrf,
        },
        body: JSON.stringify({ last4: last4 })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }
        
        const cardsList = document.getElementById('cards-list');
        const cardMessages = {
            cards_label: lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ö–∞—Ä—Ç–∫–∏:' : 'Cards:',
            no_cards: lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ö–∞—Ä—Ç –Ω–µ –¥–æ–¥–∞–Ω–æ' : 'No cards added',
        };
        
        if (cardsList && data.cards !== undefined) {
            let html = `<strong>${cardMessages.cards_label}</strong><div style="margin-top:6px;">`;
            if (data.cards.length === 0) {
                html += `<div class="card-item" style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">${cardMessages.no_cards}</div>`;
            } else {
                data.cards.forEach(c => {
                    html += `<div class="card-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;">
                        <span>**** **** ****${c.last4} ‚Äî ${c.cardholder || '-'} ‚Äî ${c.expiry}</span>
                        <button type="button" onclick="deleteCard('${c.last4}')" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">üóëÔ∏è</button>
                    </div>`;
                });
            }
            html += '</div>';
            cardsList.innerHTML = html;
        }
        
        const successMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ö–∞—Ä—Ç–∫—É –≤–∏–¥–∞–ª–µ–Ω–æ!' : 'Card deleted!';
        alert(successMsg);
    })
    .catch(err => {
        console.error('Delete card failed', err);
        const errorMsg = lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–∞—Ä—Ç–∫–∏' : 'Error deleting card';
        alert(errorMsg);
    });
};

function checkCardsAndOpenDeposit() {
    const cardsList = document.getElementById('cards-list');
    const noCardsMessage = '{% if lang == "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" %}–ö–∞—Ä—Ç –Ω–µ –¥–æ–¥–∞–Ω–æ{% else %}No cards added{% endif %}';
    
    if (cardsList.textContent.includes(noCardsMessage)) {
        openAdd_card('add_card');
        document.getElementById('add-card-result').textContent = '{% if lang == "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" %}–°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –∫–∞—Ä—Ç–∫—É{% else %}Please add a card first{% endif %}';
    } else {
        openSubscribe('deposit');
    }
}

window.performDeposit = function() {
    const depositInput = document.getElementById('deposit-amount');
    const depositWalletSpan = document.getElementById('deposit-wallet');
    const currencySelect = document.querySelector('.wallet form select');
    const depositResult = document.getElementById('deposit-result');
    
    if (!depositInput || !depositWalletSpan) return;
    
    const v = Number(depositInput.value) || 0;
    if (v <= 0) {
        alert('Please enter an amount greater than 0');
        return;
    }

    const depositCurrency = (currencySelect && currencySelect.value) ? currencySelect.value : ("{{ user.currency|default:'USD' }}");

    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrf = csrfInput ? csrfInput.value : '';

    const formData = new FormData();
    formData.append('amount', v);
    formData.append('currency', depositCurrency);

    fetch('{% url "deposit-funds" %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrf,
        },
        body: formData,
    })
    .then(resp => {
        if (!resp.ok) throw new Error('Network response was not ok');
        return resp.json();
    })
    .then(data => {
        if (data && data.price_converted) {
            depositWalletSpan.textContent = data.price_converted;
            const walletAmountEl = document.getElementById('wallet-amount');
            if (walletAmountEl) walletAmountEl.textContent = 'Wallet: ' + data.price_converted;
            const depositToggle = document.getElementById('deposit-toggle');
            const walletToggle = document.getElementById('wallet-toggle');
            if (depositToggle) depositToggle.checked = false;
            if (walletToggle) walletToggle.checked = true;
            depositInput.value = '';
            if (depositResult) depositResult.textContent = '';
        } else if (data && data.error) {
            alert('Deposit failed: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Deposit failed:', err);
        alert('Deposit failed');
    });
};

window.openSubscribe = function(period) {
    const monthToggle = document.getElementById('subscribe-month-toggle');
    const yearToggle = document.getElementById('subscribe-year-toggle');
    const depositToggle = document.getElementById('deposit-toggle');

    if (period === 'month') {
        if (monthToggle) monthToggle.checked = true;
        if (yearToggle) yearToggle.checked = false;
        if (depositToggle) depositToggle.checked = false;
    } else if (period === 'year') {
        if (yearToggle) yearToggle.checked = true;
        if (monthToggle) monthToggle.checked = false;
        if (depositToggle) depositToggle.checked = false;
    } else if (period === 'deposit') {
        if (depositToggle) depositToggle.checked = true;
        if (monthToggle) monthToggle.checked = false;
        if (yearToggle) yearToggle.checked = false;
    }
};

window.openAdd_card = function() {
    const addToggle = document.getElementById('add_card-toggle');
    if (addToggle) addToggle.checked = true;
    const monthToggle = document.getElementById('subscribe-month-toggle');
    const yearToggle = document.getElementById('subscribe-year-toggle');
    if (monthToggle) monthToggle.checked = false;
    if (yearToggle) yearToggle.checked = false;
    const depositToggle = document.getElementById('deposit-toggle');
    if (depositToggle) depositToggle.checked = false;
};

window.submitAddCard = function() {
    const numberEl = document.getElementById('card-number');
    const holderEl = document.getElementById('card-cardholder');
    const monthEl = document.getElementById('card-expiry-month');
    const yearEl = document.getElementById('card-expiry-year');
    const resultEl = document.getElementById('add-card-result');

    const cardMessages = {
        invalid_card_number: "{{ card_messages.invalid_card_number }}",
        card_added: "{{ card_messages.card_added }}",
        add_card_failed: "{{ card_messages.add_card_failed }}",
        cards_label: "{{ card_messages.cards_label }}",
        no_cards: "{{ card_messages.no_cards }}",
    };

    if (!numberEl || !monthEl || !yearEl) return;
    const number = (numberEl.value || '').replace(/\s+/g, '');
    const holder = holderEl ? holderEl.value : '';
    const month = monthEl.value;
    const year = yearEl.value;

    if (number.length < 13 || number.length > 16 || !/^[0-9]+$/.test(number)) {
        if (resultEl) resultEl.textContent = cardMessages.invalid_card_number;
        return;
    }

    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrf = csrfInput ? csrfInput.value : '';

    const fd = new FormData();
    fd.append('card_number', number);
    fd.append('cardholder', holder);
    fd.append('expiry_month', month);
    fd.append('expiry_year', year);

    fetch('{% url "add-card" %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrf,
        },
        body: fd,
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            if (resultEl) resultEl.textContent = data.error;
            return;
        }
        
        if (resultEl) resultEl.textContent = cardMessages.card_added;
        
        window.location.reload();
    })
    .catch(err => {
        console.error('Add card failed', err);
        if (resultEl) resultEl.textContent = cardMessages.add_card_failed;
    });
};

function copyOtherUserTag() {
    const otherProfileTag = document.querySelector('.other-profile-tag');
    if (otherProfileTag) {
        const tagText = otherProfileTag.textContent;
        navigator.clipboard.writeText(tagText)
            .then(() => {
                showCopyNotification('Tag copied!');
            })
            .catch(err => {
                console.error('Error copying tag:', err);
                showCopyNotification('Failed to copy tag');
            });
    }
}

function showCopyNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 2000);
}

const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

(function(){
    const kebabBtn = document.querySelector('.kebab-btn');
    const kebabMenu = document.getElementById('kebab-menu');
    
    if(kebabBtn){
        kebabBtn.addEventListener('click', (e)=>{ 
            e.stopPropagation(); 
            if(kebabMenu) kebabMenu.style.display = (kebabMenu.style.display==='block' || kebabMenu.style.display==='flex')? 'none' : 'block'; 
        });
        document.addEventListener('click', (e)=>{ 
            if(kebabMenu && !kebabBtn.contains(e.target)) kebabMenu.style.display='none'; 
        });
    }

    const viewBtn = document.getElementById('view-profile-btn');
    if(viewBtn){ 
        viewBtn.addEventListener('click', (e)=>{ 
            e.preventDefault();
            e.stopPropagation();
            if(typeof currentChatUser !== 'undefined' && currentChatUser && typeof openUserProfile === 'function') openUserProfile(currentChatUser); 
            if(kebabMenu) kebabMenu.style.display='none'; 
        }); 
    }

    const setWallBtn = document.getElementById('set-wallpaper-btn');
    if(setWallBtn){ 
        setWallBtn.addEventListener('click', (e)=>{ 
            e.preventDefault();
            e.stopPropagation();
            if(kebabMenu) kebabMenu.style.display='none'; 
        }); 
    }
})();

function applyTheme(themeName){
    let themeClass = 'theme-light';
    if(themeName === 'dark') themeClass = 'theme-dark';
    else if(themeName === 'pink') themeClass = 'theme-pink';
    else if(themeName === 'green') themeClass = 'theme-green';
    
    document.body.className = document.body.className.replace(/theme-\w+/, '') + ' ' + themeClass;
    document.body.classList.add(themeClass);
    
    const chatContainer = document.querySelector('.chat-container');
    if(chatContainer) {
        chatContainer.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--surface');
        chatContainer.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text');
    }
}

if(document.getElementById('applyThemeBtn')){
    document.getElementById('applyThemeBtn').addEventListener('click', ()=>{
        const select = document.getElementById('themeSelect');
        if(select) applyTheme(select.value || 'light');
    });
}

document.addEventListener('click', function(e) {
    if(e.target.closest('.inline-sticker')) {
        e.stopPropagation();
        e.preventDefault();
    }
});

// Checkbox in Color theme ======================================================================================
document.addEventListener('DOMContentLoaded', function () {
    const customThemeToggle = document.getElementById('customThemeToggle');
    const additionalContainer = document.getElementById('additional-checkboxes-container');
    const customOptionInput = document.getElementById('custom_option_input');
    const customOptionRadios = document.querySelectorAll('input[name="customOption"]');
    const textColorRadios = document.querySelectorAll('input[name="textColorOption"]');

    const BUTTON_SELECTORS = [
        '.main-btn',
        '.deposit-btn',
        '.add_card-btn',
        '.other-profile-message-btn',
        '.subscribe-btn',
        '.profile-btn',
        '.setting-btn',
        'label.main-btn-style-0',
        'label.main-btn-style-1',
        'label.main-btn-style-2',
        'label.main-btn-style-3',
        'label.main-btn-style-4',
        '.main-btn.main-btn-style-0',
        '.main-btn.main-btn-style-1',
        '.main-btn.main-btn-style-2',
        '.main-btn.main-btn-style-3',
        '.main-btn.main-btn-style-4',
        '.main-btn-style-0',
        '.main-btn-style-1',
        '.main-btn-style-2',
        '.main-btn-style-3',
        '.main-btn-style-4'
    ].join(',');    

    function initializeTextColor() {
        const userColor = "{{ user.color_text_button|default:'black' }}";
        localStorage.setItem('buttonTextColor', userColor);
        const savedColor = userColor;
        applyTextColorToAllButtons(savedColor);
        textColorRadios.forEach(radio => {
            if (radio.value === savedColor) {
                radio.checked = true;
            }
        });
    }

    function applyTextColorToAllButtons(color) {
        const allButtons = document.querySelectorAll(BUTTON_SELECTORS);
        
        allButtons.forEach(btn => {
            btn.style.cssText += `color: ${color === 'white' ? '#ffffff' : '#000000'} !important;`;
            btn.style.cssText += `text-shadow: ${color === 'white' ? '0 1px 2px rgba(0,0,0,0.3)' : 'none'} !important;`;
        });
        
        localStorage.setItem('buttonTextColor', color);
    }

    function applyButtonStyle() {
        const allButtons = document.querySelectorAll(BUTTON_SELECTORS); 

        const isEnabled = customThemeToggle?.checked ?? false;
        const styleValue = isEnabled
            ? (customOptionInput?.value || document.querySelector('input[name="customOption"]:checked')?.value || '1')
            : '0';

        const textColor = document.querySelector('input[name="textColorOption"]:checked')?.value || localStorage.getItem('buttonTextColor') || "{{ user.color_text_button|default:'black' }}";

        allButtons.forEach(btn => {
            btn.className = btn.className
                .replace(/main-btn-style-\d+/g, '')
                .replace(/\bmain-btn\b/g, '')
                .trim();    

            if (styleValue === '0') {
                btn.classList.add('main-btn-style-0');
            } else {
                btn.classList.add('main-btn', `main-btn-style-${styleValue}`);
            }

            btn.style.cssText += `color: ${textColor === 'white' ? '#ffffff' : '#000000'} !important;`;
            btn.style.cssText += `text-shadow: ${textColor === 'white' ? '0 1px 2px rgba(0,0,0,0.3)' : 'none'} !important;`;
        });
    }

    function updateAdditionalVisibility() {
        if (additionalContainer) {
            additionalContainer.style.display = customThemeToggle.checked ? 'block' : 'none';
        }
    }

    function saveCustomOption(value) {
        const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrf) return;

        fetch('/save-custom-option/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrf,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ custom_option: value })
        }).catch(() => {});
    }

    function saveTextColor(color) {
        const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrf) return;
        
        fetch('/save-button-text-color/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrf,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({button_text_color: color})
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Error saving text color:', data.error);
            }
        })
        .catch(err => console.error('Save text color error:', err));
    }

    initializeTextColor();
    updateAdditionalVisibility();
    applyButtonStyle();

    if (customThemeToggle) {
        customThemeToggle.addEventListener('change', function () {
            updateAdditionalVisibility();
            applyButtonStyle();

            const isChecked = this.checked;
            const selectedValue = isChecked
                ? (document.querySelector('input[name="customOption"]:checked')?.value || '1')
                : '0';

            if (customOptionInput) customOptionInput.value = selectedValue;

            const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (csrf) {
                fetch('/toggle-custom-button/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrf,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ enabled: isChecked })
                }).catch(() => {});
            }
        });
    }

    customOptionRadios.forEach(radio => {
        radio.addEventListener('change', function () {
            if (customThemeToggle?.checked) {
                applyButtonStyle();
                if (customOptionInput) customOptionInput.value = this.value;
                saveCustomOption(this.value);
            }
        });
    });

    textColorRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const selectedColor = this.value;
            
            applyTextColorToAllButtons(selectedColor);
            
            saveTextColor(selectedColor);
            
            applyButtonStyle();
        });
    });

    const observer = new MutationObserver(applyButtonStyle);
    observer.observe(document.body, { childList: true, subtree: true });

    setTimeout(applyButtonStyle, 500);
});

function setupWebSocketForLiveUpdates() {
    let pendingMessages = [];
    let processingInterval = null;

    function processBatch() {
        if (pendingMessages.length > 0) {
            pendingMessages.forEach(data => {
                try {
                    console.log('Processing batched WebSocket message:', data);

                    if (data.type === 'message_edited') {
                        const msgEl = document.querySelector(`[data-message-id="${data.message_id}"]`);
                        if (msgEl) {
                            const textDiv = msgEl.querySelector('div');
                            if (textDiv) {
                                msgEl.dataset.tokenText = data.text || '';
                                const processed = processMentionsStrict(data.text || '');
                                const stickerMatch = String(processed).trim().match(/^\[sticker:([a-zA-Z0-9_-]+)\]$/);
                                if (stickerMatch) {
                                    const name = stickerMatch[1];
                                    const emoji = renderSticker(name);
                                    textDiv.innerHTML = `<div class="sticker-render" data-sticker="${name}" style="font-size:44px; display:inline-block; cursor:pointer;" onclick="sendSticker('${name}')">${emoji}</div>`;
                                } else {
                                    textDiv.innerHTML = renderStickersInline(processed);
                                }
                            }
                            const timeDiv = msgEl.querySelector('.message-time');
                            if (timeDiv) {
                                const now = new Date();
                                timeDiv.textContent = formatChatTime(data.timestamp || now.toISOString());
                                timeDiv.dataset.timestamp = data.timestamp || now.toISOString();

                                if (!msgEl.querySelector('.message-edited')) {
                                    const edited = document.createElement('span');
                                    edited.className = 'message-edited';
                                    edited.textContent = ("{{ user.language|default:'English' }}" === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') ? ' (–∑–º—ñ–Ω–µ–Ω–æ)' : ' (edited)';
                                    edited.style.cssText = 'font-size:10px;color:#888;margin-left:6px;';
                                    timeDiv.appendChild(edited);
                                }
                            }
                            
                            addMentionEventListeners(msgEl);
                        }
                        return;
                    }

                    if (data.type === 'message_deleted') {
                        const msgEl = document.querySelector(`[data-message-id="${data.message_id}"]`);
                        if (msgEl) msgEl.remove();
                        return;
                    }

                    if (isVideoModalOpen) {
                        console.log('Video modal open ‚Äî deferring WebSocket updates for this chat');
                        try { if (currentChatUser) pendingRefreshOnModalClose[currentChatUser] = true; } catch(e) {}
                        return;
                    }
                    
                    if (data.file_url) {
                        if (isVideoModalOpen && openVideoUrl && data.file_url === openVideoUrl) {
                            console.log('Received file message for currently open video, skipping UI update to avoid interrupting playback');
                            return;
                        }
                        if (data.sender !== "{{ user.username }}") {
                            displayFileMessage({
                                file_url: data.file_url,
                                file_name: data.file_name,
                                file_type: data.file_type,
                                file_size: data.file_size,
                                text: data.message || '',
                                sender: data.sender,
                                timestamp: data.timestamp || new Date().toISOString()
                            }, false);
                            loadRecentContacts();
                        } else {
                            console.log('Ignoring own file message from WebSocket');
                        }
                        return;
                    }
                    
                    if (data.sender !== "{{ user.username }}") {
                        if (typeof data.message !== 'string' || !data.message.trim()) {
                            console.log('Ignoring non-string/empty message from WebSocket:', data.message);
                        } else {
                            if (data.message_id && document.querySelector(`[data-message-id="${data.message_id}"]`)) {
                                console.debug('Incoming message already present, skipping render', data.message_id);
                            } else {
                                displayMessage({ 
                                    text: data.message, 
                                    sender: data.sender, 
                                    timestamp: data.timestamp || new Date().toISOString(), 
                                    id: data.message_id, 
                                    is_sent: false 
                                });
                                loadRecentContacts();
                            }
                        }
                    } else {
                        console.log('Ignoring own message from WebSocket');
                    }
                } catch (error) {
                    console.error('Error processing batched WebSocket message:', error);
                }
            });

            pendingMessages = [];

            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
    }

    if (chatSocket) {
        chatSocket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                pendingMessages.push(data);

                if (!processingInterval) {
                    processingInterval = setInterval(processBatch, 5000);
                }
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
    }
}


document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        updateAllMessageTimes();
        setupWebSocketForLiveUpdates();
    }, 1000);
    
    const hourFormatToggle = document.getElementById('hour-format-toggle');
    const hourFormatCheckbox = document.getElementById('hour-format-toggle-checkbox');
    
    if (hourFormatToggle) {
        hourFormatToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const is24Hour = !hourFormatCheckbox.checked;
            hourFormatCheckbox.checked = is24Hour;
            
            localStorage.setItem('hourFormat', is24Hour ? '24' : '12');
            
            updateAllMessageTimes();
        });
    }
});

// chat-settings
document.addEventListener('DOMContentLoaded', function() {
    const hourFormatToggle = document.getElementById('hour-format-toggle');
    const hourFormatCheckbox = document.getElementById('hour-format-toggle-checkbox');
    const hourFormatText = document.getElementById('hour-format-text');
    const toggleLabel = document.querySelector('.toggle-label');
    
    const savedFormat = localStorage.getItem('hourFormat') || '12';
    const is24HourFormat = savedFormat === '24';
    
    if (hourFormatCheckbox) hourFormatCheckbox.checked = is24HourFormat;
    updateHourFormatDisplay(is24HourFormat);
    
    if (toggleLabel) {
        toggleLabel.addEventListener('click', function(e) {
            e.preventDefault();
            const is24Hour = !hourFormatCheckbox.checked;
            hourFormatCheckbox.checked = is24Hour;
            
            updateHourFormatDisplay(is24Hour);
            
            localStorage.setItem('hourFormat', is24Hour ? '24' : '12');
            
            updateAllMessageTimes();
        });
    }
    
    if (hourFormatToggle) {
        hourFormatToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const is24Hour = !hourFormatCheckbox.checked;
            hourFormatCheckbox.checked = is24Hour;
            
            updateHourFormatDisplay(is24Hour);
            
            localStorage.setItem('hourFormat', is24Hour ? '24' : '12');
            
            updateAllMessageTimes();
        });
    }
    
    function updateHourFormatDisplay(is24Hour) {
        if (hourFormatText) {
            hourFormatText.textContent = is24Hour 
                ? '24-hour format' 
                : '12-hour format (AM/PM)';
        }
        
        if (hourFormatToggle) {
            const slider = hourFormatToggle.querySelector('.toggle-slider');
            if (slider) {
                slider.style.transform = is24Hour ? 'translateX(26px)' : 'translateX(0)';
            }
            
            hourFormatToggle.style.background = is24Hour ? '#4CAF50' : '#ddd';
        }
    }
    
    function formatChatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const format24Hour = localStorage.getItem('hourFormat') === '24';
        const lang = "{{ user.language|default:'English' }}";   

        const isToday = date.toDateString() === now.toDateString();

        if (!isToday) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();

            let timeString;
            if (format24Hour) {
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                timeString = `${hours}:${minutes}`;
            } else {
                timeString = date.toLocaleTimeString(lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' ? 'uk-UA' : 'en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            }

            return `${day}.${month}.${year} ${timeString}`;
        }

        if (format24Hour) {
            if (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
                return date.toLocaleTimeString('uk-UA', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                }).replace(/^24:/, '00:');
            } else {
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                }).replace(/^24:/, '00:');
            }
        } else {
            if (lang === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') {
                return date.toLocaleTimeString('uk-UA', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            } else {
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            }
        }
    }
    
    function updateAllMessageTimes() {
        const messageTimeElements = document.querySelectorAll('.message-time');
        messageTimeElements.forEach(element => {
            const timestamp = element.dataset.timestamp;
            if (timestamp) {
                element.textContent = formatChatTime(timestamp);
                
                const editedSpan = element.querySelector('.message-edited');
                if (editedSpan) {
                    editedSpan.textContent = ("{{ user.language|default:'English' }}" === '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞') ? ' (–∑–º—ñ–Ω–µ–Ω–æ)' : ' (edited)';
                }
            }
        }); 

        const contactTimeElements = document.querySelectorAll('.contact-time');
        contactTimeElements.forEach(element => {
            const timestamp = element.dataset.timestamp;
            if (timestamp) {
                element.textContent = formatTime(timestamp);
            }
        }); 

        const binMessages = document.querySelectorAll('.message[data-sender="Bin"], .message[data-sender="Bin_bot"]');
        binMessages.forEach(message => {
            const timeElement = message.querySelector('.message-time');
            if (timeElement) {
                const timestamp = timeElement.dataset.timestamp;
                if (timestamp) {
                    timeElement.textContent = formatChatTime(timestamp);
                }
            }
        }); 

        const noteMessages = document.querySelectorAll('.message.sent:not([data-sender])');
        noteMessages.forEach(message => {
            const timeElement = message.querySelector('.message-time');
            if (timeElement) {
                const timestamp = timeElement.dataset.timestamp;
                if (timestamp) {
                    timeElement.textContent = formatChatTime(timestamp);
                }
            }
        });
    }
    
    window.formatChatTime = formatChatTime;
    
    const originalDisplayMessage = window.displayMessage;
    if (originalDisplayMessage) {
        window.displayMessage = function(text, sender, isSent, messageId = null) {
            originalDisplayMessage(text, sender, isSent, messageId);
            
            setTimeout(() => {
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    const lastMessage = messagesContainer.querySelector('.message:last-child');
                    if (lastMessage) {
                        const timeElement = lastMessage.querySelector('.message-time');
                        if (timeElement && !timeElement.dataset.formatted) {
                            const timestamp = new Date().toISOString();
                            timeElement.textContent = formatChatTime(timestamp);
                            timeElement.dataset.timestamp = timestamp;
                            timeElement.dataset.formatted = 'true';
                        }
                    }
                }
            }, 100);
        };
    }
});


document.addEventListener('DOMContentLoaded', function () {
    const chat = document.querySelector('.chat-container');
    const colorThemeToggle = document.getElementById('color_theme-toggle');

    if (chat && colorThemeToggle) {
        chat.addEventListener('click', function () {
            if (colorThemeToggle.checked) {
                colorThemeToggle.checked = false;
            }
        });
    }
});

// Color text button
const textColorRadios = document.querySelectorAll('input[name="textColorOption"]');
const textColorContainer = document.getElementById('text-color-container');

function applyTextColor(color) {
    const allButtons = document.querySelectorAll('.main-btn, .deposit-btn, .add_card-btn, .other-profile-message-btn, .subscribe-btn');
    
    allButtons.forEach(btn => {
        btn.style.cssText += `color: ${(color === 'white') ? '#ffffff' : '#000000'} !important;`;
        btn.style.cssText += `text-shadow: ${(color === 'white') ? '0 1px 2px rgba(0,0,0,0.3)' : 'none'} !important;`;
        
        localStorage.setItem('buttonTextColor', color);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    
    const userColor = "{{ user.color_text_button|default:'black' }}";
    setTimeout(() => {
        const savedColor = localStorage.getItem('buttonTextColor') || userColor;
        
        const allButtons = document.querySelectorAll(BUTTON_SELECTORS);
        allButtons.forEach(btn => {
            btn.style.cssText += `color: ${savedColor === 'white' ? '#ffffff' : '#000000'} !important;`;
            btn.style.cssText += `text-shadow: ${savedColor === 'white' ? '0 1px 2px rgba(0,0,0,0.3)' : 'none'} !important;`;
        });
        
        const textColorRadios = document.querySelectorAll('input[name="textColorOption"]');
        textColorRadios.forEach(radio => {
            if (radio.value === savedColor) {
                radio.checked = true;
                saveTextColor(savedColor);
            }
        });
    }, 200);
});

function saveTextColor(color) {
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrf) return;
    
    fetch('/save-button-text-color/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({button_text_color: color})
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Error saving text color:', data.error);
        }
    })
    .catch(err => console.error('Save text color error:', err));
}

const initialTextColor = "{{ user.button_text_color|default:'black' }}";
applyTextColor(initialTextColor);

textColorRadios.forEach(radio => {
    radio.addEventListener('change', function() {
        const selectedColor = this.value;
        const allButtons = document.querySelectorAll(BUTTON_SELECTORS);
        allButtons.forEach(btn => {
            btn.style.cssText += `color: ${selectedColor === 'white' ? '#ffffff' : '#000000'} !important;`;
            btn.style.cssText += `text-shadow: ${selectedColor === 'white' ? '0 1px 2px rgba(0,0,0,0.3)' : 'none'} !important;`;
        });
        
        localStorage.setItem('buttonTextColor', selectedColor);
        
        saveTextColor(selectedColor);
        
        applyButtonStyle();
    });
});


function refreshRecentContacts() {
    loadRecentContacts();
}

setInterval(refreshRecentContacts, 1000);

setInterval(() => {
    if (!document.getElementById('chat-toggle')?.checked) {
        refreshRecentContacts();
    }
}, 3000);
</script>

{% endblock %}